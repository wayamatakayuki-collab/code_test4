<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>在校等時間管理（Excel版→アプリ版）</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS (Excel import/export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap');
    :root{
      --ink:#111827; --muted:#6b7280; --card:#fff; --line:#e5e7eb;
      --brand:#2563eb; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --bg:#f7f7fb;
      --radius:18px;
      --shadow: 0 18px 40px rgba(2,6,23,.06), 0 2px 8px rgba(2,6,23,.04);
      --ring: 0 0 0 3px rgba(37,99,235,.18);
    }
    body{ font-family: Inter, "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--ink); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
    .tab-btn{ padding:.6rem .9rem; border-bottom:2px solid transparent; font-weight:700; color:var(--muted); }
    .tab-btn.active{ color:var(--brand); border-bottom-color:var(--brand); }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; border:1px solid var(--line); border-radius:999px; padding:.25rem .55rem; font-size:.8rem; background:#fff; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn{ border-radius:14px; font-weight:700; padding:.55rem .9rem; transition:.15s; border:1px solid #e2e8f0; background:#fff; color:#0f172a; }
    .btn.active{ background:var(--brand); color:#fff; border-color:transparent; }
    .btn:focus{ outline:none; box-shadow: var(--ring); }
    .btn-primary{ background:var(--brand); color:#fff; }
    .btn-primary:hover{ filter:brightness(.95); }
    .btn-ghost{ background:#fff; border-color:var(--line); color:var(--ink); }
    .btn-ghost:hover{ background:#f8fafc; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-danger:hover{ filter:brightness(.95); }
    .btn-ok{ background:var(--ok); color:#fff; }
    .btn-ok:hover{ filter:brightness(.95); }
    .input{ width:100%; border:1px solid var(--line); border-radius:14px; padding:.55rem .7rem; background:#fff; }
    .input:focus{ outline:none; box-shadow: var(--ring); border-color: rgba(37,99,235,.35); }
    .small{ font-size:.82rem; color:var(--muted); }
    .sticky-head thead th{ position: sticky; top: 0; background: #f8fafc; z-index: 2; }
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; }
    }
  
    /* Safari描画遅延対策：強制再描画キック */
    #paintKick{ position:fixed; left:0; top:0; width:2px; height:2px; opacity:0; pointer-events:none; }
    .kick-anim{ animation: kickAnim 0.001s linear 1; }
    @keyframes kickAnim { from { transform: translateZ(0) translateX(0); } to { transform: translateZ(0) translateX(1px); } }

    /* --- polish --- */
    .app-wrap{ max-width: 1120px; }
    .bg-grad{ background: radial-gradient(1200px 420px at 50% -120px, rgba(37,99,235,.18), transparent 60%), var(--bg); }
    .card{ box-shadow: 0 14px 32px rgba(2,6,23,.06), 0 2px 10px rgba(2,6,23,.04); }
    .btn{ transition: transform .05s ease, filter .15s ease, background-color .15s ease, border-color .15s ease; }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: var(--ring); }
    .input:focus{ outline:none; box-shadow: var(--ring); border-color: rgba(37,99,235,.55); }
    .sticky-head thead th{ position: sticky; top: 0; background: rgba(248,250,252,.96); backdrop-filter: blur(6px); z-index: 5; border-bottom:1px solid var(--line); }
    .table-zebra tbody tr:nth-child(odd){ background: rgba(248,250,252,.65); }
    .table-zebra tbody tr:hover{ background: rgba(37,99,235,.06); }
    .section-title{ font-weight:900; letter-spacing:.02em; }
    .subtle{ color: var(--muted); }
    .pill{ border-radius: 999px; padding: .2rem .55rem; font-size: .75rem; border:1px solid var(--line); background:#fff; }
    /* print layout */
    @media print{
      body{ background:#fff !important; }
      .card{ box-shadow:none !important; }
      .no-print{ display:none !important; }
      .print-only{ display:block !important; }
      .page-break{ break-before: page; }
    }


/* Print overlay */
#printOverlay{ position:fixed; inset:0; background:#f8fafc; z-index:99999; display:none; }
#printOverlay.show{ display:block; }
.printOverlayBar{ position:sticky; top:0; z-index:2; background:rgba(255,255,255,.92); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid #e5e7eb; padding:10px 14px; display:flex; align-items:center; justify-content:space-between; }
.printFrame{ width:100%; height:calc(100vh - 56px); border:0; background:#fff; }

@media print{
  body > *:not(#printOverlay){ display:none !important; }
  #printOverlay{ display:block !important; position:static; inset:auto; background:#fff; }
  .printOverlayBar{ display:none !important; }
  .printFrame{ height:auto !important; }
}


#toast{z-index:1000000;}
</style>
</head>

<body class="min-h-screen bg-grad">
    <div id="paintKick" aria-hidden="true"></div>
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="card p-5 mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-start gap-3">
        <div class="w-11 h-11 rounded-2xl bg-blue-50 border border-blue-100 flex items-center justify-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 3v3M17 3v3M4 9h16M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" stroke="#2563eb" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-black tracking-tight">在校等時間 管理システム</h1>
          <div class="small mt-0.5">
            Excel（あなたの原本）ロジックを踏襲：
            <span class="mono">在校時間 − 休憩 − その他業務外 = 在校等時間</span> ／
            <span class="mono">在校等時間 − 7:45 = 時間外在校等時間</span>（勤務日） ／
            土日祝等（休みの日）は「在校等時間＝時間外」として集計
          </div>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="chip"><span class="w-2 h-2 rounded-full bg-blue-500 inline-block"></span><span id="chip-month">—</span></span>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span><span id="chip-workday-count">勤務日: —</span></span>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span><span id="chip-holiday-count">休み: —</span></span>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span><span id="chip-threshold">45h/80h 自動警告</span></span>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between md:justify-end gap-3">
        <div class="text-right">
          <div class="mono text-2xl font-black text-blue-600" id="nowTime">--:--:--</div>
          <div class="small" id="nowDate">----/--/-- (---)</div>
        </div>
        <button class="btn btn-ghost no-print" onclick="openHelp()">使い方</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="no-print card px-3 py-2 mb-4">
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn active" id="tab-input" onclick="switchTab('input')">入力</button>
        <button class="tab-btn" id="tab-calendar" onclick="switchTab('calendar')">カレンダー</button>
        <button class="tab-btn" id="tab-overview" onclick="switchTab('overview')">月別 全体一覧</button>
        <button class="tab-btn" id="tab-individual" onclick="switchTab('individual')">月別 個別一覧</button>
        <button class="tab-btn" id="tab-settings" onclick="switchTab('settings')">設定・出力</button>
      </div>
    </div>

    <!-- INPUT -->
    <section id="section-input" class="space-y-4">
      <div class="card p-5">
        <div class="flex flex-col gap-4">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
            <div class="md:col-span-5">
              <label class="block text-sm font-black mb-1">職員</label>
              <button id="inpStaffBtn" class="input text-left w-full" onclick="openStaffPicker()" type="button">
                <span class="font-black" id="inpStaffName">—</span>
                <span class="small ml-2">（タップして選択）</span>
              </button>
              <input type="hidden" id="inpStaffId" value="">
            </div>

            <div class="md:col-span-3">
              <label class="block text-sm font-black mb-1">日付</label>
              <input id="inpDate" type="date" class="input mono" />
            </div>

            <div class="md:col-span-4">
              <label class="block text-sm font-black mb-1">職名</label>
              <div class="flex items-center justify-between gap-2">
                <div id="inpDayBadge" class="text-sm"></div>
                <button class="btn btn-ghost" onclick="openEditModal()" type="button">編集</button>
              </div>
            </div>
          </div>

          <!-- 最速入力：2ボタン + 業務外 -->
          <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
            <div class="md:col-span-4">
              <button class="btn btn-primary h-14 w-full text-lg font-black" onclick="quickStamp('in')" type="button">出勤（今）</button>
            </div>
            <div class="md:col-span-4">
              <button class="btn btn-danger h-14 w-full text-lg font-black" onclick="quickStamp('out')" type="button">退勤（今）</button>
            </div>
            <div class="md:col-span-4">
              <label class="block text-sm font-black mb-1">業務外（時間）</label>
              <input id="inpOtherOff" type="text" class="input mono" placeholder="例: 0:30 / 0.5" onblur="saveOtherOff()" />
              <div class="small mt-1 text-slate-500">※休憩45分とは別に、業務外の時間を入力します。</div>
            </div>
          </div>

          <!-- 常時表示（1行） -->
          <div class="overflow-x-auto">
            <table class="w-full text-left min-w-[880px]">
              <thead class="bg-slate-50">
                <tr>
                  <th class="p-3 text-sm font-black">氏名</th>
                  <th class="p-3 text-sm font-black">職名</th>
                  <th class="p-3 text-sm font-black">出勤</th>
                  <th class="p-3 text-sm font-black">退勤</th>
                  <th class="p-3 text-sm font-black">在校等</th>
                  <th class="p-3 text-sm font-black">業務外</th>
                  <th class="p-3 text-sm font-black">時間外</th>
                  <th class="p-3 text-sm font-black">今月の時間外</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr>
                  <td class="p-3 text-sm font-bold" id="rowName">—</td>
                  <td class="p-3 text-sm" id="rowType">—</td>
                  <td class="p-3 text-sm mono" id="rowIn">--:--</td>
                  <td class="p-3 text-sm mono" id="rowOut">--:--</td>
                  <td class="p-3 text-sm mono font-black" id="rowStayEq">--:--</td>
                  <td class="p-3 text-sm mono" id="rowOther">0:00</td>
                  <td class="p-3 text-sm mono font-black" id="rowOver">--:--</td>
                  <td class="p-3 text-sm mono font-black" id="rowMonthOver">--:--</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="small text-slate-600">
            ※計算：<b>在校時間</b>（退勤−出勤）− <b>休憩</b>（休憩: <span class="mono" id="miniBreak">--</span>）− <b>業務外</b> ＝ <b>在校等時間</b>。<br/>
            ※<b>時間外</b>：勤務日は <b>在校等−標準勤務</b>、休みは <b>在校等</b>。
          </div>

          <!-- hidden time inputs (kept for internal storage) -->
          <input id="inpIn" type="time" class="hidden" />
          <input id="inpOut" type="time" class="hidden" />
        </div>
      </div>
    </section>

<!-- CALENDAR -->
    <section id="section-calendar" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">カレンダー（休みの日のチェック）</h2>
            <div class="small">土日祝は休み（時間外扱い）ですが、登校日・代休等がある場合はここで切り替えます。</div>
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <div class="chip mono" id="calMonthLabel">----</div>
            <button id="btnPrevMonth" class="btn btn-ghost" type="button">◀ 前月</button>
            <button id="btnNextMonth" class="btn btn-ghost" type="button">翌月 ▶</button>
            <span class="small">（月の変更は全タブに反映）</span>
            <span class="w-2"></span>
            <button class="btn btn-ghost" onclick="resetWeekendDefaults()" type="button">土日を休みに戻す</button>
            <button class="btn btn-ghost" onclick="openHolidayPaste()" type="button">祝日を貼り付け</button>
            <button class="btn btn-ghost" onclick="bulkSetWorkday()" type="button">選択範囲を勤務日に</button>
            <button class="btn btn-ghost" onclick="bulkSetOffday()" type="button">選択範囲を休みに</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-7 gap-2 text-center">
          <div class="text-xs font-black text-gray-500">日</div>
          <div class="text-xs font-black text-gray-500">月</div>
          <div class="text-xs font-black text-gray-500">火</div>
          <div class="text-xs font-black text-gray-500">水</div>
          <div class="text-xs font-black text-gray-500">木</div>
          <div class="text-xs font-black text-gray-500">金</div>
          <div class="text-xs font-black text-gray-500">土</div>
        </div>

        <div id="calGrid" class="mt-2 grid grid-cols-7 gap-2"></div>

        <div class="mt-4 small">
          ・「休」チェックが <b>ON</b>：休みの日（週休日・祝日・代休など） → その日の在校等時間は <b>すべて時間外</b> に集計。<br/>
          ・「休」チェックが <b>OFF</b>：勤務日（登校日・土曜授業など） → <b>在校等 − 7:45</b> を時間外として集計。
        </div>
      </div>
    </section>

    <!-- OVERVIEW -->
    <section id="section-overview" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">月別 全体一覧（職員別サマリー）</h2>
            <div class="small">Excelの「様式２」イメージ：平日（平均）／週休日等（平均）／当該月（合計）を並べます。</div>
          </div>
          
          <div class="flex flex-wrap items-center gap-2">
            <div class="flex items-center gap-1">
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(-1)">◀</button>
              <input id="ovMonth" type="month" class="input w-40" onchange="onViewMonthChange(this.value)" />
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(1)">▶</button>
              <span id="ovMonthChip" class="pill mono"></span>
            </div>
            <input id="ovSearch" class="input w-full md:w-64" placeholder="氏名で絞り込み" oninput="renderOverview()" />
            <button class="btn btn-ok" onclick="exportMonthExcel()">Excel出力（表示月）</button>

            
            <div class="flex flex-wrap items-center gap-2">
              <button class="btn btn-ghost" onclick="openOverviewPrintMenu()" type="button">印刷</button>
              <button class="btn btn-ghost" onclick="openPrintHelp()" type="button">印刷の使い方</button>
            </div>
          </div>
        </div>

        <div class="print-only" style="display:none;margin-top:8px;margin-bottom:8px;"><div style="font-weight:900;font-size:16px;">月別 全体一覧（<span id="printMonthChip"></span>）</div><div style="color:#6b7280;font-size:12px;">※印刷：全体／チェック職員 のいずれか</div></div>
<div id="indSummary" class="mt-4 no-print"></div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-left sticky-head table-zebra">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">氏名</th>
                <th class="p-3 text-xs font-black">職名</th>
                <th class="p-3 text-xs font-black">平日 出勤(平均)</th>
                <th class="p-3 text-xs font-black">平日 退勤(平均)</th>
                <th class="p-3 text-xs font-black">平日 在校等(平均)</th>
                <th class="p-3 text-xs font-black">休み 出勤(平均)</th>
                <th class="p-3 text-xs font-black">休み 退勤(平均)</th>
                <th class="p-3 text-xs font-black">休み 在校等(平均)</th>
                <th class="p-3 text-xs font-black">週休日等(合計)</th>
                <th class="p-3 text-xs font-black">当月 時間外(合計)</th>
                <th class="p-3 text-xs font-black">45h/80h</th>
                <th class="p-3 text-xs font-black no-print">詳細</th>
              </tr>
            </thead>
            <tbody id="overviewBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div>
            <h3 class="font-black">平均（チェックした職員の平均）</h3>
            <div class="small">月別印刷・集計の対象職員をチェックで選びます。</div>
          </div>
          <div class="flex flex-wrap gap-2 no-print">
            <button class="btn btn-ghost" onclick="toggleAllAvg(true)" type="button">全選択</button>
            <button class="btn btn-ghost" onclick="toggleAllAvg(false)" type="button">解除</button>
            <button class="btn btn-ghost" onclick="" type="button">校長</button>
            <button class="btn btn-ghost" onclick="" type="button">教頭</button>
            <button class="btn btn-ghost" onclick="" type="button">事務</button>
            <button class="btn btn-ghost" onclick="" type="button">その他</button>
          </div>
        </div>


        <div class="mt-3 grid grid-cols-2 md:grid-cols-4 gap-2 no-print" id="avgStaffChecks"></div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="card p-4">
            <div class="small">平日 出勤（平均）</div>
            <div class="mono text-xl font-black" id="avgWorkIn">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">平日 退勤（平均）</div>
            <div class="mono text-xl font-black" id="avgWorkOut">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">平日 在校等（平均）</div>
            <div class="mono text-xl font-black" id="avgWorkStayEq">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">当月 時間外（平均）</div>
            <div class="mono text-xl font-black" id="avgMonthOver">--:--</div>
          </div>
        </div>
      </div>
    </section>

    <!-- INDIVIDUAL -->
    <section id="section-individual" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">月別 個別一覧</h2>
            <div class="small">日ごとの「在校等時間」「時間外」を確認。必要なら「業務外(除く)」もここで編集できます。</div>
          </div>
          
          <div class="flex flex-wrap items-center gap-2">
            <div class="flex items-center gap-1">
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(-1)">◀</button>
              <input id="indMonth" type="month" class="input w-40" onchange="onViewMonthChange(this.value)" />
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(1)">▶</button>
              <span id="indMonthChip" class="pill mono"></span>
            </div>
            <select id="indStaff" class="input md:w-72" onchange="renderIndividual()"></select>
            <button class="btn btn-primary" onclick="printIndividual()" type="button">個別レポートを開く（印刷/保存）</button>
            <button class="btn btn-ghost" onclick="openBatchPrintModal()" type="button">一括印刷</button>
            <button class="btn btn-ghost" onclick="openIndEditHelp()">業務外の編集について</button>
            <button class="btn btn-ghost" onclick="openPrintHelp()" type="button">印刷の使い方</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-left sticky-head table-zebra">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">日付</th>
                <th class="p-3 text-xs font-black">職名</th>
                <th class="p-3 text-xs font-black">出勤</th>
                <th class="p-3 text-xs font-black">退勤</th>
                <th class="p-3 text-xs font-black">在校等</th>
                <th class="p-3 text-xs font-black">業務外(除く)</th>
                <th class="p-3 text-xs font-black">時間外</th>
                <th class="p-3 text-xs font-black no-print">操作</th>
              </tr>
            </thead>
            <tbody id="indBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="section-settings" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">設定（このタブで月・勤務条件を調整）</h2>
            <div class="small">「月の設定は設定画面で」：入力タブは極力シンプルに保ちます。</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-ghost" onclick="backupJSON()">バックアップ(JSON)</button>
            <button class="btn btn-ghost" onclick="restoreJSON()">復元(JSON)</button>
            <button class="btn btn-danger" onclick="resetAll()">全データ初期化</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-4">
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">年</label>
            <input id="setYear" type="number" class="input" min="2000" max="2100" />
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">月</label>
            <input id="setMonth" type="number" class="input" min="1" max="12" />
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">正規勤務時間（分）</label>
            <input id="setStdMin" type="number" class="input" min="0" max="1440" />
            <div class="small mt-1">既定：7:45 = 465分</div>
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">休憩（分）</label>
            <div class="grid grid-cols-1 gap-2">
              <input id="setBreakMin" type="number" class="input" min="0" max="300" />
            </div>
            <div class="small mt-1">既定：45分（設定で変更）</div>
          </div>

          <div class="md:col-span-12 flex flex-wrap gap-2 items-center">
            <button class="btn btn-primary" onclick="applySettings()">設定を反映</button>
            <span class="small">※反映すると、カレンダーと一覧が再計算されます。</span>
          </div>
        </div>
      </div>

      <div class="card p-5">
        <h3 class="font-black mb-2">職員（最大50名）</h3>
        <div class="small mb-4">Excelの原本に合わせて「職名（校長/教頭/教員等/事務 等）」も持てます（自由入力）。</div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
          <div class="md:col-span-4">
            <label class="block text-sm font-bold mb-1">氏名</label>
            <input id="newStaffName" class="input" placeholder="例：山田 太郎" />
          </div>
          <div class="md:col-span-4">
            
            <label class="block text-sm font-bold mb-1">職名</label>
            <input id="newStaffRole" class="input" list="roleSuggestions" placeholder="例：校長 / 教頭 / 教諭 / 事務職員 など（自由入力）" />
            <datalist id="roleSuggestions">
              <option value="校長"></option>
              <option value="教頭"></option>
              <option value="副校長・教頭"></option>
              <option value="教諭"></option>
              <option value="教員等"></option>
              <option value="事務職員"></option>
              <option value="養護教諭"></option>
              <option value="講師"></option>
              <option value="その他"></option>
            </datalist>
          </div>
          
          <div class="md:col-span-4 flex gap-2">
            <button class="btn btn-primary w-full" onclick="addStaff()">追加</button>
            <button class="btn btn-ghost w-full" onclick="sortStaff()">並び替え</button>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left sticky-head table-zebra">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">No</th>
                <th class="p-3 text-xs font-black">氏名</th>
                <th class="p-3 text-xs font-black">職名</th>
                <th class="p-3 text-xs font-black no-print">操作</th>
              </tr>
            </thead>
            <tbody id="staffBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h3 class="font-black">Excel（原本）から取り込み</h3>
            <div class="small">あなたの.xlsm から「職員」「月」「出勤/退勤」「週休日在校」「業務外(除く)」「主な理由」を自動で読み取ります。</div>
          </div>
          <div class="flex gap-2">
            <input id="excelFile" type="file" accept=".xlsx,.xlsm" class="input" />
            <button class="btn btn-primary" onclick="importExcel()">取り込み</button>
          </div>
        </div>

        <div class="mt-3 small text-gray-600">
          取り込み対象シート（固定名を想定）：
          <span class="mono">設定シート / 出退勤時刻等入力 / 週休日在校時間入力 / 1〜(個人シート)</span>
        </div>
      </div>

      <div class="card p-5">
        <h3 class="font-black mb-2">業務外の理由（学校で編集）</h3>
        <div class="small mb-3">入力時の「理由」一覧に反映されます。形式：<span class="mono">番号|内容</span>（1行=1項目）</div>
        <textarea id="setReasons" class="input mono" rows="7" placeholder="例) 1|読書の時間"></textarea>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <button class="btn btn-primary" onclick="applyReasons()">理由を反映</button>
          <button class="btn btn-ghost" onclick="resetReasons()">既定に戻す</button>
        </div>
      </div>


<div class="card p-5">
  <h3 class="font-black mb-2">目標（時間外在校等時間・月）</h3>
  <div class="small mb-4 text-slate-600">
    設定した時間を「100%」として、今月の時間外在校等時間が少ないほど達成率が上がります（例：目標45h / 今月20h → 225%）。
  </div>

  <div class="grid md:grid-cols-3 gap-3 mb-1">
    <div>
      <div class="small mb-1">目標（時間）</div>
      <input id="setGoalOverH" class="input w-full" type="number" min="0" step="1" value="45" />
    </div>
    <div class="md:col-span-2">
      <div class="small mb-1">操作</div>
      <div class="flex gap-2 flex-wrap">
        <button class="btn btn-primary px-4" type="button" onclick="applyGoalOver()">目標を保存</button>
        <button class="btn btn-ghost px-4" type="button" onclick="resetGoalOver()">初期値に戻す</button>
      </div>
      <div class="small mt-2 text-slate-500">※0にすると達成率表示は非表示（—）になります。</div>
    </div>
  </div>
</div>

    </section>

    <!-- Toast -->
    
  <!-- 印刷オーバーレイ（Safariでも確実に印刷できる） -->
  <div id="printOverlay" class="hidden">
    <div class="printOverlayBar no-print">
      <div class="font-black">印刷プレビュー</div>
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost" onclick="printOverlayPrint()" type="button">印刷</button>
        <button class="btn btn-ghost" onclick="closePrintOverlay()" type="button">閉じる</button>
      </div>
    </div>
    <div id="printOverlayMsg" class="no-print" style="display:none; padding:10px 14px; color:#b91c1c; background:#fff1f2; border-bottom:1px solid #fecdd3;"></div>
    <iframe id="printFrame" title="print" class="printFrame"></iframe>
  </div>

<div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-lg opacity-0 transition-opacity pointer-events-none no-print"></div>

    <!-- Modal -->
    <div id="modalWrap" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50 no-print">
      <div class="card max-w-2xl w-full p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" id="modalTitle">—</div>
            <div class="small mt-1" id="modalSub">—</div>
          </div>
          <button class="btn btn-ghost" onclick="closeModal()">閉じる</button>
        </div>
        <div class="mt-4" id="modalBody"></div>
        <div class="mt-5 flex justify-end gap-2" id="modalFooter"></div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   Data Model (Excel原本ロジック対応)
   =========================================================
   settings: { year, month, stdMin(7:45), breakWorkMin(45), breakOffMin(0), holidaysText[] }
   staff: [{id, no, name, role}]
   calendar: { "YYYY-MM-DD": { off: true/false } }  // off=true=休み
   records:
     records[dateKey][staffId] = {
       in:"HH:MM"|"", out:"HH:MM"|"",
       over:"H:MM"|"0.5"|""  // 入力（空欄なら自動）
       otherOff:"H:MM"|""    // その他業務外（除く時間）※個別一覧で編集
       reasonCode:number|""  // 主な理由（Excelに合わせて保持）
       holidayStayEq は互換用に読み込む場合があります（本計算では不使用）
     }
*/
const STORE = {
  settings: "wh.settings.v1",
  staff:    "wh.staff.v1",
  calendar: "wh.calendar.v1",
  records:  "wh.records.v1",
  selfStaff:"wh.selfStaff.v1",
viewYM:   "wh.viewYM.v1",
};
const KEY_AVG_SELECTED = "wh.avgSelected.v1";
const DEFAULT_SETTINGS = {
  year: new Date().getFullYear(),
  month: new Date().getMonth()+1,

  // 標準勤務（7時間45分）
  stdMin: 7*60+45,

  // 休憩（分）※設定で変更
  breakMin: 45,

  // 互換（旧キー）
  standardWorkMin: 7*60+45,
  breakWorkMin: 45,
  breakOffMin: 0,

  // 祝日（YYYY-MM-DD）
  holidayDates: [],

  // 業務外の理由（学校で編集可能）
  reasons: [
    { code:"1", label:"教師が幅広くその専門性を高めるための学術書や専門書の読書の時間" },
    { code:"2", label:"教科に関する論文の執筆" },
    { code:"3", label:"教科指導や生徒指導に係る自主的な研究会への参加" },
    { code:"4", label:"自らの資質を高めるための資格試験のための勉強の時間" },
    { code:"5", label:"朝早めに出勤して新聞や本を読む時間" },
    { code:"6", label:"所定の勤務外の食事の時間" },
    { code:"7", label:"学校内で実施されるPTA活動に校務としてではなく参加している時間" },
    { code:"8", label:"地域住民等としての立場で学校で行われる地域活動に参加している時間" },
    { code:"9", label:"その他" },
  ],
goalOverH: 45,
};

let settings = load(STORE.settings, DEFAULT_SETTINGS);
let viewYM = load(STORE.viewYM, null);
let staff = load(STORE.staff, [

  {id: uid(), no: 1, name: "管理者", role: "その他"},
  {id: uid(), no: 2, name: "教職員A", role: "教員等"},
  {id: uid(), no: 3, name: "教職員B", role: "教員等"},
]);

// --- staff helper ---
function getStaff(id){
  if(!id) return null;
  try{
    return (Array.isArray(staff) ? staff : []).find(s => String(s.id) === String(id)) || null;
  }catch(e){
    return null;
  }
}

let calendar = load(STORE.calendar, {}); // dateKey => {off:true/false}
let records  = load(STORE.records, {});  // dateKey => { staffId => entry }

function normalizeSettings(){
  // break
  if(settings.breakMin==null){
    settings.breakMin = Number(settings.breakWorkMin ?? 45);
  }
  settings.breakWorkMin = Number(settings.breakMin);
  settings.breakOffMin = 0;

  // std
  if(settings.stdMin==null){
    settings.stdMin = Number(settings.standardWorkMin ?? (7*60+45));
  }
  settings.standardWorkMin = Number(settings.stdMin);

  // reasons
  if(!Array.isArray(settings.reasons) || settings.reasons.length===0){
    settings.reasons = DEFAULT_SETTINGS.reasons.slice();
  }else{
    settings.reasons = settings.reasons
      .map(r=>({code:String(r.code||"").trim(), label:String(r.label||"").trim()}))
      .filter(r=>r.code && r.label);
  }

  if(settings.goalOverH==null) settings.goalOverH = Number(DEFAULT_SETTINGS.goalOverH ?? 45);
  settings.goalOverH = Number(settings.goalOverH||0);

  save(STORE.settings, settings);
}

function normalizeStaff(){
  let changed = false;
  staff.forEach(s=>{
    if(s.title!=null && (s.role==null || s.role==="")){
      s.role = s.title;
      delete s.title;
      changed = true;
    }
    if(s.patterns!=null){ delete s.patterns; changed = true; }
    if(s.pattern!=null){ delete s.pattern; changed = true; }
  });
  if(changed) save(STORE.staff, staff);
}



function fillReasonSelect(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const opts = ['<option value="">（理由を選択）</option>'].concat(
    (settings.reasons||[]).map(r=>{
      const txt = `${escapeHtml(r.code)}：${escapeHtml(r.label)}`;
      return `<option value="${escapeAttr(r.code)}">${txt}</option>`;
    })
  );
  sel.innerHTML = opts.join("");
}

function reasonLabel(code){
  const c = String(code||"").trim();
  const r = (settings.reasons||[]).find(x=>String(x.code)===c);
  return r ? `${r.code}：${r.label}` : c;
}

function fillReasonEditor(){
  const ta = document.getElementById("setReasons");
  if(!ta) return;
  ta.value = (settings.reasons||[]).map(r=>`${r.code}|${r.label}`).join("\n");
}

function applyReasons(){
  const ta = document.getElementById("setReasons");
  if(!ta) return;
  const lines = ta.value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const parsed = [];
  for(const line of lines){
    const parts = line.split("|");
    if(parts.length>=2){
      const code = parts[0].trim();
      const label = parts.slice(1).join("|").trim();
      if(code && label) parsed.push({code, label});
      continue;
    }
    const parts2 = line.split("=>");
    if(parts2.length>=2){
      const code = parts2[0].trim();
      const label = parts2.slice(1).join("=>").trim();
      if(code && label) parsed.push({code, label});
    }
  }
  if(parsed.length===0){ toast("理由の形式が不正です（例: 1|読書の時間）"); return; }
  settings.reasons = parsed;
  save(STORE.settings, settings);
  toast("理由を反映しました");
}

function resetReasons(){
  settings.reasons = DEFAULT_SETTINGS.reasons.slice();
  save(STORE.settings, settings);
  fillReasonEditor();
  toast("既定に戻しました");
}






let charts = { monthOver:null, dailyTotal:null };

/* =========================
   Utilities
   ========================= */
function uid(){ return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
function saveAll(){ save(STORE.settings, settings); save(STORE.staff, staff); save(STORE.calendar, calendar); save(STORE.records, records); }
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function load(key, fallback){
  try{ const v = JSON.parse(localStorage.getItem(key)); return (v ?? fallback); }catch{ return fallback; }
}
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.remove("opacity-0");
  setTimeout(()=>t.classList.add("opacity-0"), 2600);
}
function pad2(n){ return String(n).padStart(2,"0"); }
function dateKeyFromParts(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
function parseTimeToMin(hhmm){
  if(!hhmm) return null;
  const m = /^(\d{1,2}):(\d{2})$/.exec(hhmm.trim());
  if(!m) return null;
  const h = Number(m[1]), mi=Number(m[2]);
  if(h<0||h>47||mi<0||mi>59) return null;
  return h*60 + mi;
}
function formatClock(min){
  if(min==null || isNaN(min)) return "";
  min = Math.round(min);
  let h = Math.floor(min/60) % 24;
  let m = min % 60;
  return `${pad2(h)}:${pad2(m)}`;
}

function buildAnnualOverSvg(annual, curY, curM, goalH){
  // annual: [{y,m,over(min)}] length 12
  const w = 980, h = 220, pad = 30;
  const innerW = w - pad*2, innerH = h - pad*2;
  const xs = annual.map((_,i)=>pad + (innerW*(i/(annual.length-1 || 1))));
  const ysVal = annual.map(a => (Number(a.over)||0)/60); // hours
  const maxV = Math.max(goalH||0, ...ysVal, 1);
  const yScale = v => pad + innerH - (v/maxV)*innerH;

  const pts = xs.map((x,i)=>`${x.toFixed(1)},${yScale(ysVal[i]).toFixed(1)}`).join(" ");
  const area = `${pad},${pad+innerH} ` + pts + ` ${pad+innerW},${pad+innerH}`;

  // goal line
  const goalY = (goalH>0) ? yScale(goalH) : null;

  // current month highlight
  const curIdx = annual.findIndex(a => Number(a.y)===Number(curY) && Number(a.m)===Number(curM));
  const curX = (curIdx>=0) ? xs[curIdx] : null;

  // x labels (month)
  const lab = annual.map(a => `${Number(a.m)}月`);

  const escape = (s)=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
  const ticks = (()=>{
    const n = annual.length;
    const arr=[];
    for(let i=0;i<n;i++){
      if(n<=6 || i%2===0) arr.push({i, x:xs[i], t:lab[i]});
    }
    return arr;
  })();

  const gridLines = 4;
  let grid = "";
  for(let i=0;i<=gridLines;i++){
    const v = (maxV/gridLines)*i;
    const y = yScale(v);
    grid += `<line x1="${pad}" y1="${y}" x2="${pad+innerW}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
    grid += `<text x="${pad-8}" y="${y+4}" text-anchor="end" font-size="11" fill="#6b7280">${v.toFixed(0)}</text>`;
  }

  const xTicks = ticks.map(t=>`
    <text x="${t.x}" y="${pad+innerH+18}" text-anchor="middle" font-size="11" fill="#6b7280">${escape(t.t)}</text>
  `).join("");

  const curHi = (curX!=null) ? `<rect x="${curX-10}" y="${pad}" width="20" height="${innerH}" fill="#111827" opacity="0.04"/>` : "";

  const goalLine = (goalY!=null) ? `<line x1="${pad}" y1="${goalY}" x2="${pad+innerW}" y2="${goalY}" stroke="#111827" stroke-dasharray="6 5" stroke-width="1.5" opacity="0.55"/>` : "";

  return `
  <svg viewBox="0 0 ${w} ${h}" width="100%" height="auto" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="年間の時間外在校等時間の推移">
    <rect x="0" y="0" width="${w}" height="${h}" fill="#ffffff"/>
    ${curHi}
    ${grid}
    ${goalLine}
    <polygon points="${area}" fill="#93c5fd" opacity="0.55"/>
    <polyline points="${pts}" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
    ${xTicks}
    <text x="${pad}" y="${pad-10}" font-size="12" fill="#6b7280">時間（h）</text>
  </svg>`;
}

function formatDur(min){
  if(min==null || isNaN(min)) return "--:--";
  min = Math.round(min);
  const h = Math.floor(min/60);
  const m = Math.abs(min % 60);
  return `${h}:${pad2(m)}`;
}

function formatDurJP(min){
  if(min==null || isNaN(min)) return "—";
  min = Math.round(Number(min));
  const sign = min<0 ? "-" : "";
  min = Math.abs(min);
  const h = Math.floor(min/60);
  const m = min % 60;
  return `${sign}${h}時間${m}分`;
}
function parseDurationToMin(s){
  if(s===undefined || s===null) return null;
  const t = s.toString().trim();
  if(!t) return null;

  // H:MM (e.g. 0:30, 12:05)
  let m = /^(\d{1,3}):(\d{2})$/.exec(t);
  if(m){
    const h = Number(m[1]), mi = Number(m[2]);
    if(mi<0 || mi>59) return null;
    return h*60 + mi;
  }

  // JP formats: "1時間30分", "2時間", "45分"
  m = /^(\d{1,3})\s*時間\s*(\d{1,2})\s*分$/.exec(t);
  if(m){
    const h = Number(m[1]||0), mi = Number(m[2]||0);
    if(mi<0 || mi>59) return null;
    return h*60 + mi;
  }
  m = /^(\d{1,3})\s*時間$/.exec(t);
  if(m){
    const h = Number(m[1]||0);
    return h*60;
  }
  m = /^(\d{1,3})\s*分$/.exec(t);
  if(m){
    const mi = Number(m[1]||0);
    return mi;
  }

  // decimal hours (e.g. 0.5)
  if(/^\d+(\.\d+)?$/.test(t)){
    return Math.round(Number(t)*60);
  }
  return null;
}


function durMinToHM(min){
  const n = Math.max(0, Math.round(Number(min)||0));
  const h = Math.floor(n/60);
  const m = n%60;
  return `${h}:${String(m).padStart(2,"0")}`;
}


function minutesDiff(inMin, outMin){
  if(inMin==null || outMin==null) return null;
  let diff = outMin - inMin;
  if(diff < 0) diff += 24*60; // overnight safety
  return diff;
}
function dowLabel(dateObj){
  const w = ["日","月","火","水","木","金","土"][dateObj.getDay()];
  return w;
}
function isWeekend(dateObj){
  const d = dateObj.getDay();
  return d===0 || d===6;
}
function getMonthInfo(){
  const y = Number(settings.year), m = Number(settings.month);
  const daysInMonth = new Date(y, m, 0).getDate();
  const firstDow = new Date(y, m-1, 1).getDay(); // 0=Sun
  return {y,m,daysInMonth,firstDow};
}

function ensureViewYM(){
  if(!viewYM || typeof viewYM!=="object"){
    viewYM = { y:Number(settings.year), m:Number(settings.month) };
    save(STORE.viewYM, viewYM);
  }
}
function getViewYM(){
  ensureViewYM();
  return { y:Number(viewYM.y), m:Number(viewYM.m) };
}
function getViewMonthInfo(){
  const {y,m} = getViewYM();
  const daysInMonth = new Date(y, m, 0).getDate();
  const firstDow = new Date(y, m-1, 1).getDay();
  return {y,m,daysInMonth,firstDow};
}
function setViewYM(y,m){
  const yy = Number(y), mm = Number(m);
  if(!yy || !mm) return;
  viewYM = { y: yy, m: mm };
  save(STORE.viewYM, viewYM);
  syncViewMonthUI();
  safeCall(renderOverview);
  safeCall(renderIndividual);
}
function shiftViewYM(delta){
  const cur = getViewYM();
  let y = cur.y, m = cur.m + Number(delta||0);
  while(m<1){ m+=12; y-=1; }
  while(m>12){ m-=12; y+=1; }
  setViewYM(y,m);
}
function ymToInputValue(y,m){ return `${y}-${pad2(m)}`; }
function syncViewMonthUI(){
  const {y,m} = getViewYM();
  const v = ymToInputValue(y,m);
  const ov = document.getElementById("ovMonth");
  const ind = document.getElementById("indMonth");
  if(ov && ov.value!==v) ov.value = v;
  if(ind && ind.value!==v) ind.value = v;
  const chip1 = document.getElementById("ovMonthChip");
  const chip2 = document.getElementById("indMonthChip");
  const text = `${y}年${pad2(m)}月`;
  if(chip1) chip1.textContent = text;
  if(chip2) chip2.textContent = text;
  const pchip = document.getElementById("printMonthChip");
  if(pchip) pchip.textContent = text;
}

function onViewMonthChange(v){
  if(!v) return;
  const parts = String(v).split("-");
  if(parts.length!==2) return;
  const y = Number(parts[0]), m = Number(parts[1]);
  setViewYM(y,m);
}




function getDateObj(dateKey){
  const [y,m,d]=dateKey.split("-").map(Number);
  return new Date(y, m-1, d);
}
function defaultOff(dateKey){
  const d = getDateObj(dateKey);
  // 土日 + 設定した祝日 を休みに
  if(isWeekend(d)) return true;
  if((settings.holidayDates||[]).includes(dateKey)) return true;
  return false;
}
function isOffday(dateKey){
  if(calendar[dateKey] && typeof calendar[dateKey].off === "boolean") return !!calendar[dateKey].off;
  return defaultOff(dateKey);
}
function setOffday(dateKey, off){
  calendar[dateKey] = { off: !!off };
  save(STORE.calendar, calendar);
}

/* =========================
   Core calculations (Excel準拠)
   ========================= */
function getEntry(dateKey, staffId){
  if(!records[dateKey]) records[dateKey] = {};
  if(!records[dateKey][staffId]) records[dateKey][staffId] = { in:"", out:"", otherOff:"", reason:"", reasonCode:"" };
  const e = records[dateKey][staffId];
  // compat
  if(e.reason==null && e.reasonCode!=null) e.reason = String(e.reasonCode||"");
  if(e.reasonCode==null && e.reason!=null) e.reasonCode = String(e.reason||"");
  return e;
}

function calcFor(dateKey, staffId){
  const e = getEntry(dateKey, staffId);
  const off = isOffday(dateKey);

  // In/Out
  const inMin  = parseTimeToMin(e.in);
  const outMin = parseTimeToMin(e.out);

  // ① 在校時間（raw）
  const stayRaw = minutesDiff(inMin, outMin);

  // 休憩（設定：分）
  const breakMin = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);

  // 業務外（手入力）
  const otherOffMin = parseDurationToMin(e.otherOff) || 0;

  // ② 除く時間
  const exclude = (stayRaw==null) ? null : (breakMin + otherOffMin);

  // ③ 在校等時間 = ① − ②
  const stayEq = (stayRaw==null) ? null : Math.max(0, stayRaw - exclude);

  // ④ 時間外在校等時間 = ③ − 7:45（休みの日は全て時間外扱い）
  const std = Number(settings.stdMin ?? settings.standardWorkMin ?? (7*60+45));
  const baseStd = off ? 0 : std;
  const over = (stayEq==null) ? null : (off ? stayEq : Math.max(0, stayEq - baseStd));

  return { off, inMin, outMin, stayRaw, breakMin, otherOffMin, exclude, stayEq, over };
}

function monthAggByStaff(staffId, y, m){
  const mi = (y && m) ? {y:Number(y), m:Number(m), daysInMonth: new Date(Number(y), Number(m), 0).getDate()} : getMonthInfo();
  const yy = mi.y, mm = mi.m, daysInMonth = mi.daysInMonth;
  const arr = [];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(yy,mm,d);
    const c = calcFor(key, staffId);
    const ent = getEntry(key, staffId);
    const hasAny = !!(ent.in || ent.out || ent.otherOff);
    arr.push({dateKey:key, day:d, dow:dowLabel(getDateObj(key)), ...c, ent, hasAny});
  }
  return arr;
}

function summaryByStaff(staffId, y, m){
  const vm = (y && m) ? {y:Number(y), m:Number(m)} : getViewYM();
  const days = monthAggByStaff(staffId, vm.y, vm.m);

  const work = days.filter(x => !x.off && x.hasAny);
  const off  = days.filter(x =>  x.off && x.hasAny);

  const avg = (vals) => {
    const xs = vals.filter(v => v!=null && !isNaN(v));
    if(xs.length===0) return null;
    return xs.reduce((a,b)=>a+b,0) / xs.length;
  };
  const sum = (vals) => vals.filter(v=>v!=null && !isNaN(v)).reduce((a,b)=>a+b,0);

  const avgWorkIn  = avg(work.map(x=>x.inMin));
  const avgWorkOut = avg(work.map(x=>x.outMin));
  const avgWorkStayEq = avg(work.map(x=>x.stayEq));
  const avgWorkOtherOff = avg(work.map(x=>x.otherOffMin));

  const avgOffIn  = avg(off.map(x=>x.inMin));
  const avgOffOut = avg(off.map(x=>x.outMin));
  const avgOffStayEq = avg(off.map(x=>x.stayEq));
  const avgOffOtherOff = avg(off.map(x=>x.otherOffMin));

  const totalOffStayEq = sum(off.map(x=>x.stayEq));  // 週休日等 在校等（合計）
  const totalOver = sum(days.map(x=>x.over));        // 当該月 時間外（合計）
  const totalOtherOff = sum(days.map(x=>x.otherOffMin)); // 当該月 業務外（合計）

  return {
    avgWorkIn, avgWorkOut, avgWorkStayEq,
    avgOffIn, avgOffOut, avgOffStayEq,
    avgWorkOtherOff, avgOffOtherOff,
    totalOffStayEq, totalOver, totalOtherOff,
    totalWeekendWork: totalOffStayEq,
    over45: totalOver >= 45*60,
    over80: totalOver >= 80*60,
    offHas: totalOffStayEq>0
  };
}

function dailyTotalOver(){
  const {y,m,daysInMonth} = getMonthInfo();
  const labels = [];
  const totals = [];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    labels.push(String(d));
    let total = 0;
    for(const s of staff){
      const c = calcFor(key, s.id);
      if(c.over!=null) total += c.over;
    }
    totals.push(total);
  }
  return {labels, totals};
}

/* =========================
   UI Init
   ========================= */

function bindMonthNavButtons(){
  const prev = document.getElementById("btnPrevMonth");
  const next = document.getElementById("btnNextMonth");
  const wire = (el, delta)=>{
    if(!el) return;
    const go = (ev)=>{
      ev.preventDefault?.();
      ev.stopPropagation?.();
      shiftMonth(delta);
      return false;
    };
    // iPad Safari: touchendが最優先
    el.addEventListener("touchend", go, {passive:false});
    el.addEventListener("pointerup", go);
    el.addEventListener("click", go);
  };
  wire(prev, -1);
  wire(next, +1);
}

window.addEventListener("load", ()=>{
  bindMonthNavButtons();
  normalizeSettings();
  ensureViewYM();
  normalizeStaff();
  startClock();
  hydrateSettingsUI();
  renderAll();

  // default date to today in current month, else 1st
  const today = new Date();
  const {y,m,daysInMonth} = getMonthInfo();
  let d = 1;
  if(today.getFullYear()===y && (today.getMonth()+1)===m){
    d = today.getDate();
  }
  document.getElementById("inpDate").value = dateKeyFromParts(y,m,d);

  startDateRolloverWatcher();

  // selectors
  fillStaffSelects();
syncInputFromEntry();
  renderDaily();
  renderCalendar();
  renderOverview();
  renderIndividual();
  initCharts();
  updateCharts();
});

/* =========================
   Clock
   ========================= */
function startClock(){
  const tick = ()=>{
    const now = new Date();
    const timeStr = now.toLocaleTimeString("ja-JP", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    const dateStr = now.toLocaleDateString("ja-JP", {year:"numeric", month:"2-digit", day:"2-digit", weekday:"short"});
    document.getElementById("nowTime").textContent = timeStr;
    document.getElementById("nowDate").textContent = dateStr;
  };
  tick();
  setInterval(tick, 1000);
}

function startDateRolloverWatcher(){
  let last = todayKeyLocal();
  setInterval(()=>{
    const nowKey = todayKeyLocal();
    if(nowKey===last) return;

    // date changed
    const prev = last;
    last = nowKey;

    // 入力日が「前の今日」だった場合のみ、自動で「新しい今日」へ
    const inp = document.getElementById("inpDate");
    if(inp && inp.value===prev){
      inp.value = nowKey;
      toast("日付を本日に更新しました");
    }

    // 月跨ぎの場合は、設定月も追従（表示が一致するように）
    const dt = getDateObj(nowKey);
    const ny = dt.getFullYear();
    const nm = dt.getMonth()+1;
    if(settings.year!==ny || settings.month!==nm){
      settings.year = ny;
      settings.month = nm;
      save(STORE.settings, settings);
      const fy = document.getElementById("setYear");
      const fm = document.getElementById("setMonth");
      if(fy) fy.value = String(ny);
      if(fm) fm.value = String(nm).padStart(2,"0");
      hydrateSettingsUI();
      renderCalendar();
      renderHeaderChips();
    }

    syncInputFromEntry();
    renderDaily();
    renderInputCalc();
  }, 20000);
}


/* =========================
   Tab
   ========================= */
function switchTab(tab){
  const tabs = ["input","calendar","overview","individual","settings"];
  for(const t of tabs){
    document.getElementById(`section-${t}`).classList.toggle("hidden", t!==tab);
    document.getElementById(`tab-${t}`).classList.toggle("active", t===tab);
  }
  if(tab==="calendar") renderCalendar();
  if(tab==="overview"){ renderOverview(); updateCharts(); }
  if(tab==="individual") renderIndividual();
  if(tab==="settings"){ hydrateSettingsUI(); renderStaffTable(); }
}

/* =========================
   Populate selects and header chips
   ========================= */
function fillStaffSelects(){
  // 個別一覧
  const selInd = document.getElementById("indStaff");
  const opts = staff.map(s => `<option value="${s.id}">${s.no}. ${escapeHtml(s.name)}</option>`).join("");
  if(selInd){ selInd.innerHTML = opts; }

  // 入力：端末ごとに最後に選んだ職員を保持
  const saved = localStorage.getItem(STORE.selfStaff);
  const initial = (saved && staff.some(s=>s.id===saved)) ? saved : (staff[0]?.id || "");
  setInputStaff(initial);
renderAvgControls();

  // イベント
  const inpDate = document.getElementById("inpDate");
  if(inpDate){
    inpDate.onchange = () => { syncInputFromEntry(); renderDaily(); };
  }
  document.getElementById("inpIn").oninput = renderInputCalc;
  document.getElementById("inpOut").oninput = renderInputCalc;
  document.getElementById("inpOtherOff").oninput = renderInputCalc;

  if(selInd){
    selInd.onchange = ()=> renderIndividual();
  }
}

function renderHeaderChips(){
  const {y,m,daysInMonth} = getMonthInfo();
  document.getElementById("chip-month").textContent = `${y}年${m}月`;
  document.getElementById("chip-month").classList.add("mono");
  // counts
  let work=0, off=0;
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    if(isOffday(key)) off++; else work++;
  }
  document.getElementById("chip-workday-count").textContent = `勤務日: ${work}`;
  document.getElementById("chip-holiday-count").textContent = `休み: ${off}`;

  document.getElementById("miniBreak").textContent = formatDurJP(Number(settings.breakMin ?? settings.breakWorkMin ?? 45));
}

function safeCall(fn){
  try{ fn(); }catch(e){ console.error(e); }
}

function renderAll(){
  // 月変更などで「どこか1箇所のエラーで全体が止まる」ことを防ぐ
  safeCall(renderHeaderChips);
  safeCall(renderCalendar);
  safeCall(syncInputFromEntry);
  safeCall(renderDaily);
  safeCall(renderOverview);
  safeCall(renderIndividual);
  safeCall(updateCharts);
}

/* =========================
   Input tab behavior
   ========================= */
// --- Input: staff "self" & fast picker ---
function getInpStaffId(){
  const hid = document.getElementById("inpStaffId");
  let v = hid?.value || "";
  if(!v && staff[0]?.id){
    v = staff[0].id;
    if(hid) hid.value = v;
    const nameEl = document.getElementById("inpStaffName");
    const s = staff.find(x=>x.id===v);
    if(nameEl) nameEl.textContent = s ? `${s.no}. ${s.name}` : "—";
  }
  return v;
}
function setInputStaff(staffId){
  const hid = document.getElementById("inpStaffId");
  if(!hid) return;
  if(!staffId) staffId = staff[0]?.id || "";
  hid.value = staffId;

  // remember last used staff on this device
  localStorage.setItem(STORE.selfStaff, staffId);

  const s = staff.find(x=>x.id===staffId);
  const nameEl = document.getElementById("inpStaffName");
  if(nameEl) nameEl.textContent = s ? `${s.no}. ${s.name}` : "—";

  syncInputFromEntry();
}


function openStaffPicker(){
  const body = `
    <div class="small">検索して選べます（この端末では最後に選んだ職員が自動で保持されます）。</div>
    <input id="staffPickQ" class="input mt-3" placeholder="氏名で検索（例：佐藤）" oninput="renderStaffPicker()" />
    <div id="staffPickList" class="mt-3 grid grid-cols-2 md:grid-cols-3 gap-2"></div>
  `;
  openModal("職員を選択", "入力する職員を選びます", body, [
    { label:"閉じる", className:"btn btn-ghost", onClick: closeModal },
  ]);
  setTimeout(()=>renderStaffPicker(), 0);
}

function renderStaffPicker(){
  const q = (document.getElementById("staffPickQ")?.value || "").trim();
  const list = document.getElementById("staffPickList");
  if(!list) return;

  const items = staff.filter(s=>{
    if(!q) return true;
    return (s.name||"").includes(q) || String(s.no||"").includes(q);
  });

  const current = getInpStaffId();
  list.innerHTML = items.map(s=>{
    const active = s.id===current;
    return `
      <button type="button" class="btn ${active ? "btn-primary" : "btn-ghost"} w-full text-left" onclick="pickStaff('${s.id}')">
        <div class="font-black truncate">${escapeHtml(s.name)}</div>
        <div class="small mono">No.${s.no} / ${escapeHtml(s.role||"")}</div>
      </button>
    `;
  }).join("");
}

function pickStaff(staffId){
  setInputStaff(staffId);
  closeModal();
}

// --- Fast actions ---
function quickStamp(type){
  if(type==="in") fillNow("in");
  if(type==="out") fillNow("out");
  saveEntry();
}

function nudgeTime(field, deltaMin){
  const id = field==="in" ? "inpIn" : (field==="out" ? "inpOut" : null);
  if(!id) return;
  const el = document.getElementById(id);
  const v = el.value;
  if(!v){
    fillNow(field);
    return;
  }
  const [hh,mm] = v.split(":").map(Number);
  let total = hh*60 + mm + deltaMin;
  total = (total%1440+1440)%1440;
  const nh = String(Math.floor(total/60)).padStart(2,"0");
  const nm = String(total%60).padStart(2,"0");
  el.value = `${nh}:${nm}`;
  renderInputCalc();
}

function stepDate(delta){
  const d = document.getElementById("inpDate").value;
  if(!d) return;
  const dt = getDateObj(d);
  dt.setDate(dt.getDate()+delta);
  // keep within current settings month; if out, clamp
  const {y,m,daysInMonth} = getMonthInfo();
  if(dt.getFullYear()!==y || (dt.getMonth()+1)!==m){
    // clamp
    const newD = Math.min(daysInMonth, Math.max(1, dt.getDate()));
    document.getElementById("inpDate").value = dateKeyFromParts(y,m,newD);
  }else{
    document.getElementById("inpDate").value = dateKeyFromParts(y,m,dt.getDate());
  }
  syncInputFromEntry();
  renderDaily();
}

function fillNow(which){
  const now = new Date();
  const t = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  if(which==="in") document.getElementById("inpIn").value = t;
  if(which==="out") document.getElementById("inpOut").value = t;
  renderInputCalc();
}

function clearField(which){
  if(which==="in") document.getElementById("inpIn").value = "";
  if(which==="out") document.getElementById("inpOut").value = "";
  if(which==="other") document.getElementById("inpOtherOff").value = "";
  renderInputCalc();
}

function syncInputFromEntry(){
  const staffId = getInpStaffId() || (staff[0]?.id);
  const dateKey = document.getElementById("inpDate").value;
  if(!staffId || !dateKey) return;

  const e = getEntry(dateKey, staffId);

  // keep hidden inputs in sync
  document.getElementById("inpIn").value = e.in || "";
  document.getElementById("inpOut").value = e.out || "";

  const otherEl = document.getElementById("inpOtherOff");
  if(otherEl) otherEl.value = e.otherOff || "";

  const off = isOffday(dateKey);
  const dobj = getDateObj(dateKey);
  const badge = off
    ? `<span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span>休み</span> <span class="small">${dobj.toLocaleDateString("ja-JP",{weekday:"short"})}</span>`
    : `<span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>勤務日</span> <span class="small">${dobj.toLocaleDateString("ja-JP",{weekday:"short"})}</span>`;
  document.getElementById("inpDayBadge").innerHTML = badge;

  renderInputCalc();
}

function renderInputCalc(){
  const dateKey = document.getElementById("inpDate").value;
  const staffId = getInpStaffId();
  if(!dateKey || !staffId) return;

  const s = staff.find(x=>x.id===staffId);
  const e = getEntry(dateKey, staffId);

  // Use current UI values for preview
  const inV  = document.getElementById("inpIn").value || "";
  const outV = document.getElementById("inpOut").value || "";
  const othV = (document.getElementById("inpOtherOff")?.value || "").trim();

  const backup = {...e};
  e.in = inV;
  e.out = outV;
  e.otherOff = othV;
  const c = calcFor(dateKey, staffId);
  Object.assign(e, backup);

  const off = isOffday(dateKey);

  const rowName = document.getElementById("rowName");
  const rowType = document.getElementById("rowType");
  const rowIn = document.getElementById("rowIn");
  const rowOut = document.getElementById("rowOut");
  const rowStayEq = document.getElementById("rowStayEq");
  const rowOther = document.getElementById("rowOther");
  const rowOver = document.getElementById("rowOver");
  const rowMonthOver = document.getElementById("rowMonthOver");

  if(rowName) rowName.textContent = s ? s.name : "—";
  if(rowType) rowType.textContent = off ? "休み" : "勤務日";
  if(rowIn) rowIn.textContent = inV ? inV : "--:--";
  if(rowOut) rowOut.textContent = outV ? outV : "--:--";
  if(rowOther){
    const m = parseDurationToMin(othV);
    rowOther.textContent = formatDurJP(m==null?0:m);
  }
  if(rowStayEq) rowStayEq.textContent = (c.stayEq==null) ? "--:--" : formatDurJP(c.stayEq);
  if(rowOver) rowOver.textContent = (c.over==null) ? "--:--" : formatDurJP(c.over);

  // 今月の累計（時間外）
  if(rowMonthOver){
    const sumObj = summaryByStaff(staffId);
    rowMonthOver.textContent = formatDurJP(sumObj.totalOver || 0);
  }

  // mini
  const br = document.getElementById("miniBreak");
  if(br) br.textContent = formatDurJP(Number(settings.breakMin ?? settings.breakWorkMin ?? 45));
}



function saveOtherOff(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate").value;
  if(!staffId || !dateKey) return;

  const val = (document.getElementById("inpOtherOff")?.value || "").trim();
  const e = getEntry(dateKey, staffId);

  if(!val){
    e.otherOff = "";
    save(STORE.records, records);
    renderInputCalc();
    renderDaily();
    renderOverview();
    renderIndividual();
    updateCharts();
    return;
  }

  const mm = parseDurationToMin(val);
  if(mm==null){
    toast("業務外の形式が不正です（例: 0:30 / 0.5）");
    document.getElementById("inpOtherOff").focus();
    return;
  }

  const hm = durMinToHM(mm);
  e.otherOff = hm;
  if(document.getElementById("inpOtherOff")) document.getElementById("inpOtherOff").value = hm;
  save(STORE.records, records);
  renderInputCalc();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}
function saveEntry(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId){ toast("職員を選択してください"); return; }
  if(!dateKey){ toast("日付を選択してください"); return; }

  const e = getEntry(dateKey, staffId);
  e.in = document.getElementById("inpIn")?.value || "";
  e.out = document.getElementById("inpOut")?.value || "";
  e.otherOff = document.getElementById("inpOtherOff")?.value || e.otherOff || "";

  save(STORE.records, records);
  toast("保存しました");
  syncInputFromEntry();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

function jumpToIndividual(){
  // set individual staff select to current staff
  const staffId = getInpStaffId();
  document.getElementById("indStaff").value = staffId;
  switchTab("individual");
}

/* =========================
   Daily table
   ========================= */
function renderDaily(){
  const dateKey = document.getElementById("inpDate").value;
  const tbody = document.getElementById("dailyBody");
  if(!dateKey){ tbody.innerHTML=""; return; }

  const off = isOffday(dateKey);
  const badge = off ? `<span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span>休み</span>`
                    : `<span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>勤務</span>`;

  tbody.innerHTML = staff.map(s=>{
    const c = calcFor(dateKey, s.id);
    const e = getEntry(dateKey, s.id);
    const stayEq = (c.stayEq==null) ? "—" : `<span class="mono">${formatDurJP(c.stayEq)}</span>`;
    const over = (c.over==null) ? "—" : `<span class="mono ${c.over>=45*60? "text-red-600 font-black": (c.over>0? "text-red-600 font-bold":"text-gray-700")}">${formatDurJP(c.over)}</span>`;

    const warn = (c.over==null) ? "" : ((c.over>=80*60) ? `<span class="chip"><span class="w-2 h-2 bg-red-600 rounded-full"></span>80+</span>` :
                                        (c.over>=45*60) ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>45+</span>` : "");

    return `
      <tr>
        <td class="p-3 text-sm font-bold">${escapeHtml(s.name)}</td>
        <td class="p-3 text-sm">${badge}</td>
        <td class="p-3 text-sm mono">${escapeHtml(e.in||"---")}</td>
        <td class="p-3 text-sm mono">${escapeHtml(e.out||"---")}</td>
        <td class="p-3 text-sm">${stayEq}</td>
        <td class="p-3 text-sm">${over}</td>
        <td class="p-3 text-sm">${warn}</td>
        <td class="p-3 text-sm no-print">
          <button class="btn btn-ghost px-3 py-1" onclick="quickPick('${s.id}')">入力</button>
        </td>
      </tr>
    `;
  }).join("");
}

function quickPick(staffId){
  switchTab("input");
  setInputStaff(staffId);
  window.scrollTo({top:0, behavior:"smooth"});
}

/* =========================
   Calendar
   ========================= */

function hardRepaint(){
  // iPad Safariで「DOMは変わっているのに描画しない」症状の最終対策
  const pk = document.getElementById("paintKick");
  if(pk){
    pk.classList.remove("kick-anim");
    void pk.offsetWidth;
    pk.classList.add("kick-anim");
  }

  // 1pxスクロールは描画を促進することがある（元に戻す）
  const x = window.scrollX, y = window.scrollY;
  window.scrollTo(x, y+1);
  window.scrollTo(x, y);

  // bodyを軽く触ってreflow
  document.body.style.webkitTransform = "translateZ(0)";
  document.body.getBoundingClientRect();
  requestAnimationFrame(()=>{ document.body.style.webkitTransform = ""; });
}

function forceRepaint(el){
  if(!el) return;
  // Safari/iPadで「状態は変わっているのに描画が遅れる」症状対策（強め）
  const prevDisplay = el.style.display;
  const prevTransform = el.style.transform;
  const prevWebkit = el.style.webkitTransform;

  // 1) transform + layout
  el.style.transform = "translateZ(0)";
  el.style.webkitTransform = "translateZ(0)";
  el.getBoundingClientRect();

  // 2) display toggle (micro) to force paint
  el.style.display = "none";
  void el.offsetHeight;
  el.style.display = prevDisplay || "";

  // 3) cleanup next frame
  requestAnimationFrame(()=>{
    el.style.transform = prevTransform || "";
    el.style.webkitTransform = prevWebkit || "";
  });
}

let _fullRefreshTimer = null;
let _monthShiftLock = false;
let _lastTouchToggle = 0;
function scheduleFullRefresh(){
  if(_fullRefreshTimer) clearTimeout(_fullRefreshTimer);
  _fullRefreshTimer = setTimeout(()=>{
    safeCall(renderHeaderChips);
    safeCall(renderDaily);
    safeCall(renderInputCalc);
    safeCall(renderOverview);
    safeCall(renderIndividual);
    safeCall(updateCharts);
  }, 80); // paint first, then refresh heavy parts
}

function shiftMonth(delta){
  if(_monthShiftLock) return;
  _monthShiftLock = true;
  try{
    let y = Number(settings.year);
    let mo = Number(settings.month);
    mo += delta;
    if(mo<=0){ mo=12; y--; }
    if(mo>=13){ mo=1; y++; }

    settings.year = y;
    settings.month = mo;
    save(STORE.settings, settings);

    // settingsフォーム反映
    const fy = document.getElementById("setYear");
    const fm = document.getElementById("setMonth");
    if(fy) fy.value = String(y);
    if(fm) fm.value = String(mo).padStart(2,"0");

    // ラベル更新（最優先）
    const lab = document.getElementById("calMonthLabel");
    if(lab) lab.textContent = `${y}年${String(mo).padStart(2,"0")}月`;

    // calGridノード差し替え（Safariで描画が止まる対策）
    const oldGrid = document.getElementById("calGrid");
    if(oldGrid && oldGrid.parentNode){
      const neoGrid = document.createElement("div");
      neoGrid.id = "calGrid";
      neoGrid.className = oldGrid.className;
      oldGrid.parentNode.replaceChild(neoGrid, oldGrid);
    }

    // 即描画（＋追い描画）
    safeCall(renderCalendar);
    forceRepaint(document.getElementById("calGrid"));

    requestAnimationFrame(()=>{
      safeCall(renderCalendar);
      forceRepaint(document.getElementById("calGrid"));
    });

    setTimeout(()=>{
      safeCall(renderCalendar);
      forceRepaint(document.getElementById("calGrid"));
      scheduleFullRefresh();
    }, 0);

  } finally {
    // lock解除は少し遅らせて二重実行防止
    setTimeout(()=>{ _monthShiftLock = false; }, 120);
  }
}
let calSel = {start:null, end:null}; // range selection
function renderCalendar(){
  const grid = document.getElementById("calGrid");
  const {y,m,daysInMonth,firstDow} = getMonthInfo();
  if(!grid) return;

  const lab = document.getElementById("calMonthLabel");
  if(lab) lab.textContent = `${y}年${String(m).padStart(2,"0")}月`;

  renderHeaderChips();

  const frag = document.createDocumentFragment();
  const shift = firstDow; // 0=Sun
  for(let i=0;i<shift;i++){
    const blank = document.createElement("div");
    blank.className = "h-24 md:h-28 rounded-2xl border border-dashed border-gray-200 bg-white/40";
    frag.appendChild(blank);
  }

  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const dobj = getDateObj(key);
    const off = isOffday(key);
    const dow = dobj.getDay();
    const isSat = dow===6, isSun = dow===0;
    const accent = off ? "bg-amber-50 border-amber-100" : "bg-emerald-50 border-emerald-100";
    const label = ["日","月","火","水","木","金","土"][dow];
    const sub = off ? "休" : "勤";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = `h-24 md:h-28 text-left rounded-2xl border ${accent} p-3 hover:brightness-[0.99] transition`;
    btn.title = "タップで勤務/休みを切替";

    // touchstart (Safari)
    btn.addEventListener("touchstart", (ev)=>{
      _lastTouchToggle = Date.now();
      ev.preventDefault();
      toggleOffday(key);
    }, {passive:false});

    // click (desktop / windows)
    btn.addEventListener("click", ()=>{
      // touch直後のクリック二重発火防止
      if(Date.now() - _lastTouchToggle < 450) return;
      toggleOffday(key);
    });

    btn.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div>
          <div class="font-black text-lg leading-none">${d}</div>
          <div class="small mt-1">${label}</div>
        </div>
        <div class="flex items-center gap-2">
          <span class="chip ${off? "border-amber-200":"border-emerald-200"}">${sub}</span>
        </div>
      </div>
      <div class="mt-3 small">
        <span class="${isSat? "text-blue-600 font-bold": isSun? "text-red-600 font-bold":"text-gray-500"}">${isSat?"土":isSun?"日":" "}</span>
        <span class="ml-1">${off? "時間外扱い":"勤務日扱い"}</span>
      </div>
    `;
    frag.appendChild(btn);
  }

  grid.replaceChildren(frag);
}

let calDragging = false;
function calMouseDown(key){
  calDragging = true;
  calSel.start = key;
  calSel.end = key;
  renderCalendar();
}
function calMouseEnter(key){
  if(!calDragging) return;
  calSel.end = key;
  renderCalendar();
}
function calMouseUp(){
  calDragging = false;
}
function inRange(key, a, b){
  const x = new Date(key).getTime();
  const t1 = new Date(a).getTime();
  const t2 = new Date(b).getTime();
  const lo = Math.min(t1,t2), hi=Math.max(t1,t2);
  return x>=lo && x<=hi;
}
function bulkSetWorkday(){
  if(!calSel.start || !calSel.end){ toast("範囲選択してください（ドラッグ）"); return; }
  applyRangeOff(false);
}
function bulkSetOffday(){
  if(!calSel.start || !calSel.end){ toast("範囲選択してください（ドラッグ）"); return; }
  applyRangeOff(true);
}
function applyRangeOff(off){
  const {y,m,daysInMonth} = getMonthInfo();
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    if(inRange(key, calSel.start, calSel.end)){
      setOffday(key, off);
    }
  }
  toast(`範囲を「${off?"休み":"勤務日"}」にしました`);
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

function toggleOffday(dateKey){
  const nowOff = isOffday(dateKey);
  setOffday(dateKey, !nowOff);
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

function resetWeekendDefaults(){
  const {y,m,daysInMonth} = getMonthInfo();
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const dobj = getDateObj(key);
    if(isWeekend(dobj)){
      calendar[key] = {off:true};
    }else{
      // keep manual entries only for weekdays; if it was weekend override to workday, now reset to off
      if(calendar[key] && calendar[key].off===true && !defaultOff(key)){
        // do nothing
      }
    }
  }
  save(STORE.calendar, calendar);
  toast("土日を休みに戻しました");
  renderCalendar();
  renderOverview();
  updateCharts();
}

function openHolidayPaste(){
  openModal("祝日を貼り付け", "1行1日付（YYYY-MM-DD）で貼り付け → 休みとして扱います。", `
    <textarea id="holidayText" class="input min-h-[160px] mono" placeholder="例:\n2026-02-11\n2026-02-23"></textarea>
    <div class="small mt-2">※土日以外の祝日も「休み」として自動反映できます。</div>
  `, [
    {label:"反映", className:"btn btn-primary", onClick:()=>{
      const raw = document.getElementById("holidayText").value || "";
      const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const ok = [];
      for(const line of lines){
        if(/^\d{4}-\d{2}-\d{2}$/.test(line)) ok.push(line);
      }
      settings.holidayDates = Array.from(new Set([...(settings.holidayDates||[]), ...ok])).sort();
      save(STORE.settings, settings);
      closeModal();
      toast(`祝日 ${ok.length} 件を追加`);
      renderCalendar();
      renderOverview();
      updateCharts();
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal},
  ]);
}

/* =========================
   Overview
   ========================= */
function renderOverview(){
  const q = (document.getElementById("ovSearch")?.value || "").trim();
  const tbody = document.getElementById("overviewBody");
  if(!tbody) return;

  const base = staff.filter(s => !q || s.name.includes(q));

  const only = window.__ovFilterIds;
  const list = (Array.isArray(only) && only.length)
    ? base.filter(s=>only.includes(s.id))
    : base;

  const vm = getViewYM();

  const rows = list.map(s=>{
    const sum = summaryByStaff(s.id, vm.y, vm.m);
    const warn = sum.over80 ? `<span class="chip"><span class="w-2 h-2 bg-red-600 rounded-full"></span>80+</span>`
               : sum.over45 ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>45+</span>`
               : "";
    const badge = sum.offHas ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>週休日等あり</span>` : "";

    return `
      <tr class="hover:bg-slate-50">
        <td class="p-3 text-sm border-b font-bold">${escapeHtml(s.name)} ${warn} ${badge}</td>
        <td class="p-3 text-sm border-b">${escapeHtml(s.role||"")}</td>
        <td class="p-3 text-sm border-b mono">${sum.avgWorkIn==null? "--:--": formatClock(sum.avgWorkIn)}</td>
        <td class="p-3 text-sm border-b mono">${sum.avgWorkOut==null? "--:--": formatClock(sum.avgWorkOut)}</td>
        <td class="p-3 text-sm border-b mono">${sum.avgWorkStayEq==null? "--:--": formatDurJP(sum.avgWorkStayEq)}</td>
        <td class="p-3 text-sm border-b mono">${sum.avgOffIn==null? "--:--": formatClock(sum.avgOffIn)}</td>
        <td class="p-3 text-sm border-b mono">${sum.avgOffOut==null? "--:--": formatClock(sum.avgOffOut)}</td>
        <td class="p-3 text-sm border-b mono">${sum.avgOffStayEq==null? "--:--": formatDurJP(sum.avgOffStayEq)}</td>
        <td class="p-3 text-sm border-b mono font-black">${formatDurJP(sum.totalOver || 0)}</td>
        <td class="p-3 text-sm border-b">
          <span class="chip mono">${formatDurJP(sum.totalWeekendWork || 0)}</span>
        </td>
        <td class="p-3 text-sm border-b no-print">
          <button class="btn btn-ghost px-3" onclick="goToIndividual('${s.id}')">個別へ</button>
        </td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = rows;

  renderAvgBox();
}



function goToIndividual(staffId){
  const sel = document.getElementById("indStaff");
  if(sel) sel.value = staffId;
  switchTab("individual");
  safeCall(renderIndividual);
}

// --- Average selection (checks + patterns) ---
function getSelectedAvgStaffIds(){
  const wrap = document.getElementById("avgStaffChecks");
  if(!wrap) return staff.map(s=>s.id);
  const checked = Array.from(wrap.querySelectorAll('input[type="checkbox"][data-staff-id]'))
    .filter(ch=>ch.checked)
    .map(ch=>ch.getAttribute("data-staff-id"));
  return checked.length ? checked : [];
}
function toggleAllAvg(flag){
  const wrap = document.getElementById("avgStaffChecks");
  if(!wrap) return;
  wrap.querySelectorAll('input[type="checkbox"][data-staff-id]').forEach(ch=> ch.checked = !!flag);
  persistAvgSelection();
  renderAvgBox();
}
function persistAvgSelection(){
  const ids = getSelectedAvgStaffIds();
  localStorage.setItem(KEY_AVG_SELECTED, JSON.stringify(ids));
}
function loadAvgSelection(){
  try{
    const ids = JSON.parse(localStorage.getItem(KEY_AVG_SELECTED) || "null");
    if(Array.isArray(ids)) return ids;
  }catch(e){}
  return null;
}
function normalizeRoleTag(role){
  const r = (role||"");
  if(r.includes("校長")) return "principal";
  if(r.includes("教頭") || r.includes("副校長")) return "vice";
  if(r.includes("事務")) return "office";
  return "others";
}
function renderAvgControls(){
  const wrap = document.getElementById("avgStaffChecks");
  if(!wrap) return;

  // 初期値：保存がない場合は「全員」をデフォルトにする
  let sel = loadAvgSelection();
  if(!Array.isArray(sel)){
    sel = staff.map(s=>s.id);
    localStorage.setItem(KEY_AVG_SELECTED, JSON.stringify(sel));
  }

  const chips = staff.map(s=>{
    const checked = sel.includes(s.id) ? "checked" : "";
    return `
      <label class="chip">
        <input type="checkbox" class="sr-only" data-staff-id="${s.id}" ${checked} onchange="persistAvgSelection(); renderAvgBox(); renderOverview();" />
        <span class="dot"></span>
        <span class="mono">${escapeHtml(s.name||"")}</span>
        <span class="small ml-2 text-slate-500">${escapeHtml(s.role||"")}</span>
      </label>
    `;
  }).join("");

  wrap.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <button class="btn btn-ghost" onclick="toggleAllAvg(true)">全員</button>
      <button class="btn btn-ghost" onclick="toggleAllAvg(false)">解除</button>
      <div class="small text-slate-500">※チェックした職員の平均を表示します（印刷も同じ対象）。</div>
    </div>
    <div class="flex flex-wrap gap-2">${chips}</div>
  `;
}
function renderAvgBox(){
  const ids = getSelectedAvgStaffIds();
  const sums = ids.map(id=>summaryByStaff(id));

  const avg = (vals)=>{
    const xs = vals.filter(v=>v!=null && !isNaN(v));
    if(!xs.length) return null;
    return xs.reduce((a,b)=>a+b,0)/xs.length;
  };
  const avgTime = (vals)=> avg(vals.map(v=>v==null? null : v));
  const avgDur  = (vals)=> avg(vals.map(v=>v==null? null : v));

  const workIn  = avgTime(sums.map(s=>s.avgWorkIn));
  const workOut = avgTime(sums.map(s=>s.avgWorkOut));
  const workStayEq = avgDur(sums.map(s=>s.avgWorkStayEq));
  const monthOver  = avgDur(sums.map(s=>s.totalOver));

  document.getElementById("avgWorkIn").textContent = (workIn==null? "--:--": formatClock(workIn));
  document.getElementById("avgWorkOut").textContent = (workOut==null? "--:--": formatClock(workOut));
  document.getElementById("avgWorkStayEq").textContent = (workStayEq==null? "--:--": formatDurJP(workStayEq));
  document.getElementById("avgMonthOver").textContent = (monthOver==null? "--:--": formatDurJP(monthOver));

  updateCharts();
}

/* =========================
   Individual
   ========================= */
function renderIndividual(){
  const staffId = document.getElementById("indStaff")?.value || staff[0]?.id;
  const tbody = document.getElementById("indBody");
  const vm = getViewYM();
  const sum = summaryByStaff(staffId, vm.y, vm.m);
  const sumEl = document.getElementById('indSummary');
  if(!tbody || !staffId) return;

  const days = monthAggByStaff(staffId, vm.y, vm.m);
  if(sumEl){
    sumEl.innerHTML = `
      <div class="flex flex-wrap gap-2">
        <span class="pill">当月 時間外(合計)：<b class="mono">${formatDurJP(sum.totalOver||0)}</b></span>
        <span class="pill">当月 業務外(合計)：<b class="mono">${formatDurJP(sum.totalOtherOff||0)}</b></span>
        <span class="pill">週休日等(合計)：<b class="mono">${formatDurJP(sum.totalOffStayEq||0)}</b></span>
      </div>
    `;
  }
  tbody.innerHTML = days.map(x=>{
    const kind = x.off ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>休み</span>`
                       : `<span class="chip"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span>勤務</span>`;
    const inStr = x.ent.in ? `<span class="mono">${escapeHtml(x.ent.in)}</span>` : "—";
    const outStr= x.ent.out? `<span class="mono">${escapeHtml(x.ent.out)}</span>` : "—";

    const stayEq = x.stayEq==null? "—" : `<span class="mono">${formatDurJP(x.stayEq)}</span>`;
    const over   = x.over==null? "—" : `<span class="mono font-black ${x.over>=45*60? "text-red-600": (x.over>0? "text-red-600":"text-gray-700")}">${formatDurJP(x.over)}</span>`;
    const hasOtherOff = (x.ent.otherOff!=null && String(x.ent.otherOff).trim()!=="");
    const otherOff = hasOtherOff ? `<span class="mono">${formatDurJP(x.otherOffMin||0)}</span>` : "—";

    return `
      <tr>
        <td class="p-3 text-sm">
          <div class="font-bold">${x.day}日（${x.dow}）</div>
          <div class="small mono">${x.dateKey}</div>
        </td>
        <td class="p-3 text-sm">${kind}</td>
        <td class="p-3 text-sm">${inStr}</td>
        <td class="p-3 text-sm">${outStr}</td>
        <td class="p-3 text-sm">${stayEq}</td>
        <td class="p-3 text-sm">${otherOff}</td>
        <td class="p-3 text-sm">${over}</td>
        <td class="p-3 text-sm no-print">
          <button class="btn btn-ghost px-3 py-1" onclick="jumpInput('${staffId}','${x.dateKey}')">入力</button>
          <button class="btn btn-ghost px-3 py-1" onclick="editOtherOff('${staffId}','${x.dateKey}')">業務外</button>
        </td>
      </tr>
    `;
  }).join("");
}

function jumpInput(staffId, dateKey){
  switchTab("input");
  setInputStaff(staffId);
  document.getElementById("inpDate").value = dateKey;
  syncInputFromEntry();
  window.scrollTo({top:0, behavior:"smooth"});
}

function editOtherOff(staffId, dateKey){
  const e = getEntry(dateKey, staffId);
  const c = calcFor(dateKey, staffId);
  openModal("業務外（除く時間）を編集", `${dateKey} / ${staff.find(s=>s.id===staffId)?.name||""}`, `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <div class="text-sm font-bold mb-1">その他業務外（除く時間）</div>
        <input id="editOtherOff" class="input mono" placeholder="例: 0:30（空欄=0）" value="${escapeAttr(e.otherOff||"")}" />
        <div class="small mt-1">在校等時間 = 在校時間 − 休憩 − その他業務外</div>
      </div>
      <div>
        <div class="text-sm font-bold mb-1">主な理由（番号）</div>
        <input id="editReason" class="input mono" placeholder="例: 1" value="${escapeAttr((e.reason||e.reasonCode)||"")}" />
        <div class="small mt-1">※Excelの「主な業務外の時間」コードを保持（必要な学校だけ使う想定）</div>
      </div>
    </div>
    <div class="mt-4 card p-4">
      <div class="small">現状の計算</div>
      <div class="mt-2 flex flex-wrap gap-2">
        <span class="chip">在校時間: <b class="mono">${c.stayRaw==null?"--:--":formatDurJP(c.stayRaw)}</b></span>
        <span class="chip">休憩: <b class="mono">${formatDurJP(c.breakMin)}</b></span>
        <span class="chip">在校等: <b class="mono">${c.stayEq==null?"--:--":formatDurJP(c.stayEq)}</b></span>
        <span class="chip">時間外: <b class="mono">${c.over==null?"--:--":formatDurJP(c.over)}</b></span>
      </div>
    </div>
  `, [
    {label:"保存", className:"btn btn-primary", onClick:()=>{
      const v = document.getElementById("editOtherOff").value.trim();
      if(v){
        const mm = parseDurationToMin(v);
        if(mm==null){ toast("業務外の形式が不正です（例: 0:30）"); return; }
        e.otherOff = formatDurJP(mm);
      }else{
        e.otherOff = "";
      }
      const rc = document.getElementById("editReason").value.trim();
      e.reason = rc ? rc : "";
      e.reasonCode = e.reason;

      save(STORE.records, records);
      closeModal();
      toast("保存しました");
      renderIndividual();
      renderDaily();
      renderOverview();
      updateCharts();
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal},
  ]);
}

function openIndEditHelp(){
  openModal("業務外（除く時間）について", "入力タブはスッキリさせるため、除く時間の編集はここで行います。", `
    <div class="space-y-3 text-sm">
      <p>Excel原本では、<b>在校等時間</b>を次の式で計算しています。</p>
      <div class="card p-4 mono">
        在校等時間 = 在校時間 − 休憩時間 − その他業務外の時間
      </div>
      <p>このアプリでも同じ計算をします。日によって「会議待機」「外部業務」など、<b>業務外として除きたい時間</b>がある場合だけ、個別一覧の「業務外」ボタンから入力してください（空欄は 0 扱い）。</p>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick:closeModal}]);
}

/* =========================
   Charts
   ========================= */
function initCharts(){
  const ctx1 = document.getElementById("chartMonthOver")?.getContext("2d");
  const ctx2 = document.getElementById("chartDailyTotal")?.getContext("2d");
  if(ctx1){
    charts.monthOver = new Chart(ctx1, {
      type: "bar",
      data: { labels: [], datasets: [{ label: "当月 時間外（合計）", data: [] }] },
      options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{ticks:{callback:(v)=>minutesToHourLabel(v)}}} }
    });
  }
  if(ctx2){
    charts.dailyTotal = new Chart(ctx2, {
      type: "line",
      data: { labels: [], datasets: [{ label: "日別 合計時間外", data: [], tension: 0.25 }] },
      options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{ticks:{callback:(v)=>minutesToHourLabel(v)}}} }
    });
  }
}
function minutesToHourLabel(min){
  if(min==null) return "";
  return formatDurJP(min);
}
function updateCharts(){
  // Month over by staff (selected)
  if(charts.monthOver){
    const ids = getSelectedAvgStaffIds();
    const labelNames = [];
    const data = [];
    ids.forEach(id=>{
      const s = staff.find(x=>x.id===id);
      if(!s) return;
      const sum = summaryByStaff(id);
      labelNames.push(s.name);
      data.push(sum.totalOver || 0);
    });
    charts.monthOver.data.labels = labelNames;
    charts.monthOver.data.datasets[0].data = data;
    charts.monthOver.update();
  }
  // Daily total over all staff
  if(charts.dailyTotal){
    const {labels, totals} = dailyTotalOver();
    charts.dailyTotal.data.labels = labels;
    charts.dailyTotal.data.datasets[0].data = totals;
    charts.dailyTotal.update();
  }
}

/* =========================
   Settings UI
   ========================= */
function hydrateSettingsUI(){
  const y = document.getElementById("setYear");
  const m = document.getElementById("setMonth");
  const s = document.getElementById("setStdMin");
  const b = document.getElementById("setBreakMin");

  if(y) y.value = settings.year;
  if(m) m.value = String(settings.month).padStart(2,"0");
  if(s) s.value = Number(settings.stdMin ?? settings.standardWorkMin ?? (7*60+45));
  if(b) b.value = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);

  
  const g = document.getElementById("setGoalOverH");
  if(g) g.value = Number(settings.goalOverH ?? 45);
renderStaffTable();
  fillStaffSelects();
  fillReasonEditor();
renderHeaderChips();
}

function applySettings(){
  const y = Number(document.getElementById("setYear").value);
  const m = Number(document.getElementById("setMonth").value);
  const std = Number(document.getElementById("setStdMin").value);
  const b = Number(document.getElementById("setBreakMin").value);

  if(!(y>=2000 && y<=2100)){ toast("年が不正です"); return; }
  if(!(m>=1 && m<=12)){ toast("月が不正です"); return; }

  settings.year = y;
  settings.month = m;
  settings.stdMin = Math.max(0, std);
  settings.standardWorkMin = settings.stdMin;

  settings.breakMin = Math.max(0, b);
  settings.breakWorkMin = settings.breakMin; // compat
  settings.breakOffMin = 0;

  save(STORE.settings, settings);

  // update date picker to keep in month
  const {daysInMonth} = getMonthInfo();
  const cur = document.getElementById("inpDate")?.value;
  if(cur){
    const dt = getDateObj(cur);
    const newKey = dateKeyFromParts(y,m, Math.min(dt.getDate(), daysInMonth));
    document.getElementById("inpDate").value = newKey;
  }else{
    document.getElementById("inpDate").value = dateKeyFromParts(y,m,1);
  }

  renderAll();
  renderCalendar();
  renderOverview();
  renderIndividual();
  updateCharts();
  toast("設定を保存しました");
}

function addStaff(){
  const name = (document.getElementById("newStaffName").value||"").trim();
  const role = (document.getElementById("newStaffRole").value||"").trim();
  if(!name){ toast("氏名を入力してください"); return; }
  const id = uid();
  staff.push({ id, no: staff.length+1, name, role });
  document.getElementById("newStaffName").value = "";
  document.getElementById("newStaffRole").value = "";
  save(STORE.staff, staff);
  renderStaffTable();
  fillStaffSelects();
  renderIndividual();
  renderOverview();
  toast("追加しました");
}

function removeStaff(staffId){
  const s = staff.find(x=>x.id===staffId);
  if(!s) return;
  if(!confirm(`${s.name} を削除しますか？（記録は残ります）`)) return;
  staff = staff.filter(x=>x.id!==staffId);
  save(STORE.staff, staff);
  toast("削除しました");
  fillStaffSelects();
  renderStaffTable();
  renderOverview();
  updateCharts();
}

function openStaffEdit(id){
  const s = staff.find(x=>x.id===id);
  if(!s) return;
  openModal("職員の編集", "氏名・職名を編集します", `
    <div class="grid gap-3">
      <div>
        <div class="small font-bold text-slate-600 mb-1">氏名</div>
        <input id="editStaffName" class="input" value="${escapeAttr(s.name||"")}" />
      </div>
      <div>
        <div class="small font-bold text-slate-600 mb-1">職名</div>
        <input id="editStaffRole" class="input" value="${escapeAttr(s.role||"")}" />
      </div>
    </div>
  `,[
    {label:"キャンセル", className:"btn btn-ghost", onClick: closeModal},
    {label:"保存", className:"btn btn-primary", onClick: ()=>saveStaffEdit(id)},
  ]);
}

function saveStaffEdit(id){
  const s = staff.find(x=>x.id===id);
  if(!s) return;
  const name = (document.getElementById("editStaffName").value||"").trim();
  const role = (document.getElementById("editStaffRole").value||"").trim();
  if(!name){ toast("氏名を入力してください"); return; }
  s.name = name;
  s.role = role;
  save(STORE.staff, staff);
  closeModal();
  renderStaffTable();
  fillStaffSelects();
  renderIndividual();
  renderOverview();
  toast("保存しました");
}

function sortStaff(){
  staff.sort((a,b)=> (a.no||0)-(b.no||0));
  // reassign No sequentially
  staff.forEach((s,i)=>s.no=i+1);
  save(STORE.staff, staff);
  toast("並び替えしました");
  fillStaffSelects();
  renderStaffTable();
  renderOverview();
}

function renderStaffTable(){
  const tbody = document.getElementById("staffBody");
  if(!tbody) return;
  tbody.innerHTML = staff.map((s,idx)=>`
    <tr>
      <td class="p-3 text-sm mono">${idx+1}</td>
      <td class="p-3 text-sm font-bold">${escapeHtml(s.name||"")}</td>
      <td class="p-3 text-sm">${escapeHtml(s.role||"")}</td>
      <td class="p-3 text-sm no-print whitespace-nowrap">
        <button class="btn btn-ghost px-3 py-1" onclick="openStaffEdit('${s.id}')">編集</button>
        <button class="btn btn-ghost px-3 py-1" onclick="removeStaff('${s.id}')">削除</button>
      </td>
    </tr>
  `).join("");
}

/* =========================
   Export (Excel)
   ========================= */
function exportMonthExcel(){
  const {y,m,daysInMonth} = getViewMonthInfo();

  // Sheet 1: 月別 全体一覧
  const sheet1 = [["氏名","区分","平日 出勤(平均)","平日 退勤(平均)","平日 在校等(平均)","休み 出勤(平均)","休み 退勤(平均)","休み 在校等(平均)","週休日等(合計)","当月 時間外(合計)","45h超","80h超"]];
  staff.forEach(s=>{
    const sum = summaryByStaff(s.id, y, m);
    sheet1.push([
      s.name, s.role||"",
      sum.avgWorkIn==null? "": formatClock(sum.avgWorkIn),
      sum.avgWorkOut==null? "": formatClock(sum.avgWorkOut),
      sum.avgWorkStayEq==null? "": formatDurJP(sum.avgWorkStayEq),
      sum.avgOffIn==null? "": formatClock(sum.avgOffIn),
      sum.avgOffOut==null? "": formatClock(sum.avgOffOut),
      sum.avgOffStayEq==null? "": formatDurJP(sum.avgOffStayEq),
      formatDurJP(sum.totalOffStayEq),
      formatDurJP(sum.totalOver),
      sum.over45? "○": "",
      sum.over80? "○": ""
    ]);
  });

  // Sheet 2: 月別 個別（全職員・日別）
  const sheet2 = [["日付","曜","勤務/休み","氏名","出勤","退勤","在校時間","休憩","業務外(除く)","在校等時間","時間外在校等時間"]];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const off = isOffday(key);
    const dow = dowLabel(getDateObj(key));
    for(const s of staff){
      const e = getEntry(key, s.id);
      const c = calcFor(key, s.id);
      if(!(e.in||e.out||e.otherOff)) continue;
      sheet2.push([
        key, dow, off?"休み":"勤務",
        s.name,
        e.in||"", e.out||"",
        c.stayRaw==null? "": formatDurJP(c.stayRaw),
        formatDurJP(c.breakMin),
        e.otherOff||"",
        c.stayEq==null? "": formatDurJP(c.stayEq),
        c.over==null? "": formatDurJP(c.over),
      ]);
    }
  }

  // Sheet 3: カレンダー
  const sheet3 = [["日付","曜","休み(1)/勤務(0)"]];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    sheet3.push([key, dowLabel(getDateObj(key)), isOffday(key)?1:0]);
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet1), "月別_全体一覧");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet2), "月別_日別一覧");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet3), "カレンダー");

  const fname = `在校等時間_${y}-${pad2(m)}.xlsx`;
  XLSX.writeFile(wb, fname);
}

function printOverview(mode){
  // mode: "all" | "selected"
  const prevFilter = window.__ovFilterIds;
  const search = document.getElementById("ovSearch");
  const prevQ = search ? search.value : "";
  try{
    if(mode==="selected"){
      const ids = getSelectedAvgStaffIds();
      if(!ids.length){ toast("チェックした職員がありません（平均のチェックを入れてください）"); return; }
      window.__ovFilterIds = ids;
    }else{
      window.__ovFilterIds = null;
    }
    if(search) search.value = "";
    renderOverview();
    window.print();
  } finally {
    window.__ovFilterIds = prevFilter || null;
    if(search) search.value = prevQ;
    renderOverview();
  }
}



function fiscalYearFrom(y,m){
  // 4月開始
  return (m>=4) ? y : (y-1);
}

function monthSummaryForStaffYM(staffId, y, m){
  const days = new Date(y, m, 0).getDate();
  let overMin = 0;
  let stayEqMin = 0;
  let stayRawMin = 0;
  let otherOffMin = 0;
  let has = false;
  for(let d=1; d<=days; d++){
    const key = dateKeyFromParts(y,m,d);
    const ent = getEntry(key, staffId);
    if(!(ent.in || ent.out || ent.otherOff)) continue;
    const c = calcFor(key, staffId);
    has = true;
    if(c.over!=null) overMin += c.over;
    if(c.stayEq!=null) stayEqMin += c.stayEq;
    if(c.stayRaw!=null) stayRawMin += c.stayRaw;
    otherOffMin += (c.otherOffMin||0);
  }
  return {has, overMin, stayEqMin, stayRawMin, otherOffMin};
}

function makeBarChartImage(labels, data, title, goalValue, highlightIndex){
  try{
    const c = document.createElement("canvas");
    c.width = 900;
    c.height = 360;
    const ctx = c.getContext("2d");

    // goal line dataset (optional)
    const ds = [{
      label: title || "時間外(時間)",
      data,
    }];

    if(goalValue && goalValue>0){
      ds.push({
        label: "目標",
        data: labels.map(()=>goalValue),
        type: "line",
        borderDash: [6,4],
        pointRadius: 0,
        tension: 0,
      });
    }

    const chart = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: ds },
      options: {
        responsive: false,
        animation: false,
        plugins: { legend: { display: !!(goalValue && goalValue>0) }, title: { display: !!title, text: title } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // highlight current month bar by drawing overlay (no color change)
    chart.update();
    if(Number.isInteger(highlightIndex) && highlightIndex>=0 && highlightIndex<labels.length){
      const meta = chart.getDatasetMeta(0);
      const el = meta.data[highlightIndex];
      if(el){
        const {x, y, base, width} = el.getProps(['x','y','base','width'], true);
        ctx.save();
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = "#111827";
        ctx.fillRect(x - width/2, y, width, base - y);
        ctx.restore();
      }
    }

    const url = c.toDataURL("image/png");
    chart.destroy();
    return url;
  }catch(e){
    return null;
  }
}

function makeLineChartImage(labels, data, title){
  const c = document.createElement("canvas");
  c.width = 900; c.height = 360;
  const ctx = c.getContext("2d");
  // minimal line chart drawing
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle = "#111827";
  ctx.font = "bold 20px system-ui,-apple-system,'Noto Sans JP',sans-serif";
  ctx.fillText(title || "", 24, 34);

  const padL = 60, padR = 24, padT = 56, padB = 48;
  const W = c.width - padL - padR;
  const H = c.height - padT - padB;

  const maxV = Math.max(1e-6, ...data.map(v=>Number(v)||0));
  const minV = 0;

  // axes
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, padT+H);
  ctx.lineTo(padL+W, padT+H);
  ctx.stroke();

  const n = Math.max(1, data.length);
  const step = (n<=1) ? 0 : (W/(n-1));

  // line
  ctx.strokeStyle = "#2563eb";
  ctx.lineWidth = 3;
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const v = Number(data[i])||0;
    const x = padL + step*i;
    const y = padT + H - ((v-minV)/(maxV-minV))*H;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // dots
  ctx.fillStyle = "#2563eb";
  for(let i=0;i<n;i++){
    const v = Number(data[i])||0;
    const x = padL + step*i;
    const y = padT + H - ((v-minV)/(maxV-minV))*H;
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  }

  // x labels (sparse)
  ctx.fillStyle = "#64748b";
  ctx.font = "12px system-ui,-apple-system,'Noto Sans JP',sans-serif";
  const every = Math.ceil(n/12);
  for(let i=0;i<n;i+=every){
    const x = padL + step*i;
    const lab = labels[i] ?? "";
    ctx.fillText(String(lab), x-6, padT+H+22);
  }

  // y label max
  ctx.fillText(String(maxV.toFixed(1)), 10, padT+6);
  ctx.fillText("0.0", 20, padT+H+4);

  return c.toDataURL("image/png");
}



function updatePrintOverlayStatus(title, sub){
  const frame = document.getElementById("printFrame");
  if(!frame) return;
  const t = escapeHtml(title || "処理中…");
  const s = escapeHtml(sub || "");
  frame.srcdoc = `<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>${t}</title></head>
    <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
      <div style="font-weight:900;font-size:18px;margin-bottom:8px;">${t}</div>
      <div style="color:#64748b;white-space:pre-wrap;">${s}</div>
    </body></html>`;
}

function setPrintOverlayMsg(html){
  const box = document.getElementById("printOverlayMsg");
  if(!box) return;
  if(html){
    box.style.display = "block";
    box.innerHTML = html;
  }else{
    box.style.display = "none";
    box.innerHTML = "";
  }
}

function openPrintOverlay(htmlDoc, autoPrint=true){
  const ov = document.getElementById("printOverlay");
  const frame = document.getElementById("printFrame");
  if(!ov || !frame){ alert("印刷ビューの準備に失敗しました"); return; }

  ov.classList.remove("hidden");
  ov.classList.add("show");
  ov.style.display = "block";

  // message area reset
  setPrintOverlayMsg("");

  // Safari対策：document.write で確実に描画（srcdocは補助）
  const writeToFrame = () => {
    try{
      const d = frame.contentWindow.document;
      d.open(); d.write(htmlDoc); d.close();
      return true;
    }catch(e){
      return false;
    }
  };

  // 一度クリアしてから書き込み
  try{
    const d = frame.contentWindow.document;
    d.open(); d.write("<!doctype html><html><head><meta charset='utf-8'/></head><body></body></html>"); d.close();
  }catch(e){}

  setTimeout(()=>{
    // まず write
    const ok = writeToFrame();

    // srcdoc も試す（対応ブラウザ向け）
    try{ frame.srcdoc = htmlDoc; }catch(e){}

    if(autoPrint){
      // 次のtickで印刷
      setTimeout(()=>{
        try{ frame.contentWindow.focus(); frame.contentWindow.print(); }catch(e){}
      }, 0);
    }

    if(!ok){
      setPrintOverlayMsg("プレビューの描画に失敗しました。Safariの設定や拡張機能の影響がある可能性があります。");
    }
  }, 0);
}

function closePrintOverlay(){
  const ov = document.getElementById("printOverlay");
  const frame = document.getElementById("printFrame");
  setPrintOverlayMsg("");
  if(frame){
    try{
      const d = frame.contentWindow.document;
      d.open(); d.write("<!doctype html><html><head><meta charset='utf-8'/></head><body></body></html>"); d.close();
    }catch(e){}
    frame.onload=null; frame.srcdoc="";
  }
  if(ov){ ov.classList.remove("show"); ov.classList.add("hidden"); ov.style.display="none"; }
}

function printOverlayPrint(){
  const frame = document.getElementById("printFrame");
  if(!frame){ window.print(); return; }
  try{ frame.contentWindow.focus(); frame.contentWindow.print(); }catch(e){ window.print(); }
}

function printIndividual(){
  try{ toast("個別レポートを準備中…"); }catch(e){}

  // 先にプレビューを表示（Safari対策）
  openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>生成中…</title></head>
    <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
      <div style="font-weight:900;font-size:18px;margin-bottom:8px;">個別レポートを生成しています…</div>
      <div style="color:#64748b;">（Safari対策）この後「確認中…」→「集計中…」へ進みます。</div>
    </body></html>`, false);

  setTimeout(() => {
    try{
      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>確認中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">確認中…</div>
          <div style="color:#64748b;">職員選択とデータを確認しています。</div>
        </body></html>`, false);

      const sel = document.getElementById("indStaff");
      const staffId = (sel && sel.value) ? sel.value : ((Array.isArray(staff) && staff[0] && staff[0].id) ? staff[0].id : "");
      if(!staffId){
        openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>職員未選択</title></head>
          <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#fff;">
            <div style="font-weight:900;font-size:18px;margin-bottom:8px;">職員が未選択です</div>
            <div style="color:#64748b;">上部の「職員」を選んでから、もう一度押してください。</div>
          </body></html>`, false);
        return;
      }
      const s = getStaff(staffId);
      if(!s){
        openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>エラー</title></head>
          <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#fff;">
            <div style="font-weight:900;font-size:18px;margin-bottom:8px;">職員が見つかりません</div>
            <div style="color:#64748b;">職員マスタを確認してください。</div>
          </body></html>`, false);
        return;
      }

      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>集計中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">集計中…</div>
          <div style="color:#64748b;">当月データを集計しています。</div>
        </body></html>`, false);

      const {y,m} = getViewYM();
      const monthTitle = `${y}年${pad2(m)}月`;

      const days = monthAggByStaff(staffId, y, m);
      const sum  = summaryByStaff(staffId, y, m);

      // totals for this month
      const sumMin = (arr, key) => arr.reduce((a,x)=>a + (Number(x[key])||0), 0);
      const monthStayRawMin = sumMin(days, "stayRaw");
      const monthStayEqMin  = sumMin(days, "stayEq");
      const monthOtherOffMin = sumMin(days, "otherOffMin");
      const monthOverMin = sumMin(days, "over");

      const workDays = days.filter(x=>!x.off && x.hasAny && x.over!=null).length;
      const avgOverMin = workDays ? (monthOverMin/workDays) : 0;

      // max over day
      let maxDay = null;
      days.forEach(x=>{
        if(x.over!=null && (maxDay==null || x.over > maxDay.over)) maxDay = {dateKey:x.dateKey, over:x.over};
      });

      // previous month for MoM
      const prev = (()=>{
        let py=y, pm=m-1;
        if(pm<=0){ pm=12; py=y-1; }
        return {y:py,m:pm};
      })();
      const prevDays = monthAggByStaff(staffId, prev.y, prev.m);
      const prevOverMin = prevDays.reduce((a,x)=>a+(Number(x.over)||0),0);
      const thisOverMin = monthOverMin;
      const prevOverMin2 = prevOverMin;
      const momDiffMin = (monthOverMin - prevOverMin);


      // goal
      const goalOverH = Number(settings.goalOverH||0);
      const goalOverMin = (goalOverH>0) ? goalOverH*60 : 0;
      const achievePct = (goalOverMin>0) ? Math.min(999, Math.round((goalOverMin/Math.max(1, Number(thisOverMin)||0))*100)) : null;

      // reason lookup
      const reasonMap = {};
      (settings.reasons||[]).forEach(r=>{ reasonMap[String(r.code)] = r.label; });

      const tableRows = days.map(x=>{
        const ent = x.ent || {};
        const inS  = ent.in || "—";
        const outS = ent.out || "—";
        const otherOffMin = parseDurationToMin(ent.otherOff);
        const otherOffS = (otherOffMin==null) ? "—" : formatDurJP(otherOffMin);
        const stayEqS = (x.stayEq==null)? "—" : formatDurJP(x.stayEq);
        const overS   = (x.over==null)? "—" : `<span style="${(x.over||0)>0?'color:#b91c1c;font-weight:900;':''}">${formatDurJP(x.over)}</span>`;
        const kbn = x.off ? "休み" : "勤務";
        const reason = ent.reason ? (reasonMap[String(ent.reason)] || "その他") : "—";
        return `<tr>
          <td>${x.day}日（${x.dow}）<div class="s">${x.dateKey}</div></td>
          <td><span class="pill ${x.off?'off':'work'}">${kbn}</span></td>
          <td class="mono">${escapeHtml(inS)}</td>
          <td class="mono">${escapeHtml(outS)}</td>
          <td class="mono">${stayEqS}</td>
          <td class="mono">${otherOffS==="—" ? "—" : otherOffS}</td>
          <td class="mono">${overS}</td>
          <td class="reason">${escapeHtml(reason)}</td>
        </tr>`;
      }).join("");

      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>年間集計中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">年間集計中…</div>
          <div style="color:#64748b;">4月〜3月の推移を作成しています。</div>
        </body></html>`, false);

      const fyYear = fiscalYearFrom(y,m);
      const annual = [];
      for(let i=0;i<12;i++){
        const mm = ((4 + i - 1) % 12) + 1; // 4..12,1..3
        const yy = (mm>=4) ? fyYear : (fyYear+1);
        const ssum = summaryByStaff(staffId, yy, mm);
        annual.push({y:yy, m:mm, over:(ssum.totalOver||0)});
      }
      const chartSvg = buildAnnualOverSvg(annual, y, m, goalOverH);

      const kpi = {
        monthOverMin,
        monthStayEqMin,
        monthStayRawMin,
        monthOtherOffMin,
        workDays,
        avgOverMin,
        avgStayEqMin: (workDays ? (monthStayEqMin/workDays) : 0),
        avgStayRawMin: (workDays ? (monthStayRawMin/workDays) : 0),
        avgOtherOffMin: (workDays ? (monthOtherOffMin/workDays) : 0),
        maxDayKey: maxDay ? maxDay.dateKey : null,
        maxDayOverMin: maxDay ? maxDay.over : 0,
        prevOverMin2: Number(prevOverMin2),
        thisOverMin: Number(thisOverMin),
        momDiffMin: Number(momDiffMin),
        achievePct,
      };

      const p = {
        title: "在校等時間 管理システム",
        staffName: s.name,
        staffRole: s.role || "その他",
        monthTitle,
        breakMin: Number(settings.breakMin||45),
        goalOverH,
        chartSvg,
        chartUrl: null,
        kpi,
        tableRows
      };

      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>レポート作成中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">レポート作成中…</div>
          <div style="color:#64748b;">レイアウトを生成しています。</div>
        </body></html>`, false);

      const htmlDoc = buildPrintIndividualHTML(p);
      openPrintOverlay(htmlDoc, false);
      toast("個別レポートを表示しました");
    }catch(err){
      console.error(err);
      const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
      setPrintOverlayMsg("個別レポート生成でエラーが発生しました（下に詳細）。");
      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>エラー</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#fff;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">個別レポート生成でエラーが発生しました</div>
          <div style="color:#64748b;margin-bottom:12px;">下の内容をそのまま送ってください。</div>
          <pre style="white-space:pre-wrap;background:#0f172a;color:#e2e8f0;padding:12px;border-radius:12px;overflow:auto;">${escapeHtml(msg)}</pre>
        </body></html>`, false);
      try{ toast("個別レポートでエラー"); }catch(e){}
    }
  }, 0);
}



function openBatchPrintModal(){
  const vm = getViewYM();
  const y = vm.y, m = vm.m;
  const modeId = `batchMode_${Date.now()}`;

  const listHtml = staff.map(s=>`
    <label class="flex items-center gap-2 py-1">
      <input type="checkbox" class="checkbox" name="bpStaff" value="${escapeAttr(s.id)}" checked>
      <span class="font-semibold">${escapeHtml(s.name||"")}</span>
      <span class="text-xs text-gray-500">${escapeHtml(s.title||"")}</span>
    </label>
  `).join("");

  const body = `
    <div class="space-y-3">
      <div class="text-sm text-gray-600">対象月：<span class="mono font-black">${y}年${m}月</span>　／　複数名の個別レポートをまとめて印刷します。</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="card p-3">
          <div class="font-black mb-2">印刷形式</div>
          <label class="flex items-center gap-2 text-sm mb-1"><input type="radio" name="${modeId}" value="one" checked> A4 1枚（要約）</label>
          <label class="flex items-center gap-2 text-sm"><input type="radio" name="${modeId}" value="two"> 2枚（1ページ目：要約／2ページ目：当月一覧）</label>
          <div class="text-xs text-gray-500 mt-2">※一括印刷では、選択した形式で全員分を生成します。</div>
        </div>

        <div class="card p-3">
          <div class="font-black mb-2">職員の選択</div>
          <div class="flex gap-2 mb-2">
            <button class="btn btn-ghost px-3" type="button" onclick="bpSelectAll(true)">全て</button>
            <button class="btn btn-ghost px-3" type="button" onclick="bpSelectAll(false)">解除</button>
          </div>
          <div class="max-h-56 overflow-auto pr-2">${listHtml}</div>
        </div>
      </div>

      <div class="text-xs text-gray-500">※生成後は「印刷プレビュー」画面に切り替わります。</div>
    </div>
  `;

  const getMode = ()=>{
    const el = document.querySelector(`input[name="${modeId}"]:checked`);
    return el ? el.value : "one";
  };

  openModal("一括印刷", "全員 / 複数選択で印刷できます。", body, [
    { label:"選択した職員を印刷", className:"btn btn-primary", onClick: ()=>{
        const ids = Array.from(document.querySelectorAll('input[name="bpStaff"]:checked')).map(x=>x.value);
        if(!ids.length){ showToast("職員を選択してください"); return; }
        const mode = getMode();
        closeModal();
        printIndividualBatch(ids, y, m, mode);
      }
    },
    { label:"全員を印刷", className:"btn btn-ghost", onClick: ()=>{
        const ids = staff.map(s=>s.id);
        const mode = getMode();
        closeModal();
        printIndividualBatch(ids, y, m, mode);
      }
    },
    { label:"閉じる", className:"btn btn-ghost", onClick: closeModal }
  ]);
}

function bpSelectAll(on){
  document.querySelectorAll('input[name="bpStaff"]').forEach(el=>{ el.checked = !!on; });
}

function printIndividualBatch(ids, y, m, mode){
  try{
    openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"><title>印刷プレビュー</title>
      <style>body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif; padding:24px; color:#111827}</style></head>
      <body><h2 style="margin:0 0 8px">印刷プレビュー</h2><div style="color:#6b7280">個別レポート（${ids.length}名分）を生成しています…</div></body></html>`);
    setTimeout(()=>{
      try{
        const html = buildPrintBatchHTML(ids, y, m, mode);
        openPrintOverlay(html);
      }catch(e){
        console.error(e);
        showToast("一括印刷でエラー");
        openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"><title>印刷プレビュー</title></head>
          <body style="font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif; padding:24px;">
            <h2>印刷プレビュー</h2>
            <p style="color:#b91c1c;font-weight:800;">一括印刷の生成でエラーが発生しました。</p>
            <pre style="white-space:pre-wrap; background:#f3f4f6; padding:12px; border-radius:12px;">${escapeHtml(String(e))}</pre>
          </body></html>`);
      }
    }, 60);
  }catch(e){
    console.error(e);
    showToast("一括印刷でエラー");
  }
}

function buildPrintBatchHTML(ids, y, m, mode){
  const vm = {y, m};
  const curY = y, curM = m;
  const schoolYear = toSchoolYear(curY, curM);
  const months = buildSchoolYearMonths(schoolYear); // [{y,m}] 12

  // prebuild reasonMap and settings snapshot
  const settings = STORE.settings || {};
  const breakMin = Number(settings.breakMin||45);
  const goalOverH = Number(settings.goalOverH||0);

  const reasonMap = {};
  (settings.reasonOptions||DEFAULTS.reasonOptions).forEach(o=>{ reasonMap[String(o.code)] = o.label; });

  const sections = ids.map(staffId=>{
    const s = staff.find(x=>x.id===staffId) || {id:staffId,name:"",title:""};
    const days = buildMonthDays(curY, curM).map(d=>{
      const dateKey = d.dateKey;
      const ent = getEntry(dateKey, staffId) || {};
      const off = isOffDay(dateKey, staffId);
      const raw = computeRawStayMin(ent.in, ent.out);
      const stayEq = (raw==null) ? null : Math.max(0, raw - breakMin - (parseDurationToMin(ent.otherOff)||0));
      const over = (stayEq==null) ? null : (off ? stayEq : Math.max(0, stayEq - (7*60+45)));
      return { ...d, ent, off, raw, stayEq, over };
    });

    // month sums
    let monthOverMin=0, monthStayEqMin=0, monthStayRawMin=0, monthOtherOffMin=0, workDays=0;
    let maxDayOverMin=0, maxDayKey=null;
    days.forEach(x=>{
      const ent=x.ent||{};
      const other=parseDurationToMin(ent.otherOff)||0;
      if(x.raw!=null) monthStayRawMin+=x.raw;
      if(x.stayEq!=null) monthStayEqMin+=x.stayEq;
      monthOtherOffMin+=other;
      if(x.over!=null){
        monthOverMin += x.over;
        if(x.over>maxDayOverMin){ maxDayOverMin=x.over; maxDayKey=x.dateKey; }
      }
      if(!x.off && x.over!=null && (ent.in||ent.out||ent.otherOff)) workDays++;
    });

    const avgOverMin = workDays ? (monthOverMin/workDays) : 0;
    const kpi = {
      monthOverMin, monthStayEqMin, monthStayRawMin, monthOtherOffMin,
      workDays, avgOverMin,
      avgStayEqMin: (workDays ? (monthStayEqMin/workDays) : 0),
      avgStayRawMin: (workDays ? (monthStayRawMin/workDays) : 0),
      avgOtherOffMin: (workDays ? (monthOtherOffMin/workDays) : 0),
      thisOverMin: monthOverMin,
      prevOverMin2: null,
      momDiffMin: 0,
      achievePct: null,
      maxDayOverMin, maxDayKey
    };

    // prev month for mom
    const pm = shiftYM(curY, curM, -1);
    const prevDays = buildMonthDays(pm.y, pm.m);
    let prevOver=0;
    prevDays.forEach(d=>{
      const ent = getEntry(d.dateKey, staffId) || {};
      const off = isOffDay(d.dateKey, staffId);
      const raw = computeRawStayMin(ent.in, ent.out);
      if(raw==null) return;
      const stayEq = Math.max(0, raw - breakMin - (parseDurationToMin(ent.otherOff)||0));
      const over = off ? stayEq : Math.max(0, stayEq - (7*60+45));
      prevOver += over;
    });
    kpi.prevOverMin2 = prevOver;
    kpi.momDiffMin = (monthOverMin - prevOver);
    const goalOverMin = (goalOverH>0) ? goalOverH*60 : 0;
    kpi.achievePct = (goalOverMin>0) ? Math.min(999, Math.round((goalOverMin/Math.max(1, (monthOverMin||0))) * 100)) : null;

    // annual for chart
    const annual = months.map(mm=>{
      let over=0;
      buildMonthDays(mm.y, mm.m).forEach(d=>{
        const ent=getEntry(d.dateKey, staffId)||{};
        const off=isOffDay(d.dateKey, staffId);
        const raw=computeRawStayMin(ent.in, ent.out);
        if(raw==null) return;
        const stayEq=Math.max(0, raw - breakMin - (parseDurationToMin(ent.otherOff)||0));
        const o = off ? stayEq : Math.max(0, stayEq - (7*60+45));
        over += o;
      });
      return {y:mm.y,m:mm.m,over};
    });

    const chartSvg = buildAnnualOverSvg(annual, curY, curM, goalOverH);
    const p = {
      title:`${curY}年${curM}月 / （${schoolYear}年度）`,
      y:curY, m:curM,
      staffName:s.name||"",
      staffTitle:(s.role||""),
      breakMin, goalOverH, chartSvg, kpi,
      tableRows: buildPrintTableRows(days, reasonMap),
      mode
    };
    return buildPrintIndividualSection(p, mode);
  }).join('<div class="page-break"></div>');

  return `<!doctype html><html><head><meta charset="utf-8"><title>個別レポート 一括印刷</title>
    ${PRINT_STYLE_BLOCK}
  </head><body>
    ${sections}
  </body></html>`;
}

function buildPrintTableRows(days, reasonMap){
  return days.map(x=>{
    const ent = x.ent || {};
    const inS  = ent.in || "—";
    const outS = ent.out || "—";
    const otherOffMin = parseDurationToMin(ent.otherOff);
    const otherOffS = (otherOffMin==null) ? "—" : formatDurJP(otherOffMin);
    const stayEqS = (x.stayEq==null)? "—" : formatDurJP(x.stayEq);
    const overS   = (x.over==null)? "—" : `<span style="${(x.over||0)>0?'color:#b91c1c;font-weight:900;':''}">${formatDurJP(x.over)}</span>`;
    const kbn = x.off ? "休み" : "勤務";
    const reason = ent.reason ? (reasonMap[String(ent.reason)] || "その他") : "—";
    return `<tr>
      <td>${x.day}日（${x.dow}）<div class="s">${x.dateKey}</div></td>
      <td><span class="pill ${x.off?'off':'work'}">${kbn}</span></td>
      <td class="mono">${escapeHtml(inS)}</td>
      <td class="mono">${escapeHtml(outS)}</td>
      <td class="mono">${stayEqS}</td>
      <td class="mono">${otherOffS==="—" ? "—" : otherOffS}</td>
      <td class="mono">${overS}</td>
      <td class="reason">${escapeHtml(reason)}</td>
    </tr>`;
  }).join("");
}

function buildPrintIndividualSection(p, mode){
  // share the same CSS and card renderer as buildPrintIndividualHTML
  const k = p.kpi;
  const card = (t,v,s)=>`
    <div class="kpi card">
      <div class="kpi-t">${escapeHtml(t)}</div>
      <div class="kpi-v">${v}</div>
      <div class="kpi-s">${escapeHtml(s||"")}</div>
    </div>`;

  const kpiHtml = `
    <div class="kpi-grid">
      ${card("今月の時間外", formatDurJP(k.monthOverMin||0), (()=>{
        const g = (p.goalOverH>0)? `目標：${formatDurJP(p.goalOverH*60)}` : "";
        const mom = (k.prevOverMin2!=null)? `先月比：${(k.momDiffMin>=0?"+":"-")}${formatDurJP(Math.abs(k.momDiffMin||0))}（先月${formatDurJP(k.prevOverMin2||0)}）` : "";
        const ach = (k.achievePct!=null)? `達成率：${k.achievePct}%` : "";
        return [g,mom,ach].filter(Boolean).join("｜");
      })())}
      ${card("前年差（先月比）", `${(k.momDiffMin>=0?"+":"-")}${formatDurJP(Math.abs(k.momDiffMin||0))}`, (k.prevOverMin2!=null? `先月：${formatDurJP(k.prevOverMin2||0)} ／ 今月：${formatDurJP(k.thisOverMin||0)}` : ""))}
      ${card("今月の在校等（平均）", formatDurJP(k.avgStayEqMin||0), `勤務日平均｜合計：${formatDurJP(k.monthStayEqMin||0)}（在校時間−(休憩${p.breakMin}分＋業務外)）`)}
      ${card("今月の在校時間（平均）", formatDurJP(k.avgStayRawMin||0), `勤務日平均｜合計：${formatDurJP(k.monthStayRawMin||0)}（出勤→退勤）`)}
      ${card("今月の業務外", formatDurJP(k.monthOtherOffMin||0), "自主研修/食事等")}
      ${card("目標達成率（%）", (k.achievePct==null? "—" : `${k.achievePct}%`), (p.goalOverH>0? `目標：${formatDurJP(p.goalOverH*60)} ／ 今月：${formatDurJP(k.thisOverMin||0)}` : "目標が0のため非表示"))}
      ${card("勤務日数", `${k.workDays||0}日`, "入力がある勤務日のみ")}
      ${card("勤務日平均(時間外)", `${formatDurJP(k.avgOverMin||0)}/日`, (k.maxDayKey? `最大：${k.maxDayKey}（${formatDurJP(k.maxDayOverMin||0)}）`:""))}
    </div>
  `;

  const chart = p.chartSvg ? `<div class="chart">${p.chartSvg}</div>` : `<div style="color:#6b7280">（グラフ生成に失敗しました）</div>`;
  const detailBlock = (mode==="two") ? `
    <div class="page-break"></div>
    <h2 class="h2">当月（日別一覧）</h2>
    <div class="small">列：日付 / 区分 / 出勤 / 退勤 / 在校等 / 業務外 / 時間外 / 理由</div>
    <table class="tbl">
      <thead><tr><th>日付</th><th>区分</th><th>出勤</th><th>退勤</th><th>在校等</th><th>業務外</th><th>時間外</th><th>理由</th></tr></thead>
      <tbody>${p.tableRows}</tbody>
    </table>
  ` : "";

  return `
    <div class="report">
      <div class="top">
        <div class="ttl">在校等時間 管理レポート</div>
        <div class="meta">${escapeHtml(p.title)}</div>
        <div class="who">
          <div class="name">${escapeHtml(p.staffName)}</div>
          <div class="role">${escapeHtml(p.staffTitle||"")}</div>
        </div>
      </div>

      <h2 class="h2">今月のサマリー</h2>
      ${kpiHtml}

      <h2 class="h2" style="margin-top:18px;">年間（4〜3月）時間外在校等時間の推移</h2>
      ${chart}

      ${detailBlock}
    </div>
  `;
}

// A shared style block for batch print (keep in sync with buildPrintIndividualHTML)
const PRINT_STYLE_BLOCK = `<style>
  :root{ --ink:#111827; --muted:#6b7280; --line:#e5e7eb; --card:#ffffff; --bg:#ffffff; --brand:#2563eb; --shadow:0 14px 34px rgba(2,6,23,.10); --r:18px;}
  body{ background:var(--bg); color:var(--ink); }
  .report{ background:var(--card); border:1px solid var(--line); border-radius:22px; padding:18px; box-shadow:var(--shadow); }
  .top{ display:flex; gap:14px; align-items:flex-end; justify-content:space-between; border-bottom:1px solid var(--line); padding-bottom:10px; margin-bottom:12px; }
  .ttl{ font-size:18px; font-weight:900; letter-spacing:.02em; }
  .meta{ font-size:12px; color:var(--muted); }
  .who{ text-align:right; }
  .name{ font-size:18px; font-weight:900; }
  .role{ font-size:12px; color:var(--muted); }
  .h2{ margin:14px 0 8px; font-size:14px; font-weight:900; }
  .small{ font-size:11px; color:var(--muted); margin-bottom:8px; }
  .kpi-grid{ display:grid; grid-template-columns: repeat(4,minmax(0,1fr)); gap:10px; }
  .card{ border:1px solid var(--line); border-radius:18px; padding:10px 12px; }
  .kpi-t{ font-size:11px; color:var(--muted); font-weight:800; }
  .kpi-v{ font-size:20px; font-weight:900; margin-top:2px; }
  .kpi-s{ font-size:11px; color:var(--muted); margin-top:4px; line-height:1.3; }
  .chart{ border:1px solid var(--line); border-radius:18px; padding:10px; }
  .chart svg{ width:100%; height:auto; display:block; }
  .tbl{ width:100%; border-collapse:separate; border-spacing:0; font-size:12px; overflow:hidden; border:1px solid var(--line); border-radius:18px; }
  .tbl th{ text-align:left; background:#f3f4f6; padding:8px; border-bottom:1px solid var(--line); }
  .tbl td{ padding:8px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
  .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace; }
  .pill{ display:inline-flex; align-items:center; gap:6px; font-size:11px; padding:2px 10px; border-radius:999px; border:1px solid var(--line); background:#fff; font-weight:800; }
  .pill.work{ color:#047857; }
  .pill.off{ color:#b45309; }
  .reason{ max-width:240px; }
  .s{ color:var(--muted); font-size:11px; }
  .page-break{ break-before: page; }
  @media print{
    body{ margin:12mm; }
    .page-break{ break-before: page; }
  }
  @media (max-width:880px){ .kpi-grid{ grid-template-columns: repeat(2,minmax(0,1fr)); } }
</style>`;
function buildPrintIndividualHTML(p){
  const now = new Date();
  const stamp = now.toLocaleString("ja-JP");
  const closeScript = "</scr" + "ipt>";
  const chart = p.chartSvg ? `<div class="chart">${p.chartSvg}</div>` : `<div style="color:#6b7280">（グラフ生成に失敗しました）</div>`;

  const k = p.kpi||{};
  const card = (label, value, sub)=>`
    <div class="kpi">
      <div class="kpi-l">${label}</div>
      <div class="kpi-v">${value}</div>
      ${sub? `<div class="kpi-s">${sub}</div>`:""}
    </div>
  `;

  const kpiHtml = `
    <div class="kpi-grid">
      ${card("今月の時間外", formatDurJP(k.monthOverMin||0), (()=>{
        const g = (p.goalOverH>0)? `目標：${formatDurJP(p.goalOverH*60)}` : "";
        const mom = (k.prevOverMin2!=null)? `先月比：${(k.momDiffMin>=0?"+":"-")}${formatDurJP(Math.abs(k.momDiffMin||0))}（先月${formatDurJP(k.prevOverMin2||0)}）` : "";
        const ach = (k.achievePct!=null)? `達成率：${k.achievePct}%` : "";
        return [g,mom,ach].filter(Boolean).join("｜");
      })())}
      ${card("前年差（先月比）", `${(k.momDiffMin>=0?"+":"-")}${formatDurJP(Math.abs(k.momDiffMin||0))}`, (k.prevOverMin2!=null? `先月：${formatDurJP(k.prevOverMin2||0)} ／ 今月：${formatDurJP(k.thisOverMin||0)}` : ""))}
      ${card("今月の在校等（平均）", formatDurJP(k.avgStayEqMin||0), `勤務日平均｜合計：${formatDurJP(k.monthStayEqMin||0)}（在校時間−(休憩${p.breakMin}分＋業務外)）`)}
      ${card("今月の在校時間（平均）", formatDurJP(k.avgStayRawMin||0), `勤務日平均｜合計：${formatDurJP(k.monthStayRawMin||0)}（出勤→退勤）`)}
      ${card("今月の業務外", formatDurJP(k.monthOtherOffMin||0), "自主研修/食事等")}
      ${card("目標達成率（%）", (k.achievePct==null? "—" : `${k.achievePct}%`), (p.goalOverH>0? `目標：${formatDurJP(p.goalOverH*60)} ／ 今月：${formatDurJP(k.thisOverMin||0)}` : "目標が0のため非表示"))}
      ${card("勤務日数", `${k.workDays||0}日`, "入力がある勤務日のみ")}
      ${card("勤務日平均(時間外)", `${formatDurJP(k.avgOverMin||0)}/日`, (k.maxDayKey? `最大：${k.maxDayKey}（${formatDurJP(k.maxDayOverMin||0)}）`:""))}
    </div>
  `;

  return `<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(p.title)} - ${escapeHtml(p.staffName)}</title>
<style>
  @page{ size:A4; margin:10mm; }

  body{ font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans",sans-serif; color:#111827; margin:22px; background:#fff; }
  .hero{ display:flex; justify-content:space-between; align-items:flex-end; gap:16px; border:1px solid #e5e7eb; border-radius:20px; padding:18px 20px; }
  .ttl{ font-size:22px; font-weight:900; letter-spacing:.02em; }
  .sub{ color:#6b7280; font-size:12px; margin-top:4px; }
  .name{ font-size:18px; font-weight:900; }
  .meta{ color:#6b7280; font-size:12px; text-align:right; }
  .btn{ border:1px solid #e5e7eb; border-radius:12px; padding:8px 12px; background:#111827; color:#fff; font-weight:900; cursor:pointer; }
  .btn{ border:1px solid #e5e7eb; border-radius:12px; padding:8px 12px; background:#fff; color:#111827; font-weight:900; cursor:pointer; }
  .btn.active{ background:#111827; color:#fff; border-color:#111827; }
  .btn:hover{ background:#f3f4f6; }

  .grid{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:14px; }
  .card{ border:1px solid #e5e7eb; border-radius:20px; padding:16px 18px; }
  h2{ font-size:14px; margin:0 0 10px; font-weight:900; }
  .note{ color:#6b7280; font-size:12px; line-height:1.55; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ border-bottom:1px solid #eef2f7; padding:8px 10px; font-size:12px; vertical-align:top; }
  th{ background:#f8fafc; position:sticky; top:0; }
  .mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; }
  .kpi-grid{ display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:10px; }
  .kpi{ border:1px solid #eef2f7; border-radius:16px; padding:10px 12px; background:#fff; }
  .kpi-l{ font-size:12px; color:#6b7280; font-weight:900; }
  .kpi-v{ font-size:18px; font-weight:900; margin-top:2px; }
  .kpi-s{ font-size:11px; color:#6b7280; margin-top:2px; }
  .toggle{ display:flex; gap:8px; flex-wrap:wrap; }
  .hidden{ display:none !important; }
  @media (max-width: 760px){
    .kpi-grid{ grid-template-columns: repeat(2,minmax(0,1fr)); }
  }
  @media print{
    body[data-mode="two"] .detail-block{ break-before: page; }
    body[data-mode="one"] .detail-block{ display:none !important; }

    body{ margin:10mm; }
    .no-print{ display:none !important; }
    th{ position:static; }
    .page-break{ break-before: page; }

    /* 2ページ目（当月一覧）をA4内に収めるためのコンパクト設定 */
    body[data-mode="two"] .detail-block h2{ font-size:12px; margin:0 0 6px; }
    body[data-mode="two"] .detail-block .card{ padding:12px 14px; }
    body[data-mode="two"] .detail-block th,
    body[data-mode="two"] .detail-block td{ padding:3px 5px; font-size:9px; }
    body[data-mode="two"] .detail-block .small{ display:none !important; }
    body[data-mode="two"] .detail-block .reason{ max-width: 180px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  }
  .chart{ border:1px solid #e5e7eb; border-radius:18px; padding:10px; background:#fff; }
  .chart svg{ width:100%; height:auto; display:block; }
</style>
</head>
<body>
  <div class="hero">
    <div>
      <div class="ttl">${escapeHtml(p.title)}</div>
      <div class="sub">${escapeHtml(p.monthTitle)} / ${escapeHtml(p.fyTitle)}　（休憩：${p.breakMin}分｜標準：${formatDurJP(p.stdMin)}）</div>
      <div style="margin-top:10px">
        <div class="name">${escapeHtml(p.staffName)} <span style="font-size:12px;color:#6b7280;font-weight:700">${escapeHtml(p.staffRole||"")}</span></div>
      </div>
    </div>
    <div class="meta">
      <div>出力：${stamp}</div>
      <div class="toggle no-print" style="margin-top:8px;">
        <button id="btnModeOne" class="btn active" onclick="setMode('one')">A4 1枚（要約）</button>
        <button id="btnModeTwo" class="btn" onclick="setMode('two')">2枚（要約＋当月一覧）</button>
        <button class="btn" onclick="window.print()">印刷</button>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>今月のサマリー</h2>
      ${kpiHtml}
      <div class="note" style="margin-top:10px;">※「時間外在校等時間」は、勤務日は（在校等−標準7:45）、休みの日は在校等の全てを時間外として集計しています。</div>
    </div>

    <div class="card">
      <h2>年間（4〜3月）時間外在校等時間の推移</h2>
      ${chart}
      ${p.goalOverH>0? `<div class="note" style="margin-top:10px;">点線は目標（${p.goalOverH}h/月）です。黒い薄いハイライトは「当月」を示します。</div>`:""}
    </div>

    <div class="card detail-block">
      <h2>当月（日別一覧）</h2>
      <div class="note" style="margin:0 0 10px;">列：日付 / 区分 / 出勤 / 退勤 / 在校等 / 業務外 / 時間外 / 理由</div>
      <div style="overflow:auto; max-height: 62vh;">
        <table>
          <thead>
            <tr>
              <th>日付</th><th>区分</th><th>出勤</th><th>退勤</th><th>在校等</th><th>業務外</th><th>時間外</th><th>理由</th>
            </tr>
          </thead>
          <tbody>
            ${p.tableRows}
          </tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  function setMode(mode){
    document.body.dataset.mode = mode;
    const detail = document.querySelector(".detail-block");
    const b1 = document.getElementById("btnModeOne");
    const b2 = document.getElementById("btnModeTwo");
    if(mode==="one"){
      if(detail) detail.classList.add("hidden");
      if(b1) b1.classList.add("active");
      if(b2) b2.classList.remove("active");
    }else{
      if(detail) detail.classList.remove("hidden");
      if(b1) b1.classList.remove("active");
      if(b2) b2.classList.add("active");
    }
  }
  // default: 1枚（要約）
  setMode('one');
${closeScript}
</body>
</html>`;
}


/* =========================
   Backup / Restore
   ========================= */
function backupJSON(){
  const data = {settings, staff, calendar, records, exportedAt: new Date().toISOString()};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_working_hours_${settings.year}-${pad2(settings.month)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("バックアップを保存しました");
}

function restoreJSON(){
  openModal("復元（JSON）", "バックアップ(JSON)を貼り付けて復元します。", `
    <textarea id="restoreText" class="input min-h-[200px] mono" placeholder="ここにJSONを貼り付け"></textarea>
    <div class="small mt-2 text-red-600">※現在のデータは上書きされます。必要なら先にバックアップしてください。</div>
  `, [
    {label:"復元", className:"btn btn-danger", onClick:()=>{
      try{
        const obj = JSON.parse(document.getElementById("restoreText").value || "{}");
        if(obj.settings) settings = obj.settings;
        if(obj.staff) staff = obj.staff;
        if(obj.calendar) calendar = obj.calendar;
        if(obj.records) records = obj.records;
        saveAll();
        closeModal();
        toast("復元しました");
        hydrateSettingsUI();
        renderCalendar();
        renderDaily();
        renderOverview();
        renderIndividual();
        syncInputFromEntry();
        updateCharts();
      }catch(e){
        toast("JSONが不正です");
      }
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal}
  ]);
}

function resetAll(){
  if(!confirm("全データを初期化します。よろしいですか？")) return;
  localStorage.removeItem(STORE.settings);
  localStorage.removeItem(STORE.staff);
  localStorage.removeItem(STORE.calendar);
  localStorage.removeItem(STORE.records);
  location.reload();
}

/* =========================
   Excel Import (your original workbook)
   ========================= */
async function importExcel(){
  const file = document.getElementById("excelFile").files?.[0];
  if(!file){ toast("ファイルを選択してください"); return; }

  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});

  const mustSheets = ["設定シート","出退勤時刻等入力","週休日在校時間入力"];
  for(const s of mustSheets){
    if(!wb.Sheets[s]){ toast(`シート「${s}」が見つかりません`); return; }
  }

  // --- read settings: year(K1) month(K2), staff list rows B3.. (No), C3..(Name), A3..(Role)
  const wsSet = wb.Sheets["設定シート"];
  const year = numCell(wsSet, "K1");
  const month= numCell(wsSet, "K2");
  if(year) settings.year = year;
  if(month) settings.month = month;

  // staff rows: 3..27 in original
  const newStaff = [];
  for(let r=3; r<=60; r++){
    const no = numCell(wsSet, "B"+r);
    const name = strCell(wsSet, "C"+r);
    const role = strCell(wsSet, "A"+r);
    if(!no || !name) continue;
    newStaff.push({id: uid(), no, name, role: role || "教員等"});
  }
  if(newStaff.length){
    staff = newStaff.sort((a,b)=>a.no-b.no).slice(0,50);
  }

  // break defaults: O4 has weekday break? In original O4 is 0:45 as time, stored as fraction.
  // We'll try read O4 and O5 for off? but original changes by weekday. We'll keep current settings unless we can infer.
  // Also read standard 7:45 is fixed.

  // --- read 出退勤時刻等入力 matrix: day blocks (出勤/退勤/業務外)
  const wsIO = wb.Sheets["出退勤時刻等入力"];
  // staff headers: row 4 col D.. for names
  const staffStartCol = 4; // D
  // find maximum staff columns by reading row4
  const nameRow = 4;
  // build mapping col -> staffId by matching name
  const colToStaff = {};
  for(let c=staffStartCol; c<staffStartCol+60; c++){
    const addr = XLSX.utils.encode_cell({r:nameRow-1, c:c-1});
    const v = wsIO[addr]?.v;
    const nm = (v||"").toString().trim();
    if(!nm) break;
    const s = staff.find(x=>x.name===nm);
    if(s) colToStaff[c] = s.id;
  }

  // find first "出勤" label in column C
  let startRow = null;
  for(let r=1; r<=200; r++){
    const v = strCell(wsIO, "C"+r);
    if(v==="出勤"){ startRow = r; break; }
  }
  if(!startRow){ toast("出退勤時刻等入力: 出勤行が見つかりません"); return; }

  const {y,m,daysInMonth} = getMonthInfo();
  // prepare records for month
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(settings.year, settings.month, d);
    // rows = startRow + (d-1)*3  : in, out, otherOff
    const rIn  = startRow + (d-1)*3;
    const rOut = rIn + 1;
    const rOff = rIn + 2;

    for(const [col, staffId] of Object.entries(colToStaff)){
      const c = Number(col);
      const inV  = wsIO[XLSX.utils.encode_cell({r:rIn-1, c:c-1})]?.v;
      const outV = wsIO[XLSX.utils.encode_cell({r:rOut-1, c:c-1})]?.v;
      const offV = wsIO[XLSX.utils.encode_cell({r:rOff-1, c:c-1})]?.v;

      const e = getEntry(key, staffId);
      // Excel times are fraction of day; convert to hh:mm
      e.in  = excelTimeToHHMM(inV)  || e.in || "";
      e.out = excelTimeToHHMM(outV) || e.out || "";
      // 業務外 is duration time; convert to h:mm
      const offMin = excelDurationToMin(offV);
      e.otherOff = (offMin!=null && offMin>0) ? formatDurJP(offMin) : (e.otherOff||"");
    }
  }

  // --- read 週休日在校時間入力: direct stayEq per day per staff
  const wsHol = wb.Sheets["週休日在校時間入力"];
  // header row: 4, staff columns start at D
  const holHeaderRow = 4;
  const holColToStaff = {};
  for(let c=4; c<4+60; c++){
    const addr = XLSX.utils.encode_cell({r:holHeaderRow-1, c:c-1});
    const v = (wsHol[addr]?.v||"").toString().trim();
    if(!v) break;
    const s = staff.find(x=>x.name===v);
    if(s) holColToStaff[c] = s.id;
  }
  // start row: 5
  const holStartRow = 5;
  for(let i=0; i<daysInMonth; i++){
    const r = holStartRow + i;
    // column B has day number possibly empty, skip if blank
    const dayNo = numCell(wsHol, "B"+r);
    if(!dayNo) continue;
    const key = dateKeyFromParts(settings.year, settings.month, dayNo);

    for(const [col, staffId] of Object.entries(holColToStaff)){
      const c = Number(col);
      const v = wsHol[XLSX.utils.encode_cell({r:r-1, c:c-1})]?.v;
      const min = excelDurationToMin(v);
      if(min!=null && min>0){
        const e = getEntry(key, staffId);
        e.holidayStayEq = formatDurJP(min);
      }
    }
  }

  // --- read reasonCode from personal sheets "1".."50" if exists
  for(const s of staff){
    // guess sheet by staff no if exists
    const sn = String(s.no);
    if(!wb.Sheets[sn]) continue;
    const wsP = wb.Sheets[sn];

    // find first data row where header has "主な業務外の時間" (code column)
    // In original, code is column L, starting row 9. We'll just read L9..L(9+daysInMonth-1)
    for(let d=1; d<=daysInMonth; d++){
      const key = dateKeyFromParts(settings.year, settings.month, d);
      const r = 8 + d; // row9 is d=1
      const code = wsP[XLSX.utils.encode_cell({r:r-1, c:11})]?.v; // L=12th col => index 11
      if(code!=null && code!==""){
        const e = getEntry(key, s.id);
        e.reasonCode = String(code).trim();
      }
    }
  }

  saveAll();
  toast("取り込みが完了しました");
  hydrateSettingsUI();
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  syncInputFromEntry();
  updateCharts();
}

function numCell(ws, addr){
  const v = ws[addr]?.v;
  if(v==null || v==="") return null;
  const n = Number(v);
  return isNaN(n) ? null : n;
}
function strCell(ws, addr){
  const v = ws[addr]?.v;
  if(v==null) return "";
  return String(v).trim();
}
function excelTimeToHHMM(v){
  // Excel serial time (fraction of day) or already string "07:50"
  if(v==null || v==="") return "";
  if(typeof v === "string"){
    const t = v.trim();
    if(/^\d{1,2}:\d{2}$/.test(t)) return normalizeHHMM(t);
    return "";
  }
  if(typeof v === "number"){
    // fraction day
    const totalMin = Math.round(v * 24 * 60);
    return normalizeHHMM(formatClock(totalMin));
  }
  return "";
}
function excelDurationToMin(v){
  if(v==null || v==="") return null;
  if(typeof v === "string"){
    const mm = parseDurationToMin(v.trim());
    return mm;
  }
  if(typeof v === "number"){
    // duration as fraction day
    const totalMin = Math.round(v * 24 * 60);
    return totalMin;
  }
  return null;
}
function normalizeHHMM(t){
  const m = /^(\d{1,2}):(\d{2})$/.exec(t);
  if(!m) return "";
  return `${pad2(Number(m[1])%24)}:${pad2(Number(m[2]))}`;
}

/* =========================
   Modal
   ========================= */


function openEditModal(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey){ toast("職員と日付を選択してください"); return; }

  const s = staff.find(x=>x.id===staffId);
  const e = getEntry(dateKey, staffId);

  const body = `
    <div class="space-y-3">
      <div class="small text-slate-600">${s? escapeHtml(s.name):""} / ${dateKey}</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-black mb-1">出勤</label>
          <input id="modalIn" type="time" class="input mono" value="${escapeAttr(e.in||"")}" />
        </div>
        <div>
          <label class="block text-sm font-black mb-1">退勤</label>
          <input id="modalOut" type="time" class="input mono" value="${escapeAttr(e.out||"")}" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-black mb-1">業務外（時間）</label>
        <input id="modalOther" type="text" class="input mono" placeholder="例: 0:30 / 0.5" value="${escapeAttr(e.otherOff||"")}" />
      </div>

      <div>
        <label class="block text-sm font-black mb-1">業務外の理由</label>
        <select id="modalReason" class="input"></select>
      </div>

      <div class="flex flex-wrap gap-2 pt-2">
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalIn').value='';">出勤クリア</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalOut').value='';">退勤クリア</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalOther').value='';">業務外クリア</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalReason').value='';">理由クリア</button>
      </div>

      <div class="small text-slate-600">
        ※保存すると、入力タブの表示・月別集計・グラフにも即反映されます。
      </div>
    </div>
  `;

  openModal("編集", "出勤／退勤／業務外／理由を修正できます。", body, [
    { label:"保存", className:"btn btn-primary", onClick: saveEditModal },
    { label:"閉じる", className:"btn btn-ghost", onClick: closeModal },
  ]);

  // after open
  fillReasonSelect("modalReason");
  const sel = document.getElementById("modalReason");
  if(sel) sel.value = String(e.reason||"");
}

function saveEditModal(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey) return;

  const inV = document.getElementById("modalIn")?.value || "";
  const outV = document.getElementById("modalOut")?.value || "";
  const othV = (document.getElementById("modalOther")?.value || "").trim();
  const reaV = (document.getElementById("modalReason")?.value || "").trim();

  if(othV){
    const mm = parseDurationToMin(othV);
    if(mm==null){ toast("業務外の形式が不正です（例: 0:30 / 0.5）"); return; }
  }

  const e = getEntry(dateKey, staffId);
  e.in = inV;
  e.out = outV;
  if(!othV){ e.otherOff = ""; }
      else{
        const mm = parseDurationToMin(othV);
        if(mm==null){ toast("業務外の形式が正しくありません（例：0:30 / 0.5 / 30分）"); return; }
        e.otherOff = durMinToHM(mm);
      }
  e.reason = reaV || "";

  save(STORE.records, records);

  // ★保存したらフォーム（モーダル）を消す
  closeModal();

  // reflect into hidden inputs and main field
  if(document.getElementById("inpIn")) document.getElementById("inpIn").value = inV;
  if(document.getElementById("inpOut")) document.getElementById("inpOut").value = outV;
  if(document.getElementById("inpOtherOff")) document.getElementById("inpOtherOff").value = e.otherOff;

  // update views
  safeCall(saveEntry);
  safeCall(renderInputCalc);
  safeCall(renderDaily);
  safeCall(renderOverview);
  safeCall(renderIndividual);
  safeCall(updateCharts);
}
function openModal(title, sub, bodyHtml, actions){
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalSub").textContent = sub;
  document.getElementById("modalBody").innerHTML = bodyHtml;

  const foot = document.getElementById("modalFooter");
  foot.innerHTML = "";
  (actions||[]).forEach(a=>{
    const btn = document.createElement("button");
    btn.className = a.className || "btn btn-ghost";
    btn.textContent = a.label;
    btn.onclick = a.onClick;
    foot.appendChild(btn);
  });

  const wrap = document.getElementById("modalWrap");
  wrap.style.display = "flex";
  wrap.classList.remove("hidden");
  wrap.classList.add("flex");
}
function closeModal(){
  const wrap = document.getElementById("modalWrap");
  if(!wrap) return;
  wrap.classList.add("hidden");
  wrap.classList.remove("flex");
  wrap.style.display = "none";
  const body = document.getElementById("modalBody");
  if(body) body.innerHTML = "";
}


function openOverviewPrintMenu(){
  openModal("印刷メニュー", "月別 全体一覧（表示月）", `
    <div class="space-y-3">
      <div class="small text-slate-600">「全体」または「チェックした職員（平均のチェック）」で印刷できます。</div>
      <div class="grid sm:grid-cols-2 gap-2">
        <button class="btn btn-primary w-full" onclick="(function(){ closeModal(); printOverview('all'); })()">全体を印刷</button>
        <button class="btn btn-ghost w-full" onclick="(function(){ closeModal(); printOverview('selected'); })()">チェックした職員を印刷</button>
      </div>
    </div>
  `,[{label:"閉じる", className:"btn btn-ghost", onClick: closeModal}]);
}

function openPrintHelp(){
  const {y,m} = getViewYM();
  const ym = `${y}年${pad2(m)}月`;
  openModal("印刷の使い方", `表示月：${ym}`, `
    <div class="space-y-3">
      <div class="font-black">1) まず「表示月」を選びます</div>
      <div class="small">全体一覧・個別一覧の上部にある「◀／▶」または月入力で、印刷したい月に切り替えます。</div>

      <div class="font-black">2) 全体一覧の印刷</div>
      <ul class="small list-disc pl-5 space-y-1">
        <li><b>印刷（全体）</b>：その月の全職員を印刷します。</li>
        <li><b>印刷（チェックした職員）</b>：設定タブの「平均に含める」チェックを使って、対象職員だけ印刷します。</li>
</ul>

      <div class="font-black">3) 個別レポートの印刷</div>
      <div class="small">「個別レポートを開く（印刷/保存）」を押すと、別タブでレポートが開きます。右上の <b>印刷</b> を押してください（A4 1枚/2枚も切替できます）。</div>

      <div class="small text-slate-500">※Safariではポップアップ制限で別タブが開かない場合があります。そのときはアドレスバーの右側の設定で、このサイトのポップアップを許可してください。</div>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick: closeModal}]);
}

function openHelp(){
  openModal("使い方（最短）", "“入力は3つだけ”を徹底して、Excelの考え方をそのままアプリにしました。", `
    <div class="space-y-3 text-sm">
      <div class="card p-4">
        <div class="font-bold mb-2">1. 入力</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>「職員」「日付」を選び、<b>出勤</b>・<b>退勤</b>・<b>時間外</b>だけ入力して保存。</li>
          <li>時間外は空欄でもOK（自動計算）。必要なら「自」ボタンで自動値を入れられます。</li>
        </ul>
      </div>
      <div class="card p-4">
        <div class="font-bold mb-2">2. 休みの日の設定（カレンダー）</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>土日祝は「休み」扱い。登校日・代休などはクリックで切り替え。</li>
          <li>休みの日は <b>在校等時間＝時間外</b> として集計します。</li>
        </ul>
      </div>
      <div class="card p-4">
        <div class="font-bold mb-2">3. 一覧・出力</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>「月別 全体一覧」で、職員別の平日/休みの平均・当月合計（時間外）を確認。</li>
          <li>Excel出力で、当月の集計をそのまま保存できます。</li>
        </ul>
      </div>
      <div class="small text-gray-600">
        ※Excel原本の「業務外（除く時間）」を使いたい場合は、個別一覧の「業務外」から入力できます（入力画面を簡単にするため分離しています）。
      </div>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick:closeModal}]);
}

/* =========================
   Helpers
   ========================= */
function escapeHtml(s){
  return (s??"").toString().replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

/* =========================
   Hooks (re-render when changing input)
   ========================= */
function renderAvgBoxDebounced(){
  renderAvgBox();
}
</script>
</body>
</html>
