<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>在校等時間管理（Excel版→アプリ版）</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS (Excel import/export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap');
    :root{
      --ink:#111827; --muted:#6b7280; --card:#fff; --line:#e5e7eb;
      --brand:#2563eb; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --bg:#f7f7fb;
      --radius:18px;
      --shadow: 0 18px 40px rgba(2,6,23,.06), 0 2px 8px rgba(2,6,23,.04);
      --ring: 0 0 0 3px rgba(37,99,235,.18);
    }
    body{ font-family: Inter, "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--ink); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
    .tab-btn{ padding:.6rem .9rem; border-bottom:2px solid transparent; font-weight:700; color:var(--muted); }
    .tab-btn.active{ color:var(--brand); border-bottom-color:var(--brand); }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; border:1px solid var(--line); border-radius:999px; padding:.25rem .55rem; font-size:.8rem; background:#fff; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn{ border-radius:14px; font-weight:700; padding:.55rem .9rem; transition:.15s; border:1px solid transparent; }
    .btn:focus{ outline:none; box-shadow: var(--ring); }
    .btn-primary{ background:var(--brand); color:#fff; }
    .btn-primary:hover{ filter:brightness(.95); }
    .btn-ghost{ background:#fff; border-color:var(--line); color:var(--ink); }
    .btn-ghost:hover{ background:#f8fafc; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-danger:hover{ filter:brightness(.95); }
    .btn-ok{ background:var(--ok); color:#fff; }
    .btn-ok:hover{ filter:brightness(.95); }
    .input{ width:100%; border:1px solid var(--line); border-radius:14px; padding:.55rem .7rem; background:#fff; }
    .input:focus{ outline:none; box-shadow: var(--ring); border-color: rgba(37,99,235,.35); }
    .small{ font-size:.82rem; color:var(--muted); }
    .sticky-head thead th{ position: sticky; top: 0; background: #f8fafc; z-index: 2; }
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; }
    }
  </style>
</head>

<body class="min-h-screen">
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="card p-5 mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-start gap-3">
        <div class="w-11 h-11 rounded-2xl bg-blue-50 border border-blue-100 flex items-center justify-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 3v3M17 3v3M4 9h16M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" stroke="#2563eb" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-black tracking-tight">在校等時間 管理システム</h1>
          <div class="small mt-0.5">
            Excel（あなたの原本）ロジックを踏襲：
            <span class="mono">在校時間 − 休憩 − その他業務外 = 在校等時間</span> ／
            <span class="mono">在校等時間 − 7:45 = 時間外在校等時間</span>（勤務日） ／
            土日祝等（休みの日）は「在校等時間＝時間外」として集計
          </div>
          <div class="mt-2 flex flex-wrap gap-2">
            <div class="flex items-center gap-2">
              <button id="btnPrevMonth" type="button" class="btn btn-ghost px-3" title="前の月">◀</button>
              <span class="chip"><span class="w-2 h-2 rounded-full bg-blue-500 inline-block"></span><span id="chip-month">—</span></span>
              <button id="btnNextMonth" type="button" class="btn btn-ghost px-3" title="次の月">▶</button>
            </div>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span><span id="chip-workday-count">勤務日: —</span></span>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span><span id="chip-holiday-count">休み: —</span></span>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-red-500 inline-block"></span><span id="chip-threshold">45h/80h 自動警告</span></span>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between md:justify-end gap-3">
        <div class="text-right">
          <div class="mono text-2xl font-black text-blue-600" id="nowTime">--:--:--</div>
          <div class="small" id="nowDate">----/--/-- (---)</div>
        </div>
        <button class="btn btn-ghost no-print" onclick="openHelp()">使い方</button>
      </div>
    </header>

    <!-- Tabs -->
    <div class="no-print card px-3 py-2 mb-4">
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn active" id="tab-input" onclick="switchTab('input')">入力</button>
        <button class="tab-btn" id="tab-calendar" onclick="switchTab('calendar')">カレンダー</button>
        <button class="tab-btn" id="tab-overview" onclick="switchTab('overview')">月別 全体一覧</button>
        <button class="tab-btn" id="tab-individual" onclick="switchTab('individual')">月別 個別一覧</button>
        <button class="tab-btn" id="tab-settings" onclick="switchTab('settings')">設定・出力</button>
      </div>
    </div>

    <!-- INPUT -->
    <section id="section-input" class="space-y-4">
      <div class="card p-5">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
          <div class="md:col-span-3">
            <label class="block text-sm font-black mb-1">職員</label>
            <select id="inpStaff" class="input"></select>
          </div>

          <div class="md:col-span-3">
            <label class="block text-sm font-black mb-1">日付</label>
            <div class="flex gap-2">
              <button type="button" class="btn btn-ghost px-3" onclick="stepDate(-1)" title="前日">◀</button>
              <input id="inpDate" type="date" class="input" />
              <button type="button" class="btn btn-ghost px-3" onclick="stepDate(1)" title="翌日">▶</button>
            </div>
            <div class="small mt-1" id="inpDayBadge">—</div>
          </div>

          <div class="md:col-span-6">
            <label class="block text-sm font-black mb-1">入力</label>
            <div class="flex flex-wrap gap-2">
              <button type="button" class="btn btn-primary" onclick="stampNow('in')">出勤（今）</button>
              <button type="button" class="btn btn-danger" onclick="stampNow('out')">退勤（今）</button>

              <div class="flex items-center gap-2 flex-1 min-w-[220px]">
                <span class="small whitespace-nowrap">業務外</span>
                <input id="inpOtherOff" type="text" class="input mono" placeholder="例: 0:30 / 0.5" />
                <select id="inpReason" class="input" title="業務外の理由"></select>
              </div>

              <button type="button" class="btn btn-ghost" onclick="openEditModal()">編集</button>

              <!-- hidden for stamping preview/save -->
              <input id="inpIn" type="time" class="hidden" />
              <input id="inpOut" type="time" class="hidden" />
            </div>
            <div class="small mt-2">
              ※時間外在校等時間は自動計算です（在校等時間 − 標準勤務）。休憩は設定で変更できます。
            </div>
          </div>

          <div class="md:col-span-12 mt-3 overflow-x-auto">
            <table class="w-full text-left sticky-head">
              <thead>
                <tr>
                  <th class="p-3 text-xs font-black">氏名</th>
                  <th class="p-3 text-xs font-black">区分</th>
                  <th class="p-3 text-xs font-black">出勤</th>
                  <th class="p-3 text-xs font-black">退勤</th>
                  <th class="p-3 text-xs font-black">在校等</th>
                  <th class="p-3 text-xs font-black">業務外</th>
                  <th class="p-3 text-xs font-black">時間外</th>
                  <th class="p-3 text-xs font-black">今月の時間外</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-100">
                <tr class="bg-white">
                  <td class="p-3 text-sm font-black" id="rowName">—</td>
                  <td class="p-3 text-sm" id="rowType">—</td>
                  <td class="p-3 text-sm mono" id="rowIn">--:--</td>
                  <td class="p-3 text-sm mono" id="rowOut">--:--</td>
                  <td class="p-3 text-sm mono font-black" id="rowStayEq">--:--</td>
                  <td class="p-3 text-sm mono" id="rowOther">0:00</td>
                  <td class="p-3 text-sm mono font-black" id="rowOver">--:--</td>
                  <td class="p-3 text-sm mono font-black" id="rowMonthOver">--:--</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="md:col-span-12 mt-2 small">
            計算式：①在校時間(出勤〜退勤)／②除く時間(休憩+業務外)／③在校等時間=①−②／④時間外在校等時間=③−7:45（休みの日は標準勤務0）。
          </div>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex items-center justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">今日（選択日）の状況</h2>
            <div class="small">全職員の入力状況を一覧で確認できます。</div>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-ghost" onclick="jumpToIndividual()">個別一覧へ</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-left sticky-head">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">氏名</th>
                <th class="p-3 text-xs font-black">区分</th>
                <th class="p-3 text-xs font-black">出勤</th>
                <th class="p-3 text-xs font-black">退勤</th>
                <th class="p-3 text-xs font-black">在校等</th>
                <th class="p-3 text-xs font-black">業務外</th>
                <th class="p-3 text-xs font-black">時間外</th>
                <th class="p-3 text-xs font-black">理由</th>
                <th class="p-3 text-xs font-black no-print">操作</th>
              </tr>
            </thead>
            <tbody id="dailyBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CALENDAR -->
    <section id="section-calendar" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">カレンダー（休みの日のチェック）</h2>
            <div class="small">土日祝は休み（時間外扱い）ですが、登校日・代休等がある場合はここで切り替えます。</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-ghost" onclick="resetWeekendDefaults()">土日を休みに戻す</button>
            <button class="btn btn-ghost" onclick="openHolidayPaste()">祝日を貼り付け</button>
            <button class="btn btn-ghost" onclick="bulkSetWorkday()">選択範囲を勤務日に</button>
            <button class="btn btn-ghost" onclick="bulkSetOffday()">選択範囲を休みに</button>
          </div>
        </div>

        
        <div class="mt-4 flex items-center justify-between gap-2">
          <div class="text-sm font-black">表示月：<span id="calMonthLabel" class="mono">—</span></div>
          <div class="flex gap-2">
            <button type="button" class="btn btn-ghost px-3" id="calPrevBtn" title="前の月">◀</button>
            <button type="button" class="btn btn-ghost px-3" id="calNextBtn" title="次の月">▶</button>
          </div>
        </div>
<div class="mt-4 grid grid-cols-7 gap-2 text-center">
          <div class="text-xs font-black text-gray-500 text-red-600">日</div>
          <div class="text-xs font-black text-gray-500">月</div>
          <div class="text-xs font-black text-gray-500">火</div>
          <div class="text-xs font-black text-gray-500">水</div>
          <div class="text-xs font-black text-gray-500">木</div>
          <div class="text-xs font-black text-gray-500">金</div>
          <div class="text-xs font-black text-gray-500 text-blue-600">土</div></div>

        <div id="calGrid" class="mt-2 grid grid-cols-7 gap-2"></div>

        <div class="mt-4 small">
          ・「休」チェックが <b>ON</b>：休みの日（週休日・祝日・代休など） → その日の在校等時間は <b>すべて時間外</b> に集計。<br/>
          ・「休」チェックが <b>OFF</b>：勤務日（登校日・土曜授業など） → <b>在校等 − 7:45</b> を時間外として集計。
        </div>
      </div>
    </section>

    <!-- OVERVIEW -->
    <section id="section-overview" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">月別 全体一覧（職員別サマリー）</h2>
            <div class="small">Excelの「様式２」イメージ：平日（平均）／週休日等（平均）／当該月（合計）を並べます。</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <input id="ovSearch" class="input w-full md:w-72" placeholder="氏名で絞り込み" oninput="renderOverview()" />
          <select id="ovPattern" class="input w-full md:w-56" onchange="renderOverview()" title="平均/印刷の対象">
            <option value="0">平均対象：全職員</option>
            <option value="1">①</option>
            <option value="2">②</option>
            <option value="3">③</option>
            <option value="4">④</option>
            <option value="5">⑤</option>
          </select>
            <button class="btn btn-ok" onclick="exportMonthExcel()">Excel出力（当月）</button>
            <button class="btn btn-ghost" onclick="window.print()">印刷</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-left sticky-head">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">氏名</th>
                <th class="p-3 text-xs font-black">区分</th>
                <th class="p-3 text-xs font-black">平日 出勤(平均)</th>
                <th class="p-3 text-xs font-black">平日 退勤(平均)</th>
                <th class="p-3 text-xs font-black">平日 在校等(平均)</th>
                <th class="p-3 text-xs font-black">休み 出勤(平均)</th>
                <th class="p-3 text-xs font-black">休み 退勤(平均)</th>
                <th class="p-3 text-xs font-black">休み 在校等(平均)</th>
                <th class="p-3 text-xs font-black">週休日等(合計)</th>
                <th class="p-3 text-xs font-black">当月 時間外(合計)</th>
                <th class="p-3 text-xs font-black">45h/80h</th>
                <th class="p-3 text-xs font-black no-print">詳細</th>
              </tr>
            </thead>
            <tbody id="overviewBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h3 class="font-black">平均（選択した職員の平均）</h3>
            <div class="small">平均計算に含める職員を選べます（複数選択可）。</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <select id="avgPreset" class="input md:w-56" onchange="applyAvgPreset()" title="パターンで選択">
              <option value="0">パターン選択（任意）</option>
              <option value="1">①</option>
              <option value="2">②</option>
              <option value="3">③</option>
              <option value="4">④</option>
              <option value="5">⑤</option>
            </select>
            <select id="avgStaffSelect" multiple class="input min-h-[44px] md:w-[420px]"></select>
            <button class="btn btn-ghost" onclick="selectAllAvg(true)">全選択</button>
            <button class="btn btn-ghost" onclick="selectAllAvg(false)">解除</button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="card p-4">
            <div class="small">平日 出勤（平均）</div>
            <div class="mono text-xl font-black" id="avgWorkIn">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">平日 退勤（平均）</div>
            <div class="mono text-xl font-black" id="avgWorkOut">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">平日 在校等（平均）</div>
            <div class="mono text-xl font-black" id="avgWorkStayEq">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">当月 時間外（平均合計）</div>
            <div class="mono text-xl font-black" id="avgMonthOver">--:--</div>
          </div>
        </div>

        <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="font-black">当月 時間外（職員別）</div>
              <div class="small">45h・80h を線で意識</div>
            </div>
            <canvas id="chartMonthOver" height="180"></canvas>
          </div>
          <div class="card p-4">
            <div class="flex items-center justify-between">
              <div class="font-black">日別 合計時間外（全体）</div>
              <div class="small">勤務日=超過 / 休み=そのまま</div>
            </div>
            <canvas id="chartDailyTotal" height="180"></canvas>
          </div>
        </div>
      </div>
    </section>

    <!-- INDIVIDUAL -->
    <section id="section-individual" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">月別 個別一覧</h2>
            <div class="small">日ごとの「在校等時間」「時間外」を確認。必要なら「業務外(除く)」もここで編集できます。</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <select id="indStaff" class="input md:w-72" onchange="renderIndividual()"></select>
            <button class="btn btn-ghost" onclick="openIndEditHelp()">業務外の編集について</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-left sticky-head">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">日付</th>
                <th class="p-3 text-xs font-black">区分</th>
                <th class="p-3 text-xs font-black">出勤</th>
                <th class="p-3 text-xs font-black">退勤</th>
                <th class="p-3 text-xs font-black">在校等</th>
                <th class="p-3 text-xs font-black">時間外</th>
                <th class="p-3 text-xs font-black">業務外(除く)</th>
                <th class="p-3 text-xs font-black no-print">操作</th>
              </tr>
            </thead>
            <tbody id="indBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="section-settings" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">設定（このタブで月・勤務条件を調整）</h2>
            <div class="small">「月の設定は設定画面で」：入力タブは極力シンプルに保ちます。</div>
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-ghost" onclick="backupJSON()">バックアップ(JSON)</button>
            <button class="btn btn-ghost" onclick="restoreJSON()">復元(JSON)</button>
            <button class="btn btn-danger" onclick="resetAll()">全データ初期化</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-4">
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">年</label>
            <input id="setYear" type="number" class="input" min="2000" max="2100" />
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">月</label>
            <input id="setMonth" type="number" class="input" min="1" max="12" />
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">正規勤務時間（分）</label>
            <input id="setStdMin" type="number" class="input" min="0" max="1440" />
            <div class="small mt-1">既定：7:45 = 465分</div>
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">休憩（分）</label>
            <div class="grid grid-cols-1 gap-2">
              <input id="setBreakMin" type="number" class="input" min="0" max="300" />
            </div>
            <div class="small mt-1">既定：45分（設定で変更できます）</div>
          </div>

          <div class="md:col-span-12 flex flex-wrap gap-2 items-center">
            <button class="btn btn-primary" onclick="applySettings()">設定を反映</button>
            <span class="small">※反映すると、カレンダーと一覧が再計算されます。</span>
          </div>
        </div>
      </div>

      <div class="card p-5">
        <h3 class="font-black mb-2">職員（最大50名）</h3>
        <div class="small mb-4">Excelの原本に合わせて「区分（校長/教頭/教員等/事務 等）」も持てます。</div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
          <div class="md:col-span-4">
            <label class="block text-sm font-bold mb-1">氏名</label>
            <input id="newStaffName" class="input" placeholder="例：山田 太郎" />
          </div>
          <div class="md:col-span-4">
            <label class="block text-sm font-bold mb-1">区分</label>
            <select id="newStaffRole" class="input">
              <option value="教員等">教員等</option>
              <option value="副校長・教頭">副校長・教頭</option>
              <option value="校長">校長</option>
              <option value="事務">事務</option>
              <option value="その他">その他</option>
            </select>
          </div>
          <div class="md:col-span-4">
            <label class="block text-sm font-bold mb-1">パターン（平均/印刷）</label>
            <select id="newStaffPattern" class="input">
              <option value="1">①</option>
              <option value="2">②</option>
              <option value="3" selected>③</option>
              <option value="4">④</option>
              <option value="5">⑤</option>
            </select>
          </div>

          <div class="md:col-span-4 flex gap-2">
            <button class="btn btn-primary w-full" onclick="addStaff()">追加</button>
            <button class="btn btn-ghost w-full" onclick="sortStaff()">並び替え</button>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left sticky-head">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">No</th>
                <th class="p-3 text-xs font-black">氏名</th>
                <th class="p-3 text-xs font-black">区分</th>
                <th class="p-3 text-xs font-black">パターン</th>
                <th class="p-3 text-xs font-black no-print">操作</th>
              </tr>
            </thead>
            <tbody id="staffBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h3 class="font-black">Excel（原本）から取り込み</h3>
            <div class="small">あなたの.xlsm から「職員」「月」「出勤/退勤」「週休日在校」「業務外(除く)」「主な理由」を自動で読み取ります。</div>
          </div>
          <div class="flex gap-2">
            <input id="excelFile" type="file" accept=".xlsx,.xlsm" class="input" />
            <button class="btn btn-primary" onclick="importExcel()">取り込み</button>
          </div>
        </div>

        <div class="mt-3 small text-gray-600">
          取り込み対象シート（固定名を想定）：
          <span class="mono">設定シート / 出退勤時刻等入力 / 週休日在校時間入力 / 1〜(個人シート)</span>
        </div>
      
      <div class="card p-5">
        <h3 class="font-black mb-2">業務外の理由（学校で編集）</h3>
        <div class="small mb-3">入力タブの「理由」一覧に反映されます。形式：<span class="mono">番号|内容</span>（1行=1項目）</div>
        <textarea id="setReasons" class="input mono" rows="6" placeholder="例) 1|読書の時間"></textarea>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <button class="btn btn-primary" onclick="applyReasons()">理由を反映</button>
          <button class="btn btn-ghost" onclick="resetReasons()">既定に戻す</button>
        </div>
      </div>

      <div class="card p-5">
        <h3 class="font-black mb-2">平均・印刷パターン（5つまで）</h3>
        <div class="small mb-4">例：①校長／②教頭／③その他職員／④事務職を抜いたその他職員／⑤カスタム</div>
        <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
          <input id="pat1" class="input" placeholder="①" />
          <input id="pat2" class="input" placeholder="②" />
          <input id="pat3" class="input" placeholder="③" />
          <input id="pat4" class="input" placeholder="④" />
          <input id="pat5" class="input" placeholder="⑤" />
        </div>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <button class="btn btn-primary" onclick="applyPatternNames()">パターン名を反映</button>
          <button class="btn btn-ghost" onclick="resetPatternNames()">既定に戻す</button>
        </div>
      </div>
</div>
    </section>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-lg opacity-0 transition-opacity pointer-events-none no-print"></div>

    <!-- Modal -->
    <div id="modalWrap" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 no-print">
      <div class="card max-w-2xl w-full p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" id="modalTitle">—</div>
            <div class="small mt-1" id="modalSub">—</div>
          </div>
          <button class="btn btn-ghost" onclick="closeModal()">閉じる</button>
        </div>
        <div class="mt-4" id="modalBody"></div>
        <div class="mt-5 flex justify-end gap-2" id="modalFooter"></div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   Data Model (Excel原本ロジック対応)
   =========================================================
   settings: { year, month, stdMin(7:45), breakWorkMin(45), breakOffMin(0), holidaysText[] }
   staff: [{id, no, name, role}]
   calendar: { "YYYY-MM-DD": { off: true/false } }  // off=true=休み
   records:
     records[dateKey][staffId] = {
       in:"HH:MM"|"", out:"HH:MM"|"",
       over:"H:MM"|"0.5"|""  // 入力（空欄なら自動）
       otherOff:"H:MM"|""    // その他業務外（除く時間）※個別一覧で編集
       reasonCode:number|""  // 主な理由（Excelに合わせて保持）
       holidayStayEq:"H:MM"|"" // 週休日在校時間（直接入力）※Excel取り込み時に使用
     }
*/
const STORE = {
  settings: "wh.settings.v1",
  staff:    "wh.staff.v1",
  calendar: "wh.calendar.v1",
  records:  "wh.records.v1",
};

const DEFAULT_SETTINGS = {
  year: new Date().getFullYear(),
  month: new Date().getMonth()+1,

  // 標準勤務（7:45）
  stdMin: 7*60+45,

  // 休憩（分）※設定画面で変更
  breakMin: 45,

  // 互換用（旧キー）
  breakWorkMin: 45,
  breakOffMin: 0,

  // 祝日（YYYY-MM-DD）
  holidayDates: [],

  // 業務外の理由（学校で編集可能）
  reasons: [
    { code:"1", label:"教師が幅広くその専門性を高めるための学術書や専門書の読書の時間" },
    { code:"2", label:"教科に関する論文の執筆" },
    { code:"3", label:"教科指導や生徒指導に係る自主的な研究会への参加" },
    { code:"4", label:"自らの資質を高めるための資格試験のための勉強の時間" },
    { code:"5", label:"朝早めに出勤して新聞や本を読む時間" },
    { code:"6", label:"所定の勤務外の食事の時間" },
    { code:"7", label:"学校内で実施されるPTA活動に校務としてではなく参加している時間" },
    { code:"8", label:"地域住民等としての立場で学校で行われる地域活動に参加している時間" },
    { code:"9", label:"その他" },
  ],

  // 平均/印刷のパターン（名称は編集可能）
  patternNames: ["校長","教頭","その他職員","事務職を抜いたその他職員","カスタム"],
};

let settings = load(STORE.settings, DEFAULT_SETTINGS);

function normalizeSettings(){
  // breakMin
  if(settings.breakMin==null){
    settings.breakMin = Number(settings.breakWorkMin ?? 45);
  }
  // keep compatibility
  settings.breakWorkMin = Number(settings.breakMin);
  settings.breakOffMin = 0;

  // reasons
  if(!Array.isArray(settings.reasons) || settings.reasons.length===0){
    settings.reasons = DEFAULT_SETTINGS.reasons.slice();
  }else{
    // sanitize
    settings.reasons = settings.reasons
      .map(r=>({code:String(r.code||"").trim(), label:String(r.label||"").trim()}))
      .filter(r=>r.code && r.label);
  }

  // patternNames
  if(!Array.isArray(settings.patternNames) || settings.patternNames.length<5){
    settings.patternNames = (DEFAULT_SETTINGS.patternNames || ["①","②","③","④","⑤"]).slice(0,5);
    while(settings.patternNames.length<5) settings.patternNames.push(`パターン${settings.patternNames.length+1}`);
  }
  save(STORE.settings, settings);
}

function fillReasonSelect(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const opts = ['<option value="">（理由を選択）</option>'].concat(
    (settings.reasons||[]).map(r=>{
      const txt = `${escapeHtml(r.code)}：${escapeHtml(r.label)}`;
      return `<option value="${escapeAttr(r.code)}">${txt}</option>`;
    })
  );
  sel.innerHTML = opts.join("");
}

function reasonLabel(code){
  const c = String(code||"").trim();
  const r = (settings.reasons||[]).find(x=>String(x.code)===c);
  return r ? `${r.code}：${r.label}` : c;
}

function fillReasonEditor(){
  const ta = document.getElementById("setReasons");
  if(!ta) return;
  ta.value = (settings.reasons||[]).map(r=>`${r.code}|${r.label}`).join("\n");
}

function applyReasons(){
  const ta = document.getElementById("setReasons");
  if(!ta) return;
  const lines = ta.value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const parsed = [];
  for(const line of lines){
    const parts = line.split("|");
    if(parts.length>=2){
      const code = parts[0].trim();
      const label = parts.slice(1).join("|").trim();
      if(code && label) parsed.push({code, label});
      continue;
    }
    const parts2 = line.split("=>");
    if(parts2.length>=2){
      const code = parts2[0].trim();
      const label = parts2.slice(1).join("=>").trim();
      if(code && label) parsed.push({code, label});
    }
  }
  if(parsed.length===0){ toast("理由の形式が不正です（例: 1|読書の時間）"); return; }
  settings.reasons = parsed;
  save(STORE.settings, settings);
  fillReasonSelect("inpReason");
  toast("理由を反映しました");
}

function resetReasons(){
  settings.reasons = DEFAULT_SETTINGS.reasons.slice();
  save(STORE.settings, settings);
  fillReasonEditor();
  fillReasonSelect("inpReason");
  toast("既定に戻しました");
}

function fillPatternEditor(){
  const names = settings.patternNames || DEFAULT_SETTINGS.patternNames;
  for(let i=1;i<=5;i++){
    const el = document.getElementById("pat"+i);
    if(el) el.value = names?.[i-1] || "";
  }
  const sel = document.getElementById("newStaffPattern");
  if(sel){
    [...sel.options].forEach((o,idx)=>{
      o.textContent = `${idx+1===1?"①":idx+1===2?"②":idx+1===3?"③":idx+1===4?"④":"⑤"} ${names?.[idx]||""}`.trim();
    });
  }
}

function applyPatternNames(){
  const names = [];
  for(let i=1;i<=5;i++){
    const v = (document.getElementById("pat"+i)?.value || "").trim();
    names.push(v || DEFAULT_SETTINGS.patternNames[i-1] || `パターン${i}`);
  }
  settings.patternNames = names;
  save(STORE.settings, settings);
  renderStaffTable();
  fillPatternEditor();
  toast("パターン名を反映しました");
}

function resetPatternNames(){
  settings.patternNames = DEFAULT_SETTINGS.patternNames.slice();
  save(STORE.settings, settings);
  renderStaffTable();
  fillPatternEditor();
  toast("既定に戻しました");
}

function setStaffPattern(staffId, val){
  const s = staff.find(x=>x.id===staffId);
  if(!s) return;
  s.pattern = Number(val||3);
  save(STORE.staff, staff);
  toast("パターンを更新しました");
}


let staff = load(STORE.staff, [
  {id: uid(), no: 1, name: "管理者", role: "その他"},
  {id: uid(), no: 2, name: "教職員A", role: "教員等"},
  {id: uid(), no: 3, name: "教職員B", role: "教員等"},
]);
let calendar = load(STORE.calendar, {}); // dateKey => {off:true/false}
let records  = load(STORE.records, {});  // dateKey => { staffId => entry }

let charts = { monthOver:null, dailyTotal:null };

/* =========================
   Utilities
   ========================= */
function uid(){ return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
function saveAll(){ save(STORE.settings, settings); save(STORE.staff, staff); save(STORE.calendar, calendar); save(STORE.records, records); }
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function load(key, fallback){
  try{ const v = JSON.parse(localStorage.getItem(key)); return (v ?? fallback); }catch{ return fallback; }
}
function toast(msg){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.remove("opacity-0");
  setTimeout(()=>t.classList.add("opacity-0"), 2600);
}
function pad2(n){ return String(n).padStart(2,"0"); }
function dateKeyFromParts(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
function parseTimeToMin(hhmm){
  if(!hhmm) return null;
  const m = /^(\d{1,2}):(\d{2})$/.exec(hhmm.trim());
  if(!m) return null;
  const h = Number(m[1]), mi=Number(m[2]);
  if(h<0||h>47||mi<0||mi>59) return null;
  return h*60 + mi;
}
function formatClock(min){
  if(min==null || isNaN(min)) return "";
  min = Math.round(min);
  let h = Math.floor(min/60) % 24;
  let m = min % 60;
  return `${pad2(h)}:${pad2(m)}`;
}
function formatDur(min){
  if(min==null || isNaN(min)) return "--:--";
  min = Math.round(min);
  const h = Math.floor(min/60);
  const m = Math.abs(min % 60);
  return `${h}:${pad2(m)}`;
}
function parseDurationToMin(s){
  if(!s) return null;
  const t = s.toString().trim();
  if(!t) return null;

  // H:MM
  const m = /^(\d{1,3}):(\d{2})$/.exec(t);
  if(m){
    const h = Number(m[1]), mi=Number(m[2]);
    if(mi<0||mi>59) return null;
    return h*60+mi;
  }
  // decimal hours (e.g. 0.5)
  if(/^\d+(\.\d+)?$/.test(t)){
    return Math.round(Number(t)*60);
  }
  return null;
}
function minutesDiff(inMin, outMin){
  if(inMin==null || outMin==null) return null;
  let diff = outMin - inMin;
  if(diff < 0) diff += 24*60; // overnight safety
  return diff;
}
function dowLabel(dateObj){
  const w = ["日","月","火","水","木","金","土"][dateObj.getDay()];
  return w;
}
function isWeekend(dateObj){
  const d = dateObj.getDay();
  return d===0 || d===6;
}
function getMonthInfo(){
  const y = Number(settings.year), m = Number(settings.month);
  const daysInMonth = new Date(y, m, 0).getDate();
  const firstDow = new Date(y, m-1, 1).getDay(); // 0=Sun
  return {y,m,daysInMonth,firstDow};
}

function safeCall(fn){ try{ fn&&fn(); }catch(e){ console.error(e); } }

function setMonthByDelta(delta){
  // delta: -1 / +1
  let y = Number(settings.year), m = Number(settings.month);
  m += delta;
  if(m<=0){ m = 12; y--; }
  if(m>=13){ m = 1; y++; }

  settings.year = y;
  settings.month = m;
  save(STORE.settings, settings);

  // settings form sync (if exists)
  const fy = document.getElementById("setYear");
  const fm = document.getElementById("setMonth");
  if(fy) fy.value = String(y);
  if(fm) fm.value = String(m).padStart(2,"0");

  // update month labels immediately
  const calLab = document.getElementById("calMonthLabel");
  if(calLab) calLab.textContent = `${y}年${String(m).padStart(2,"0")}月`;

  // input date stays in-month (clamp day)
  const inp = document.getElementById("inpDate");
  if(inp){
    const base = inp.value ? getDateObj(inp.value) : new Date();
    const day = base.getDate();
    const last = new Date(y, m, 0).getDate();
    inp.value = toDateKey(new Date(y, m-1, Math.min(day, last)));
  }

  // Force immediate calendar refresh (矢印問題対策)
  safeCall(renderCalendar);

  // refresh all dependent views
  setTimeout(()=>{ safeCall(renderAll); }, 0);
}

function bindMonthNav(){
  const hook = (id, delta)=>{
    const el = document.getElementById(id);
    if(!el) return;
    const fn = (ev)=>{ ev.preventDefault(); ev.stopPropagation(); setMonthByDelta(delta); };
    el.addEventListener("click", fn);
    el.addEventListener("pointerup", fn);
  };
  hook("btnPrevMonth", -1);
  hook("btnNextMonth",  1);
  hook("calPrevBtn", -1);
  hook("calNextBtn",  1);
}

function getDateObj(dateKey){
  const [y,m,d]=dateKey.split("-").map(Number);
  return new Date(y, m-1, d);
}
function defaultOff(dateKey){
  const d = getDateObj(dateKey);
  // 土日 + 設定した祝日 を休みに
  if(isWeekend(d)) return true;
  if((settings.holidayDates||[]).includes(dateKey)) return true;
  return false;
}
function isOffday(dateKey){
  if(calendar[dateKey] && typeof calendar[dateKey].off === "boolean") return !!calendar[dateKey].off;
  return defaultOff(dateKey);
}
function setOffday(dateKey, off){
  calendar[dateKey] = { off: !!off };
  save(STORE.calendar, calendar);
}

/* =========================
   Core calculations (Excel準拠)
   ========================= */
function getEntry(dateKey, staffId){
  if(!records[dateKey]) records[dateKey] = {};
  if(!records[dateKey][staffId]) records[dateKey][staffId] = { in:"", out:"", over:"", otherOff:"", reasonCode:"", holidayStayEq:"" };
  return records[dateKey][staffId];
}

function calcFor(dateKey, staffId){
  const e = getEntry(dateKey, staffId);
  const off = isOffday(dateKey);

  // ① 在校時間 = 出勤から退勤まで
  const inMin  = parseTimeToMin(e.in);
  const outMin = parseTimeToMin(e.out);
  const stayRaw = minutesDiff(inMin, outMin);

  // ② 除く時間 = 休憩（設定）+ 業務外
  const breakMin = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);
  const otherOffMin = parseDurationToMin(e.otherOff) || 0;
  const exclude = (stayRaw==null && parseDurationToMin(e.holidayStayEq)==null) ? null : (breakMin + otherOffMin);

  // base minutes (在校時間) — offday direct input fallback
  const holidayDirect = parseDurationToMin(e.holidayStayEq);
  const baseStay = (stayRaw!=null) ? stayRaw : (holidayDirect!=null ? holidayDirect : null);

  // ③ 在校等時間 = ① - ②
  const stayEq = (baseStay==null) ? null : Math.max(0, baseStay - breakMin - otherOffMin);

  // ④ 時間外在校等時間 = ③ - 7:45（休みの日は標準勤務0として扱う）
  const stdMin = Number(settings.stdMin ?? 465); // 7h45m
  const std = off ? 0 : stdMin;
  const over = (stayEq==null) ? null : Math.max(0, stayEq - std);

  return { off, inMin, outMin, stayRaw: baseStay, breakMin, otherOffMin, exclude, stayEq, over };
}

function monthAggByStaff(staffId){
  const {y,m,daysInMonth} = getMonthInfo();
  const arr = [];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const c = calcFor(key, staffId);
    const ent = getEntry(key, staffId);
    const hasAny = !!(ent.in || ent.out || ent.over || ent.otherOff || ent.holidayStayEq);
    arr.push({dateKey:key, day:d, dow:dowLabel(getDateObj(key)), ...c, ent, hasAny});
  }
  return arr;
}

function summaryByStaff(staffId){
  const days = monthAggByStaff(staffId);

  const work = days.filter(x => !x.off && x.hasAny);
  const off  = days.filter(x =>  x.off && x.hasAny);

  const avg = (vals) => {
    const xs = vals.filter(v => v!=null && !isNaN(v));
    if(xs.length===0) return null;
    return xs.reduce((a,b)=>a+b,0) / xs.length;
  };
  const sum = (vals) => vals.filter(v=>v!=null && !isNaN(v)).reduce((a,b)=>a+b,0);

  const avgWorkIn  = avg(work.map(x=>x.inMin));
  const avgWorkOut = avg(work.map(x=>x.outMin));
  const avgWorkStayEq = avg(work.map(x=>x.stayEq));

  const avgOffIn  = avg(off.map(x=>x.inMin));
  const avgOffOut = avg(off.map(x=>x.outMin));
  const avgOffStayEq = avg(off.map(x=>x.stayEq));

  const totalOffStayEq = sum(off.map(x=>x.stayEq));  // 週休日等 在校等（合計）
  const totalOver = sum(days.map(x=>x.over));        // 当該月 時間外（合計）

  return {
    avgWorkIn, avgWorkOut, avgWorkStayEq,
    avgOffIn, avgOffOut, avgOffStayEq,
    totalOffStayEq, totalOver,
    over45: totalOver >= 45*60,
    over80: totalOver >= 80*60
  };
}

function dailyTotalOver(){
  const {y,m,daysInMonth} = getMonthInfo();
  const labels = [];
  const totals = [];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    labels.push(String(d));
    let total = 0;
    for(const s of staff){
      const c = calcFor(key, s.id);
      if(c.over!=null) total += c.over;
    }
    totals.push(total);
  }
  return {labels, totals};
}

/* =========================
   UI Init
   ========================= */
window.addEventListener("load", ()=>{
  startClock();

  // normalize/compat
  normalizeSettings();

  // UI
  hydrateSettingsUI();
  bindMonthNav();

  renderAll();

  // default date to today in current month, else 1st
  const today = new Date();
  const {y,m,daysInMonth} = getMonthInfo();
  let d = 1;
  if(today.getFullYear()===y && (today.getMonth()+1)===m){
    d = today.getDate();
  }
  const inpDate = document.getElementById("inpDate");
  if(inpDate) inpDate.value = dateKeyFromParts(y,m,d);

  // selectors
  fillStaffSelects();
  syncInputFromEntry();

  // views
  renderDaily();
  renderCalendar();
  renderOverview();
  renderIndividual();
  initCharts();
  updateCharts();
});

/* =========================
   Clock
   ========================= */
function startClock(){
  const tick = ()=>{
    const now = new Date();
    const timeStr = now.toLocaleTimeString("ja-JP", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    const dateStr = now.toLocaleDateString("ja-JP", {year:"numeric", month:"2-digit", day:"2-digit", weekday:"short"});
    document.getElementById("nowTime").textContent = timeStr;
    document.getElementById("nowDate").textContent = dateStr;
  };
  tick();
  setInterval(tick, 1000);
}

/* =========================
   Tab
   ========================= */
function switchTab(tab){
  const tabs = ["input","calendar","overview","individual","settings"];
  for(const t of tabs){
    document.getElementById(`section-${t}`).classList.toggle("hidden", t!==tab);
    document.getElementById(`tab-${t}`).classList.toggle("active", t===tab);
  }
  if(tab==="calendar") renderCalendar();
  if(tab==="overview"){ renderOverview(); updateCharts(); }
  if(tab==="individual") renderIndividual();
  if(tab==="settings"){ hydrateSettingsUI(); renderStaffTable(); }
}

/* =========================
   Populate selects and header chips
   ========================= */
function fillStaffSelects(){
  const sel1 = document.getElementById("inpStaff");
  const sel2 = document.getElementById("indStaff");
  const sel3 = document.getElementById("avgStaffSelect");
  if(!sel1 || !sel2 || !sel3) return;

  const opts = staff.map(s => `<option value="${s.id}">${s.no}. ${escapeHtml(s.name)}</option>`).join("");
  sel1.innerHTML = opts;
  sel2.innerHTML = opts;

  // multi-select (avg)
  sel3.innerHTML = staff.map(s => `<option value="${s.id}" selected>${escapeHtml(s.name)}</option>`).join("");

  sel1.onchange = () => { syncInputFromEntry(); };
  sel2.onchange = () => { renderIndividual(); };
  sel3.onchange = () => { renderAvgBox(); };

  const d = document.getElementById("inpDate");
  if(d) d.onchange = () => { syncInputFromEntry(); renderDaily(); };

  const oth = document.getElementById("inpOtherOff");
  if(oth){
    oth.addEventListener("change", ()=> saveEntry());
    oth.addEventListener("blur", ()=> saveEntry());
  }
  const rs = document.getElementById("inpReason");
  if(rs) rs.onchange = ()=> saveEntry();

  // individual filter refresh
  const indDate = document.getElementById("indDate");
  if(indDate) indDate.onchange = renderIndividual;

  // preset labels
  const preset = document.getElementById("avgPreset");
  if(preset){
    const names = settings.patternNames || DEFAULT_SETTINGS.patternNames;
    const labs = ["①","②","③","④","⑤"];
    for(let i=1;i<=5;i++){
      const opt = preset.querySelector(`option[value="${i}"]`);
      if(opt) opt.textContent = `${labs[i-1]} ${names?.[i-1]||""}`.trim();
    }
    // keep selection
  }
}

function renderHeaderChips(){
  const {y,m,daysInMonth} = getMonthInfo();
  const mm = String(m).padStart(2,"0");
  const chip = document.getElementById("chip-month");
  if(chip){
    chip.textContent = `${y}年${mm}月`;
    chip.classList.add("mono");
  }
  const calLab = document.getElementById("calMonthLabel");
  if(calLab) calLab.textContent = `${y}年${mm}月`;

  // counts
  let work=0, off=0;
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    if(isOffday(key)) off++; else work++;
  }
  const cw = document.getElementById("chip-workday-count");
  const ch = document.getElementById("chip-holiday-count");
  if(cw) cw.textContent = `勤務日: ${work}`;
  if(ch) ch.textContent = `休み: ${off}`;

  const b = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);
  const bw = document.getElementById("miniBreakWork");
  const bo = document.getElementById("miniBreakOff");
  if(bw) bw.textContent = formatDur(b);
  if(bo) bo.textContent = formatDur(b);
}

function renderAll(){
  renderHeaderChips();
  document.getElementById("chip-month").textContent = `${settings.year}年${settings.month}月`;
}

/* =========================
   Input tab behavior
   ========================= */
function stepDate(delta){
  const d = document.getElementById("inpDate").value;
  if(!d) return;
  const dt = getDateObj(d);
  dt.setDate(dt.getDate()+delta);
  // keep within current settings month; if out, clamp
  const {y,m,daysInMonth} = getMonthInfo();
  if(dt.getFullYear()!==y || (dt.getMonth()+1)!==m){
    // clamp
    const newD = Math.min(daysInMonth, Math.max(1, dt.getDate()));
    document.getElementById("inpDate").value = dateKeyFromParts(y,m,newD);
  }else{
    document.getElementById("inpDate").value = dateKeyFromParts(y,m,dt.getDate());
  }
  syncInputFromEntry();
  renderDaily();
}

function fillNow(which){
  const now = new Date();
  const t = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  if(which==="in") document.getElementById("inpIn").value = t;
  if(which==="out") document.getElementById("inpOut").value = t;
  renderInputCalc();
}

function stampNow(which){
  const staffId = document.getElementById("inpStaff")?.value;
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey){ toast("職員と日付を選択してください"); return; }

  fillNow(which);
  // mirror into entry then save
  const e = getEntry(dateKey, staffId);
  if(which==="in") e.in = document.getElementById("inpIn").value;
  if(which==="out") e.out = document.getElementById("inpOut").value;
  save(STORE.records, records);

  saveEntry();
  toast(which==="in" ? "出勤を記録しました" : "退勤を記録しました");
}

function openEditModal(){
  const staffId = document.getElementById("inpStaff")?.value;
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey){ toast("職員と日付を選択してください"); return; }

  const s = staff.find(x=>x.id===staffId);
  const e = getEntry(dateKey, staffId);

  const body = `
    <div class="space-y-3">
      <div class="small text-slate-600">${s? escapeHtml(s.name):""} / ${dateKey}</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-black mb-1">出勤</label>
          <input id="modalIn" type="time" class="input mono" value="${escapeAttr(e.in||"")}" />
        </div>
        <div>
          <label class="block text-sm font-black mb-1">退勤</label>
          <input id="modalOut" type="time" class="input mono" value="${escapeAttr(e.out||"")}" />
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-black mb-1">業務外（時間）</label>
          <input id="modalOther" type="text" class="input mono" placeholder="例: 0:30 / 0.5" value="${escapeAttr(e.otherOff||"")}" />
        </div>
        <div>
          <label class="block text-sm font-black mb-1">業務外の理由</label>
          <select id="modalReason" class="input"></select>
        </div>
      </div>

      <details class="mt-2">
        <summary class="small font-black cursor-pointer">（必要な場合）週休日の在校時間を直接入力</summary>
        <div class="mt-2">
          <label class="block text-sm font-black mb-1">週休日勤務時間（出勤/退勤が無い場合）</label>
          <input id="modalHolidayStay" type="text" class="input mono" placeholder="例: 2:00" value="${escapeAttr(e.holidayStayEq||"")}" />
          <div class="small mt-1 text-slate-600">※出勤/退勤が入力されている場合は、そちらから在校時間を算出します。</div>
        </div>
      </details>

      <div class="small text-slate-600">保存すると、入力・一覧・集計に即反映されます。</div>
    </div>
  `;

  openModal("編集", "出勤／退勤／業務外（理由）を修正できます。", body, [
    { label:"保存", className:"btn btn-primary", onClick: saveEditModal },
    { label:"閉じる", className:"btn btn-ghost", onClick: closeModal },
  ]);

  // fill reason options
  fillReasonSelect("modalReason");
  const mr = document.getElementById("modalReason");
  if(mr) mr.value = e.reasonCode || "";
}

function saveEditModal(){
  const staffId = document.getElementById("inpStaff")?.value;
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey) return;

  const e = getEntry(dateKey, staffId);

  e.in  = document.getElementById("modalIn")?.value || "";
  e.out = document.getElementById("modalOut")?.value || "";

  const oth = (document.getElementById("modalOther")?.value || "").trim();
  if(oth){
    const mm = parseDurationToMin(oth);
    if(mm==null){ toast("業務外の形式が不正です（例: 0:30 / 0.5）"); return; }
    e.otherOff = formatDur(mm);
  }else{
    e.otherOff = "";
  }

  e.reasonCode = document.getElementById("modalReason")?.value || "";

  const hs = (document.getElementById("modalHolidayStay")?.value || "").trim();
  if(hs){
    const mm = parseDurationToMin(hs);
    if(mm==null){ toast("週休日勤務時間の形式が不正です（例: 2:00）"); return; }
    e.holidayStayEq = formatDur(mm);
  }else{
    e.holidayStayEq = "";
  }

  save(STORE.records, records);
  closeModal();
  renderInputCalc();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}


function clearField(which){
  if(which==="in"){ const el=document.getElementById("inpIn"); if(el) el.value=""; }
  if(which==="out"){ const el=document.getElementById("inpOut"); if(el) el.value=""; }
  // inpOver は廃止（互換のため残す）
  renderInputCalc();
}

function syncInputFromEntry(){
  const staffId = document.getElementById("inpStaff")?.value || (staff[0]?.id);
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey) return;

  // ensure selects exist
  fillReasonSelect("inpReason");

  renderInputCalc();
}

function renderInputCalc(){
  const dateKey = document.getElementById("inpDate")?.value;
  const staffId = document.getElementById("inpStaff")?.value;
  if(!dateKey || !staffId) return;

  const s = staff.find(x=>x.id===staffId);
  const e = getEntry(dateKey, staffId);

  // reflect entry into hidden time fields (for preview) unless user is in modal
  const hin = document.getElementById("inpIn");
  const hout = document.getElementById("inpOut");
  if(hin) hin.value = e.in || "";
  if(hout) hout.value = e.out || "";

  // otherOff input
  const io = document.getElementById("inpOtherOff");
  if(io && io !== document.activeElement) io.value = e.otherOff || "";

  // reason select
  const ir = document.getElementById("inpReason");
  if(ir && ir !== document.activeElement) ir.value = e.reasonCode || "";

  // calc
  const c = calcFor(dateKey, staffId);

  // badge
  const badge = document.getElementById("inpDayBadge");
  if(badge){
    badge.innerHTML = isOffday(dateKey)
      ? `<span class="chip border-amber-200">休み（時間外扱い）</span>`
      : `<span class="chip border-emerald-200">勤務日</span>`;
  }

  // row
  const set = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
  set("rowName", s ? s.name : "—");
  set("rowType", c.off ? "休み" : "勤務日");
  set("rowIn", e.in ? e.in : "--:--");
  set("rowOut", e.out ? e.out : "--:--");
  set("rowOther", e.otherOff ? e.otherOff : "0:00");
  set("rowStayEq", c.stayEq==null ? "--:--" : formatDur(c.stayEq));
  set("rowOver", c.over==null ? "--:--" : formatDur(c.over));

  // month total overtime
  const agg = monthAggByStaff(staffId);
  set("rowMonthOver", formatDur(agg.totalOver || 0));
}

function autoOver(){
  // 互換用：時間外は常に自動計算（入力欄は廃止）
  renderInputCalc();
}

function saveEntry(){
  const staffId = document.getElementById("inpStaff")?.value;
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey) return;

  const e = getEntry(dateKey, staffId);
  e.in  = document.getElementById("inpIn")?.value || e.in || "";
  e.out = document.getElementById("inpOut")?.value || e.out || "";

  // 業務外
  const oth = (document.getElementById("inpOtherOff")?.value || "").trim();
  if(oth){
    const mm = parseDurationToMin(oth);
    if(mm==null){ toast("業務外の形式が不正です（例: 0:30 / 0.5）"); return; }
    e.otherOff = formatDur(mm);
  }else{
    e.otherOff = "";
  }

  // 理由
  const rc = document.getElementById("inpReason")?.value || "";
  e.reasonCode = rc;

  save(STORE.records, records);
  renderInputCalc();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

function jumpToIndividual(){
  // set individual staff select to current staff
  const staffId = document.getElementById("inpStaff").value;
  document.getElementById("indStaff").value = staffId;
  switchTab("individual");
}

function fillAllAutoOver(){
  const dateKey = document.getElementById("inpDate").value;
  if(!dateKey) return;
  let changed = 0;
  for(const s of staff){
    const e = getEntry(dateKey, s.id);
    if(!e.over){
      const c = calcFor(dateKey, s.id);
      if(c.over!=null){
        e.over = formatDur(c.over);
        changed++;
      }
    }
  }
  save(STORE.records, records);
  toast(`自動計算で ${changed} 件を補完しました`);
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

/* =========================
   Daily table
   ========================= */
function renderDaily(){
  const dateKey = document.getElementById("inpDate")?.value;
  const tbody = document.getElementById("dailyBody");
  if(!tbody) return;
  if(!dateKey){ tbody.innerHTML=""; return; }

  const off = isOffday(dateKey);
  const badge = off ? `<span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span>休み</span>`
                    : `<span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>勤務</span>`;

  tbody.innerHTML = staff.map(s=>{
    const c = calcFor(dateKey, s.id);
    const e = getEntry(dateKey, s.id);

    const stayEq = (c.stayEq==null) ? "—" : `<span class="mono font-black">${formatDur(c.stayEq)}</span>`;
    const over = (c.over==null) ? "—" : `<span class="mono ${c.over>0? "text-red-600 font-black":"text-gray-700"}">${formatDur(c.over)}</span>`;
    const other = e.otherOff ? `<span class="mono">${escapeHtml(e.otherOff)}</span>` : `<span class="mono text-gray-400">0:00</span>`;
    const reason = e.reasonCode ? `<span class="text-xs">${escapeHtml(reasonLabel(e.reasonCode))}</span>` : `<span class="text-xs text-gray-400">—</span>`;

    return `
      <tr>
        <td class="p-3 text-sm font-bold">${escapeHtml(s.name)}</td>
        <td class="p-3 text-sm">${badge}</td>
        <td class="p-3 text-sm mono">${escapeHtml(e.in||"---")}</td>
        <td class="p-3 text-sm mono">${escapeHtml(e.out||"---")}</td>
        <td class="p-3 text-sm">${stayEq}</td>
        <td class="p-3 text-sm">${other}</td>
        <td class="p-3 text-sm">${over}</td>
        <td class="p-3 text-sm">${reason}</td>
        <td class="p-3 text-sm no-print">
          <button type="button" class="btn btn-ghost px-3 py-1" onclick="quickPick('${s.id}')">入力</button>
        </td>
      </tr>
    `;
  }).join("");
}

function quickPick(staffId){
  document.getElementById("inpStaff").value = staffId;
  syncInputFromEntry();
  window.scrollTo({top:0, behavior:"smooth"});
}

/* =========================
   Calendar
   ========================= */
let calSel = {start:null, end:null}; // range selection
function renderCalendar(){
  const grid = document.getElementById("calGrid");
  const {y,m,daysInMonth,firstDow} = getMonthInfo();

  // header chips
  renderHeaderChips();

  // Sunday-first UI: JS getDay is Sun..Sat, so blanks = firstDow
  const shift = firstDow; // number of blanks before day1 (Sun=0)
  const cells = [];

  for(let i=0;i<shift;i++){
    cells.push(`<div class="h-24 md:h-28 rounded-2xl border border-dashed border-gray-200 bg-white/40"></div>`);
  }

  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const dobj = getDateObj(key);
    const off = isOffday(key);
    const dow = dobj.getDay(); // 0..6
    const isSat = dow===6, isSun = dow===0;
    const accent = off ? "bg-amber-50 border-amber-100" : "bg-emerald-50 border-emerald-100";
    const sel = (calSel.start && calSel.end && inRange(key, calSel.start, calSel.end)) ? "ring-2 ring-blue-400" : "";

    const label = ["日","月","火","水","木","金","土"][dow];
    const sub = off ? "休" : "勤";

    cells.push(`
      <button type="button" class="h-24 md:h-28 text-left rounded-2xl border ${accent} ${sel} p-3 hover:brightness-[0.99] transition"
        onpointerdown="calMouseDown('${key}')"
        onpointerenter="calMouseEnter('${key}')"
        onpointerup="calMouseUp()"
        onclick="toggleOffday('${key}')"
        title="クリックで切替／ドラッグで範囲選択"
      >
        <div class="flex items-start justify-between gap-2">
          <div>
            <div class="font-black text-lg leading-none">${d}</div>
            <div class="small mt-1">${label}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="chip ${off? "border-amber-200":"border-emerald-200"}">${sub}</span>
          </div>
        </div>
        <div class="mt-3 small">
          <span class="${isSat? "text-blue-600 font-bold": isSun? "text-red-600 font-bold":"text-gray-500"}">${isSat?"土":isSun?"日":" "}</span>
          <span class="ml-1">${off? "時間外扱い":"勤務日扱い"}</span>
        </div>
      </button>
    `);
  }

  grid.innerHTML = cells.join("");

  // Force repaint (Safari/iPad対策)：矢印クリック直後に描画されない症状を抑止
  grid.style.display = "none";
  void grid.offsetHeight;
  grid.style.display = "grid";
}

let calDragging = false;
function calMouseDown(key){
  calDragging = true;
  calSel.start = key;
  calSel.end = key;
  renderCalendar();
}
function calMouseEnter(key){
  if(!calDragging) return;
  calSel.end = key;
  renderCalendar();
}
function calMouseUp(){
  calDragging = false;
}
function inRange(key, a, b){
  const x = new Date(key).getTime();
  const t1 = new Date(a).getTime();
  const t2 = new Date(b).getTime();
  const lo = Math.min(t1,t2), hi=Math.max(t1,t2);
  return x>=lo && x<=hi;
}
function bulkSetWorkday(){
  if(!calSel.start || !calSel.end){ toast("範囲選択してください（ドラッグ）"); return; }
  applyRangeOff(false);
}
function bulkSetOffday(){
  if(!calSel.start || !calSel.end){ toast("範囲選択してください（ドラッグ）"); return; }
  applyRangeOff(true);
}
function applyRangeOff(off){
  const {y,m,daysInMonth} = getMonthInfo();
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    if(inRange(key, calSel.start, calSel.end)){
      setOffday(key, off);
    }
  }
  toast(`範囲を「${off?"休み":"勤務日"}」にしました`);
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

function toggleOffday(dateKey){
  const nowOff = isOffday(dateKey);
  setOffday(dateKey, !nowOff);
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

function resetWeekendDefaults(){
  const {y,m,daysInMonth} = getMonthInfo();
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const dobj = getDateObj(key);
    if(isWeekend(dobj)){
      calendar[key] = {off:true};
    }else{
      // keep manual entries only for weekdays; if it was weekend override to workday, now reset to off
      if(calendar[key] && calendar[key].off===true && !defaultOff(key)){
        // do nothing
      }
    }
  }
  save(STORE.calendar, calendar);
  toast("土日を休みに戻しました");
  renderCalendar();
  renderOverview();
  updateCharts();
}

function openHolidayPaste(){
  openModal("祝日を貼り付け", "1行1日付（YYYY-MM-DD）で貼り付け → 休みとして扱います。", `
    <textarea id="holidayText" class="input min-h-[160px] mono" placeholder="例:\n2026-02-11\n2026-02-23"></textarea>
    <div class="small mt-2">※土日以外の祝日も「休み」として自動反映できます。</div>
  `, [
    {label:"反映", className:"btn btn-primary", onClick:()=>{
      const raw = document.getElementById("holidayText").value || "";
      const lines = raw.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const ok = [];
      for(const line of lines){
        if(/^\d{4}-\d{2}-\d{2}$/.test(line)) ok.push(line);
      }
      settings.holidayDates = Array.from(new Set([...(settings.holidayDates||[]), ...ok])).sort();
      save(STORE.settings, settings);
      closeModal();
      toast(`祝日 ${ok.length} 件を追加`);
      renderCalendar();
      renderOverview();
      updateCharts();
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal},
  ]);
}

/* =========================
   Overview
   ========================= */
function renderOverview(){
  const q = (document.getElementById("ovSearch")?.value || "").trim();
  const tbody = document.getElementById("overviewBody");
  if(!tbody) return;

  const rows = staff
    .filter(s => !q || s.name.includes(q))
    .map(s=>{
      const sum = summaryByStaff(s.id);
      const warn = sum.over80 ? `<span class="chip"><span class="w-2 h-2 bg-red-600 rounded-full"></span>80+</span>`
                 : sum.over45 ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>45+</span>` : "";

      return `
        <tr>
          <td class="p-3 text-sm font-bold">${escapeHtml(s.name)}</td>
          <td class="p-3 text-sm">${escapeHtml(s.role||"")}</td>
          <td class="p-3 text-sm mono">${sum.avgWorkIn==null? "—": formatClock(sum.avgWorkIn)}</td>
          <td class="p-3 text-sm mono">${sum.avgWorkOut==null? "—": formatClock(sum.avgWorkOut)}</td>
          <td class="p-3 text-sm mono">${sum.avgWorkStayEq==null? "—": formatDur(sum.avgWorkStayEq)}</td>
          <td class="p-3 text-sm mono">${sum.avgOffIn==null? "—": formatClock(sum.avgOffIn)}</td>
          <td class="p-3 text-sm mono">${sum.avgOffOut==null? "—": formatClock(sum.avgOffOut)}</td>
          <td class="p-3 text-sm mono">${sum.avgOffStayEq==null? "—": formatDur(sum.avgOffStayEq)}</td>
          <td class="p-3 text-sm mono">${formatDur(sum.totalOffStayEq)}</td>
          <td class="p-3 text-sm mono font-black ${sum.totalOver>=45*60? "text-red-600": ""}">${formatDur(sum.totalOver)}</td>
          <td class="p-3 text-sm">${warn}</td>
          <td class="p-3 text-sm no-print">
            <button class="btn btn-ghost px-3 py-1" onclick="openDetail('${s.id}')">開く</button>
          </td>
        </tr>
      `;
    });

  tbody.innerHTML = rows.join("");

  renderAvgBox();
}

function openDetail(staffId){
  document.getElementById("indStaff").value = staffId;
  switchTab("individual");
}

function getSelectedAvgStaffIds(){
  const sel = document.getElementById("avgStaffSelect");
  if(!sel) return staff.map(s=>s.id);
  const ids = Array.from(sel.selectedOptions).map(o=>o.value);
  return ids.length ? ids : [];
}

function selectAllAvg(flag){
  const sel = document.getElementById("avgStaffSelect");
  if(!sel) return;
  for(const opt of sel.options) opt.selected = flag;
  renderAvgBox();
}

function applyAvgPreset(){
  const preset = Number(document.getElementById("avgPreset")?.value || 0);
  const sel = document.getElementById("avgStaffSelect");
  if(!sel) return;

  for(const opt of sel.options){
    if(preset===0){ /* keep as is */ }
    else{
      const st = staff.find(x=>x.id===opt.value);
      const p = Number(st?.pattern || 3);
      opt.selected = (p===preset);
    }
  }
  renderAvgBox();
}


function renderAvgBox(){
  const ids = getSelectedAvgStaffIds();
  const sums = ids.map(id=>summaryByStaff(id));

  const avg = (vals)=>{
    const xs = vals.filter(v=>v!=null && !isNaN(v));
    if(!xs.length) return null;
    return xs.reduce((a,b)=>a+b,0)/xs.length;
  };
  const avgTime = (vals)=> avg(vals.map(v=>v==null? null : v));
  const avgDur  = (vals)=> avg(vals.map(v=>v==null? null : v));

  const workIn  = avgTime(sums.map(s=>s.avgWorkIn));
  const workOut = avgTime(sums.map(s=>s.avgWorkOut));
  const workStayEq = avgDur(sums.map(s=>s.avgWorkStayEq));
  const monthOver  = avgDur(sums.map(s=>s.totalOver));

  document.getElementById("avgWorkIn").textContent = (workIn==null? "--:--": formatClock(workIn));
  document.getElementById("avgWorkOut").textContent = (workOut==null? "--:--": formatClock(workOut));
  document.getElementById("avgWorkStayEq").textContent = (workStayEq==null? "--:--": formatDur(workStayEq));
  document.getElementById("avgMonthOver").textContent = (monthOver==null? "--:--": formatDur(monthOver));

  updateCharts();
}

/* =========================
   Individual
   ========================= */
function renderIndividual(){
  const staffId = document.getElementById("indStaff")?.value || staff[0]?.id;
  const tbody = document.getElementById("indBody");
  if(!tbody || !staffId) return;

  const days = monthAggByStaff(staffId);
  tbody.innerHTML = days.map(x=>{
    const kind = x.off ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>休み</span>`
                       : `<span class="chip"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span>勤務</span>`;
    const inStr = x.ent.in ? `<span class="mono">${escapeHtml(x.ent.in)}</span>` : "—";
    const outStr= x.ent.out? `<span class="mono">${escapeHtml(x.ent.out)}</span>` : "—";

    const stayEq = x.stayEq==null? "—" : `<span class="mono">${formatDur(x.stayEq)}</span>`;
    const over   = x.over==null? "—" : `<span class="mono font-black ${x.over>=45*60? "text-red-600": (x.over>0? "text-red-600":"text-gray-700")}">${formatDur(x.over)}</span>`;
    const otherOff = (parseDurationToMin(x.ent.otherOff)==null || !x.ent.otherOff) ? "—" : `<span class="mono">${escapeHtml(x.ent.otherOff)}</span>`;

    return `
      <tr>
        <td class="p-3 text-sm">
          <div class="font-bold">${x.day}日（${x.dow}）</div>
          <div class="small mono">${x.dateKey}</div>
        </td>
        <td class="p-3 text-sm">${kind}</td>
        <td class="p-3 text-sm">${inStr}</td>
        <td class="p-3 text-sm">${outStr}</td>
        <td class="p-3 text-sm">${stayEq}</td>
        <td class="p-3 text-sm">${over}</td>
        <td class="p-3 text-sm">${otherOff}</td>
        <td class="p-3 text-sm no-print">
          <button class="btn btn-ghost px-3 py-1" onclick="jumpInput('${staffId}','${x.dateKey}')">入力</button>
          <button class="btn btn-ghost px-3 py-1" onclick="editOtherOff('${staffId}','${x.dateKey}')">業務外</button>
        </td>
      </tr>
    `;
  }).join("");
}

function jumpInput(staffId, dateKey){
  document.getElementById("inpStaff").value = staffId;
  document.getElementById("inpDate").value = dateKey;
  syncInputFromEntry();
  switchTab("input");
  window.scrollTo({top:0, behavior:"smooth"});
}

function editOtherOff(staffId, dateKey){
  const e = getEntry(dateKey, staffId);
  const c = calcFor(dateKey, staffId);
  openModal("業務外（除く時間）を編集", `${dateKey} / ${staff.find(s=>s.id===staffId)?.name||""}`, `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <div class="text-sm font-bold mb-1">その他業務外（除く時間）</div>
        <input id="editOtherOff" class="input mono" placeholder="例: 0:30（空欄=0）" value="${escapeAttr(e.otherOff||"")}" />
        <div class="small mt-1">在校等時間 = 在校時間 − 休憩 − その他業務外</div>
      </div>
      <div>
        <div class="text-sm font-bold mb-1">主な理由（番号）</div>
        <input id="editReason" class="input mono" placeholder="例: 1" value="${escapeAttr(e.reasonCode||"")}" />
        <div class="small mt-1">※Excelの「主な業務外の時間」コードを保持（必要な学校だけ使う想定）</div>
      </div>
    </div>
    <div class="mt-4 card p-4">
      <div class="small">現状の計算</div>
      <div class="mt-2 flex flex-wrap gap-2">
        <span class="chip">在校時間: <b class="mono">${c.stayRaw==null?"--:--":formatDur(c.stayRaw)}</b></span>
        <span class="chip">休憩: <b class="mono">${formatDur(c.breakMin)}</b></span>
        <span class="chip">在校等: <b class="mono">${c.stayEq==null?"--:--":formatDur(c.stayEq)}</b></span>
        <span class="chip">時間外: <b class="mono">${c.over==null?"--:--":formatDur(c.over)}</b></span>
      </div>
    </div>
  `, [
    {label:"保存", className:"btn btn-primary", onClick:()=>{
      const v = document.getElementById("editOtherOff").value.trim();
      if(v){
        const mm = parseDurationToMin(v);
        if(mm==null){ toast("業務外の形式が不正です（例: 0:30）"); return; }
        e.otherOff = formatDur(mm);
      }else{
        e.otherOff = "";
      }
      const rc = document.getElementById("editReason").value.trim();
      e.reasonCode = rc ? rc : "";

      save(STORE.records, records);
      closeModal();
      toast("保存しました");
      renderIndividual();
      renderDaily();
      renderOverview();
      updateCharts();
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal},
  ]);
}

function openIndEditHelp(){
  openModal("業務外（除く時間）について", "入力タブはスッキリさせるため、除く時間の編集はここで行います。", `
    <div class="space-y-3 text-sm">
      <p>Excel原本では、<b>在校等時間</b>を次の式で計算しています。</p>
      <div class="card p-4 mono">
        在校等時間 = 在校時間 − 休憩時間 − その他業務外の時間
      </div>
      <p>このアプリでも同じ計算をします。日によって「会議待機」「外部業務」など、<b>業務外として除きたい時間</b>がある場合だけ、個別一覧の「業務外」ボタンから入力してください（空欄は 0 扱い）。</p>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick:closeModal}]);
}

/* =========================
   Charts
   ========================= */
function initCharts(){
  const ctx1 = document.getElementById("chartMonthOver")?.getContext("2d");
  const ctx2 = document.getElementById("chartDailyTotal")?.getContext("2d");
  if(ctx1){
    charts.monthOver = new Chart(ctx1, {
      type: "bar",
      data: { labels: [], datasets: [{ label: "当月 時間外（合計）", data: [] }] },
      options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{ticks:{callback:(v)=>minutesToHourLabel(v)}}} }
    });
  }
  if(ctx2){
    charts.dailyTotal = new Chart(ctx2, {
      type: "line",
      data: { labels: [], datasets: [{ label: "日別 合計時間外", data: [], tension: 0.25 }] },
      options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{ticks:{callback:(v)=>minutesToHourLabel(v)}}} }
    });
  }
}
function minutesToHourLabel(min){
  if(min==null) return "";
  const h = (Number(min)/60);
  // 0.5h刻み程度に表示
  return h.toFixed(1);
}
function updateCharts(){
  // Month over by staff (selected)
  if(charts.monthOver){
    const ids = getSelectedAvgStaffIds();
    const labelNames = [];
    const data = [];
    ids.forEach(id=>{
      const s = staff.find(x=>x.id===id);
      if(!s) return;
      const sum = summaryByStaff(id);
      labelNames.push(s.name);
      data.push(sum.totalOver || 0);
    });
    charts.monthOver.data.labels = labelNames;
    charts.monthOver.data.datasets[0].data = data;
    charts.monthOver.update();
  }
  // Daily total over all staff
  if(charts.dailyTotal){
    const {labels, totals} = dailyTotalOver();
    charts.dailyTotal.data.labels = labels;
    charts.dailyTotal.data.datasets[0].data = totals;
    charts.dailyTotal.update();
  }
}

/* =========================
   Settings UI
   ========================= */
function hydrateSettingsUI(){
  const y = document.getElementById("setYear");
  const m = document.getElementById("setMonth");
  const s = document.getElementById("setStdMin");
  const b = document.getElementById("setBreakMin");

  if(y) y.value = settings.year;
  if(m) m.value = String(settings.month).padStart(2,"0");
  if(s) s.value = settings.stdMin;
  if(b) b.value = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);

  renderStaffTable();
  fillStaffSelects();
  fillReasonEditor();
  fillPatternEditor();
  renderHeaderChips();
}

function applySettings(){
  const y = Number(document.getElementById("setYear").value);
  const m = Number(document.getElementById("setMonth").value);
  const std = Number(document.getElementById("setStdMin").value);
  const b = Number(document.getElementById("setBreakMin").value);

  if(!(y>=2000 && y<=2100)){ toast("年が不正です"); return; }
  if(!(m>=1 && m<=12)){ toast("月が不正です"); return; }

  settings.year = y;
  settings.month = m;
  settings.stdMin = Math.max(0, std);

  settings.breakMin = Math.max(0, b);
  // compat
  settings.breakWorkMin = settings.breakMin;
  settings.breakOffMin = 0;

  save(STORE.settings, settings);

  // update date picker to keep in month
  const {daysInMonth} = getMonthInfo();
  const cur = document.getElementById("inpDate")?.value;
  if(cur){
    const dt = getDateObj(cur);
    const newKey = dateKeyFromParts(y,m, Math.min(dt.getDate(), daysInMonth));
    document.getElementById("inpDate").value = newKey;
  }else{
    document.getElementById("inpDate").value = dateKeyFromParts(y,m,1);
  }

  renderAll();
  renderCalendar();
  renderOverview();
  renderIndividual();
  updateCharts();
  toast("設定を保存しました");
}

function addStaff(){
  const name = (document.getElementById("newStaffName").value||"").trim();
  const role = document.getElementById("newStaffRole").value;
  const pat = Number(document.getElementById("newStaffPattern")?.value || 3);

  if(!name){ toast("氏名を入力してください"); return; }
  if(staff.length>=50){ toast("最大50名までです"); return; }

  const no = (staff.reduce((mx,s)=>Math.max(mx, s.no||0), 0) || 0) + 1;
  staff.push({id: uid(), no, name, role, pattern: pat});

  save(STORE.staff, staff);

  document.getElementById("newStaffName").value = "";
  toast("職員を追加しました");

  fillStaffSelects();
  renderStaffTable();
  renderOverview();
  updateCharts();
}

function removeStaff(staffId){
  const s = staff.find(x=>x.id===staffId);
  if(!s) return;
  if(!confirm(`${s.name} を削除しますか？（記録は残ります）`)) return;
  staff = staff.filter(x=>x.id!==staffId);
  save(STORE.staff, staff);
  toast("削除しました");
  fillStaffSelects();
  renderStaffTable();
  renderOverview();
  updateCharts();
}

function sortStaff(){
  staff.sort((a,b)=> (a.no||0)-(b.no||0));
  // reassign No sequentially
  staff.forEach((s,i)=>s.no=i+1);
  save(STORE.staff, staff);
  toast("並び替えしました");
  fillStaffSelects();
  renderStaffTable();
  renderOverview();
}

function renderStaffTable(){
  const tbody = document.getElementById("staffBody");
  if(!tbody) return;
  tbody.innerHTML = staff.map(s=>{
    const p = Number(s.pattern || 3);
    const pname = (settings.patternNames||[])[p-1] || `パターン${p}`;
    return `
      <tr>
        <td class="p-3 text-sm mono">${s.no||""}</td>
        <td class="p-3 text-sm font-bold">${escapeHtml(s.name)}</td>
        <td class="p-3 text-sm">${escapeHtml(s.role||"")}</td>
        <td class="p-3 text-sm">
          <select class="input" style="padding:6px 10px;" onchange="setStaffPattern('${s.id}', this.value)">
            <option value="1" ${p===1?"selected":""}>① ${escapeHtml(settings.patternNames?.[0]||"")}</option>
            <option value="2" ${p===2?"selected":""}>② ${escapeHtml(settings.patternNames?.[1]||"")}</option>
            <option value="3" ${p===3?"selected":""}>③ ${escapeHtml(settings.patternNames?.[2]||"")}</option>
            <option value="4" ${p===4?"selected":""}>④ ${escapeHtml(settings.patternNames?.[3]||"")}</option>
            <option value="5" ${p===5?"selected":""}>⑤ ${escapeHtml(settings.patternNames?.[4]||"")}</option>
          </select>
          <div class="small mt-1 text-slate-500">${escapeHtml(pname)}</div>
        </td>
        <td class="p-3 text-sm no-print">
          <button class="btn btn-ghost px-3 py-1" onclick="removeStaff('${s.id}')">削除</button>
        </td>
      </tr>
    `;
  }).join("");
}

/* =========================
   Export (Excel)
   ========================= */
function exportMonthExcel(){
  const {y,m,daysInMonth} = getMonthInfo();

  // Sheet 1: 月別 全体一覧
  const sheet1 = [["氏名","区分","平日 出勤(平均)","平日 退勤(平均)","平日 在校等(平均)","休み 出勤(平均)","休み 退勤(平均)","休み 在校等(平均)","週休日等(合計)","当月 時間外(合計)","45h超","80h超"]];
  staff.forEach(s=>{
    const sum = summaryByStaff(s.id);
    sheet1.push([
      s.name, s.role||"",
      sum.avgWorkIn==null? "": formatClock(sum.avgWorkIn),
      sum.avgWorkOut==null? "": formatClock(sum.avgWorkOut),
      sum.avgWorkStayEq==null? "": formatDur(sum.avgWorkStayEq),
      sum.avgOffIn==null? "": formatClock(sum.avgOffIn),
      sum.avgOffOut==null? "": formatClock(sum.avgOffOut),
      sum.avgOffStayEq==null? "": formatDur(sum.avgOffStayEq),
      formatDur(sum.totalOffStayEq),
      formatDur(sum.totalOver),
      sum.over45? "○": "",
      sum.over80? "○": ""
    ]);
  });

  // Sheet 2: 月別 個別（全職員・日別）
  const sheet2 = [["日付","曜","勤務/休み","氏名","出勤","退勤","在校時間","休憩","業務外(除く)","在校等時間","時間外在校等時間"]];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const off = isOffday(key);
    const dow = dowLabel(getDateObj(key));
    for(const s of staff){
      const e = getEntry(key, s.id);
      const c = calcFor(key, s.id);
      if(!(e.in||e.out||e.over||e.otherOff||e.holidayStayEq)) continue;
      sheet2.push([
        key, dow, off?"休み":"勤務",
        s.name,
        e.in||"", e.out||"",
        c.stayRaw==null? "": formatDur(c.stayRaw),
        formatDur(c.breakMin),
        e.otherOff||"",
        c.stayEq==null? "": formatDur(c.stayEq),
        c.over==null? "": formatDur(c.over),
      ]);
    }
  }

  // Sheet 3: カレンダー
  const sheet3 = [["日付","曜","休み(1)/勤務(0)"]];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    sheet3.push([key, dowLabel(getDateObj(key)), isOffday(key)?1:0]);
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet1), "月別_全体一覧");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet2), "月別_日別一覧");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet3), "カレンダー");

  const fname = `在校等時間_${y}-${pad2(m)}.xlsx`;
  XLSX.writeFile(wb, fname);
}

/* =========================
   Backup / Restore
   ========================= */
function backupJSON(){
  const data = {settings, staff, calendar, records, exportedAt: new Date().toISOString()};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_working_hours_${settings.year}-${pad2(settings.month)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("バックアップを保存しました");
}

function restoreJSON(){
  openModal("復元（JSON）", "バックアップ(JSON)を貼り付けて復元します。", `
    <textarea id="restoreText" class="input min-h-[200px] mono" placeholder="ここにJSONを貼り付け"></textarea>
    <div class="small mt-2 text-red-600">※現在のデータは上書きされます。必要なら先にバックアップしてください。</div>
  `, [
    {label:"復元", className:"btn btn-danger", onClick:()=>{
      try{
        const obj = JSON.parse(document.getElementById("restoreText").value || "{}");
        if(obj.settings) settings = obj.settings;
        if(obj.staff) staff = obj.staff;
        if(obj.calendar) calendar = obj.calendar;
        if(obj.records) records = obj.records;
        saveAll();
        closeModal();
        toast("復元しました");
        hydrateSettingsUI();
        renderCalendar();
        renderDaily();
        renderOverview();
        renderIndividual();
        syncInputFromEntry();
        updateCharts();
      }catch(e){
        toast("JSONが不正です");
      }
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal}
  ]);
}

function resetAll(){
  if(!confirm("全データを初期化します。よろしいですか？")) return;
  localStorage.removeItem(STORE.settings);
  localStorage.removeItem(STORE.staff);
  localStorage.removeItem(STORE.calendar);
  localStorage.removeItem(STORE.records);
  location.reload();
}

/* =========================
   Excel Import (your original workbook)
   ========================= */
async function importExcel(){
  const file = document.getElementById("excelFile").files?.[0];
  if(!file){ toast("ファイルを選択してください"); return; }

  const buf = await file.arrayBuffer();
  const wb = XLSX.read(buf, {type:"array"});

  const mustSheets = ["設定シート","出退勤時刻等入力","週休日在校時間入力"];
  for(const s of mustSheets){
    if(!wb.Sheets[s]){ toast(`シート「${s}」が見つかりません`); return; }
  }

  // --- read settings: year(K1) month(K2), staff list rows B3.. (No), C3..(Name), A3..(Role)
  const wsSet = wb.Sheets["設定シート"];
  const year = numCell(wsSet, "K1");
  const month= numCell(wsSet, "K2");
  if(year) settings.year = year;
  if(month) settings.month = month;

  // staff rows: 3..27 in original
  const newStaff = [];
  for(let r=3; r<=60; r++){
    const no = numCell(wsSet, "B"+r);
    const name = strCell(wsSet, "C"+r);
    const role = strCell(wsSet, "A"+r);
    if(!no || !name) continue;
    newStaff.push({id: uid(), no, name, role: role || "教員等"});
  }
  if(newStaff.length){
    staff = newStaff.sort((a,b)=>a.no-b.no).slice(0,50);
  }

  // break defaults: O4 has weekday break? In original O4 is 0:45 as time, stored as fraction.
  // We'll try read O4 and O5 for off? but original changes by weekday. We'll keep current settings unless we can infer.
  // Also read standard 7:45 is fixed.

  // --- read 出退勤時刻等入力 matrix: day blocks (出勤/退勤/業務外)
  const wsIO = wb.Sheets["出退勤時刻等入力"];
  // staff headers: row 4 col D.. for names
  const staffStartCol = 4; // D
  // find maximum staff columns by reading row4
  const nameRow = 4;
  // build mapping col -> staffId by matching name
  const colToStaff = {};
  for(let c=staffStartCol; c<staffStartCol+60; c++){
    const addr = XLSX.utils.encode_cell({r:nameRow-1, c:c-1});
    const v = wsIO[addr]?.v;
    const nm = (v||"").toString().trim();
    if(!nm) break;
    const s = staff.find(x=>x.name===nm);
    if(s) colToStaff[c] = s.id;
  }

  // find first "出勤" label in column C
  let startRow = null;
  for(let r=1; r<=200; r++){
    const v = strCell(wsIO, "C"+r);
    if(v==="出勤"){ startRow = r; break; }
  }
  if(!startRow){ toast("出退勤時刻等入力: 出勤行が見つかりません"); return; }

  const {y,m,daysInMonth} = getMonthInfo();
  // prepare records for month
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(settings.year, settings.month, d);
    // rows = startRow + (d-1)*3  : in, out, otherOff
    const rIn  = startRow + (d-1)*3;
    const rOut = rIn + 1;
    const rOff = rIn + 2;

    for(const [col, staffId] of Object.entries(colToStaff)){
      const c = Number(col);
      const inV  = wsIO[XLSX.utils.encode_cell({r:rIn-1, c:c-1})]?.v;
      const outV = wsIO[XLSX.utils.encode_cell({r:rOut-1, c:c-1})]?.v;
      const offV = wsIO[XLSX.utils.encode_cell({r:rOff-1, c:c-1})]?.v;

      const e = getEntry(key, staffId);
      // Excel times are fraction of day; convert to hh:mm
      e.in  = excelTimeToHHMM(inV)  || e.in || "";
      e.out = excelTimeToHHMM(outV) || e.out || "";
      // 業務外 is duration time; convert to h:mm
      const offMin = excelDurationToMin(offV);
      e.otherOff = (offMin!=null && offMin>0) ? formatDur(offMin) : (e.otherOff||"");
    }
  }

  // --- read 週休日在校時間入力: direct stayEq per day per staff
  const wsHol = wb.Sheets["週休日在校時間入力"];
  // header row: 4, staff columns start at D
  const holHeaderRow = 4;
  const holColToStaff = {};
  for(let c=4; c<4+60; c++){
    const addr = XLSX.utils.encode_cell({r:holHeaderRow-1, c:c-1});
    const v = (wsHol[addr]?.v||"").toString().trim();
    if(!v) break;
    const s = staff.find(x=>x.name===v);
    if(s) holColToStaff[c] = s.id;
  }
  // start row: 5
  const holStartRow = 5;
  for(let i=0; i<daysInMonth; i++){
    const r = holStartRow + i;
    // column B has day number possibly empty, skip if blank
    const dayNo = numCell(wsHol, "B"+r);
    if(!dayNo) continue;
    const key = dateKeyFromParts(settings.year, settings.month, dayNo);

    for(const [col, staffId] of Object.entries(holColToStaff)){
      const c = Number(col);
      const v = wsHol[XLSX.utils.encode_cell({r:r-1, c:c-1})]?.v;
      const min = excelDurationToMin(v);
      if(min!=null && min>0){
        const e = getEntry(key, staffId);
        e.holidayStayEq = formatDur(min);
      }
    }
  }

  // --- read reasonCode from personal sheets "1".."50" if exists
  for(const s of staff){
    // guess sheet by staff no if exists
    const sn = String(s.no);
    if(!wb.Sheets[sn]) continue;
    const wsP = wb.Sheets[sn];

    // find first data row where header has "主な業務外の時間" (code column)
    // In original, code is column L, starting row 9. We'll just read L9..L(9+daysInMonth-1)
    for(let d=1; d<=daysInMonth; d++){
      const key = dateKeyFromParts(settings.year, settings.month, d);
      const r = 8 + d; // row9 is d=1
      const code = wsP[XLSX.utils.encode_cell({r:r-1, c:11})]?.v; // L=12th col => index 11
      if(code!=null && code!==""){
        const e = getEntry(key, s.id);
        e.reasonCode = String(code).trim();
      }
    }
  }

  saveAll();
  toast("取り込みが完了しました");
  hydrateSettingsUI();
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  syncInputFromEntry();
  updateCharts();
}

function numCell(ws, addr){
  const v = ws[addr]?.v;
  if(v==null || v==="") return null;
  const n = Number(v);
  return isNaN(n) ? null : n;
}
function strCell(ws, addr){
  const v = ws[addr]?.v;
  if(v==null) return "";
  return String(v).trim();
}
function excelTimeToHHMM(v){
  // Excel serial time (fraction of day) or already string "07:50"
  if(v==null || v==="") return "";
  if(typeof v === "string"){
    const t = v.trim();
    if(/^\d{1,2}:\d{2}$/.test(t)) return normalizeHHMM(t);
    return "";
  }
  if(typeof v === "number"){
    // fraction day
    const totalMin = Math.round(v * 24 * 60);
    return normalizeHHMM(formatClock(totalMin));
  }
  return "";
}
function excelDurationToMin(v){
  if(v==null || v==="") return null;
  if(typeof v === "string"){
    const mm = parseDurationToMin(v.trim());
    return mm;
  }
  if(typeof v === "number"){
    // duration as fraction day
    const totalMin = Math.round(v * 24 * 60);
    return totalMin;
  }
  return null;
}
function normalizeHHMM(t){
  const m = /^(\d{1,2}):(\d{2})$/.exec(t);
  if(!m) return "";
  return `${pad2(Number(m[1])%24)}:${pad2(Number(m[2]))}`;
}

/* =========================
   Modal
   ========================= */
function openModal(title, sub, bodyHtml, actions){
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalSub").textContent = sub;
  document.getElementById("modalBody").innerHTML = bodyHtml;

  const foot = document.getElementById("modalFooter");
  foot.innerHTML = "";
  (actions||[]).forEach(a=>{
    const btn = document.createElement("button");
    btn.className = a.className || "btn btn-ghost";
    btn.textContent = a.label;
    btn.onclick = a.onClick;
    foot.appendChild(btn);
  });

  const wrap = document.getElementById("modalWrap");
  wrap.classList.remove("hidden");
  wrap.classList.add("flex");
}
function closeModal(){
  const wrap = document.getElementById("modalWrap");
  wrap.classList.add("hidden");
  wrap.classList.remove("flex");
}
function openHelp(){
  openModal("使い方（最短）", "“入力は3つだけ”を徹底して、Excelの考え方をそのままアプリにしました。", `
    <div class="space-y-3 text-sm">
      <div class="card p-4">
        <div class="font-bold mb-2">1. 入力</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>「職員」「日付」を選び、<b>出勤</b>・<b>退勤</b>・<b>時間外</b>だけ入力して保存。</li>
          <li>時間外は空欄でもOK（自動計算）。必要なら「自」ボタンで自動値を入れられます。</li>
        </ul>
      </div>
      <div class="card p-4">
        <div class="font-bold mb-2">2. 休みの日の設定（カレンダー）</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>土日祝は「休み」扱い。登校日・代休などはクリックで切り替え。</li>
          <li>休みの日は <b>在校等時間＝時間外</b> として集計します。</li>
        </ul>
      </div>
      <div class="card p-4">
        <div class="font-bold mb-2">3. 一覧・出力</div>
        <ul class="list-disc ml-5 space-y-1">
          <li>「月別 全体一覧」で、職員別の平日/休みの平均・当月合計（時間外）を確認。</li>
          <li>Excel出力で、当月の集計をそのまま保存できます。</li>
        </ul>
      </div>
      <div class="small text-gray-600">
        ※Excel原本の「業務外（除く時間）」を使いたい場合は、個別一覧の「業務外」から入力できます（入力画面を簡単にするため分離しています）。
      </div>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick:closeModal}]);
}

/* =========================
   Helpers
   ========================= */
function escapeHtml(s){
  return (s??"").toString().replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

/* =========================
   Hooks (re-render when changing input)
   ========================= */
function renderAvgBoxDebounced(){
  renderAvgBox();
}
</script>
</body>
</html>
