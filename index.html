<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>在校等時間管理（秋田モデル準拠 / 月別一覧 / 出力 / 設定集約）</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", sans-serif; }
    .tab-active{ border-bottom:3px solid #2563eb; color:#2563eb; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .no-print{ display:block; }
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff !important; }
      .print-card{ box-shadow:none !important; border:1px solid #e5e7eb !important; }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen">
  <div class="max-w-6xl mx-auto px-4 py-8">

    <!-- Header -->
    <header class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="text-2xl font-extrabold text-gray-900 tracking-tight">在校等時間管理システム</h1>
        <p class="text-sm text-gray-500 mt-1">
          秋田モデル：在校等＝滞在−(休憩＋除外) ／ 時間外在校等＝（勤務日）max(0,在校等−基準) ／（休日扱い）在校等そのまま
        </p>
      </div>

      <div class="flex items-center justify-between md:justify-end gap-4">
        <div class="text-right">
          <div class="text-xs text-gray-500">現在時刻</div>
          <div id="current-time" class="mono text-2xl font-extrabold text-blue-600"></div>
        </div>

        <div class="no-print flex gap-2">
          <button onclick="exportBackupJSON()" class="px-3 py-2 rounded-xl bg-gray-900 text-white text-sm hover:bg-gray-800 font-semibold">バックアップ</button>
          <label class="px-3 py-2 rounded-xl bg-white border border-gray-200 text-sm hover:bg-gray-50 cursor-pointer font-semibold">
            復元<input id="backupFile" type="file" accept="application/json" class="hidden" onchange="importBackupJSON(event)">
          </label>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="flex space-x-4 mb-6 border-b border-gray-200 no-print mt-6">
      <button onclick="switchTab('input')" id="tab-input" class="py-2 px-4 font-semibold tab-active">入力</button>
      <button onclick="switchTab('monthly')" id="tab-monthly" class="py-2 px-4 font-semibold text-gray-500">月別一覧</button>
      <button onclick="switchTab('settings')" id="tab-settings" class="py-2 px-4 font-semibold text-gray-500">設定</button>
    </div>

    <!-- 1) INPUT (super simple) -->
    <section id="section-input" class="space-y-6">
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 w-full">
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">職員</label>
              <select id="staff-select" class="w-full border rounded-xl p-2.5 focus:ring-2 focus:ring-blue-500 outline-none"
                      onchange="refreshInputSummary(); refreshTodayTable();"></select>
            </div>
            <div>
              <label class="block text-sm font-semibold text-gray-700 mb-1">日付</label>
              <input type="date" id="target-date" class="w-full border rounded-xl p-2.5"
                     onchange="refreshInputSummary(); refreshTodayTable();">
            </div>
            <div class="no-print">
              <label class="block text-sm font-semibold text-gray-700 mb-1">編集</label>
              <button onclick="openEditModal()" class="w-full bg-gray-900 text-white py-2.5 rounded-xl hover:bg-gray-800 font-semibold">
                まとめて入力（詳細）
              </button>
            </div>
          </div>

          <div class="no-print flex gap-2 md:min-w-[280px]">
            <button onclick="stampNow('in')" class="flex-1 bg-blue-600 text-white py-3 rounded-xl hover:bg-blue-700 font-extrabold">
              出勤（今）
            </button>
            <button onclick="stampNow('out')" class="flex-1 bg-rose-600 text-white py-3 rounded-xl hover:bg-rose-700 font-extrabold">
              退勤（今）
            </button>
          </div>
        </div>

        <div class="mt-4 rounded-2xl border bg-gray-50 p-4">
          <div class="text-sm font-extrabold text-gray-900">この日の状況（選択職員）</div>
          <div id="input-summary" class="mt-2 text-sm text-gray-700">---</div>
          <div class="mt-3 no-print flex flex-wrap gap-2">
            <button onclick="quickAdjust(-5)" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold">±5分調整</button>
            <button onclick="clearOneRecord()" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold text-rose-600">この記録を削除</button>
            <button onclick="copyPrevDay()" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold">前日を複製（全員）</button>
          </div>
          <div class="text-xs text-gray-500 mt-2">
            ※月や基準時間などの設定は「設定」タブに集約しています。
          </div>
        </div>
      </div>

      <!-- Today's table (collapsible) -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex items-center justify-between gap-3">
          <div class="text-lg font-extrabold text-gray-900">日別：全体一覧（この日）</div>
          <div class="no-print flex gap-2">
            <button onclick="toggleTodayPanel()" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold" id="todayToggleBtn">
              表示/非表示
            </button>
            <button onclick="printDaily()" class="px-3 py-2 rounded-xl bg-gray-900 text-white hover:bg-gray-800 text-sm font-semibold">
              日別印刷
            </button>
          </div>
        </div>

        <div id="todayPanel" class="mt-4 overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 text-xs font-extrabold text-gray-600">氏名</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">出勤</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">退勤</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">在校（滞在）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">在校等</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">時間外在校等</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">週休日勤務</th>
              </tr>
            </thead>
            <tbody id="today-table-body" class="divide-y divide-gray-100"></tbody>
          </table>

          <div class="text-xs text-gray-500 mt-3">
            休日扱いの日は「在校等＝時間外在校等」。代休や登校日などは「設定＞勤務日カレンダー上書き」で調整できます。
          </div>
        </div>
      </div>
    </section>

    <!-- 2) MONTHLY -->
    <section id="section-monthly" class="hidden space-y-6">

      <!-- Month header + export -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 no-print">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <div class="text-xs text-gray-500 font-semibold">集計対象月（変更は設定で）</div>
            <div class="text-2xl font-extrabold text-gray-900 mt-1" id="monthTitle">----</div>
            <div class="text-sm text-gray-600 mt-1" id="monthSub">---</div>
          </div>

          <div class="flex flex-wrap gap-2">
            <button onclick="switchTab('settings'); scrollToMonthSetting()" class="px-4 py-2.5 rounded-xl bg-white border border-gray-200 hover:bg-gray-50 font-semibold">
              月・基準などを設定
            </button>
            <button onclick="exportMonthExcel()" class="px-4 py-2.5 rounded-xl bg-green-600 text-white hover:bg-green-700 font-semibold">
              Excel出力（設定の月）
            </button>
            <button onclick="exportMonthCSV()" class="px-4 py-2.5 rounded-xl bg-emerald-700 text-white hover:bg-emerald-800 font-semibold">
              CSV出力（設定の月）
            </button>
            <button onclick="window.print()" class="px-4 py-2.5 rounded-xl bg-gray-900 text-white hover:bg-gray-800 font-semibold">
              印刷
            </button>
          </div>
        </div>

        <div class="mt-4 grid grid-cols-1 md:grid-cols-4 gap-3">
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="text-xs text-gray-500 font-semibold">当月：時間外在校等</div>
            <div id="kpi_ot" class="text-2xl font-extrabold text-rose-700 mt-1">0.00h</div>
          </div>
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="text-xs text-gray-500 font-semibold">当月：在校等</div>
            <div id="kpi_zk" class="text-2xl font-extrabold text-gray-900 mt-1">0.00h</div>
          </div>
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="text-xs text-gray-500 font-semibold">当月：在校（滞在）</div>
            <div id="kpi_stay" class="text-2xl font-extrabold text-gray-900 mt-1">0.00h</div>
          </div>
          <div class="p-4 rounded-2xl border bg-gray-50">
            <div class="text-xs text-gray-500 font-semibold">当月：週休日勤務</div>
            <div id="kpi_weekend" class="text-2xl font-extrabold text-gray-900 mt-1">0.00h</div>
          </div>
        </div>
      </div>

      <!-- Chart -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-extrabold text-gray-900">日別：時間外在校等（合計 / 平均切替）</h3>
          <div class="no-print flex items-center gap-2">
            <span class="text-xs text-gray-500">表示</span>
            <select id="monthViewMode" class="border rounded-xl p-2 text-sm"
                    onchange="settings.monthViewMode=this.value; saveAll(); refreshMonthly();">
              <option value="total">合計</option>
              <option value="avg">平均（選択職員）</option>
            </select>
          </div>
        </div>
        <canvas id="monthChart" height="220" class="mt-3"></canvas>
      </div>

      <!-- Monthly overall list (by day) -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-extrabold text-gray-900">月別：全体一覧（日別合計）</h3>
          <div class="no-print flex gap-2">
            <button class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold" onclick="expandAllDays(true)">全展開</button>
            <button class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold" onclick="expandAllDays(false)">全折りたたみ</button>
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 text-xs font-extrabold text-gray-600">日付</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">勤務/休日</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">在校（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">在校等（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">時間外在校等（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">週休日勤務（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600 no-print">詳細</th>
              </tr>
            </thead>
            <tbody id="monthly-overall-body" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>

        <div class="text-xs text-gray-500 mt-3">
          詳細を開くと、その日の「職員別内訳（在校等・時間外など）」が見られます。
        </div>
      </div>

      <!-- Monthly individual list -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
          <div>
            <h3 class="font-extrabold text-gray-900">月別：個別一覧（職員別合計）</h3>
            <div class="text-xs text-gray-500 mt-1">「詳細」を開くと、その職員の“日別内訳”が表示されます。</div>
          </div>

          <div class="no-print flex items-center gap-2">
            <span class="text-xs text-gray-500">絞り込み</span>
            <input id="staffFilter" type="text" class="border rounded-xl p-2 text-sm" placeholder="氏名で検索"
                   oninput="refreshMonthlyIndividualTable()">
          </div>
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 text-xs font-extrabold text-gray-600">氏名</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">在校（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">在校等（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">時間外在校等（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">週休日勤務（h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">目安（月45h）</th>
                <th class="p-3 text-xs font-extrabold text-gray-600 no-print">詳細</th>
              </tr>
            </thead>
            <tbody id="monthly-individual-body" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 3) SETTINGS -->
    <section id="section-settings" class="hidden space-y-6">

      <!-- Month & rules -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card" id="monthSettingCard">
        <div class="flex items-center justify-between">
          <h3 class="font-extrabold text-gray-900">月・集計ルール（全部ここ）</h3>
          <button onclick="applySettingsAndRefresh()" class="no-print px-4 py-2.5 rounded-xl bg-blue-600 text-white hover:bg-blue-700 font-semibold">
            保存して反映
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">集計対象月</label>
            <input type="month" id="setMonth" class="w-full border rounded-xl p-2.5">
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">勤務日 基準（時間）</label>
            <input type="number" id="setStandardHours" step="0.25" min="0" class="w-full border rounded-xl p-2.5" placeholder="例）7.75">
            <div class="text-xs text-gray-500 mt-1">職員ごとの基準は「職員設定」で上書き可</div>
          </div>

          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">休憩 既定（分）</label>
            <input type="number" id="setDefaultBreak" step="5" min="0" class="w-full border rounded-xl p-2.5" placeholder="例）45">
            <div class="text-xs text-gray-500 mt-1">未入力日の休憩はこの値で計算</div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">月別グラフ表示</label>
            <select id="setMonthViewMode" class="w-full border rounded-xl p-2.5">
              <option value="total">合計</option>
              <option value="avg">平均（選択職員）</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">警告しきい値（月）</label>
            <input type="number" id="setWarn45" step="0.5" min="0" class="w-full border rounded-xl p-2.5" placeholder="例）45">
            <div class="text-xs text-gray-500 mt-1">月別個別一覧で色付け表示</div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">週休日の定義</label>
            <select id="setWeeklyHoliday" class="w-full border rounded-xl p-2.5">
              <option value="sat_sun">土日</option>
              <option value="sun_only">日曜のみ</option>
            </select>
            <div class="text-xs text-gray-500 mt-1">週休日勤務時間の自動計算に使用</div>
          </div>
        </div>
      </div>

      <!-- Avg staff selector -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h3 class="font-extrabold text-gray-900">平均の対象職員（選択可）</h3>
            <div class="text-xs text-gray-500 mt-1">月別グラフを「平均」にしたとき、ここでチェックした職員だけで平均を計算。</div>
          </div>
          <div class="no-print flex gap-2">
            <button onclick="selectAvgAll()" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold">全員</button>
            <button onclick="selectAvgNone()" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold">なし</button>
          </div>
        </div>
        <div class="mt-3">
          <input id="avgSearch" type="text" class="w-full border rounded-xl p-2.5" placeholder="名前で絞り込み" oninput="renderAvgSelector()">
        </div>
        <div id="avgBox" class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2"></div>
      </div>

      <!-- Staff settings -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-extrabold text-gray-900">職員設定（最大50名）</h3>
          <button onclick="applySettingsAndRefresh()" class="no-print px-4 py-2.5 rounded-xl bg-gray-900 text-white hover:bg-gray-800 font-semibold">保存して反映</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-4 no-print">
          <div class="md:col-span-2">
            <label class="block text-sm font-semibold text-gray-700 mb-1">氏名</label>
            <input id="newStaffName" type="text" class="w-full border rounded-xl p-2.5" placeholder="氏名を入力">
          </div>
          <div class="flex items-end">
            <button onclick="addStaff()" class="w-full bg-blue-600 text-white py-2.5 rounded-xl hover:bg-blue-700 font-semibold">追加</button>
          </div>
        </div>

        <div class="mt-4 space-y-2" id="staffListBox"></div>
      </div>

      <!-- Calendar overrides -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-extrabold text-gray-900">勤務日カレンダー（上書き）</h3>
          <div class="no-print flex gap-2">
            <button onclick="openOverrideModal()" class="px-4 py-2.5 rounded-xl bg-gray-900 text-white hover:bg-gray-800 font-semibold">上書き追加</button>
            <button onclick="clearAllOverrides()" class="px-4 py-2.5 rounded-xl bg-white border border-gray-200 hover:bg-gray-50 text-rose-600 font-semibold">上書き全削除</button>
          </div>
        </div>
        <div class="text-sm text-gray-600 mt-2">
          代休（平日→休日扱い）／登校日（休日→勤務日扱い）など、学校ごとの例外をここで管理。
        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-gray-50">
              <tr>
                <th class="p-3 text-xs font-extrabold text-gray-600">日付</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">上書き</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">理由</th>
                <th class="p-3 text-xs font-extrabold text-gray-600">メモ</th>
                <th class="p-3 text-xs font-extrabold text-gray-600 no-print">操作</th>
              </tr>
            </thead>
            <tbody id="overrideBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <!-- Data ops -->
      <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print-card">
        <div class="flex items-center justify-between gap-3">
          <h3 class="font-extrabold text-gray-900">データ操作</h3>
          <button onclick="hardResetAll()" class="no-print px-4 py-2.5 rounded-xl bg-rose-600 text-white hover:bg-rose-700 font-semibold">全データ初期化</button>
        </div>
        <div class="text-sm text-gray-600 mt-2">初期化は戻せません（バックアップ後の実行を推奨）。</div>
      </div>

    </section>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-lg opacity-0 transition-opacity pointer-events-none no-print"></div>

  <!-- Edit Modal (detailed input) -->
  <div id="editModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 no-print">
    <div class="bg-white w-full max-w-xl rounded-2xl shadow-xl border border-gray-100">
      <div class="p-5 border-b flex items-center justify-between">
        <div>
          <div class="text-lg font-extrabold text-gray-900">詳細入力</div>
          <div id="editSub" class="text-sm text-gray-500 mt-1">---</div>
        </div>
        <button onclick="closeEditModal()" class="w-10 h-10 rounded-xl hover:bg-gray-50 text-gray-500">✕</button>
      </div>

      <div class="p-5 space-y-4">
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">出勤</label>
            <div class="flex gap-2">
              <input id="editIn" type="time" class="w-full border rounded-xl p-2.5">
              <button onclick="setNowTo('editIn')" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold">今</button>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">退勤</label>
            <div class="flex gap-2">
              <input id="editOut" type="time" class="w-full border rounded-xl p-2.5">
              <button onclick="setNowTo('editOut')" class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold">今</button>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">休憩（分）</label>
            <input id="editBreak" type="number" min="0" step="5" class="w-full border rounded-xl p-2.5">
            <div class="text-xs text-gray-500 mt-1">未入力なら設定の既定値</div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">除外（分）</label>
            <input id="editExclude" type="number" min="0" step="5" class="w-full border rounded-xl p-2.5">
            <div class="text-xs text-gray-500 mt-1">勤務時間外の自己研鑽等として除く</div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">時間外在校等（手入力h）</label>
            <input id="editManualOT" type="number" min="0" step="0.25" class="w-full border rounded-xl p-2.5" placeholder="未入力=自動">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">週休日勤務（手入力h）</label>
            <input id="editManualWeekend" type="number" min="0" step="0.25" class="w-full border rounded-xl p-2.5" placeholder="未入力=自動">
          </div>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">メモ（任意）</label>
          <input id="editMemo" type="text" class="w-full border rounded-xl p-2.5" placeholder="例）研修、出張、行事など">
        </div>

        <div class="bg-gray-50 border rounded-2xl p-4 text-sm text-gray-700">
          <div class="font-extrabold text-gray-900 mb-2">計算</div>
          <ul class="list-disc pl-5 space-y-1">
            <li>在校（滞在）＝出勤〜退勤</li>
            <li>在校等＝滞在−（休憩＋除外）</li>
            <li>勤務日：時間外在校等＝max(0, 在校等−基準)</li>
            <li>休日扱い：時間外在校等＝在校等</li>
          </ul>
        </div>
      </div>

      <div class="p-5 border-t flex gap-2">
        <button onclick="saveEditModal()" class="flex-1 bg-blue-600 text-white py-2.5 rounded-xl hover:bg-blue-700 font-semibold">保存</button>
        <button onclick="closeEditModal()" class="flex-1 bg-white border border-gray-200 py-2.5 rounded-xl hover:bg-gray-50 font-semibold">閉じる</button>
      </div>
    </div>
  </div>

  <!-- Override Modal -->
  <div id="overrideModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 no-print">
    <div class="bg-white w-full max-w-xl rounded-2xl shadow-xl border border-gray-100">
      <div class="p-5 border-b flex items-center justify-between">
        <div>
          <div class="text-lg font-extrabold text-gray-900">勤務日上書き</div>
          <div class="text-sm text-gray-500 mt-1">代休／振替登校など</div>
        </div>
        <button onclick="closeOverrideModal()" class="w-10 h-10 rounded-xl hover:bg-gray-50 text-gray-500">✕</button>
      </div>
      <div class="p-5 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">日付</label>
            <input id="ovDate" type="date" class="w-full border rounded-xl p-2.5">
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">上書き</label>
            <select id="ovMode" class="w-full border rounded-xl p-2.5">
              <option value="work">勤務日</option>
              <option value="off">休日（時間外扱い）</option>
              <option value="auto">自動に戻す（削除）</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-semibold text-gray-700 mb-1">理由</label>
            <input id="ovLabel" type="text" class="w-full border rounded-xl p-2.5" placeholder="例）代休、振替登校">
          </div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-1">メモ</label>
          <input id="ovNote" type="text" class="w-full border rounded-xl p-2.5" placeholder="例）行事対応の振替">
        </div>
        <div class="flex gap-2">
          <button onclick="applyOverride()" class="flex-1 bg-gray-900 text-white py-2.5 rounded-xl hover:bg-gray-800 font-semibold">適用</button>
          <button onclick="closeOverrideModal()" class="flex-1 bg-white border border-gray-200 py-2.5 rounded-xl hover:bg-gray-50 font-semibold">閉じる</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========================
    // Storage
    // =========================
    const LS = {
      staff: 'wh_staff_v6',
      data:  'wh_data_v6',
      ov:    'wh_ov_v6',
      set:   'wh_set_v6',
      ui:    'wh_ui_v6'
    };

    const DEFAULT_SETTINGS = {
      month: '',                // yyyy-mm
      standardHours: 7.75,
      defaultBreakMin: 45,
      warnMonthHours: 45,
      monthViewMode: 'total',   // total | avg
      weeklyHolidayMode: 'sat_sun', // sat_sun | sun_only
      avgSelected: []           // names
    };

    // staff: [{name, standardHours?}]
    let staffList = loadJSON(LS.staff, null);
    // data[date][name] = {in,out, breakMin, excludeMin, manualOTMin, manualWeekendMin, memo}
    let attendanceData = loadJSON(LS.data, {});
    // ov[date] = {mode:'work'|'off', label, note}
    let overrides = loadJSON(LS.ov, {});
    let settings = loadJSON(LS.set, DEFAULT_SETTINGS);
    let uiState = loadJSON(LS.ui, { todayPanelOpen: true, dayExpanded: {} });

    if (!staffList) {
      const old = JSON.parse(localStorage.getItem('staffList') || 'null');
      if (Array.isArray(old)) staffList = old.map(n => ({ name:String(n) }));
      else staffList = [{ name:"管理者" }, { name:"教職員A" }];
      saveAll();
    }

    // Chart
    let monthChart;

    // =========================
    // Init
    // =========================
    window.onload = () => {
      updateClock();
      setInterval(updateClock, 1000);

      const today = new Date();
      document.getElementById('target-date').valueAsDate = today;

      // default month
      if (!settings.month) settings.month = `${today.getFullYear()}-${pad2(today.getMonth()+1)}`;

      // apply settings to UI
      loadSettingsToUI();

      // build selectors
      renderStaffSelect();
      renderStaffSettingsList();
      renderAvgSelector();
      renderOverrideTable();

      // input
      refreshInputSummary();
      refreshTodayTable();
      applyTodayPanelState();

      // monthly
      initMonthChart();
      refreshMonthly();
    };

    function updateClock(){
      const now = new Date();
      document.getElementById('current-time').innerText =
        now.toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }

    // =========================
    // Tabs
    // =========================
    function switchTab(tab){
      ['input','monthly','settings'].forEach(t=>{
        document.getElementById(`section-${t}`).classList.add('hidden');
        const b = document.getElementById(`tab-${t}`);
        b.classList.remove('tab-active','text-blue-600');
        b.classList.add('text-gray-500');
      });
      document.getElementById(`section-${tab}`).classList.remove('hidden');
      const b = document.getElementById(`tab-${tab}`);
      b.classList.add('tab-active','text-blue-600');

      if (tab === 'monthly') refreshMonthly();
      if (tab === 'settings') { renderAvgSelector(); renderStaffSettingsList(); renderOverrideTable(); }
    }

    // =========================
    // Staff UI
    // =========================
    function renderStaffSelect(){
      const sel = document.getElementById('staff-select');
      sel.innerHTML = staffList.map(s=>`<option value="${escAttr(s.name)}">${escHTML(s.name)}</option>`).join('');
      // ensure avg default
      if (!Array.isArray(settings.avgSelected) || settings.avgSelected.length === 0) {
        settings.avgSelected = staffList.map(s=>s.name);
        saveAll();
      }
    }

    function renderStaffSettingsList(){
      const box = document.getElementById('staffListBox');
      box.innerHTML = staffList.map((s,idx)=>{
        const std = Number(s.standardHours ?? settings.standardHours).toFixed(2);
        return `
          <div class="border rounded-2xl p-4 bg-gray-50 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
            <div class="min-w-0">
              <div class="font-extrabold text-gray-900 truncate">${escHTML(s.name)}</div>
              <div class="text-xs text-gray-500 mt-1">勤務日基準：${std}h</div>
            </div>
            <div class="no-print flex flex-wrap gap-2">
              <button class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold"
                      onclick="editStaffStandard(${idx})">基準変更</button>
              <button class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold text-rose-600"
                      onclick="removeStaff(${idx})">削除</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function addStaff(){
      const input = document.getElementById('newStaffName');
      const name = input.value.trim();
      if (!name) return;
      if (staffList.length >= 50){ toast("最大50名までです"); return; }
      if (staffList.some(s=>s.name===name)){ toast("同名の職員がいます"); return; }
      staffList.push({name});
      settings.avgSelected = Array.from(new Set([...(settings.avgSelected||[]), name]));
      saveAll();
      renderStaffSelect();
      renderStaffSettingsList();
      renderAvgSelector();
      refreshTodayTable();
      refreshMonthly();
      input.value='';
      toast("職員を追加しました");
    }

    function removeStaff(idx){
      const s = staffList[idx];
      if (!s) return;
      if (!confirm(`「${s.name}」を削除しますか？（記録は残ります）`)) return;
      staffList.splice(idx,1);
      settings.avgSelected = (settings.avgSelected||[]).filter(n=>n!==s.name);
      saveAll();
      renderStaffSelect();
      renderStaffSettingsList();
      renderAvgSelector();
      refreshTodayTable();
      refreshMonthly();
      toast("職員を削除しました");
    }

    function editStaffStandard(idx){
      const s = staffList[idx]; if(!s) return;
      const v = prompt(`「${s.name}」の勤務日基準（時間）`, String(s.standardHours ?? settings.standardHours));
      if (v === null) return;
      const n = Number(v);
      if (!isFinite(n) || n < 0){ toast("数値が不正です"); return; }
      s.standardHours = n;
      saveAll();
      renderStaffSettingsList();
      refreshTodayTable();
      refreshMonthly();
      toast("基準を更新しました");
    }

    // =========================
    // Avg selector
    // =========================
    function renderAvgSelector(){
      const box = document.getElementById('avgBox');
      const q = (document.getElementById('avgSearch')?.value || '').toLowerCase().trim();
      const sel = new Set(getAvgSelected());
      box.innerHTML = staffList
        .filter(s=>!q || s.name.toLowerCase().includes(q))
        .map(s=>{
          const checked = sel.has(s.name) ? 'checked' : '';
          return `
            <label class="flex items-center gap-3 bg-white border rounded-2xl p-3 cursor-pointer hover:bg-gray-50">
              <input type="checkbox" class="w-4 h-4" ${checked} onchange="toggleAvg('${escAttr(s.name)}', this.checked)">
              <span class="text-sm font-semibold text-gray-800">${escHTML(s.name)}</span>
            </label>
          `;
        }).join('') || `<div class="text-sm text-gray-500">該当なし</div>`;
    }

    function toggleAvg(name, on){
      const set = new Set(getAvgSelected());
      if (on) set.add(name); else set.delete(name);
      settings.avgSelected = Array.from(set);
      saveAll();
      refreshMonthly();
    }

    function selectAvgAll(){
      settings.avgSelected = staffList.map(s=>s.name);
      saveAll();
      renderAvgSelector();
      refreshMonthly();
    }
    function selectAvgNone(){
      settings.avgSelected = [];
      saveAll();
      renderAvgSelector();
      refreshMonthly();
    }
    function getAvgSelected(){
      const arr = Array.isArray(settings.avgSelected) ? settings.avgSelected : [];
      const names = new Set(staffList.map(s=>s.name));
      return arr.filter(n=>names.has(n));
    }

    // =========================
    // Settings UI
    // =========================
    function loadSettingsToUI(){
      document.getElementById('setMonth').value = settings.month || '';
      document.getElementById('setStandardHours').value = settings.standardHours ?? 7.75;
      document.getElementById('setDefaultBreak').value = settings.defaultBreakMin ?? 45;
      document.getElementById('setWarn45').value = settings.warnMonthHours ?? 45;
      document.getElementById('setMonthViewMode').value = settings.monthViewMode || 'total';
      document.getElementById('setWeeklyHoliday').value = settings.weeklyHolidayMode || 'sat_sun';

      const mv = document.getElementById('monthViewMode');
      if (mv) mv.value = settings.monthViewMode || 'total';
    }

    function applySettingsAndRefresh(){
      settings.month = document.getElementById('setMonth').value || settings.month;
      settings.standardHours = Number(document.getElementById('setStandardHours').value) || 7.75;
      settings.defaultBreakMin = clampInt(document.getElementById('setDefaultBreak').value, 0, 600);
      settings.warnMonthHours = Number(document.getElementById('setWarn45').value) || 45;
      settings.monthViewMode = document.getElementById('setMonthViewMode').value || 'total';
      settings.weeklyHolidayMode = document.getElementById('setWeeklyHoliday').value || 'sat_sun';

      // reflect to monthly view dropdown too
      const mv = document.getElementById('monthViewMode');
      if (mv) mv.value = settings.monthViewMode;

      saveAll();
      renderAvgSelector();
      refreshInputSummary();
      refreshTodayTable();
      refreshMonthly();
      toast("設定を反映しました");
    }

    function scrollToMonthSetting(){
      const el = document.getElementById('monthSettingCard');
      el?.scrollIntoView({behavior:'smooth', block:'start'});
    }

    // =========================
    // INPUT: quick stamping
    // =========================
    function stampNow(kind){
      const name = document.getElementById('staff-select').value;
      const date = document.getElementById('target-date').value;
      if (!name || !date) return;

      const now = new Date();
      const t = pad2(now.getHours()) + ':' + pad2(now.getMinutes());

      const rec = ensureRecord(date, name);
      rec[kind] = t;

      // defaults
      if (rec.breakMin == null) rec.breakMin = settings.defaultBreakMin;
      if (rec.excludeMin == null) rec.excludeMin = 0;

      saveAll();
      refreshInputSummary();
      refreshTodayTable();
      toast(`${name}：${kind==='in'?'出勤':'退勤'}を記録しました`);
    }

    function quickAdjust(delta){
      const name = document.getElementById('staff-select').value;
      const date = document.getElementById('target-date').value;
      const rec = getRecord(date,name);
      if (!rec || (!rec.in && !rec.out)){ toast("調整する時刻がありません"); return; }
      // どちらか片方だけならそれを、両方あるなら両方を調整
      if (rec.in) rec.in = shiftTime(rec.in, delta);
      if (rec.out) rec.out = shiftTime(rec.out, delta);
      saveAll();
      refreshInputSummary();
      refreshTodayTable();
      toast(`±${Math.abs(delta)}分調整しました`);
    }

    function clearOneRecord(){
      const name = document.getElementById('staff-select').value;
      const date = document.getElementById('target-date').value;
      if (!name || !date) return;
      if (!confirm("この職員のこの日の記録を削除しますか？")) return;
      if (attendanceData[date]) {
        delete attendanceData[date][name];
        if (Object.keys(attendanceData[date]).length === 0) delete attendanceData[date];
      }
      saveAll();
      refreshInputSummary();
      refreshTodayTable();
      toast("削除しました");
    }

    function refreshInputSummary(){
      const name = document.getElementById('staff-select').value;
      const date = document.getElementById('target-date').value;
      const el = document.getElementById('input-summary');
      if (!name || !date){ el.textContent='---'; return; }

      const rec = getRecord(date,name) || {};
      const eff = getDayModeEffective(date);
      const staff = staffList.find(s=>s.name===name);
      const stdMin = Math.round((Number(staff?.standardHours ?? settings.standardHours))*60);

      const breakMin = rec.breakMin ?? settings.defaultBreakMin;
      const excludeMin = rec.excludeMin ?? 0;

      const rawMin = calcRawMinutes(rec.in, rec.out);
      const stay = (rawMin==null) ? null : rawMin;
      const zk = (rawMin==null) ? null : Math.max(0, rawMin - (breakMin + excludeMin));

      let ot = null;
      if (zk != null) {
        ot = eff.isWorkday ? Math.max(0, zk - stdMin) : zk;
        if (rec.manualOTMin != null && isFinite(rec.manualOTMin)) ot = rec.manualOTMin;
      }

      // weekend
      let weekend = 0;
      if (!eff.isWorkday && isWeeklyHolidayAuto(date) && zk != null) weekend = zk;
      if (rec.manualWeekendMin != null && isFinite(rec.manualWeekendMin)) weekend = rec.manualWeekendMin;

      const badge = eff.isWorkday
        ? `<span class="inline-flex px-2 py-1 rounded-full text-xs font-extrabold bg-emerald-100 text-emerald-700">勤務日</span>`
        : `<span class="inline-flex px-2 py-1 rounded-full text-xs font-extrabold bg-rose-100 text-rose-700">休日扱い</span>`;

      el.innerHTML = `
        <div class="flex flex-wrap items-center gap-2">
          <span class="font-extrabold text-gray-900">${escHTML(date)}（${weekdayJP(parseDate(date))}）</span>
          ${badge}
          <span class="text-xs text-gray-500">${escHTML(eff.reason)}</span>
        </div>
        <div class="mt-2 grid grid-cols-1 md:grid-cols-5 gap-2">
          <div class="p-3 rounded-2xl bg-white border">
            <div class="text-xs text-gray-500 font-semibold">出勤</div>
            <div class="text-lg font-extrabold text-gray-900">${rec.in || '---'}</div>
          </div>
          <div class="p-3 rounded-2xl bg-white border">
            <div class="text-xs text-gray-500 font-semibold">退勤</div>
            <div class="text-lg font-extrabold text-gray-900">${rec.out || '---'}</div>
          </div>
          <div class="p-3 rounded-2xl bg-white border">
            <div class="text-xs text-gray-500 font-semibold">在校（滞在）</div>
            <div class="text-lg font-extrabold text-gray-900">${stay==null?'-':(stay/60).toFixed(2)+'h'}</div>
          </div>
          <div class="p-3 rounded-2xl bg-white border">
            <div class="text-xs text-gray-500 font-semibold">在校等</div>
            <div class="text-lg font-extrabold text-gray-900">${zk==null?'-':(zk/60).toFixed(2)+'h'}</div>
          </div>
          <div class="p-3 rounded-2xl bg-white border">
            <div class="text-xs text-gray-500 font-semibold">時間外在校等</div>
            <div class="text-lg font-extrabold ${ot!=null && ot>0 ? 'text-rose-700':'text-gray-900'}">
              ${ot==null?'-':(ot/60).toFixed(2)+'h'}
            </div>
            <div class="text-xs text-gray-500 mt-1">週休日勤務：${(weekend/60).toFixed(2)}h</div>
          </div>
        </div>
      `;
    }

    // =========================
    // Today panel/table
    // =========================
    function applyTodayPanelState(){
      const panel = document.getElementById('todayPanel');
      const btn = document.getElementById('todayToggleBtn');
      if (uiState.todayPanelOpen) {
        panel.classList.remove('hidden');
        btn.textContent = "表示/非表示";
      } else {
        panel.classList.add('hidden');
        btn.textContent = "非表示中";
      }
    }

    function toggleTodayPanel(){
      uiState.todayPanelOpen = !uiState.todayPanelOpen;
      saveAll();
      applyTodayPanelState();
    }

    function refreshTodayTable(){
      const date = document.getElementById('target-date').value;
      const tbody = document.getElementById('today-table-body');
      if (!date) { tbody.innerHTML=''; return; }

      const eff = getDayModeEffective(date);

      tbody.innerHTML = staffList.map(s=>{
        const rec = getRecord(date,s.name) || {};
        const staff = s;
        const stdMin = Math.round((Number(staff.standardHours ?? settings.standardHours))*60);

        const breakMin = rec.breakMin ?? settings.defaultBreakMin;
        const excludeMin = rec.excludeMin ?? 0;

        const rawMin = calcRawMinutes(rec.in, rec.out);
        const zkMin = (rawMin==null) ? null : Math.max(0, rawMin - (breakMin + excludeMin));

        let otMin = null;
        if (zkMin != null){
          otMin = eff.isWorkday ? Math.max(0, zkMin - stdMin) : zkMin;
          if (rec.manualOTMin != null && isFinite(rec.manualOTMin)) otMin = rec.manualOTMin;
        }

        let weekendMin = 0;
        if (!eff.isWorkday && isWeeklyHolidayAuto(date) && zkMin != null) weekendMin = zkMin;
        if (rec.manualWeekendMin != null && isFinite(rec.manualWeekendMin)) weekendMin = rec.manualWeekendMin;

        return `
          <tr class="hover:bg-gray-50">
            <td class="p-3 text-sm font-extrabold text-gray-900">${escHTML(s.name)}</td>
            <td class="p-3 text-sm">${rec.in || '---'}</td>
            <td class="p-3 text-sm">${rec.out || '---'}</td>
            <td class="p-3 text-sm">${rawMin==null?'-':(rawMin/60).toFixed(2)+'h'}</td>
            <td class="p-3 text-sm font-semibold">${zkMin==null?'-':(zkMin/60).toFixed(2)+'h'}</td>
            <td class="p-3 text-sm">${otMin==null?'-':otCell(otMin)}</td>
            <td class="p-3 text-sm">${(weekendMin/60).toFixed(2)}h</td>
          </tr>
        `;
      }).join('');
    }

    function printDaily(){
      // just print current view; table is on page
      window.print();
    }

    function otCell(min){
      const h = min/60;
      if (h <= 0.0001) return `0.00h`;
      return `<span class="font-extrabold text-rose-700">${h.toFixed(2)}h</span>`;
    }

    function copyPrevDay(){
      const date = document.getElementById('target-date').value;
      if (!date) return;
      const prev = toYMD(addDays(parseDate(date), -1));
      if (!attendanceData[prev]) { toast("前日の記録がありません"); return; }
      if (!confirm("前日の記録をこの日に複製しますか？（全職員）")) return;

      if (!attendanceData[date]) attendanceData[date] = {};
      staffList.forEach(s=>{
        const p = attendanceData[prev][s.name];
        if (p) attendanceData[date][s.name] = JSON.parse(JSON.stringify(p));
      });

      saveAll();
      refreshInputSummary();
      refreshTodayTable();
      toast("複製しました");
    }

    // =========================
    // MONTHLY
    // =========================
    function initMonthChart(){
      const ctx = document.getElementById('monthChart').getContext('2d');
      monthChart = new Chart(ctx, {
        type: 'bar',
        data: { labels: [], datasets: [{ label: '時間外在校等（h）', data: [] }] },
        options: {
          responsive: true,
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function refreshMonthly(){
      // title
      const ym = settings.month;
      const [y,m] = ym.split('-').map(Number);
      const dim = daysInMonth(y,m);

      const avgNames = getAvgSelected();
      const avgCount = avgNames.length;

      document.getElementById('monthTitle').textContent = `${ym}（${dim}日）`;
      document.getElementById('monthSub').textContent =
        `基準：${Number(settings.standardHours).toFixed(2)}h / 休憩既定：${settings.defaultBreakMin}分 / 平均対象：${avgCount}名`;

      // reflect view mode
      const mv = document.getElementById('monthViewMode');
      if (mv) mv.value = settings.monthViewMode || 'total';

      // compute day totals
      const dayAgg = []; // [{date, eff, stayMin, zkMin, otMin, weekendMin, byStaff:[]}]
      let sumStay=0, sumZk=0, sumOt=0, sumWeekend=0;

      for (let d=1; d<=dim; d++){
        const date = `${y}-${pad2(m)}-${pad2(d)}`;
        const eff = getDayModeEffective(date);
        const isWeekly = isWeeklyHolidayAuto(date);

        let stayMin=0, zkMin=0, otMin=0, weekendMin=0;
        const byStaff = [];

        staffList.forEach(s=>{
          const rec = getRecord(date, s.name);
          if (!rec || (!rec.in || !rec.out)) return;

          const breakMin = rec.breakMin ?? settings.defaultBreakMin;
          const excludeMin = rec.excludeMin ?? 0;

          const raw = calcRawMinutes(rec.in, rec.out);
          if (raw==null) return;

          const zk = Math.max(0, raw - (breakMin + excludeMin));
          const stdMin = Math.round((Number(s.standardHours ?? settings.standardHours))*60);

          let ot = eff.isWorkday ? Math.max(0, zk - stdMin) : zk;
          if (rec.manualOTMin != null && isFinite(rec.manualOTMin)) ot = rec.manualOTMin;

          let wk = (!eff.isWorkday && isWeekly) ? zk : 0;
          if (rec.manualWeekendMin != null && isFinite(rec.manualWeekendMin)) wk = rec.manualWeekendMin;

          stayMin += raw; zkMin += zk; otMin += ot; weekendMin += wk;

          byStaff.push({
            name: s.name,
            in: rec.in, out: rec.out,
            stayMin: raw, zkMin: zk, otMin: ot, weekendMin: wk
          });
        });

        sumStay += stayMin; sumZk += zkMin; sumOt += otMin; sumWeekend += weekendMin;

        dayAgg.push({date, eff, stayMin, zkMin, otMin, weekendMin, byStaff});
      }

      // KPI
      document.getElementById('kpi_ot').textContent = `${(sumOt/60).toFixed(2)}h`;
      document.getElementById('kpi_zk').textContent = `${(sumZk/60).toFixed(2)}h`;
      document.getElementById('kpi_stay').textContent = `${(sumStay/60).toFixed(2)}h`;
      document.getElementById('kpi_weekend').textContent = `${(sumWeekend/60).toFixed(2)}h`;

      // chart series
      const labels = [];
      const series = [];
      dayAgg.forEach((a, i)=>{
        labels.push(`${i+1}`);
        if ((settings.monthViewMode||'total') === 'avg') {
          if (avgCount === 0) series.push(0);
          else {
            const dayOtForAvg = a.byStaff
              .filter(x=>avgNames.includes(x.name))
              .reduce((s,x)=>s+x.otMin, 0);
            series.push(Number(((dayOtForAvg/60)/avgCount).toFixed(2)));
          }
        } else {
          series.push(Number((a.otMin/60).toFixed(2)));
        }
      });

      monthChart.data.labels = labels;
      monthChart.data.datasets[0].data = series;
      monthChart.data.datasets[0].label =
        (settings.monthViewMode === 'avg')
          ? `時間外在校等（平均/日・選択${avgCount}名）`
          : '時間外在校等（合計/日）';
      monthChart.update();

      // tables
      renderMonthlyOverallTable(dayAgg);
      buildMonthlyIndividualCache(dayAgg); // for individual table + detail
      refreshMonthlyIndividualTable();
    }

    function renderMonthlyOverallTable(dayAgg){
      const tbody = document.getElementById('monthly-overall-body');
      tbody.innerHTML = dayAgg.map(a=>{
        const key = a.date;
        const expanded = !!uiState.dayExpanded[key];
        const mode = a.eff.isWorkday ? '勤務日' : '休日';
        const badge = a.eff.isWorkday
          ? `<span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 font-bold">勤務日</span>`
          : `<span class="text-xs px-2 py-1 rounded-full bg-rose-50 text-rose-700 font-bold">休日扱い</span>`;

        const detailBtn = expanded ? '閉じる' : '開く';

        const detailRow = expanded
          ? `
            <tr class="bg-gray-50">
              <td colspan="7" class="p-4">
                <div class="text-sm font-extrabold text-gray-900 mb-2">${key} の内訳（職員別）</div>
                <div class="overflow-x-auto">
                  <table class="w-full text-left bg-white border rounded-2xl">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-3 text-xs font-extrabold text-gray-600">氏名</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">出勤</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">退勤</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">在校等(h)</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">時間外(h)</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">週休日(h)</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                      ${
                        a.byStaff.length
                          ? a.byStaff.map(x=>`
                            <tr>
                              <td class="p-3 text-sm font-semibold">${escHTML(x.name)}</td>
                              <td class="p-3 text-sm">${x.in}</td>
                              <td class="p-3 text-sm">${x.out}</td>
                              <td class="p-3 text-sm">${(x.zkMin/60).toFixed(2)}</td>
                              <td class="p-3 text-sm">${(x.otMin/60).toFixed(2)}</td>
                              <td class="p-3 text-sm">${(x.weekendMin/60).toFixed(2)}</td>
                            </tr>
                          `).join('')
                          : `<tr><td colspan="6" class="p-3 text-sm text-gray-500">記録がありません。</td></tr>`
                      }
                    </tbody>
                  </table>
                </div>
                <div class="text-xs text-gray-500 mt-2">${escHTML(a.eff.reason)}</div>
              </td>
            </tr>
          `
          : '';

        return `
          <tr class="hover:bg-gray-50">
            <td class="p-3 text-sm font-extrabold text-gray-900">${key}（${weekdayJP(parseDate(key))}）</td>
            <td class="p-3 text-sm">${badge}</td>
            <td class="p-3 text-sm">${(a.stayMin/60).toFixed(2)}</td>
            <td class="p-3 text-sm font-semibold">${(a.zkMin/60).toFixed(2)}</td>
            <td class="p-3 text-sm">${a.otMin>0?`<span class="font-extrabold text-rose-700">${(a.otMin/60).toFixed(2)}</span>`:(a.otMin/60).toFixed(2)}</td>
            <td class="p-3 text-sm">${(a.weekendMin/60).toFixed(2)}</td>
            <td class="p-3 text-sm no-print">
              <button class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold"
                      onclick="toggleDayDetail('${escAttr(key)}')">${detailBtn}</button>
            </td>
          </tr>
          ${detailRow}
        `;
      }).join('');
      saveAll(); // persist expanded state
    }

    function toggleDayDetail(date){
      uiState.dayExpanded[date] = !uiState.dayExpanded[date];
      saveAll();
      refreshMonthly();
    }

    function expandAllDays(open){
      const ym = settings.month;
      const [y,m] = ym.split('-').map(Number);
      const dim = daysInMonth(y,m);
      for (let d=1; d<=dim; d++){
        const date = `${y}-${pad2(m)}-${pad2(d)}`;
        uiState.dayExpanded[date] = open;
      }
      saveAll();
      refreshMonthly();
    }

    // Build cache for individual table
    let monthlyByStaff = null; // {name:{stayMin,zkMin,otMin,weekendMin, days:[{date, ...}]}}
    function buildMonthlyIndividualCache(dayAgg){
      monthlyByStaff = {};
      staffList.forEach(s=>monthlyByStaff[s.name] = { stayMin:0, zkMin:0, otMin:0, weekendMin:0, days:[] });

      dayAgg.forEach(a=>{
        a.byStaff.forEach(x=>{
          const t = monthlyByStaff[x.name];
          if (!t) return;
          t.stayMin += x.stayMin;
          t.zkMin += x.zkMin;
          t.otMin += x.otMin;
          t.weekendMin += x.weekendMin;
          t.days.push({date:a.date, ...x});
        });
      });
    }

    function refreshMonthlyIndividualTable(){
      const tbody = document.getElementById('monthly-individual-body');
      const q = (document.getElementById('staffFilter')?.value || '').trim().toLowerCase();
      const warn = Number(settings.warnMonthHours || 45);

      const names = staffList
        .map(s=>s.name)
        .filter(n=>!q || n.toLowerCase().includes(q));

      tbody.innerHTML = names.map(name=>{
        const t = monthlyByStaff?.[name] || {stayMin:0,zkMin:0,otMin:0,weekendMin:0,days:[]};
        const otH = t.otMin/60;
        const badge = otH >= warn
          ? `<span class="text-xs px-2 py-1 rounded-full bg-rose-50 text-rose-700 font-bold">超（${warn}h）</span>`
          : `<span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 font-bold">範囲内</span>`;

        const key = `staff:${name}`;
        const expanded = !!uiState.dayExpanded[key];
        const btn = expanded ? "閉じる" : "開く";

        const detail = expanded
          ? `
            <tr class="bg-gray-50">
              <td colspan="7" class="p-4">
                <div class="text-sm font-extrabold text-gray-900 mb-2">${escHTML(name)} の日別内訳</div>
                <div class="overflow-x-auto">
                  <table class="w-full text-left bg-white border rounded-2xl">
                    <thead class="bg-gray-50">
                      <tr>
                        <th class="p-3 text-xs font-extrabold text-gray-600">日付</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">出勤</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">退勤</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">在校等(h)</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">時間外(h)</th>
                        <th class="p-3 text-xs font-extrabold text-gray-600">週休日(h)</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                      ${
                        t.days.length
                          ? t.days.map(d=>`
                            <tr>
                              <td class="p-3 text-sm font-semibold">${d.date}（${weekdayJP(parseDate(d.date))}）</td>
                              <td class="p-3 text-sm">${d.in}</td>
                              <td class="p-3 text-sm">${d.out}</td>
                              <td class="p-3 text-sm">${(d.zkMin/60).toFixed(2)}</td>
                              <td class="p-3 text-sm">${(d.otMin/60).toFixed(2)}</td>
                              <td class="p-3 text-sm">${(d.weekendMin/60).toFixed(2)}</td>
                            </tr>
                          `).join('')
                          : `<tr><td colspan="6" class="p-3 text-sm text-gray-500">記録がありません。</td></tr>`
                      }
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          `
          : '';

        return `
          <tr class="hover:bg-gray-50">
            <td class="p-3 text-sm font-extrabold text-gray-900">${escHTML(name)}</td>
            <td class="p-3 text-sm">${(t.stayMin/60).toFixed(2)}</td>
            <td class="p-3 text-sm font-semibold">${(t.zkMin/60).toFixed(2)}</td>
            <td class="p-3 text-sm font-extrabold ${otH>=warn?'text-rose-700':'text-gray-900'}">${otH.toFixed(2)}</td>
            <td class="p-3 text-sm">${(t.weekendMin/60).toFixed(2)}</td>
            <td class="p-3 text-sm">${badge}</td>
            <td class="p-3 text-sm no-print">
              <button class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold"
                      onclick="toggleStaffDetail('${escAttr(name)}')">${btn}</button>
            </td>
          </tr>
          ${detail}
        `;
      }).join('');
      saveAll();
    }

    function toggleStaffDetail(name){
      const key = `staff:${name}`;
      uiState.dayExpanded[key] = !uiState.dayExpanded[key];
      saveAll();
      refreshMonthlyIndividualTable();
    }

    // =========================
    // EXPORT
    // =========================
    function exportMonthExcel(){
      const ym = settings.month;
      const rows = buildMonthRows(ym);
      const ws = XLSX.utils.aoa_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, `勤務記録_${ym}`);
      XLSX.writeFile(wb, `working_hours_${ym}.xlsx`);
      toast("Excelを出力しました");
    }

    function exportMonthCSV(){
      const ym = settings.month;
      const rows = buildMonthRows(ym);
      const csv = rows.map(r=>r.map(csvEscape).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `working_hours_${ym}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("CSVを出力しました");
    }

    function buildMonthRows(ym){
      const [y,m] = ym.split('-').map(Number);
      const dim = daysInMonth(y,m);

      const header = [
        '日付','曜日','勤務/休日','理由','メモ(上書き)','氏名',
        '出勤','退勤','休憩(分)','除外(分)',
        '在校(滞在)(h)','在校等(h)','時間外在校等(h)','週休日勤務(h)',
        '時間外(手入力h)','週休日(手入力h)','記録メモ'
      ];
      const rows = [header];

      for (let d=1; d<=dim; d++){
        const date = `${y}-${pad2(m)}-${pad2(d)}`;
        const eff = getDayModeEffective(date);
        const wd = weekdayJP(parseDate(date));
        const isWeekly = isWeeklyHolidayAuto(date);

        staffList.forEach(s=>{
          const rec = getRecord(date, s.name);
          if (!rec) return;

          // 出力は「入力がある行だけ」出す（スッキリ）
          const hasAny = (rec.in || rec.out || rec.breakMin!=null || rec.excludeMin!=null || rec.manualOTMin!=null || rec.manualWeekendMin!=null || rec.memo);
          if (!hasAny) return;

          const breakMin = rec.breakMin ?? settings.defaultBreakMin;
          const excludeMin = rec.excludeMin ?? 0;

          const raw = (rec.in && rec.out) ? calcRawMinutes(rec.in, rec.out) : null;
          const zk = (raw==null) ? null : Math.max(0, raw - (breakMin + excludeMin));
          const stdMin = Math.round((Number(s.standardHours ?? settings.standardHours))*60);

          let ot = (zk==null) ? null : (eff.isWorkday ? Math.max(0, zk - stdMin) : zk);
          if (rec.manualOTMin != null && isFinite(rec.manualOTMin)) ot = rec.manualOTMin;

          let wk = (!eff.isWorkday && isWeekly && zk!=null) ? zk : 0;
          if (rec.manualWeekendMin != null && isFinite(rec.manualWeekendMin)) wk = rec.manualWeekendMin;

          rows.push([
            date, wd,
            eff.isWorkday ? '勤務日' : '休日（時間外扱い）',
            eff.label || '',
            eff.note || '',
            s.name,
            rec.in || '',
            rec.out || '',
            breakMin ?? 0,
            excludeMin ?? 0,
            raw==null ? '' : (raw/60).toFixed(2),
            zk==null ? '' : (zk/60).toFixed(2),
            ot==null ? '' : (ot/60).toFixed(2),
            (wk/60).toFixed(2),
            (rec.manualOTMin!=null && isFinite(rec.manualOTMin)) ? (rec.manualOTMin/60).toFixed(2) : '',
            (rec.manualWeekendMin!=null && isFinite(rec.manualWeekendMin)) ? (rec.manualWeekendMin/60).toFixed(2) : '',
            rec.memo || ''
          ]);
        });
      }
      return rows;
    }

    function csvEscape(v){
      const s = String(v ?? '');
      if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    }

    // =========================
    // Detailed modal
    // =========================
    function openEditModal(){
      const name = document.getElementById('staff-select').value;
      const date = document.getElementById('target-date').value;
      if (!name || !date) return;

      const rec = ensureRecord(date,name);
      const eff = getDayModeEffective(date);

      document.getElementById('editSub').textContent =
        `${date}（${weekdayJP(parseDate(date))}）／${name} ｜ ${eff.isWorkday?'勤務日':'休日扱い'}：${eff.reason}`;

      document.getElementById('editIn').value = rec.in || '';
      document.getElementById('editOut').value = rec.out || '';
      document.getElementById('editBreak').value = (rec.breakMin ?? settings.defaultBreakMin);
      document.getElementById('editExclude').value = (rec.excludeMin ?? 0);
      document.getElementById('editManualOT').value = (rec.manualOTMin!=null && isFinite(rec.manualOTMin)) ? (rec.manualOTMin/60).toFixed(2) : '';
      document.getElementById('editManualWeekend').value = (rec.manualWeekendMin!=null && isFinite(rec.manualWeekendMin)) ? (rec.manualWeekendMin/60).toFixed(2) : '';
      document.getElementById('editMemo').value = rec.memo || '';

      document.getElementById('editModal').classList.remove('hidden');
      document.getElementById('editModal').classList.add('flex');
    }

    function closeEditModal(){
      const m = document.getElementById('editModal');
      m.classList.add('hidden'); m.classList.remove('flex');
    }

    function setNowTo(id){
      const now = new Date();
      const t = pad2(now.getHours()) + ':' + pad2(now.getMinutes());
      document.getElementById(id).value = t;
    }

    function saveEditModal(){
      const name = document.getElementById('staff-select').value;
      const date = document.getElementById('target-date').value;
      if (!name || !date) return;

      const rec = ensureRecord(date,name);
      rec.in = document.getElementById('editIn').value || '';
      rec.out = document.getElementById('editOut').value || '';
      const b = document.getElementById('editBreak').value;
      rec.breakMin = (b==='' || b==null) ? null : clampInt(b,0,600);
      rec.excludeMin = clampInt(document.getElementById('editExclude').value,0,600);

      const otH = document.getElementById('editManualOT').value;
      rec.manualOTMin = (otH==='' || otH==null) ? null : toMin(otH);

      const wkH = document.getElementById('editManualWeekend').value;
      rec.manualWeekendMin = (wkH==='' || wkH==null) ? null : toMin(wkH);

      rec.memo = (document.getElementById('editMemo').value || '').trim();

      saveAll();
      closeEditModal();
      refreshInputSummary();
      refreshTodayTable();
      refreshMonthly();
      toast("保存しました");
    }

    function toMin(h){
      const n = Number(h);
      if (!isFinite(n) || n < 0) return null;
      return Math.round(n * 60);
    }

    // =========================
    // Overrides (calendar)
    // =========================
    function openOverrideModal(){
      const d = document.getElementById('target-date').value;
      document.getElementById('ovDate').value = d || '';
      document.getElementById('ovMode').value = 'work';
      document.getElementById('ovLabel').value = '';
      document.getElementById('ovNote').value = '';
      const m = document.getElementById('overrideModal');
      m.classList.remove('hidden'); m.classList.add('flex');
    }
    function closeOverrideModal(){
      const m = document.getElementById('overrideModal');
      m.classList.add('hidden'); m.classList.remove('flex');
    }
    function applyOverride(){
      const date = document.getElementById('ovDate').value;
      const mode = document.getElementById('ovMode').value;
      const label = document.getElementById('ovLabel').value.trim();
      const note  = document.getElementById('ovNote').value.trim();
      if (!date){ toast("日付を入力してください"); return; }

      if (mode === 'auto') delete overrides[date];
      else overrides[date] = {mode, label, note};

      saveAll();
      closeOverrideModal();
      renderOverrideTable();
      refreshInputSummary();
      refreshTodayTable();
      refreshMonthly();
      toast("上書きを反映しました");
    }

    function clearAllOverrides(){
      if (!confirm("上書きを全削除しますか？")) return;
      overrides = {};
      saveAll();
      renderOverrideTable();
      refreshInputSummary();
      refreshTodayTable();
      refreshMonthly();
      toast("上書きを削除しました");
    }

    function renderOverrideTable(){
      const body = document.getElementById('overrideBody');
      const keys = Object.keys(overrides||{}).sort();
      if (!keys.length){
        body.innerHTML = `<tr><td colspan="5" class="p-3 text-sm text-gray-500">上書きはありません。</td></tr>`;
        return;
      }
      body.innerHTML = keys.map(k=>{
        const ov = overrides[k];
        const badge = ov.mode==='work'
          ? `<span class="text-xs px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 font-bold">勤務日</span>`
          : `<span class="text-xs px-2 py-1 rounded-full bg-rose-50 text-rose-700 font-bold">休日扱い</span>`;
        return `
          <tr>
            <td class="p-3 text-sm font-semibold">${k}（${weekdayJP(parseDate(k))}）</td>
            <td class="p-3 text-sm">${badge}</td>
            <td class="p-3 text-sm">${escHTML(ov.label || '')}</td>
            <td class="p-3 text-sm text-gray-600">${escHTML(ov.note || '')}</td>
            <td class="p-3 text-sm no-print">
              <button class="px-3 py-2 rounded-xl border bg-white hover:bg-gray-50 text-sm font-semibold text-rose-600"
                      onclick="deleteOverride('${escAttr(k)}')">削除</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function deleteOverride(date){
      if (!confirm(`${date} の上書きを削除しますか？`)) return;
      delete overrides[date];
      saveAll();
      renderOverrideTable();
      refreshInputSummary();
      refreshTodayTable();
      refreshMonthly();
      toast("削除しました");
    }

    // =========================
    // Day mode resolution
    // =========================
    function getDayModeEffective(dateStr){
      const ov = overrides[dateStr];
      if (ov && (ov.mode==='work' || ov.mode==='off')){
        return {
          isWorkday: ov.mode==='work',
          reason: ov.mode==='work' ? '上書き：勤務日' : '上書き：休日（時間外扱い）',
          label: ov.label || '',
          note: ov.note || ''
        };
      }

      const dt = parseDate(dateStr);
      const dow = dt.getDay();
      const isWeekend = (dow===0 || dow===6);
      const isHol = isJapaneseHoliday(dt);

      if (isWeekend) return { isWorkday:false, reason:'自動：土日', label:'', note:'' };
      if (isHol)     return { isWorkday:false, reason:'自動：祝日', label:'', note:'' };
      return { isWorkday:true, reason:'自動：平日（勤務日）', label:'', note:'' };
    }

    function isWeeklyHolidayAuto(dateStr){
      const dt = parseDate(dateStr);
      const dow = dt.getDay();
      const mode = settings.weeklyHolidayMode || 'sat_sun';
      if (mode === 'sun_only') return dow === 0;
      return (dow === 0 || dow === 6);
    }

    // =========================
    // Data helpers
    // =========================
    function ensureRecord(date, name){
      if (!attendanceData[date]) attendanceData[date] = {};
      if (!attendanceData[date][name]) attendanceData[date][name] = {
        in:'', out:'',
        breakMin:null, excludeMin:0,
        manualOTMin:null, manualWeekendMin:null,
        memo:''
      };
      return attendanceData[date][name];
    }
    function getRecord(date, name){ return attendanceData?.[date]?.[name] || null; }

    // =========================
    // Time calc
    // =========================
    function calcRawMinutes(inTime, outTime){
      if (!inTime || !outTime) return null;
      const s = parseTime(inTime), e = parseTime(outTime);
      if (!s || !e) return null;
      let start = s.h*60 + s.m;
      let end = e.h*60 + e.m;
      if (end < start) end += 24*60;
      return Math.max(0, end-start);
    }

    function parseTime(t){
      const m = /^(\d{2}):(\d{2})$/.exec(t);
      if (!m) return null;
      const h = Number(m[1]), mi = Number(m[2]);
      if (h<0||h>23||mi<0||mi>59) return null;
      return {h, m:mi};
    }

    function shiftTime(t, deltaMin){
      const p = parseTime(t);
      if (!p) return t;
      let total = p.h*60 + p.m + deltaMin;
      total = (total + 24*60) % (24*60);
      return pad2(Math.floor(total/60)) + ':' + pad2(total%60);
    }

    // =========================
    // Holiday (general)
    // =========================
    function isJapaneseHoliday(dateObj){
      const y = dateObj.getFullYear();
      const set = buildHolidaysForYear(y);
      const key = `${y}-${pad2(dateObj.getMonth()+1)}-${pad2(dateObj.getDate())}`;
      return set.has(key);
    }

    function buildHolidaysForYear(y){
      if (!buildHolidaysForYear.cache) buildHolidaysForYear.cache = {};
      if (buildHolidaysForYear.cache[y]) return buildHolidaysForYear.cache[y];

      const set = new Set();
      addHol(set,y,1,1);
      addHol(set,y,2,11);
      if (y>=2020) addHol(set,y,2,23);
      addHol(set,y,4,29);
      addHol(set,y,5,3); addHol(set,y,5,4); addHol(set,y,5,5);
      if (y>=2016) addHol(set,y,8,11);
      addHol(set,y,11,3); addHol(set,y,11,23);

      addHol(set,y,1, nthWeekdayOfMonth(y,1,1,2));  // 成人の日
      addHol(set,y,7, nthWeekdayOfMonth(y,7,1,3));  // 海の日
      addHol(set,y,9, nthWeekdayOfMonth(y,9,1,3));  // 敬老の日
      addHol(set,y,10, nthWeekdayOfMonth(y,10,1,2)); // スポーツの日

      addHol(set,y,3, vernalEquinoxDay(y));
      addHol(set,y,9, autumnalEquinoxDay(y));

      // substitute holiday (simple)
      for (let month=1; month<=12; month++){
        const dim = daysInMonth(y,month);
        for (let day=1; day<=dim; day++){
          const key = `${y}-${pad2(month)}-${pad2(day)}`;
          if (!set.has(key)) continue;
          const dt = new Date(y, month-1, day);
          if (dt.getDay()===0){
            for (let i=1; i<=7; i++){
              const dt2 = addDays(dt,i);
              const k2 = toYMD(dt2);
              if (!set.has(k2)){ set.add(k2); break; }
            }
          }
        }
      }

      // citizen holiday
      for (let month=1; month<=12; month++){
        const dim = daysInMonth(y,month);
        for (let day=1; day<=dim; day++){
          const dt = new Date(y, month-1, day);
          const key = toYMD(dt);
          if (set.has(key)) continue;
          const prev = toYMD(addDays(dt,-1));
          const next = toYMD(addDays(dt, 1));
          if (set.has(prev) && set.has(next)) set.add(key);
        }
      }

      buildHolidaysForYear.cache[y] = set;
      return set;
    }

    function addHol(set,y,m,d){ set.add(`${y}-${pad2(m)}-${pad2(d)}`); }
    function nthWeekdayOfMonth(y,m,weekday,nth){
      const first = new Date(y, m-1, 1);
      const offset = (weekday - first.getDay() + 7) % 7;
      return 1 + offset + 7*(nth-1);
    }
    function vernalEquinoxDay(y){
      return Math.floor(20.8431 + 0.242194*(y-1980) - Math.floor((y-1980)/4));
    }
    function autumnalEquinoxDay(y){
      return Math.floor(23.2488 + 0.242194*(y-1980) - Math.floor((y-1980)/4));
    }

    // =========================
    // Backup/restore/reset
    // =========================
    function exportBackupJSON(){
      const payload = { version:6, exportedAt:new Date().toISOString(), staffList, attendanceData, overrides, settings, uiState };
      const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `working_hours_backup_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("バックアップを作成しました");
    }

    function importBackupJSON(event){
      const file = event.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          if (!confirm("復元しますか？（現在のデータは上書き）")) return;

          staffList = Array.isArray(obj.staffList) ? obj.staffList : staffList;
          attendanceData = obj.attendanceData || {};
          overrides = obj.overrides || {};
          settings = obj.settings || settings;
          uiState = obj.uiState || uiState;

          saveAll();
          loadSettingsToUI();
          renderStaffSelect();
          renderStaffSettingsList();
          renderAvgSelector();
          renderOverrideTable();
          refreshInputSummary();
          refreshTodayTable();
          applyTodayPanelState();
          refreshMonthly();
          toast("復元しました");
        } catch(e){
          toast("復元に失敗しました（JSONを確認）");
        } finally {
          event.target.value = "";
        }
      };
      reader.readAsText(file);
    }

    function hardResetAll(){
      if (!confirm("全データを初期化しますか？（戻せません）")) return;
      staffList = [{name:"管理者"}];
      attendanceData = {};
      overrides = {};
      settings = {...DEFAULT_SETTINGS, month: settings.month || currentYM(), avgSelected:["管理者"]};
      uiState = {todayPanelOpen:true, dayExpanded:{}};
      saveAll();
      loadSettingsToUI();
      renderStaffSelect();
      renderStaffSettingsList();
      renderAvgSelector();
      renderOverrideTable();
      refreshInputSummary();
      refreshTodayTable();
      refreshMonthly();
      toast("初期化しました");
    }

    // =========================
    // Persistence + utils
    // =========================
    function saveAll(){
      localStorage.setItem(LS.staff, JSON.stringify(staffList));
      localStorage.setItem(LS.data, JSON.stringify(attendanceData));
      localStorage.setItem(LS.ov, JSON.stringify(overrides));
      localStorage.setItem(LS.set, JSON.stringify(settings));
      localStorage.setItem(LS.ui, JSON.stringify(uiState));
    }

    function loadJSON(key, fallback){
      try{
        const s = localStorage.getItem(key);
        if (!s) return fallback;
        return JSON.parse(s);
      } catch(e){ return fallback; }
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.innerText = msg;
      t.classList.remove('opacity-0');
      setTimeout(()=>t.classList.add('opacity-0'), 2400);
    }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function parseDate(ymd){ const [y,m,d] = ymd.split('-').map(Number); return new Date(y,m-1,d); }
    function toYMD(dt){ return `${dt.getFullYear()}-${pad2(dt.getMonth()+1)}-${pad2(dt.getDate())}`; }
    function addDays(dt,n){ const x = new Date(dt); x.setDate(x.getDate()+n); return x; }
    function daysInMonth(y,m){ return new Date(y,m,0).getDate(); }
    function weekdayJP(dt){ return ["日","月","火","水","木","金","土"][dt.getDay()]; }
    function clampInt(v,min,max){ const n = Math.round(Number(v)); if(!isFinite(n)) return min; return Math.max(min, Math.min(max,n)); }
    function currentYM(){ const d=new Date(); return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`; }

    function escHTML(str){
      return String(str).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }
    function escAttr(str){
      return String(str).replaceAll("\\","\\\\").replaceAll("'","\\'");
    }
  </script>
</body>
</html>
