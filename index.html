<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>引き継ぎ台帳（働き方改革）</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2563eb;
      --accent2:#16a34a;
      --danger:#dc2626;
      --warn:#f59e0b;
      --shadow: 0 10px 25px rgba(0,0,0,.06);
      --radius:14px;
      --radius2:10px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Hiragino Kaku Gothic ProN", "Yu Gothic", "Meiryo", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text); background:linear-gradient(180deg,#eef2ff 0%, var(--bg) 40%, var(--bg) 100%);
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    .wrap{max-width:1180px; margin:0 auto; padding:18px 16px 32px}
    header{
      display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:space-between;
      margin-bottom:14px;
    }
    .title{
      display:flex; gap:12px; align-items:center;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      background:#111827; color:#fff; padding:8px 10px; border-radius:999px;
      font-size:12px; letter-spacing:.02em;
      box-shadow:0 8px 18px rgba(17,24,39,.18);
      user-select:none;
    }
    .badge .dot{width:8px;height:8px;border-radius:999px;background:var(--accent2)}
    h1{margin:0; font-size:22px}
    .sub{margin:2px 0 0; color:var(--muted); font-size:13px}
    .top-actions{
      display:flex; flex-wrap:wrap; gap:8px; justify-content:flex-end;
    }
    button, .btn{
      appearance:none; border:1px solid var(--border); background:#fff; color:var(--text);
      padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; font-size:13px;
      box-shadow:0 1px 0 rgba(0,0,0,.02);
    }
    button:hover{border-color:#cbd5e1}
    .primary{background:var(--accent); color:#fff; border-color:transparent}
    .primary:hover{filter:brightness(.95)}
    .success{background:var(--accent2); color:#fff; border-color:transparent}
    .danger{background:var(--danger); color:#fff; border-color:transparent}
    .ghost{background:transparent}
    .small{padding:8px 10px; font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      background:#fff; border:1px solid var(--border); border-radius:999px; padding:8px 10px;
      color:var(--muted); font-size:12px;
    }
    .grid{
      display:grid; grid-template-columns: 420px 1fr; gap:14px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card .hd{
      padding:12px 14px; border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .bd{padding:14px}
    .hd h2{margin:0; font-size:15px}
    .hint{color:var(--muted); font-size:12px; line-height:1.5}
    .form{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .form .full{grid-column:1/-1}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, select, textarea{
      width:100%; padding:10px 10px; border:1px solid var(--border); border-radius:10px;
      font-size:13px; font-family:var(--sans); background:#fff;
    }
    textarea{min-height:96px; resize:vertical; line-height:1.5}
    input:focus, select:focus, textarea:focus{
      outline:none; border-color:#93c5fd; box-shadow:0 0 0 3px rgba(37,99,235,.15);
    }
    .row{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .row-right{margin-left:auto}
    .sep{height:1px; background:var(--border); margin:12px 0}
    .stats{
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .stat{
      background:#f8fafc; border:1px solid var(--border); border-radius:12px; padding:8px 10px;
      font-size:12px; color:var(--muted);
    }
    .stat b{color:var(--text)}
    table{
      width:100%; border-collapse:separate; border-spacing:0;
      font-size:13px;
    }
    thead th{
      text-align:left; padding:10px 10px; color:var(--muted); font-weight:700;
      border-bottom:1px solid var(--border);
      position:sticky; top:0; background:#fff; z-index:2;
    }
    tbody td{
      padding:10px 10px; border-bottom:1px solid #f1f5f9; vertical-align:top;
    }
    tbody tr:hover{background:#f8fafc}
    .tag{
      display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; font-size:12px;
      border:1px solid var(--border); background:#fff; color:var(--muted);
      white-space:nowrap;
    }
    .tag.high{border-color:#fecaca; background:#fff1f2; color:#991b1b}
    .tag.mid{border-color:#fde68a; background:#fffbeb; color:#92400e}
    .tag.low{border-color:#bbf7d0; background:#f0fdf4; color:#166534}
    .tag.s0{border-color:#cbd5e1; background:#f8fafc; color:#334155}
    .tag.s1{border-color:#bfdbfe; background:#eff6ff; color:#1d4ed8}
    .tag.s2{border-color:#bbf7d0; background:#f0fdf4; color:#166534}
    .tag.s3{border-color:#fecaca; background:#fff1f2; color:#991b1b}
    .mono{font-family:var(--mono); font-size:12px; color:var(--muted)}
    .click{cursor:pointer}
    .two-lines{display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden}
    .toolbar{
      display:grid; grid-template-columns: 1.3fr .8fr .8fr .8fr .8fr; gap:8px;
      padding:12px 14px; border-bottom:1px solid var(--border);
      background:#fff; border-top-left-radius:var(--radius); border-top-right-radius:var(--radius);
    }
    @media (max-width: 980px){
      .toolbar{grid-template-columns:1fr 1fr; }
      .toolbar .wide{grid-column:1/-1}
    }
    .toast{
      position:fixed; bottom:16px; left:50%; transform:translateX(-50%);
      background:#111827; color:#fff; padding:10px 12px; border-radius:999px;
      box-shadow:0 12px 25px rgba(0,0,0,.18);
      font-size:13px; opacity:0; pointer-events:none; transition:opacity .18s ease;
      max-width:min(820px, calc(100% - 24px));
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .toast.show{opacity:1}
    .print-note{display:none}
    @media print{
      body{background:#fff}
      .no-print{display:none !important}
      .wrap{max-width:none; padding:0}
      .card{box-shadow:none; border:0}
      .toolbar{position:static}
      thead th{position:static}
      .print-note{display:block; margin:0 0 10px; color:#111827}
      a{text-decoration:none; color:#111827}
      .tag{border-color:#cbd5e1 !important; background:#fff !important; color:#111827 !important}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header class="no-print">
      <div class="title">
        <div class="badge"><span class="dot"></span>オフライン対応（localStorage）</div>
        <div>
          <h1>引き継ぎ台帳</h1>
          <div class="sub">「次にやる一手」と「期限」と「資料導線」を残して、属人化を減らす</div>
        </div>
      </div>
      <div class="top-actions">
        <button id="btnNew" class="primary">新規作成</button>
        <button id="btnBackup" class="success">バックアップ（JSON）</button>
        <label class="btn small" style="display:inline-flex;align-items:center;gap:8px;">
          復元（JSON）
          <input id="fileRestore" type="file" accept="application/json" style="display:none" />
        </label>
        <button id="btnExportCsv">CSV出力</button>
        <button id="btnPrint">印刷</button>
        <button id="btnReset" class="danger">全消去</button>
      </div>
    </header>

    <div class="grid">
      <!-- Left: Form -->
      <section class="card no-print">
        <div class="hd">
          <h2 id="formTitle">新規登録</h2>
          <span class="pill" title="端末・ブラウザに保存されます。定期的なバックアップ推奨。">保存先：端末内</span>
        </div>
        <div class="bd">
          <div class="hint">
            ・最重要は「次にやる一手」。読む人が迷わない1行を入れる。<br>
            ・リンクはURLでも、校内共有フォルダのファイル名でもOK。
          </div>
          <div class="sep"></div>

          <form id="entryForm" class="form" autocomplete="off">
            <div>
              <label>分掌/領域</label>
              <input id="fArea" placeholder="例：教務、研究、保健、ICT、行事" />
            </div>
            <div>
              <label>時期</label>
              <select id="fSeason">
                <option value="通年">通年</option>
                <option value="4月">4月</option>
                <option value="5月">5月</option>
                <option value="6月">6月</option>
                <option value="7月">7月</option>
                <option value="8月">8月</option>
                <option value="9月">9月</option>
                <option value="10月">10月</option>
                <option value="11月">11月</option>
                <option value="12月">12月</option>
                <option value="1月">1月</option>
                <option value="2月">2月</option>
                <option value="3月">3月</option>
                <option value="年度末">年度末</option>
              </select>
            </div>

            <div class="full">
              <label>タスク名（やること）</label>
              <input id="fTitle" placeholder="例：学校評価アンケートの実施と集計" required />
            </div>

            <div class="full">
              <label>次にやる一手（最初の行動）</label>
              <input id="fNext" placeholder="例：昨年度のFormsを複製→締切日だけ更新→職員へURL共有" required />
            </div>

            <div>
              <label>締切日（任意）</label>
              <input id="fDue" type="date" />
            </div>
            <div>
              <label>優先度</label>
              <select id="fPriority">
                <option value="高">高</option>
                <option value="中" selected>中</option>
                <option value="低">低</option>
              </select>
            </div>

            <div>
              <label>ステータス</label>
              <select id="fStatus">
                <option value="未着手" selected>未着手</option>
                <option value="進行中">進行中</option>
                <option value="完了">完了</option>
                <option value="保留">保留</option>
              </select>
            </div>
            <div>
              <label>関係者（役職名など）</label>
              <input id="fOwner" placeholder="例：教務、教頭、担任、事務" />
            </div>

            <div class="full">
              <label>手順（短く箇条書き推奨）</label>
              <textarea id="fSteps" placeholder="例：
・昨年度データを確認
・実施日と締切を決める
・配信→回収→集計→共有"></textarea>
            </div>

            <div class="full">
              <label>関連資料（URL / ファイル名 / 保存場所）</label>
              <input id="fLinks" placeholder="例：https://... / 共有フォルダ：学校評価_2026.xlsx" />
            </div>

            <div class="full">
              <label>メモ（任意）</label>
              <textarea id="fMemo" placeholder="例：今年度は紙配布なし、Teamsで周知。"></textarea>
            </div>

            <div class="full row">
              <input type="hidden" id="fId" />
              <button type="submit" class="primary" id="btnSave">保存</button>
              <button type="button" id="btnCancel">取消</button>
              <span class="row-right mono" id="lastSaved"></span>
            </div>
          </form>

          <div class="sep"></div>
          <div class="hint">
            注意：このアプリは端末・ブラウザ内に保存されます。<br>
            ブラウザのキャッシュ削除や端末変更でデータが消える場合があります。定期的に「バックアップ（JSON）」を保存してください。
          </div>
        </div>
      </section>

      <!-- Right: List -->
      <section class="card">
        <div class="toolbar no-print">
          <div class="wide">
            <label>検索（タスク/一手/手順/資料/メモ）</label>
            <input id="q" placeholder="例：学校評価、引き継ぎ、アンケート、締切…" />
          </div>
          <div>
            <label>分掌</label>
            <input id="filtArea" placeholder="例：教務" />
          </div>
          <div>
            <label>時期</label>
            <select id="filtSeason">
              <option value="">すべて</option>
              <option value="通年">通年</option>
              <option value="4月">4月</option><option value="5月">5月</option><option value="6月">6月</option>
              <option value="7月">7月</option><option value="8月">8月</option><option value="9月">9月</option>
              <option value="10月">10月</option><option value="11月">11月</option><option value="12月">12月</option>
              <option value="1月">1月</option><option value="2月">2月</option><option value="3月">3月</option>
              <option value="年度末">年度末</option>
            </select>
          </div>
          <div>
            <label>ステータス</label>
            <select id="filtStatus">
              <option value="">すべて</option>
              <option value="未着手">未着手</option>
              <option value="進行中">進行中</option>
              <option value="完了">完了</option>
              <option value="保留">保留</option>
            </select>
          </div>
          <div>
            <label>優先度</label>
            <select id="filtPriority">
              <option value="">すべて</option>
              <option value="高">高</option>
              <option value="中">中</option>
              <option value="低">低</option>
            </select>
          </div>
        </div>

        <div class="hd">
          <h2>一覧</h2>
          <div class="stats" id="stats"></div>
        </div>

        <div class="bd" style="padding:0">
          <div class="print-note">
            <h2 style="margin:0 0 6px;">引き継ぎ台帳</h2>
            <div class="hint" style="margin:0 0 10px;">印刷日時：<span id="printTime"></span></div>
          </div>

          <div style="max-height: calc(100vh - 220px); overflow:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:110px;">分掌</th>
                  <th style="width:90px;">時期</th>
                  <th>タスク / 次にやる一手</th>
                  <th style="width:120px;">期限</th>
                  <th style="width:92px;">優先度</th>
                  <th style="width:100px;">状態</th>
                  <th style="width:150px;">更新</th>
                  <th class="no-print" style="width:120px;">操作</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
          </div>
        </div>
      </section>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(function(){
  "use strict";

  const STORAGE_KEY = "hikitsugi_daicho_v1";
  const nowISO = () => new Date().toISOString();
  const fmtDateTime = (iso) => {
    if(!iso) return "";
    const d = new Date(iso);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${y}-${m}-${day} ${hh}:${mm}`;
  };
  const fmtDate = (yyyy_mm_dd) => {
    if(!yyyy_mm_dd) return "";
    // input[type=date] gives yyyy-mm-dd
    return yyyy_mm_dd;
  };

  const el = (id)=>document.getElementById(id);
  const toast = el("toast");
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add("show");
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove("show"), 1600);
  }

  /** data model
   * { id, area, season, title, next, due, priority, status, owner, steps, links, memo, updatedAt, createdAt }
   */
  function load(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    try{
      const data = JSON.parse(raw);
      if(Array.isArray(data)) return data;
      return [];
    }catch(e){
      console.warn(e);
      return [];
    }
  }
  function saveAll(items){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  let items = load();

  // DOM refs
  const formTitle = el("formTitle");
  const entryForm = el("entryForm");
  const fId = el("fId");
  const fArea = el("fArea");
  const fSeason = el("fSeason");
  const fTitle = el("fTitle");
  const fNext = el("fNext");
  const fDue = el("fDue");
  const fPriority = el("fPriority");
  const fStatus = el("fStatus");
  const fOwner = el("fOwner");
  const fSteps = el("fSteps");
  const fLinks = el("fLinks");
  const fMemo = el("fMemo");
  const lastSaved = el("lastSaved");

  const q = el("q");
  const filtArea = el("filtArea");
  const filtSeason = el("filtSeason");
  const filtStatus = el("filtStatus");
  const filtPriority = el("filtPriority");

  const tbody = el("tbody");
  const stats = el("stats");

  // Buttons
  el("btnNew").addEventListener("click", ()=>resetForm(true));
  el("btnCancel").addEventListener("click", ()=>resetForm(true));
  el("btnPrint").addEventListener("click", ()=>{
    el("printTime").textContent = fmtDateTime(nowISO());
    window.print();
  });
  el("btnReset").addEventListener("click", ()=>{
    if(!confirm("本当に全データを消去しますか？（戻せません）")) return;
    items = [];
    saveAll(items);
    render();
    resetForm(true);
    showToast("全データを消去しました");
  });

  // Backup
  el("btnBackup").addEventListener("click", ()=>{
    const payload = {
      app: "hikitsugi_daicho",
      version: 1,
      exportedAt: nowISO(),
      items
    };
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    const ts = new Date();
    const y = ts.getFullYear();
    const m = String(ts.getMonth()+1).padStart(2,"0");
    const d = String(ts.getDate()).padStart(2,"0");
    const hh = String(ts.getHours()).padStart(2,"0");
    const mm = String(ts.getMinutes()).padStart(2,"0");
    a.href = URL.createObjectURL(blob);
    a.download = `hikitsugi_daicho_backup_${y}${m}${d}_${hh}${mm}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    showToast("バックアップを作成しました");
  });

  // Restore
  el("fileRestore").addEventListener("change", async (ev)=>{
    const file = ev.target.files && ev.target.files[0];
    ev.target.value = "";
    if(!file) return;

    try{
      const text = await file.text();
      const obj = JSON.parse(text);

      // accept either {items:[...]} or direct array
      let restored = null;
      if(Array.isArray(obj)) restored = obj;
      else if(obj && Array.isArray(obj.items)) restored = obj.items;

      if(!Array.isArray(restored)){
        alert("復元できませんでした（形式が不正）");
        return;
      }

      if(!confirm(`復元すると現在のデータが上書きされます。復元しますか？（件数：${restored.length}）`)) return;

      // sanity normalize
      restored = restored.map(normalizeItem).filter(Boolean);
      items = restored;
      saveAll(items);
      render();
      resetForm(true);
      showToast("復元しました");
    }catch(e){
      console.warn(e);
      alert("復元できませんでした（JSONの読み込みエラー）");
    }
  });

  // CSV export
  el("btnExportCsv").addEventListener("click", ()=>{
    const cols = [
      ["id","ID"],
      ["area","分掌/領域"],
      ["season","時期"],
      ["title","タスク名"],
      ["next","次にやる一手"],
      ["due","締切日"],
      ["priority","優先度"],
      ["status","ステータス"],
      ["owner","関係者"],
      ["steps","手順"],
      ["links","関連資料"],
      ["memo","メモ"],
      ["updatedAt","最終更新"],
      ["createdAt","作成"]
    ];
    const esc = (v)=>{
      const s = (v ?? "").toString().replace(/\r\n/g,"\n").replace(/\r/g,"\n");
      // wrap if contains comma/quote/newline
      if(/[",\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
      return s;
    };
    const lines = [];
    lines.push(cols.map(c=>esc(c[1])).join(","));
    for(const it of items){
      lines.push(cols.map(c=>esc(it[c[0]])).join(","));
    }
    const bom = "\uFEFF"; // Excel friendly
    const blob = new Blob([bom + lines.join("\n")], {type:"text/csv;charset=utf-8"});
    const a = document.createElement("a");
    const ts = new Date();
    const y = ts.getFullYear();
    const m = String(ts.getMonth()+1).padStart(2,"0");
    const d = String(ts.getDate()).padStart(2,"0");
    a.href = URL.createObjectURL(blob);
    a.download = `hikitsugi_daicho_${y}${m}${d}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);
    showToast("CSVを出力しました");
  });

  // Filters re-render
  [q,filtArea,filtSeason,filtStatus,filtPriority].forEach(inp=>{
    inp.addEventListener("input", render);
    inp.addEventListener("change", render);
  });

  // Form submit
  entryForm.addEventListener("submit", (ev)=>{
    ev.preventDefault();

    const payload = normalizeItem({
      id: fId.value || makeId(),
      area: fArea.value.trim(),
      season: fSeason.value,
      title: fTitle.value.trim(),
      next: fNext.value.trim(),
      due: fDue.value,
      priority: fPriority.value,
      status: fStatus.value,
      owner: fOwner.value.trim(),
      steps: fSteps.value.trim(),
      links: fLinks.value.trim(),
      memo: fMemo.value.trim(),
      updatedAt: nowISO(),
      createdAt: fId.value ? (findById(fId.value)?.createdAt || nowISO()) : nowISO()
    });

    if(!payload.title || !payload.next){
      alert("「タスク名」と「次にやる一手」は必須です。");
      return;
    }

    const idx = items.findIndex(x=>x.id===payload.id);
    if(idx >= 0){
      items[idx] = payload;
      showToast("更新しました");
    }else{
      items.unshift(payload);
      showToast("追加しました");
    }
    saveAll(items);
    render();
    resetForm(false);
  });

  function makeId(){
    // simple: yyyymmddHHMMSS + random
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    const ss = String(d.getSeconds()).padStart(2,"0");
    const r = Math.random().toString(16).slice(2,6);
    return `${y}${m}${day}${hh}${mm}${ss}-${r}`;
  }

  function normalizeItem(x){
    if(!x || typeof x !== "object") return null;
    const out = {
      id: (x.id ?? "").toString(),
      area: (x.area ?? "").toString(),
      season: (x.season ?? "通年").toString(),
      title: (x.title ?? "").toString(),
      next: (x.next ?? "").toString(),
      due: (x.due ?? "").toString(),
      priority: (x.priority ?? "中").toString(),
      status: (x.status ?? "未着手").toString(),
      owner: (x.owner ?? "").toString(),
      steps: (x.steps ?? "").toString(),
      links: (x.links ?? "").toString(),
      memo: (x.memo ?? "").toString(),
      updatedAt: (x.updatedAt ?? nowISO()).toString(),
      createdAt: (x.createdAt ?? nowISO()).toString()
    };
    if(!out.id) out.id = makeId();
    return out;
  }

  function findById(id){
    return items.find(x=>x.id===id) || null;
  }

  function resetForm(clearFocus){
    fId.value = "";
    fArea.value = "";
    fSeason.value = "通年";
    fTitle.value = "";
    fNext.value = "";
    fDue.value = "";
    fPriority.value = "中";
    fStatus.value = "未着手";
    fOwner.value = "";
    fSteps.value = "";
    fLinks.value = "";
    fMemo.value = "";
    formTitle.textContent = "新規登録";
    lastSaved.textContent = "";
    if(clearFocus) fTitle.focus();
  }

  function editItem(id){
    const it = findById(id);
    if(!it) return;
    fId.value = it.id;
    fArea.value = it.area || "";
    fSeason.value = it.season || "通年";
    fTitle.value = it.title || "";
    fNext.value = it.next || "";
    fDue.value = it.due || "";
    fPriority.value = it.priority || "中";
    fStatus.value = it.status || "未着手";
    fOwner.value = it.owner || "";
    fSteps.value = it.steps || "";
    fLinks.value = it.links || "";
    fMemo.value = it.memo || "";
    formTitle.textContent = "編集";
    lastSaved.textContent = `最終更新：${fmtDateTime(it.updatedAt)}`;
    window.scrollTo({top:0, behavior:"smooth"});
    showToast("編集モードにしました");
  }

  function deleteItem(id){
    const it = findById(id);
    if(!it) return;
    if(!confirm(`削除しますか？\n\n${it.title}`)) return;
    items = items.filter(x=>x.id!==id);
    saveAll(items);
    render();
    resetForm(false);
    showToast("削除しました");
  }

  function priorityTag(p){
    if(p==="高") return `<span class="tag high">高</span>`;
    if(p==="低") return `<span class="tag low">低</span>`;
    return `<span class="tag mid">中</span>`;
  }
  function statusTag(s){
    if(s==="未着手") return `<span class="tag s0">未着手</span>`;
    if(s==="進行中") return `<span class="tag s1">進行中</span>`;
    if(s==="完了") return `<span class="tag s2">完了</span>`;
    return `<span class="tag s3">保留</span>`;
  }

  function matchesFilters(it){
    const text = (q.value||"").trim().toLowerCase();
    const a = (filtArea.value||"").trim().toLowerCase();
    const se = (filtSeason.value||"").trim();
    const st = (filtStatus.value||"").trim();
    const pr = (filtPriority.value||"").trim();

    if(a){
      if(!(it.area||"").toLowerCase().includes(a)) return false;
    }
    if(se){
      if((it.season||"") !== se) return false;
    }
    if(st){
      if((it.status||"") !== st) return false;
    }
    if(pr){
      if((it.priority||"") !== pr) return false;
    }
    if(text){
      const blob = [
        it.area, it.season, it.title, it.next, it.owner, it.steps, it.links, it.memo, it.due, it.priority, it.status
      ].join(" ").toLowerCase();
      if(!blob.includes(text)) return false;
    }
    return true;
  }

  function render(){
    const view = items.filter(matchesFilters);

    // Stats
    const total = items.length;
    const shown = view.length;
    const c0 = view.filter(x=>x.status==="未着手").length;
    const c1 = view.filter(x=>x.status==="進行中").length;
    const c2 = view.filter(x=>x.status==="完了").length;
    const c3 = view.filter(x=>x.status==="保留").length;

    stats.innerHTML = `
      <div class="stat">表示 <b>${shown}</b> / 全体 <b>${total}</b></div>
      <div class="stat">未着手 <b>${c0}</b></div>
      <div class="stat">進行中 <b>${c1}</b></div>
      <div class="stat">完了 <b>${c2}</b></div>
      <div class="stat">保留 <b>${c3}</b></div>
    `;

    // Rows
    tbody.innerHTML = view.map(it=>{
      const due = it.due ? fmtDate(it.due) : "";
      const updated = fmtDateTime(it.updatedAt);
      const area = (it.area||"").trim() || "未設定";
      const season = it.season || "通年";

      // links: if starts with http, clickable. otherwise plain.
      const links = (it.links||"").trim();
      let linksHtml = "";
      if(links){
        if(/^https?:\/\//i.test(links)){
          linksHtml = `資料：<a href="${escapeHtml(links)}" target="_blank" rel="noopener">リンク</a>`;
        }else{
          linksHtml = `資料：${escapeHtml(links)}`;
        }
      }

      return `
        <tr>
          <td><span class="tag">${escapeHtml(area)}</span></td>
          <td><span class="tag">${escapeHtml(season)}</span></td>
          <td>
            <div style="font-weight:800; margin-bottom:4px;">${escapeHtml(it.title)}</div>
            <div class="two-lines" style="color:#111827;">次：${escapeHtml(it.next)}</div>
            ${it.steps ? `<div class="two-lines" style="margin-top:6px;color:var(--muted);">手順：${escapeHtml(it.steps)}</div>` : ``}
            ${links ? `<div style="margin-top:6px;color:var(--muted);">${linksHtml}</div>` : ``}
            ${it.memo ? `<div class="two-lines" style="margin-top:6px;color:var(--muted);">メモ：${escapeHtml(it.memo)}</div>` : ``}
          </td>
          <td>${due ? `<span class="mono">${escapeHtml(due)}</span>` : `<span class="mono">-</span>`}</td>
          <td>${priorityTag(it.priority)}</td>
          <td>${statusTag(it.status)}</td>
          <td><span class="mono">${escapeHtml(updated)}</span></td>
          <td class="no-print">
            <div class="row">
              <button class="small" data-act="edit" data-id="${escapeAttr(it.id)}">編集</button>
              <button class="small danger" data-act="del" data-id="${escapeAttr(it.id)}">削除</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    // bind row actions (event delegation)
    tbody.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const act = btn.getAttribute("data-act");
        const id = btn.getAttribute("data-id");
        if(act==="edit") editItem(id);
        if(act==="del") deleteItem(id);
      });
    });
  }

  function escapeHtml(s){
    return (s??"").toString()
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#39;");
  }
  function escapeAttr(s){ return escapeHtml(s).replaceAll("\n"," "); }

  // Seed example if empty
  if(items.length===0){
    items = [
      normalizeItem({
        id: makeId(),
        area:"教務",
        season:"通年",
        title:"引き継ぎ台帳の運用更新",
        next:"年度末にバックアップ（JSON）を保存し、新年度最初の職員会議で共有する",
        due:"",
        priority:"中",
        status:"未着手",
        owner:"教務主任",
        steps:"・このHTMLを職員室PCで開く\n・月1回バックアップ\n・年度末にCSVも出力して保管",
        links:"",
        memo:"まずは1台運用で安定させる",
        updatedAt: nowISO(),
        createdAt: nowISO()
      }),
      normalizeItem({
        id: makeId(),
        area:"研究",
        season:"年度末",
        title:"研究関係のデータと様式の保管場所を整理",
        next:"共有フォルダの「研究_年度」内に、様式と最終版資料をまとめる",
        due:"",
        priority:"高",
        status:"未着手",
        owner:"研究主任",
        steps:"・様式フォルダを作成\n・最新版の場所を1か所に\n・リンクを台帳に貼る（URLまたはファイル名）",
        links:"",
        memo:"",
        updatedAt: nowISO(),
        createdAt: nowISO()
      })
    ];
    saveAll(items);
  }

  resetForm(false);
  render();
  showToast("起動しました（データは端末内に保存）");
})();
</script>
</body>
</html>
