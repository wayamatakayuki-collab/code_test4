<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>在校等時間管理</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js (optional) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS (Excel import/export) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;600;700&display=swap');
    :root{
      --ink:#111827; --muted:#6b7280; --card:#fff; --line:#e5e7eb;
      --brand:#2563eb; --brand2:#7c3aed; --brand3:#06b6d4; --danger:#ef4444; --ok:#10b981; --warn:#f59e0b;
      --bg:#f3f7ff;
      --radius:18px;
      --shadow: 0 18px 40px rgba(2,6,23,.06), 0 2px 8px rgba(2,6,23,.04);
      --ring: 0 0 0 3px rgba(37,99,235,.18);
    }
    body{ font-family: Inter, "Noto Sans JP", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji"; background:var(--bg); color:var(--ink); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); box-shadow:var(--shadow); }
    .tab-btn{ padding:.6rem .9rem; border-bottom:2px solid transparent; font-weight:700; color:var(--muted); }
    .tab-btn.active{ color:var(--brand); border-bottom-color:var(--brand); }

    /* 管理者専用UIはログインまで非表示（ロード中の一瞬の表示も防止） */
    [data-admin-only="1"]{ display:none; }
    .chip{ display:inline-flex; align-items:center; gap:.35rem; border:1px solid var(--line); border-radius:999px; padding:.25rem .55rem; font-size:.8rem; background:#fff; }

.chip{ cursor:pointer; user-select:none; }
.chip .dot{ transition: transform .12s ease, background .12s ease, border-color .12s ease; }
.chip.on{
  background: rgba(37,99,235,.10);
  border-color: rgba(37,99,235,.35);
}
.chip.on .dot{
  background: #2563eb;
  border-color: #2563eb;
  transform: scale(1.03);
}

.avg-pill{
  font-size: 12px;
  font-weight: 900;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--line);
  background: #f8fafc;
  color: #334155;
}

.rankBox{ display:flex; flex-direction:column; line-height:1; }
.rankLetter{ font-family: "Bebas Neue","Inter","Noto Sans JP",system-ui,-apple-system,"Segoe UI",sans-serif; font-size: 44px; font-weight: 900; letter-spacing: .08em; }
.rankWord{ font-family: "Inter","Noto Sans JP",system-ui,-apple-system,"Segoe UI",sans-serif; font-size: 12px; font-weight: 800; letter-spacing: .22em; text-transform: uppercase; color: #475569; }
.avg-pill.on{
  background: rgba(37,99,235,.12);
  border-color: rgba(37,99,235,.35);
  color: #1d4ed8;
}
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .btn{ border-radius:14px; font-weight:700; padding:.55rem .9rem; transition:.15s; border:1px solid #e2e8f0; background:#fff; color:#0f172a; }
    .btn.active{ background:var(--brand); color:#fff; border-color:transparent; }
    .btn:focus{ outline:none; box-shadow: var(--ring); }
    .btn-primary{ background: linear-gradient(135deg, var(--brand) 0%, var(--brand2) 70%); color:#fff; box-shadow: 0 10px 18px rgba(37,99,235,.18); }
    .btn-primary:hover{ filter:brightness(.95); }
    .btn-ghost{ background:#fff; border-color:var(--line); color:var(--ink); }
    .btn-ghost:hover{ background:#f8fafc; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .btn-danger:hover{ filter:brightness(.95); }
    .btn-ok{ background:var(--ok); color:#fff; }
    .btn-ok:hover{ filter:brightness(.95); }
    .input{ width:100%; border:1px solid var(--line); border-radius:14px; padding:.55rem .7rem; background:#fff; }
    .input:focus{ outline:none; box-shadow: var(--ring); border-color: rgba(37,99,235,.35); }

    /* 入力タブ：職員選択カードの状態（出勤前=白 / 出勤後=青 / 退勤後=赤） */
    #inpStaffBtn.staffState-in{
      background: rgba(37,99,235,.06);
      border-color: rgba(37,99,235,.35);
    }
    #inpStaffBtn.staffState-in .mono{ color:#1d4ed8; }
    #inpStaffBtn.staffState-out{
      background: rgba(239,68,68,.06);
      border-color: rgba(239,68,68,.35);
    }
    #inpStaffBtn.staffState-out .mono{ color:#b91c1c; }

	    /* 入力タブ：職員選択モーダル（一覧ボタン）も同じ色分け */
	    .staffPickBtn.staffState-in{
	      background: rgba(37,99,235,.06);
	      border-color: rgba(37,99,235,.35);
	    }
	    .staffPickBtn.staffState-in .mono{ color:#1d4ed8; }
	    .staffPickBtn.staffState-in .font-black{ color:#1d4ed8; }
	    .staffPickBtn.staffState-out{
	      background: rgba(239,68,68,.06);
	      border-color: rgba(239,68,68,.35);
	    }
	    .staffPickBtn.staffState-out .mono{ color:#b91c1c; }
	    .staffPickBtn.staffState-out .font-black{ color:#b91c1c; }
	    /* 選択中の強調（状態色に追従） */
	    .staffPickBtn.active{ box-shadow: 0 0 0 3px rgba(37,99,235,.18); }
	    .staffPickBtn.staffState-out.active{ box-shadow: 0 0 0 3px rgba(239,68,68,.18); }
	    /* active時に白文字にならないよう、状態色に合わせて上書き */
	    .staffPickBtn.staffState-in.active{ background: rgba(37,99,235,.08) !important; border-color: rgba(37,99,235,.45) !important; color:#0f172a !important; }
	    .staffPickBtn.staffState-out.active{ background: rgba(239,68,68,.08) !important; border-color: rgba(239,68,68,.45) !important; color:#0f172a !important; }

            /* 出勤前（通常）の一覧：背景=白／文字=濃いグレー（activeでも白文字にしない） */
            .staffPickBtn:not(.staffState-in):not(.staffState-out){ background:#fff; border-color: var(--line); color:#0f172a; }
            .staffPickBtn:not(.staffState-in):not(.staffState-out) .font-black{ color:#0f172a; }
            .staffPickBtn:not(.staffState-in):not(.staffState-out) .mono{ color:#475569; }
            .staffPickBtn.active:not(.staffState-in):not(.staffState-out){ background:#fff !important; border-color: rgba(37,99,235,.35) !important; color:#0f172a !important; }
            .staffPickBtn.active:not(.staffState-in):not(.staffState-out) .mono{ color:#475569 !important; }

            /* 職員選択モーダル：横6人（6×5=30名はスクロールなし） */
            .staffPickGrid{
              display:grid;
              grid-template-columns: repeat(6, minmax(0,1fr));
              gap:.35rem;
              max-height: calc(5 * 68px + 4 * .35rem);
              overflow-y: auto;
              padding-right: 2px;
            }
            @media (max-width: 980px){
              .staffPickGrid{ grid-template-columns: repeat(4, minmax(0,1fr)); max-height: calc(5 * 68px + 4 * .35rem); }
            }
            @media (max-width: 640px){
              .staffPickGrid{ grid-template-columns: repeat(3, minmax(0,1fr)); max-height: calc(6 * 68px + 5 * .35rem); }
            }
            .staffPickBtn{ min-height: 68px; padding: .45rem .55rem; }
            .staffPickName{
              white-space: normal;
              line-height: 1.15;
              word-break: keep-all;
            }
            .staffPickBtn .mono{ font-size: .72rem; }


    /* 職員選択ボタン：30名が1画面に収まる密度 */
    .staffPickBtn{ padding: .42rem .55rem !important; border-radius: 14px !important; }
    .staffPickBtn .font-black{ font-size: .92rem; }
    .staffPickBtn .small{ font-size: .72rem; }

    .small{ font-size:.82rem; color:var(--muted); }
    .sticky-head thead th{ position: sticky; top: 0; background: #f8fafc; z-index: 2; }
    @media print{
      .no-print{ display:none !important; }
      body{ background:#fff; }
      .card{ box-shadow:none; }
    }
  
    /* Safari描画遅延対策：強制再描画キック */
    #paintKick{ position:fixed; left:0; top:0; width:2px; height:2px; opacity:0; pointer-events:none; }
    .kick-anim{ animation: kickAnim 0.001s linear 1; }
    @keyframes kickAnim { from { transform: translateZ(0) translateX(0); } to { transform: translateZ(0) translateX(1px); } }

    /* --- polish --- */
    .app-wrap{ max-width: 1120px; }
    .bg-grad{ background:
      radial-gradient(1000px 420px at 20% -140px, rgba(124,58,237,.18), transparent 62%),
      radial-gradient(900px 360px at 80% -120px, rgba(6,182,212,.16), transparent 62%),
      radial-gradient(1200px 420px at 50% -120px, rgba(37,99,235,.14), transparent 60%),
      var(--bg);
    }
    .card{ box-shadow: 0 14px 32px rgba(2,6,23,.06), 0 2px 10px rgba(2,6,23,.04); }
    .btn{ transition: transform .05s ease, filter .15s ease, background-color .15s ease, border-color .15s ease; }
    .btn:active{ transform: translateY(1px); }
    .btn:focus{ outline:none; box-shadow: var(--ring); }
    .input:focus{ outline:none; box-shadow: var(--ring); border-color: rgba(37,99,235,.55); }
    .sticky-head thead th{ position: sticky; top: 0; background: rgba(248,250,252,.96); backdrop-filter: blur(6px); z-index: 5; border-bottom:1px solid var(--line); }
    .table-zebra tbody tr:nth-child(odd){ background: rgba(248,250,252,.65); }
    .table-zebra tbody tr:hover{ background: rgba(37,99,235,.06); }
    .ov-hit{ background: rgba(254, 249, 195, 1) !important; }
    .ov-hit:hover{ background: rgba(254, 249, 195, 1) !important; }
    .section-title{ font-weight:900; letter-spacing:.02em; }
    .subtle{ color: var(--muted); }
    .pill{ border-radius: 999px; padding: .2rem .55rem; font-size: .75rem; border:1px solid var(--line); background:#fff; }
    /* print layout */
    @media print{
      body{ background:#fff !important; }
      .card{ box-shadow:none !important; }
      .no-print{ display:none !important; }
      .print-only{ display:block !important; }
      .page-break{ break-before: page; }
    }


/* Print overlay */
#printOverlay{ position:fixed; inset:0; background:#f8fafc; z-index:99999; display:none; }
#printOverlay.show{ display:block; }
.printOverlayBar{ position:sticky; top:0; z-index:2; background:rgba(255,255,255,.92); backdrop-filter:saturate(180%) blur(8px); border-bottom:1px solid #e5e7eb; padding:10px 14px; display:flex; align-items:center; justify-content:space-between; }
.printFrame{ width:100%; height:calc(100vh - 56px); border:0; background:#fff; }

@media print{
  body > *:not(#printOverlay){ display:none !important; }
  #printOverlay{ display:block !important; position:static; inset:auto; background:#fff; }
  .printOverlayBar{ display:none !important; }
  .printFrame{ height:auto !important; }
}


#toast{z-index:1000000;}

/* Staff drag sort */
.dragHandle{
  display:inline-flex;
  width: 2.1rem;
  height: 2.1rem;
  align-items:center;
  justify-content:center;
  border:1px solid var(--line);
  border-radius: 12px;
  background: var(--soft2);
  cursor: grab;
  user-select:none;
  font-weight:900;
  color: var(--muted);
}
tr.is-dragging{ opacity:.55; }
tr.is-drop-target{ outline: 2px solid rgba(37,99,235,.35); outline-offset:-2px; }

    /* --- minimal utilities (works even if Tailwind CDN is blocked) --- */
    .hidden{ display:none !important; }
    .opacity-0{ opacity:0 !important; }
    .pointer-events-none{ pointer-events:none !important; }

  </style>
</head>

<body class="min-h-screen bg-grad">
    <div id="paintKick" aria-hidden="true"></div>
  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- Header -->
    <header class="card p-5 mb-4 flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div class="flex items-start gap-3">
        <div class="w-11 h-11 rounded-2xl bg-blue-50 border border-blue-100 flex items-center justify-center">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7 3v3M17 3v3M4 9h16M6 5h12a2 2 0 0 1 2 2v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2Z" stroke="#2563eb" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1 class="text-xl md:text-2xl font-black tracking-tight">在校等時間 管理システム</h1>
          <div class="mt-2 flex flex-wrap gap-2">
            <span class="chip"><span class="w-2 h-2 rounded-full bg-blue-500 inline-block"></span><span id="chip-month">—</span></span>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span><span id="chip-workday-count">勤務日: —</span></span>
            <span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span><span id="chip-holiday-count">週休日: —</span></span>
</div>
        </div>
      </div>

      <div class="flex items-center justify-between md:justify-end gap-3">
        <div class="flex items-baseline justify-end gap-3">
          <div class="mono text-lg md:text-xl font-black text-slate-700 whitespace-nowrap" id="nowDate">----/--/-- (---)</div>
          <div class="mono text-3xl md:text-4xl font-black text-blue-600 whitespace-nowrap leading-none" id="nowTime">--:--:--</div>
        </div>
        <div class="flex items-center gap-2 no-print">
          <button id="adminLoginBtn" class="btn btn-ghost" onclick="adminToggle()" type="button">管理者ログイン</button>
          <span id="modeBadge" class="pill hidden">管理者モード</span>
          <button class="btn btn-ghost" onclick="goBackInApp()" type="button">戻る</button>
          <button class="btn btn-ghost" onclick="openHelp()" type="button">使い方</button>
        </div>
      </div>
    </header>

    <!-- Tabs -->
    <div class="no-print card px-3 py-2 mb-4">
      <div class="flex flex-wrap gap-2">
        <button class="tab-btn active" id="tab-input" onclick="switchTab('input')" type="button">入力</button>
        <button class="tab-btn" id="tab-calendar" onclick="switchTab('calendar')" type="button">カレンダー</button>
        <button class="tab-btn" id="tab-overview" onclick="switchTab('overview')" type="button">月別 全体一覧</button>
        <button class="tab-btn" id="tab-individual" onclick="switchTab('individual')" type="button">月別 個別一覧</button>
        <button class="tab-btn" id="tab-settings" data-admin-only="1" style="display:none" onclick="switchTab('settings')" type="button">設定・出力</button>
      </div>
    </div>

    <!-- INPUT -->
    <section id="section-input" class="space-y-4">
      <div class="card p-5">
        <div class="flex flex-col gap-4">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
            <div class="md:col-span-4">
              <label class="block text-sm font-black mb-1">職員</label>
              <button id="inpStaffBtn" class="input text-left w-full" onclick="openStaffPicker()" type="button">
                <span class="font-black" id="inpStaffName">職員名を選択</span>
                <span class="small ml-2">（タップして選択）</span>
              </button>
              <input type="hidden" id="inpStaffId" value="">
            </div>

            <div class="md:col-span-4">
              <label class="block text-sm font-black mb-1">日付</label>
              <div class="flex items-center gap-2">
                <button class="btn btn-ghost px-3" onclick="stepDate(-1)" type="button" aria-label="前の日">◀</button>
                <input id="inpDate" type="date" class="input mono flex-1" />
                <button class="btn btn-ghost px-3" onclick="stepDate(1)" type="button" aria-label="次の日">▶</button>
                <button class="btn btn-ghost px-3" onclick="setInputDateToday()" type="button">今日</button>
              </div>
            </div>

            <div class="md:col-span-4">
              <label class="block text-sm font-black mb-1">勤務区分</label>
              <div class="flex items-center justify-between gap-2">
                <div id="inpDayBadge" class="text-sm"></div>
                <button class="btn btn-ghost" onclick="openEditModal()" type="button">編集</button>
              </div>
            </div>
          </div>

          <!-- 最速入力：2ボタン + 業務外 -->
          <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
            <div class="md:col-span-4">
              <button class="btn btn-primary h-20 w-full text-2xl md:text-3xl font-black" onclick="quickStamp('in')" type="button">出 勤（今）</button>
            </div>
            <div class="md:col-span-4">
              <button class="btn btn-danger h-20 w-full text-2xl md:text-3xl font-black" onclick="quickStamp('out')" type="button">退 勤（今）</button>
            </div>
            <div class="md:col-span-4">
              <label class="block text-sm font-black mb-1">業務外（時間）</label>
              <input id="inpOtherOff" type="text" class="input mono" placeholder="例: 0:30 / 0.5" onblur="normalizeHalfInput(this);saveOtherOff()" />
              <div class="small mt-1 text-slate-500">※休憩45分とは別に、業務外の時間を入力します。</div>
            </div>
          </div>

          <!-- 常時表示（1行） -->
          <div class="overflow-x-auto">
            <table class="w-full text-left min-w-[880px]">
              <thead class="bg-slate-50">
                <tr>
                  <th class="p-3 text-sm font-black">氏名</th>
                  <th class="p-3 text-sm font-black">職名</th>
                  <th class="p-3 text-sm font-black">出勤</th>
                  <th class="p-3 text-sm font-black">退勤</th>
                  <th class="p-3 text-sm font-black">在校等</th>
                  <th class="p-3 text-sm font-black">業務外</th>
                  <th class="p-3 text-sm font-black">時間外</th>
                  <th class="p-3 text-sm font-black">今月の時間外</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr>
                  <td class="p-3 text-sm font-bold" id="rowName">—</td>
                  <td class="p-3 text-sm" id="rowType">—</td>
                  <td class="p-3 text-sm mono" id="rowIn">--:--</td>
                  <td class="p-3 text-sm mono" id="rowOut">--:--</td>
                  <td class="p-3 text-sm mono font-black" id="rowStayEq">--:--</td>
                  <td class="p-3 text-sm mono" id="rowOther">0:00</td>
                  <td class="p-3 text-sm mono font-black" id="rowOver">--:--</td>
                  <td class="p-3 text-sm mono font-black" id="rowMonthOver">--:--</td>
                </tr>
              </tbody>
            </table>
          </div>
<div class="mt-3 grid grid-cols-1 lg:grid-cols-12 gap-3">
  <div class="card p-4 lg:col-span-8">
    <div class="flex items-center justify-between gap-3">
      <div class="text-sm font-black">残り（当月合計）</div>
      <div class="small text-slate-600">時間外在校等時間（合計）に対して</div>
    </div>

    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
        <div class="flex items-center justify-between">
          <div class="text-sm font-black">基準① <span class="mono font-black" id="remCap1HLabel">--</span>時間まで</div>
          <div class="small text-slate-600">残り</div>
        </div>
        <div class="mt-1 text-2xl font-black mono" id="remToGoal">--:--</div>
        <div class="mt-2 h-2 bg-white rounded-full overflow-hidden border border-slate-200">
          <div id="remBarGoal" class="h-2" style="width:0%; background: var(--brand);"></div>
        </div>
        <div class="mt-1 flex justify-between small text-slate-600">
          <span id="usedGoal">--:--</span><span id="capGoal">--:--</span>
        </div>
      </div>

      <div class="rounded-2xl border border-slate-200 bg-slate-50 p-3">
        <div class="flex items-center justify-between">
          <div class="text-sm font-black">基準② <span class="mono font-black" id="remCap2HLabel">--</span>時間まで</div>
          <div class="small text-slate-600">残り</div>
        </div>
        <div class="mt-1 text-2xl font-black mono" id="remTo80">--:--</div>
        <div class="mt-2 h-2 bg-white rounded-full overflow-hidden border border-slate-200">
          <div id="remBar80" class="h-2" style="width:0%; background: rgba(239,68,68,.55);"></div>
        </div>
        <div class="mt-1 flex justify-between small text-slate-600">
          <span id="used80">--:--</span><span id="cap80">--:--</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card p-4 lg:col-span-4">
    <div class="text-sm font-black mb-2">在校等時間</div>
    <div class="small text-slate-700 leading-relaxed">
      <div class="mono">在校時間（退勤−出勤）− 休憩（ <span class="mono" id="miniBreak">--</span>）− 業務外</div>

      <div class="mt-4 text-sm font-black text-slate-800">時間外在校等時間</div>
      <div class="mt-1 mono">勤務日：在校等時間−7時間45分</div>
      <div class="mono">週休日：在校時間</div>
    </div>
  </div>
</div>

          <!-- hidden time inputs (kept for internal storage) -->
          <input id="inpIn" type="time" class="hidden" />
          <input id="inpOut" type="time" class="hidden" />
        </div>
      </div>
    </section>

<!-- CALENDAR -->
    <section id="section-calendar" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">カレンダー（週休日のチェック）</h2>
            
          </div>
          <div class="flex flex-wrap items-center gap-2">
            <div class="chip mono" id="calMonthLabel">----</div>
            <button id="btnPrevMonth" class="btn btn-ghost" type="button">◀ 前月</button>
            <button id="btnNextMonth" class="btn btn-ghost" type="button">翌月 ▶</button>
            <span class="small">（月の変更は全タブに反映）</span>
            <span class="w-2"></span>
</div>
        </div>

        <div class="mt-4 grid grid-cols-7 gap-2 text-center">
          <div class="text-xs font-black text-gray-500">日</div>
          <div class="text-xs font-black text-gray-500">月</div>
          <div class="text-xs font-black text-gray-500">火</div>
          <div class="text-xs font-black text-gray-500">水</div>
          <div class="text-xs font-black text-gray-500">木</div>
          <div class="text-xs font-black text-gray-500">金</div>
          <div class="text-xs font-black text-gray-500">土</div>
        </div>

        <div id="calGrid" class="mt-2 grid grid-cols-7 gap-2"></div>

        <div class="mt-4 small">
          ・「休」チェックが <b>ON</b>：週休日（祝日・代休など） → その日の在校等時間は <b>すべて時間外</b> に集計。<br/>
          ・「休」チェックが <b>OFF</b>：勤務日（登校日・土曜授業など） → <b>在校等 − 7:45</b> を時間外として集計。
        </div>
      </div>
    </section>

    <!-- OVERVIEW -->
    <section id="section-overview" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-base md:text-lg font-black whitespace-nowrap">月別 全体一覧（職員別サマリー）</h2>
            
          </div>
          
          <div class="flex flex-wrap items-center gap-2">
            <div class="flex items-center gap-1">
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(-1)">◀</button>
              <input id="ovMonth" type="month" class="input w-40" onchange="onViewMonthChange(this.value)" />
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(1)">▶</button>
              
            </div>
            <input id="ovSearch" class="input w-full md:w-64" placeholder="氏名で絞り込み" oninput="renderOverview()" />
            <button class="btn btn-ok" onclick="exportMonthExcel()">Excel出力（表示月）</button>

            
            <div class="flex flex-wrap items-center gap-2">
              <button class="btn btn-ghost" onclick="openOverviewPrintMenu()" type="button">印刷</button>
              <button class="btn btn-ghost" onclick="openPrintHelp()" type="button">印刷の使い方</button>
            </div>
          </div>
        </div>

        <div class="print-only" style="display:none;margin-top:8px;margin-bottom:8px;"><div style="font-weight:900;font-size:16px;">月別 全体一覧（<span id="printMonthChip"></span>）</div><div style="color:#6b7280;font-size:12px;">※印刷：全体／チェック職員 のいずれか</div></div>
<div class="mt-4 no-print">
  <div class="card p-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div class="flex-1 min-w-[240px]">
        <div class="small font-black mb-1">時間外が○時間以上（当月合計）</div>
        <div class="flex items-center gap-2">
          <input id="ovOverThreshold" class="input w-40 mono" type="number" min="0" step="1" placeholder="例：45" oninput="renderOverview()" />
          <button class="btn btn-ghost px-3" type="button" onclick="clearOvOverThreshold()">クリア</button>
        </div>
      </div>
      <div class="flex-1 min-w-[240px]">
        <div class="small mb-1">結果</div>
        <div id="ovOverResult" class="font-black">—</div>
        <div class="small text-slate-500 mt-1">※分も含めた厳密判定（例：44h59mは45h以上に含まれません）</div>
      </div>
    </div>
    <div id="ovOverNames" class="mt-2 flex flex-wrap gap-1"></div>
  </div>
</div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full min-w-[1200px] text-center sticky-head table-zebra">
            <thead>
              <tr>
  <th class="p-3 text-xs font-black text-center">氏名</th>
  <th class="p-3 text-xs font-black text-center">職名</th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">平日 出勤</div><div class="text-[10px] font-black text-slate-500 leading-none">（平均）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">平日 退勤</div><div class="text-[10px] font-black text-slate-500 leading-none">（平均）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">平日 在校等時間</div><div class="text-[10px] font-black text-slate-500 leading-none">（平均）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">週休日 出勤</div><div class="text-[10px] font-black text-slate-500 leading-none">（平均）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">週休日 退勤</div><div class="text-[10px] font-black text-slate-500 leading-none">（平均）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">週休日 在校等時間</div><div class="text-[10px] font-black text-slate-500 leading-none">（平均）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">業務外</div><div class="text-[10px] font-black text-slate-500 leading-none">（合計）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">時間外在校等時間</div><div class="text-[10px] font-black text-slate-500 leading-none">（合計）</div></th>
  <th class="p-3 text-xs font-black text-center"><div class="whitespace-nowrap">達成度</div></th>
</tr>
            </thead>
            <tbody id="overviewBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
          <div>
            <h3 class="font-black flex items-center gap-2">
              チェック平均
              <span id="avgSelPill" class="avg-pill">対象：—</span>
            </h3>
            <div class="small">チェックした職員の平均を表示します（印刷・集計も同じ対象）。</div>
          </div>
        </div>

        <div class="mt-3" id="avgStaffChecks"></div>

        
<div class="mt-4 grid grid-cols-2 md:grid-cols-3 gap-3">
          <div class="card p-4">
            <div class="small">平日 出勤(平均)</div>
            <div class="mono text-xl font-black" id="avgWdIn">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">平日 退勤(平均)</div>
            <div class="mono text-xl font-black" id="avgWdOut">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">平日 在校等時間(平均)</div>
            <div class="mono text-xl font-black" id="avgWdEq">--:--</div>
          </div>

          <div class="card p-4">
            <div class="small">週休日 出勤(平均)</div>
            <div class="mono text-xl font-black" id="avgOffIn">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">週休日 退勤(平均)</div>
            <div class="mono text-xl font-black" id="avgOffOut">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">週休日 在校等時間(平均)</div>
            <div class="mono text-xl font-black" id="avgOffEq">--:--</div>
          </div>
          <div class="card p-4">
            <div class="small">時間外在校等時間（平均）</div>
            <div class="mono text-xl font-black" id="avgMonthOver">--:--</div>
          </div>
        </div>
      </div>
      </div>
      </div>
    </section>

  </div>

  <div class="max-w-7xl mx-auto px-4 pb-6">


    <!-- INDIVIDUAL -->
    <section id="section-individual" class="hidden space-y-4">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-base md:text-lg font-black whitespace-nowrap">月別 個別一覧</h2>
            
          </div>
          
          <div class="flex flex-wrap items-center gap-2">
            <div class="flex items-center gap-1">
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(-1)">◀</button>
              <input id="indMonth" type="month" class="input w-40" onchange="onViewMonthChange(this.value)" />
              <button class="btn btn-ghost px-3" type="button" onclick="shiftViewYM(1)">▶</button>
              <span id="indMonthChip" class="pill mono"></span>
            </div>
            <select id="indStaff" class="input md:w-72" onchange="renderIndividual()"></select>
            <button class="btn btn-primary" onclick="printIndividual()" type="button">個別レポートを開く（印刷/保存）</button>
            <button class="btn btn-ghost" onclick="openBatchPrintModal()" type="button">一括印刷</button>
            <button class="btn btn-ghost" onclick="openIndEditHelp()">業務外の編集について</button>
            <button class="btn btn-ghost" onclick="openPrintHelp()" type="button">印刷の使い方</button>
          </div>
        </div>

        <div class="overflow-x-auto mt-4">
          <table class="w-full text-left sticky-head table-zebra">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black">日付</th>
                <th class="p-3 text-xs font-black">職名</th>
                <th class="p-3 text-xs font-black">出勤</th>
                <th class="p-3 text-xs font-black">退勤</th>
                <th class="p-3 text-xs font-black">在校等</th>
                <th class="p-3 text-xs font-black">業務外(除く)</th>
                <th class="p-3 text-xs font-black">時間外</th>
                <th class="p-3 text-xs font-black no-print">操作</th>
              </tr>
            </thead>
            <tbody id="indBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- SETTINGS -->
    <section id="section-settings" class="hidden space-y-4" data-admin-only="1" style="display:none">
      <div class="card p-5">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 class="text-lg font-black">設定（このタブで月・勤務条件を調整）</h2>
            
          </div>
          <div class="flex flex-wrap gap-2">
            <button class="btn btn-ghost" onclick="backupJSON()">バックアップ(JSON)</button>
            <button class="btn btn-ghost" onclick="restoreJSON()">復元(JSON)</button>
            <button class="btn btn-ghost" onclick="restoreAutoBackup()">自動バックアップから復元</button>
            <button class="btn btn-danger" onclick="resetAll()">全データ初期化</button>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mt-4">
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">年</label>
            <input id="setYear" type="number" class="input" min="2000" max="2100" />
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">月</label>
            <input id="setMonth" type="number" class="input" min="1" max="12" />
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">正規勤務時間（分）</label>
            <input id="setStdMin" type="number" class="input" min="0" max="1440" />
            <div class="small mt-1">既定：7:45 = 465分</div>
          </div>
          <div class="md:col-span-3">
            <label class="block text-sm font-bold mb-1">休憩（分）</label>
            <div class="grid grid-cols-1 gap-2">
              <input id="setBreakMin" type="number" class="input" min="0" max="300" />
            </div>
            <div class="small mt-1">既定：45分（設定で変更）</div>
          </div>

          <div class="md:col-span-12 flex flex-wrap gap-2 items-center">
            <button class="btn btn-primary" onclick="applySettings()">設定を反映</button>
            <span class="small">※反映すると、カレンダーと一覧が再計算されます。</span>
          </div>
        </div>
      </div>

      <div class="card p-5">
        <h3 class="font-black mb-2">点検（提出前チェック）</h3>
        <div class="small text-slate-600">当月の <b>未入力</b> / <b>逆転</b> / <b>業務外の形式</b> をまとめて確認できます。</div>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <button class="btn btn-ghost" onclick="runMonthlyAudit()" type="button">当月点検を開く</button>
        </div>
      </div>

<div class="card p-5" data-admin-only="1">
  <h3 class="font-black mb-2">管理者パスワード</h3>
  <div class="small text-slate-600 mb-3">初期パスワードは <span class="mono">admin</span> です（変更後はこの端末・このブラウザに保存されます）。</div>
  <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
    <div class="md:col-span-4">
      <label class="block text-sm font-bold mb-1">新しいパスワード</label>
      <input id="adminPassNew" type="password" class="input w-full" placeholder="新しいパスワード" />
    </div>
    <div class="md:col-span-4">
      <label class="block text-sm font-bold mb-1">確認</label>
      <input id="adminPassNew2" type="password" class="input w-full" placeholder="もう一度入力" />
    </div>
    <div class="md:col-span-4">
      <button class="btn btn-primary w-full" onclick="changeAdminPass()" type="button">変更して保存</button>
    </div>
  </div>
</div>


      <div class="card p-5">
        <h3 class="font-black mb-2">職員（上限なし）</h3>
        <div class="flex flex-wrap gap-2 items-center mb-3">
          <button class="btn btn-primary" onclick="downloadStaffExcel()" type="button">⬇ 職員名簿ダウンロード</button>
          <button class="btn btn-ok" onclick="triggerStaffImport()" type="button">⬆ 職員名簿アップロード</button>
          <input id="staffImportFile" type="file" accept=".csv,.xls,.xml,.xlsx" class="hidden" />
          <span class="small text-slate-500">※対応: CSV（DL/UP） / .xls/.xlsx（UP）</span>
        </div>
        

        <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">
          <div class="md:col-span-4">
            <label class="block text-sm font-bold mb-1">氏名</label>
            <input id="newStaffName" class="input" placeholder="例：山田 太郎" />
          </div>
          <div class="md:col-span-4">
            
            <label class="block text-sm font-bold mb-1">職名</label>
            <input id="newStaffRole" class="input" list="roleSuggestions" placeholder="例：校長 / 教頭 / 教諭 / 事務職員 など（自由入力）" />
            <datalist id="roleSuggestions">
              <option value="校長"></option>
              <option value="教頭"></option>
              <option value="副校長・教頭"></option>
              <option value="教諭"></option>
              <option value="教員等"></option>
              <option value="事務職員"></option>
              <option value="養護教諭"></option>
              <option value="講師"></option>
              <option value="その他"></option>
            </datalist>
          </div>
          
          <div class="md:col-span-4 flex gap-2">
            <button class="btn btn-primary w-full" onclick="addStaff()">追加</button>
            <button class="btn btn-ghost w-full" onclick="sortStaff()">No順に整列</button>
          </div>
            <div class="small mt-2 text-slate-500 md:col-span-12">※「No順に整列」は、左端の No（設定した番号）で並べ替えます。Noは「編集」で任意に変更できます。</div>

        </div>

        <div class="mt-4 overflow-x-auto">
          <table class="w-full text-left sticky-head table-zebra">
            <thead>
              <tr>
                <th class="p-3 text-xs font-black text-center">No</th>
                <th class="p-3 text-xs font-black text-center">氏名</th>
                <th class="p-3 text-xs font-black text-center">職名</th>
                <th class="p-3 text-xs font-black no-print text-center">操作</th>
                <th class="p-3 text-xs font-black no-print text-center">並替</th>
              </tr>
            </thead>
            <tbody id="staffBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>

      


      <div class="card p-5">
        <h3 class="font-black mb-2">業務外の理由（学校で編集）</h3>
        <div class="small mb-3">入力時の「理由」一覧に反映されます。形式：<span class="mono">番号|正式|略称</span>（1行=1項目）<span class="small text-slate-500"> ※略称は8文字まで</span></div>
        <textarea id="setReasons" class="input mono" rows="7" placeholder="例) 1|所定の勤務外の食事の時間|食事"></textarea>
        <div class="mt-3 flex flex-wrap gap-2 items-center">
          <button class="btn btn-primary" onclick="applyReasons()">理由を反映</button>
          <button class="btn btn-ghost" onclick="resetReasons()">既定に戻す</button>
        </div>
      </div>


<div class="card p-5">
  <h3 class="font-black mb-2">目標達成度（S〜F）設定</h3>
  <div class="small text-slate-600 mb-3">
    <b>目標達成度</b>は、<b>当月の「時間外(合計)」</b>がどの「時間帯」に入るかで判定します（<b>分も含めた厳密判定</b>：例 45h＝45:00〜45:59）。
    あわせて表示する<b>英語の言葉（スローガン）</b>も学校で変更できます。
  </div>

  <div class="rounded-2xl border border-slate-200 bg-slate-50 p-4">
    <div class="grid grid-cols-1 md:grid-cols-6 gap-3 items-end">
      <div class="md:col-span-2">
        <label class="small font-black text-slate-700">目標（時間外・月）</label>
        <input id="setGoalOverH" type="number" min="0" max="9999" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-blue-200" />
        <div class="small text-slate-500 mt-1">※目標はレポート内の表示（目標/今月/差）に使います。</div>
        <div class="mt-4 grid grid-cols-1 gap-3">
          <div>
            <label class="small font-black text-slate-700">残り表示①（時間）</label>
            <input id="setRemCap1H" type="number" min="0" max="9999" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-blue-200" />
            <div class="small text-slate-500 mt-1">※入力タブ「残り（当月合計）」の基準①</div>
          </div>
          <div>
            <label class="small font-black text-slate-700">残り表示②（時間）</label>
            <input id="setRemCap2H" type="number" min="0" max="9999" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus:outline-none focus:ring-2 focus:ring-blue-200" />
            <div class="small text-slate-500 mt-1">※入力タブ「残り（当月合計）」の基準②</div>
          </div>
        </div>

      </div>

      <div class="md:col-span-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-black">S</div>
              <div class="small text-slate-500">○時間 <b>以下</b></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input id="rankS_max" type="number" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="最大(時間)" />
              <input id="rankS_word" type="text" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="表示語（例：EXCELLENT）" />
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-black">A</div>
              <div class="small text-slate-500">○時間 〜 ○時間</div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div class="flex gap-2">
                <input id="rankA_min" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最小" />
                <input id="rankA_max" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最大" />
              </div>
              <input id="rankA_word" type="text" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="表示語" />
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-black">B</div>
              <div class="small text-slate-500">○時間 〜 ○時間</div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div class="flex gap-2">
                <input id="rankB_min" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最小" />
                <input id="rankB_max" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最大" />
              </div>
              <input id="rankB_word" type="text" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="表示語" />
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-black">C</div>
              <div class="small text-slate-500">○時間 〜 ○時間</div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div class="flex gap-2">
                <input id="rankC_min" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最小" />
                <input id="rankC_max" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最大" />
              </div>
              <input id="rankC_word" type="text" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="表示語" />
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-black">D</div>
              <div class="small text-slate-500">○時間 〜 ○時間</div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div class="flex gap-2">
                <input id="rankD_min" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最小" />
                <input id="rankD_max" type="number" class="w-1/2 px-3 py-2 rounded-xl border border-slate-200" placeholder="最大" />
              </div>
              <input id="rankD_word" type="text" class="px-3 py-2 rounded-xl border border-slate-200" placeholder="表示語" />
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-black">E</div>
              <div class="small text-slate-500">○時間 〜 ○時間</div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <div class="flex gap-2">
                <input id="rankE_min" type="number" class="w-full rounded-lg border border-slate-200 px-2 py-1" placeholder="最小" />
                <input id="rankE_max" type="number" class="w-full rounded-lg border border-slate-200 px-2 py-1" placeholder="最大" />
              </div>
              <input id="rankE_word" class="w-full rounded-lg border border-slate-200 px-2 py-1" placeholder="表現（英語）" />
            </div>
          </div>

          <div class="rounded-xl border border-slate-200 bg-white p-3">
            <div class="flex items-center justify-between">
              <div class="font-black">F</div>
              <div class="small text-slate-500">○時間 <b>以上</b></div>
            </div>
            <div class="grid grid-cols-2 gap-2 mt-2">
              <input id="rankF_min" type="number" class="w-full rounded-lg border border-slate-200 px-2 py-1" placeholder="最小" />
              <input id="rankF_word" class="w-full rounded-lg border border-slate-200 px-2 py-1" placeholder="表現（英語）" />
            </div>
          </div>
</div>

        <div class="small text-slate-500 mt-2">
          ※入力例：<b>B=45〜45</b> とすると、45:00〜45:59 がBになります。<b>分は切り捨てず</b>「入っている時間帯」で判定します。
        </div>
      </div>
    </div>

    <div class="flex gap-2 mt-4 flex-wrap">
      <button class="btn" onclick="applyGoalRankSettings()">保存</button>
      <button class="btn ghost" onclick="resetGoalRankSettings()">初期値に戻す</button>
    </div>
  </div>
</div></div>

	    </section>

	    <!-- Credit -->
	    <div class="mt-8 pb-2 text-center text-[11px] text-slate-400 no-print select-none">©2026 Takayuki WAYAMA</div>
	  </div>


    <!-- Toast -->
    
  <!-- 印刷オーバーレイ（Safariでも確実に印刷できる） -->
  <div id="printOverlay" class="hidden">
    <div class="printOverlayBar no-print">
      <div class="font-black">印刷プレビュー</div>
      <div class="flex items-center gap-2">
        <button class="btn btn-ghost" onclick="printOverlayPrint()" type="button">印刷</button>
        <button class="btn btn-ghost" onclick="closePrintOverlay()" type="button">閉じる</button>
      </div>
    </div>
    <div id="printOverlayMsg" class="no-print" style="display:none; padding:10px 14px; color:#b91c1c; background:#fff1f2; border-bottom:1px solid #fecdd3;"></div>
    <iframe id="printFrame" title="print" class="printFrame"></iframe>
  </div>

<div id="toast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-5 py-3 rounded-2xl shadow-lg opacity-0 transition-opacity pointer-events-none no-print"></div>

    <!-- Modal -->
    <div id="modalWrap" class="fixed inset-0 bg-black/40 hidden items-center justify-center p-4 z-50 no-print">
      <div id="modalCard" class="card max-w-2xl w-full p-5">
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="text-lg font-black" id="modalTitle">—</div>
            <div class="small mt-1" id="modalSub">—</div>
          </div>
          <button id="modalHeaderCloseBtn" class="btn btn-ghost" onclick="closeModal()">閉じる</button>
        </div>
        <div class="mt-4" id="modalBody"></div>
        <div class="mt-5 flex justify-end gap-2" id="modalFooter"></div>
      </div>
    </div>
  </div>

<script>
/* =========================================================
   Data Model (Excel原本ロジック対応)
   =========================================================
   settings: { year, month, stdMin(7:45), breakWorkMin(45), breakOffMin(0), holidaysText[] }
   staff: [{id, no, name, role}]
   calendar: { "YYYY-MM-DD": { off: true/false } }  // off=true=休み
   records:
     records[dateKey][staffId] = {
       in:"HH:MM"|"", out:"HH:MM"|"",
       over:"H:MM"|"0.5"|""  // 入力（空欄なら自動）
       otherOff:"H:MM"|""    // その他業務外（除く時間）※個別一覧で編集
       reasonCode:number|""  // 主な理由（Excelに合わせて保持）
       holidayStayEq は互換用に読み込む場合があります（本計算では不使用）
     }
*/
const STORE = {
  settings: "wh.settings.v1",
  staff:    "wh.staff.v1",
  calendar: "wh.calendar.v1",
  records:  "wh.records.v1",
  selfStaff:"wh.selfStaff.v1",
viewYM:   "wh.viewYM.v1",
};
const KEY_AVG_SELECTED = "wh.avgSelected.v1";
const KEY_OV_OVER_TH = "wh.ovOverThresholdH.v1";
const DEFAULT_SETTINGS = {
  year: new Date().getFullYear(),
  month: new Date().getMonth()+1,

  // 標準勤務（7時間45分）
  stdMin: 7*60+45,

  // 休憩（分）※設定で変更
  breakMin: 45,

  // 互換（旧キー）
  standardWorkMin: 7*60+45,
  breakWorkMin: 45,
  breakOffMin: 0,

  // 祝日（YYYY-MM-DD）
  holidayDates: [],

  // 業務外の理由（学校で編集可能）
    reasons: [
      { code: "1", label: "教師が幅広くその専門性を高めるための学術書や専門書の読書の時間", short: "学術書・専門書" },
      { code: "2", label: "教科に関する論文の執筆", short: "執筆" },
      { code: "3", label: "教科指導や生徒指導に係る自主的な研究会への参加", short: "研修会" },
      { code: "4", label: "自らの資質を高めるための資格試験のための勉強の時間", short: "勉強" },
      { code: "5", label: "朝早めに出勤して新聞や本を読む時間", short: "新聞や読書" },
      { code: "6", label: "所定の勤務外の食事の時間", short: "食事" },
      { code: "7", label: "学校内で実施されるPTA活動に校務としてではなく参加している時間", short: "PTA活動" },
      { code: "8", label: "地域住民等としての立場で学校で行われる地域活動に参加している時間", short: "地域活動" },
      { code: "9", label: "その他", short: "その他" },
    ],

goalOverH: 45,
  remCap1H: 45,
  remCap2H: 80,

  // 目標達成度（%差で判定）※表示はランク＋英単語
  goalRankCfg: [
    { rank:"S", min:null, max:29, word:"EXCELLENT" },
    { rank:"A", min:30, max:39, word:"GREAT" },
    { rank:"B", min:40, max:49, word:"ON TARGET" },
    { rank:"C", min:50, max:59, word:"CAUTION" },
    { rank:"D", min:60, max:69, word:"WARNING" },
    { rank:"E", min:70, max:79, word:"OVER LIMIT" },
    { rank:"F", min:80, max:null, word:"DANGER ZONE" },
  ],
};

let settings = load(STORE.settings, DEFAULT_SETTINGS);
let viewYM = load(STORE.viewYM, null);
let staff = load(STORE.staff, [

  {id: uid(), no: 1, name: "管理者", role: "その他"},
  {id: uid(), no: 2, name: "教職員A", role: "教員等"},
  {id: uid(), no: 3, name: "教職員B", role: "教員等"},
]);

function ensureStaffNos(){
  if(!Array.isArray(staff)) staff = [];
  // no が欠けている場合のみ補完（既存の番号は尊重）
  let maxNo = staff.reduce((mx,s)=>Math.max(mx, Number(s.no)||0), 0);
  staff.forEach((s)=>{
    if(s.no==null || s.no==="" || isNaN(Number(s.no))){
      maxNo += 1;
      s.no = maxNo;
    }else{
      s.no = Math.floor(Number(s.no));
    }
  });
  // 保存しておく（以後の整列に使える）
  save(STORE.staff, staff);
}
ensureStaffNos();


// --- staff helper ---
function getStaff(id){
  if(!id) return null;
  try{
    return (Array.isArray(staff) ? staff : []).find(s => String(s.id) === String(id)) || null;
  }catch(e){
    return null;
  }
}

let calendar = load(STORE.calendar, {}); // dateKey => {off:true/false}
let records  = load(STORE.records, {});  // dateKey => { staffId => entry }

function normalizeSettings(){
  // break
  if(settings.breakMin==null){
    settings.breakMin = Number(settings.breakWorkMin ?? 45);
  }
  settings.breakWorkMin = Number(settings.breakMin);
  settings.breakOffMin = 0;

  // std
  if(settings.stdMin==null){
    settings.stdMin = Number(settings.standardWorkMin ?? (7*60+45));
  }
  settings.standardWorkMin = Number(settings.stdMin);

  // reasons
  if(!Array.isArray(settings.reasons) || settings.reasons.length===0){
    settings.reasons = DEFAULT_SETTINGS.reasons.slice();
  }else{
    settings.reasons = settings.reasons
      .map(r=>{
        const code = String(r?.code||"").trim();
        const label = String(r?.label||"").trim();
        let short = String(r?.short||"").trim();
        if(!short) short = label.slice(0,8);
        short = short.slice(0,8);
        return {code, label, short};
      })
      .filter(r=>r.code && r.label);
  }

  if(settings.goalOverH==null) settings.goalOverH = Number(DEFAULT_SETTINGS.goalOverH ?? 45);
  settings.goalOverH = Number(settings.goalOverH||0);

// goal rank cfg
const defRankCfg = (DEFAULT_SETTINGS.goalRankCfg||[]).map(o=>({rank:o.rank, min:o.min, max:o.max, word:o.word}));
const normalizeNumOrNull = (v)=>{
  if(v==null) return null;
  const s = String(v).trim();
  if(s==="") return null;
  const n = Number(s);
  return (isNaN(n) ? null : n);
};
const byRank = {};
if(Array.isArray(settings.goalRankCfg)){
  settings.goalRankCfg.forEach(o=>{
    const r = String(o?.rank||"").toUpperCase();
    if(!["S","A","B","C","D","E","F"].includes(r)) return;
    byRank[r] = {
      rank: r,
      min: normalizeNumOrNull(o?.min),
      max: normalizeNumOrNull(o?.max),
      word: String(o?.word||"").trim(),
    };
  });
}
settings.goalRankCfg = ["S","A","B","C","D","E","F"].map(r=>{
  const d = defRankCfg.find(x=>x.rank===r) || {rank:r,min:null,max:null,word:""};
  const o = byRank[r] || {};
  return {
    rank: r,
    min: (o.min!=null? o.min : d.min),
    max: (o.max!=null? o.max : d.max),
    word: (o.word? o.word : d.word),
  };
});
  save(STORE.settings, settings);
}

function normalizeStaff(){
  let changed = false;
  staff.forEach(s=>{
    if(s.title!=null && (s.role==null || s.role==="")){
      s.role = s.title;
      delete s.title;
      changed = true;
    }
    if(s.patterns!=null){ delete s.patterns; changed = true; }
    if(s.pattern!=null){ delete s.pattern; changed = true; }
  });
  if(changed) save(STORE.staff, staff);
}



function fillReasonSelect(selectId){
  const sel = document.getElementById(selectId);
  if(!sel) return;
  const opts = ['<option value="">（理由を選択）</option>'].concat(
    (settings.reasons||[]).map(r=>{
      const txt = `${escapeHtml(r.code)}：${escapeHtml(r.label)}`;
      return `<option value="${escapeAttr(r.code)}">${txt}</option>`;
    })
  );
  sel.innerHTML = opts.join("");
}

function reasonLabel(code){
  const c = String(code||"").trim();
  const r = (settings.reasons||[]).find(x=>String(x.code)===c);
  return r ? `${r.code}：${r.label}` : c;
}

function fillReasonEditor(){
  const ta = document.getElementById("setReasons");
  if(!ta) return;
  ta.value = (settings.reasons||[]).map(r=>`${r.code}|${r.label}|${(r.short||'').slice(0,8)}`).join("\n");
}


function applyReasons(){
  const ta = document.getElementById("setReasons");
  if(!ta) return;
  const lines = ta.value.split(/\r?\n/).map(x=>x.trim()).filter(Boolean);
  const parsed = [];
  for(const line of lines){
    const parts = line.split("|");
    if(parts.length>=2){
      const code = (parts[0]||"").trim();
      let label = "";
      let short = "";
      if(parts.length>=3){
        short = (parts[parts.length-1]||"").trim();
        label = parts.slice(1, -1).join("|").trim();
      }else{
        label = parts.slice(1).join("|").trim();
      }
      if(code && label){
        if(!short) short = label.slice(0,8);
        short = short.slice(0,8);
        parsed.push({code, label, short});
      }
      continue;
    }
    const parts2 = line.split("=>");
    if(parts2.length>=2){
      const code = (parts2[0]||"").trim();
      const label = parts2.slice(1).join("=>").trim();
      if(code && label){
        const short = label.slice(0,8);
        parsed.push({code, label, short});
      }
    }
  }
  if(parsed.length===0){ toast("理由の形式が不正です（例: 1|所定の勤務外の食事の時間|食事）"); return; }
  settings.reasons = parsed;
  save(STORE.settings, settings);
  toast("理由を反映しました");
}

function resetReasons(){
  settings.reasons = DEFAULT_SETTINGS.reasons.slice();
  save(STORE.settings, settings);
  fillReasonEditor();
  toast("既定に戻しました");
}






let charts = { monthOver:null, dailyTotal:null };

/* =========================
   Utilities
   ========================= */
function uid(){ return "id-" + Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }
function saveAll(){ save(STORE.settings, settings); save(STORE.staff, staff); save(STORE.calendar, calendar); save(STORE.records, records); save(STORE.viewYM, viewYM); autoBackup(); }
function save(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
function load(key, fallback){
  try{ const v = JSON.parse(localStorage.getItem(key)); return (v ?? fallback); }catch{ return fallback; }
}
function toast(msg){
  const t = document.getElementById("toast");
  if(!t){ try{ console.log(msg); }catch(e){} return; }
  t.textContent = msg;
  // class と style の両方で制御（Tailwindが無い環境でも動作）
  t.classList.remove("opacity-0");
  t.style.opacity = "1";
  if(t._toastTimer) clearTimeout(t._toastTimer);
  t._toastTimer = setTimeout(()=>{
    t.classList.add("opacity-0");
    t.style.opacity = "0";
  }, 2600);
}
function showToast(msg){ toast(msg); }
function pad2(n){ return String(n).padStart(2,"0"); }
function dateKeyFromParts(y,m,d){ return `${y}-${pad2(m)}-${pad2(d)}`; }
function todayKeyLocal(){
  const now = new Date();
  return dateKeyFromParts(now.getFullYear(), now.getMonth()+1, now.getDate());
}

// ===== 文字の半角整形（全角→半角） =====
function toHalfWidth(str){
  if(str===undefined || str===null) return "";
  return str.toString()
    .replace(/[！-～]/g, s=>String.fromCharCode(s.charCodeAt(0)-0xFEE0))
    .replace(/　/g, " ")
    .replace(/[：]/g, ":")
    .replace(/[－―]/g, "-")
    .replace(/[（）]/g, c=>({"（":"(","）":")"}[c]||c))
    .trim();
}
function normalizeHalfInput(el){
  if(!el) return;
  const v = el.value;
  const nv = toHalfWidth(v);
  if(nv!==v) el.value = nv;
}

// ===== 自動バックアップ =====
const STORE_AUTO_BACKUP = "wh.autobackup.v1";
function autoBackup(){
  try{
    const payload = { settings, viewYM, staff, calendar, records, savedAt: new Date().toISOString() };
    localStorage.setItem(STORE_AUTO_BACKUP, JSON.stringify(payload));
  }catch(e){}
}
function restoreAutoBackup(){
  try{
    const raw = localStorage.getItem(STORE_AUTO_BACKUP);
    if(!raw){ toast("自動バックアップが見つかりません"); return; }
    const obj = JSON.parse(raw);
    if(obj.settings) settings = obj.settings;
    if(obj.viewYM) viewYM = obj.viewYM;
    if(obj.staff) staff = obj.staff;
    if(obj.calendar) calendar = obj.calendar;
    if(obj.records) records = obj.records;
    saveAll();
    toast("自動バックアップから復元しました");
    hydrateSettingsUI();
    renderDaily(); renderCalendar(); renderOverview(); renderIndividual();
    updateCharts();

  }catch(e){
    toast("自動バックアップの復元に失敗しました");
  }
}


function changeAdminPass(){
  if(!isAdminMode()){ openAdminLogin(); return; }
  const a = document.getElementById("adminPassNew");
  const b = document.getElementById("adminPassNew2");
  const p1 = a ? String(a.value||"") : "";
  const p2 = b ? String(b.value||"") : "";
  if(!p1){ toast("新しいパスワードを入力してください"); return; }
  if(p1 !== p2){ toast("確認用パスワードが一致しません"); return; }
  setAdminPass(p1);
  if(a) a.value=""; if(b) b.value="";
  toast("パスワードを変更しました");
}

// ===== 職員名簿 Excel/CSV 入出力 =====
function triggerStaffImport(){
  if(!isAdminMode()){ openAdminLogin(); return; }
  const el = document.getElementById("staffImportFile");
  if(!el) return;
  el.value = "";
  el.onchange = ()=>{ handleStaffImport(el.files && el.files[0]); };
  el.click();
}

function downloadStaffExcel(){
  if(!isAdminMode()){ openAdminLogin(); return; }

  const rows = [
    ["No","氏名","職名"],
    ...staff.map((s,idx)=>[String(s.no==null?(idx+1):s.no), String(s.name||""), String(s.role||"")])
  ];
  const {y,m} = getViewYM();
  const base = `staff_${y}-${pad2(m)}`;

  // 互換性優先：CSV（Excelでそのまま開けます / 日本語対策でBOM付）
  const esc = (v)=>{
    const s = String(v ?? "");
    return /[",\r\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
  };
  const csv = "\ufeff" + rows.map(r=>r.map(esc).join(",")).join("\r\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  downloadBlob(blob, `${base}.csv`);
}

function handleStaffImport(file){
  if(!file) return;
  const name = (file.name||"").toLowerCase();
  const reader = new FileReader();

  reader.onload = ()=>{
    try{
      let rows = [];
      if(name.endsWith(".xlsx")){
        if(typeof XLSX === "undefined" || !XLSX || !XLSX.read){
          toast("この環境では .xlsx の読み込みができません（CSV または .xls をご利用ください）");
          return;
        }
        const buf = reader.result;
        const wb = XLSX.read(buf, {type:"array"});
        const first = wb.SheetNames[0];
        const ws = wb.Sheets[first];
        rows = XLSX.utils.sheet_to_json(ws, {header:1, raw:false});
      }else{
        const text = String(reader.result||"");
        if(name.endsWith(".csv")){
          rows = parseCsv(text);
        }else{
          // .xls/.xml (SpreadsheetML)
          rows = parseExcelXml(text);
        }
      }

      if(!rows || rows.length<2){ toast("読み込みデータが見つかりません"); return; }

      // header skip
      const body = rows.slice(1).filter(r=>Array.isArray(r) && r.some(v=>String(v||"").trim()!==""));
      const next = body.map((r,i)=>{
        const no = String(r[0]||"").trim();
        const nm = String(r[1]||"").trim();
        const rl = String(r[2]||"").trim();
        return { no: no? Number(no): (i+1), name: nm, role: rl };
      }).filter(s=>s.name);

      if(next.length===0){ toast("氏名が入っている行がありません"); return; }

      staff = next;
      saveAll();
      fillStaffSelects();
      renderStaffTable();
      renderOverview(); renderIndividual(); // 名簿が変わると一覧も更新
      toast(`職員名簿を取り込みました（${next.length}名）`);
    }catch(e){
      console.error(e);
      toast("取り込みに失敗しました（CSV / .xls / .xlsx をご利用ください）");
    }
  };

  // read
  if(name.endsWith(".xlsx")) reader.readAsArrayBuffer(file);
  else reader.readAsText(file, "utf-8");
}


function buildExcelXml(sheetName, rows){
  const esc = (s)=>String(s??"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  const rowXml = rows.map(r=>{
    const cells = r.map(v=>`<Cell><Data ss:Type="String">${esc(v)}</Data></Cell>`).join("");
    return `<Row>${cells}</Row>`;
  }).join("");
  return `<?xml version="1.0"?>
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:html="http://www.w3.org/TR/REC-html40">
 <Worksheet ss:Name="${esc(sheetName)}">
  <Table>${rowXml}</Table>
 </Worksheet>
</Workbook>`;
}

function parseExcelXml(xmlText){
  const doc = new DOMParser().parseFromString(xmlText, "text/xml");
  const rows = Array.from(doc.getElementsByTagName("Row"));
  return rows.map(row=>{
    const cells = Array.from(row.getElementsByTagName("Cell"));
    return cells.map(c=>{
      const data = c.getElementsByTagName("Data")[0];
      return data ? (data.textContent||"") : "";
    });
  });
}

function parseCsv(csv){
  const lines = csv.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(x=>x.trim()!=="");
  const rows = lines.map(line=>{
    // simple CSV (comma). quoted supported minimally
    const out=[]; let cur=""; let inq=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch==='"'){
        if(inq && line[i+1]==='"'){ cur+='"'; i++; }
        else inq=!inq;
      }else if(ch===',' && !inq){
        out.push(cur); cur="";
      }else cur+=ch;
    }
    out.push(cur);
    return out;
  });
  return rows;
}

function downloadBlob(blob, filename){
  try{
    // old Edge / IE
    if(window.navigator && window.navigator.msSaveOrOpenBlob){
      window.navigator.msSaveOrOpenBlob(blob, filename);
      return;
    }
  }catch(e){ /* ignore */ }

  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.style.display = "none";
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 400);
}

// ===== 点検（当月チェック） =====
function runMonthlyAudit(){
  const {y,m} = getViewYM();
  const daysInMonth = new Date(y, m, 0).getDate();
  const issues = [];
  for(const s of staff){
    for(let d=1; d<=daysInMonth; d++){
      const dk = dateKeyFromParts(y,m,d);
      const off = isOffday(dk);
      const e = getEntry(dk, s.id);
      const inV = (e.in||"").trim();
      const outV = (e.out||"").trim();
      const othV = (e.otherOff||"").trim();

      // 週休日は原則入力不要（入力があればOK）。勤務日は未入力を拾う
      if(!off){
        if(!inV && !outV){
          // まるごと未入力
          issues.push({type:"未入力", staff:s, date:dk, detail:"出勤・退勤が未入力"});
        }else if((inV && !outV) || (!inV && outV)){
          issues.push({type:"片方のみ", staff:s, date:dk, detail:"出勤/退勤のどちらかが未入力"});
        }
      }

      // 逆転
      const inMin = parseTimeToMin(inV);
      const outMin = parseTimeToMin(outV);
      if(inMin!=null && outMin!=null && inMin>outMin){
        issues.push({type:"逆転", staff:s, date:dk, detail:"出勤＞退勤"});
      }

      // 業務外形式
      if(othV){
        const mm = parseDurationToMin(toHalfWidth(othV));
        if(mm==null){
          issues.push({type:"業務外形式", staff:s, date:dk, detail:`業務外が不正（${escapeHtml(othV)}）`});
        }
      }
    }
  }

  const body = issues.length ? `
    <div class="small text-slate-600 mb-2">当月（${y}/${pad2(m)}）のチェック結果：<b>${issues.length}件</b></div>
    <div class="max-h-[60vh] overflow-auto border border-slate-200 rounded-xl">
      <table class="w-full text-sm">
        <thead class="sticky top-0 bg-white border-b border-slate-200">
          <tr>
            <th class="p-2 text-left">種別</th>
            <th class="p-2 text-left">日付</th>
            <th class="p-2 text-left">氏名</th>
            <th class="p-2 text-left">内容</th>
            <th class="p-2"></th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          ${issues.map(it=>`
            <tr>
              <td class="p-2">${escapeHtml(it.type)}</td>
              <td class="p-2 mono">${escapeHtml(it.date)}</td>
              <td class="p-2">${escapeHtml(it.staff.name||"")}</td>
              <td class="p-2">${it.detail}</td>
              <td class="p-2 text-right">
                <button class="btn btn-ghost px-3 py-1" type="button" onclick="jumpToEdit('${it.staff.id}','${it.date}')">開く</button>
              </td>
            </tr>`).join("")}
        </tbody>
      </table>
    </div>
  ` : `
    <div class="small text-slate-600">当月（${y}/${pad2(m)}）は問題が見つかりませんでした。</div>
  `;

  openModal("当月点検", "未入力・逆転・業務外形式の確認", body, [
    {label:"閉じる", className:"btn btn-primary", onClick: closeModal}
  ]);
}
function jumpToEdit(staffId, dateKey){
  closeModal();
  // 月が違う場合はviewYMを合わせる
  const d = getDateObj(dateKey);
  setViewYM(d.getFullYear(), d.getMonth()+1);
  hydrateSettingsUI();
  // 入力に移動して該当日を開く
  pickStaff(staffId);
  document.getElementById("inpDate").value = dateKey;
  syncInputFromEntry();
  renderDaily();
  switchTab("input");
}
function parseTimeToMin(hhmm){
  if(!hhmm) return null;
  const m = /^(\d{1,2}):(\d{2})$/.exec(hhmm.trim());
  if(!m) return null;
  const h = Number(m[1]), mi=Number(m[2]);
  if(h<0||h>47||mi<0||mi>59) return null;
  return h*60 + mi;
}
function formatClock(min){
  if(min==null || isNaN(min)) return "";
  min = Math.round(min);
  let h = Math.floor(min/60) % 24;
  let m = min % 60;
  return `${pad2(h)}:${pad2(m)}`;
}

function buildAnnualOverSvg(annual, curY, curM, goalH){
  // annual: [{y,m,over(min)}] length 12 (4→3)
  // 仕様:
  // - 横軸は 4月〜3月を1か月刻みで表示
  // - 「時間外在校等時間」は棒グラフ（線のみ）
  // - 各月の値（時間）をバーの上に印字
  const w = 1440, h = 520, pad = 60;
  const innerW = w - pad*2, innerH = h - pad*2;
  const n = Math.max(annual.length||0, 1);
  const valsMin = annual.map(a => (Number(a.over)||0)); // minutes
  const valsH = valsMin.map(v => v/60); // hours

  // 縦軸最大値 = 目標達成度(F)の数値 + 20
  const forcedMax = (()=>{
    const cfg = Array.isArray(settings.goalRankCfg) ? settings.goalRankCfg : (DEFAULT_SETTINGS.goalRankCfg||[]);
    const norm = (x)=>{
      const min = (x.min==null || x.min==="" || isNaN(Number(x.min))) ? null : Number(x.min);
      const max = (x.max==null || x.max==="" || isNaN(Number(x.max))) ? null : Number(x.max);
      return { rank:String(x.rank||"").toUpperCase(), min, max };
    };
    const f = cfg.map(norm).find(r=>r.rank==="F");
    const base = (f && f.min!=null) ? f.min : (f && f.max!=null ? f.max : null);
    return (base==null || isNaN(base)) ? null : (base + 20);
  })();

  const maxV = (forcedMax!=null)
    ? Math.max(forcedMax, goalH||0, ...valsH, 1)
    : Math.max(goalH||0, ...valsH, 1);

  const yScale = v => pad + innerH - (v/maxV)*innerH;
  const y0 = pad + innerH;

  // current month highlight
  const curIdx = annual.findIndex(a => Number(a.y)===Number(curY) && Number(a.m)===Number(curM));

  // Xは「バー中心」で計算（12か月を等間隔）
  const step = innerW / n;
  const centers = Array.from({length:n}, (_,i)=>pad + step*(i+0.5));
  const barW = Math.max(6, step*0.58);

  // month label (4月〜3月をそのまま)
  const lab = annual.map(a => `${Number(a.m)}月`);
  const escape = (s)=>String(s).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");

  // grid
  const gridLines = 4;
  let grid = "";
  for(let i=0;i<=gridLines;i++){
    const v = (maxV/gridLines)*i;
    const y = yScale(v);
    grid += `<line x1="${pad}" y1="${y}" x2="${pad+innerW}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
    grid += `<text x="${pad-8}" y="${y+4}" text-anchor="end" font-size="11" fill="#6b7280">${v.toFixed(0)}</text>`;
  }

  // goal line
  const goalY = (goalH>0) ? yScale(goalH) : null;
  const goalLine = (goalY!=null) ? `<line x1="${pad}" y1="${goalY}" x2="${pad+innerW}" y2="${goalY}" stroke="#111827" stroke-dasharray="6 5" stroke-width="1.5" opacity="0.55"/>` : "";

  // current month highlight band (bar width range)
  const curHi = (curIdx>=0 && centers[curIdx]!=null)
    ? `<rect x="${(centers[curIdx]-barW/2-6).toFixed(1)}" y="${pad}" width="${(barW+12).toFixed(1)}" height="${innerH}" fill="#111827" opacity="0.04"/>`
    : "";

  // bars + value labels
  const fmtLabel = (min)=>{
    const v = Number(min)||0;
    return formatDurJP(v);
  };

  let bars = "";
  let vals = "";
  for(let i=0;i<n;i++){
    const min = valsMin[i] || 0;
    const v = (Number(min)||0)/60;
    const x = centers[i] - barW/2;
    const y = yScale(v);
    const hh = Math.max(0, y0 - y);
    bars += `<rect x="${x.toFixed(1)}" y="${y.toFixed(1)}" width="${barW.toFixed(1)}" height="${hh.toFixed(1)}" fill="#2563eb" stroke="#2563eb" stroke-width="1"/>`;

    // value label（上に印字）
    // 1日も出勤（入力）がない月は、ラベルを表示しない
    const anyDays = Number((annual[i] && (annual[i].anyDays ?? annual[i].anyDaysCount)) || 0);
    if(anyDays > 0){
      const vy = Math.max(pad+12, y - 6);
      vals += `<text x="${centers[i].toFixed(1)}" y="${vy.toFixed(1)}" text-anchor="middle" font-size="11" fill="#111827" font-weight="700">${fmtLabel(min)}</text>`;
    }
  }

  // x labels: 12か月すべて
  const xTicks = lab.map((t,i)=>`
    <text x="${centers[i].toFixed(1)}" y="${pad+innerH+18}" text-anchor="middle" font-size="11" fill="#6b7280">${escape(t)}</text>
  `).join("");

  return `
  <svg viewBox="0 0 ${w} ${h}" width="100%" height="100%" preserveAspectRatio="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="年間の時間外在校等時間の推移">
    <rect x="0" y="0" width="${w}" height="${h}" fill="#ffffff"/>
    ${curHi}
    ${grid}
    ${goalLine}
    ${bars}
    ${vals}
    ${xTicks}
    <text x="${pad}" y="${pad-10}" font-size="12" fill="#6b7280">時間（h）</text>
  </svg>`;
}

function formatDur(min){
  if(min==null || isNaN(min)) return "--:--";
  min = Math.round(min);
  const h = Math.floor(min/60);
  const m = Math.abs(min % 60);
  return `${h}:${pad2(m)}`;
}

function formatDurJP(min){
  if(min==null || isNaN(min)) return "—";
  min = Math.round(Number(min));
  const sign = min<0 ? "-" : "";
  min = Math.abs(min);
  const h = Math.floor(min/60);
  const m = min % 60;
  return `${sign}${h}時間${m}分`;
}function getGoalRankInfo(goalOverH, thisOverMin){
  // 「時間外(合計)」の“時間帯”で S〜E を判定（分も含めた厳密判定）
  const goalH = Number(goalOverH||0);
  const thisMin = Number(thisOverMin||0);
  const thisH = Math.floor(thisMin/60); // 45:00〜45:59 => 45
  const deltaH = thisH - goalH;

  const cfg = Array.isArray(settings.goalRankCfg) ? settings.goalRankCfg : (DEFAULT_SETTINGS.goalRankCfg||[]);
  const norm = (x)=>{
    const min = (x.min==null || x.min==="" || isNaN(Number(x.min))) ? null : Number(x.min);
    const max = (x.max==null || x.max==="" || isNaN(Number(x.max))) ? null : Number(x.max);
    return { rank:String(x.rank||"").toUpperCase(), min, max, word:String(x.word||"") };
  };
  const items = cfg.map(norm).filter(x=>x.rank);
  const match = items.find(r=>{
    const okMin = (r.min==null) ? true : (thisH >= r.min);
    const okMax = (r.max==null) ? true : (thisH <= r.max);
    return okMin && okMax;
  }) || null;

  const word = match ? (match.word||"") : "";
  const rank = match ? (match.rank||"") : "";
  return { rank, word, goalH, thisH, deltaH };
}

function parseDurationToMin(s){
  if(s===undefined || s===null) return null;
  const t = s.toString().trim();
  if(!t) return null;

  // H:MM (e.g. 0:30, 12:05)
  let m = /^(\d{1,3}):(\d{2})$/.exec(t);
  if(m){
    const h = Number(m[1]), mi = Number(m[2]);
    if(mi<0 || mi>59) return null;
    return h*60 + mi;
  }

  // JP formats: "1時間30分", "2時間", "45分"
  m = /^(\d{1,3})\s*時間\s*(\d{1,2})\s*分$/.exec(t);
  if(m){
    const h = Number(m[1]||0), mi = Number(m[2]||0);
    if(mi<0 || mi>59) return null;
    return h*60 + mi;
  }
  m = /^(\d{1,3})\s*時間$/.exec(t);
  if(m){
    const h = Number(m[1]||0);
    return h*60;
  }
  m = /^(\d{1,3})\s*分$/.exec(t);
  if(m){
    const mi = Number(m[1]||0);
    return mi;
  }

  // decimal hours (e.g. 0.5)
  if(/^\d+(\.\d+)?$/.test(t)){
    return Math.round(Number(t)*60);
  }
  return null;
}


function durMinToHM(min){
  const n = Math.max(0, Math.round(Number(min)||0));
  const h = Math.floor(n/60);
  const m = n%60;
  return `${h}:${String(m).padStart(2,"0")}`;
}


function minutesDiff(inMin, outMin){
  if(inMin==null || outMin==null) return null;
  let diff = outMin - inMin;
  if(diff < 0) diff += 24*60; // overnight safety
  return diff;
}
function dowLabel(dateObj){
  const w = ["日","月","火","水","木","金","土"][dateObj.getDay()];
  return w;
}
function isWeekend(dateObj){
  const d = dateObj.getDay();
  return d===0 || d===6;
}
function getMonthInfo(){
  const y = Number(settings.year), m = Number(settings.month);
  const daysInMonth = new Date(y, m, 0).getDate();
  const firstDow = new Date(y, m-1, 1).getDay(); // 0=Sun
  return {y,m,daysInMonth,firstDow};
}

function ensureViewYM(){
  if(!viewYM || typeof viewYM!=="object"){
    viewYM = { y:Number(settings.year), m:Number(settings.month) };
    save(STORE.viewYM, viewYM);
  }
}
function getViewYM(){
  ensureViewYM();
  return { y:Number(viewYM.y), m:Number(viewYM.m) };
}
function getViewMonthInfo(){
  const {y,m} = getViewYM();
  const daysInMonth = new Date(y, m, 0).getDate();
  const firstDow = new Date(y, m-1, 1).getDay();
  return {y,m,daysInMonth,firstDow};
}
function setViewYM(y,m){
  const yy = Number(y), mm = Number(m);
  if(!yy || !mm) return;

  // view month (used by overview/individual/graphs)
  viewYM = { y: yy, m: mm };
  save(STORE.viewYM, viewYM);

  // keep global month (settings) in sync
  settings.year = yy;
  settings.month = mm;
  save(STORE.settings, settings);

  // reflect settings form
  const fy = document.getElementById("setYear");
  const fm = document.getElementById("setMonth");
  if(fy) fy.value = String(yy);
  if(fm) fm.value = String(mm).padStart(2,"0");

  // calendar label
  const lab = document.getElementById("calMonthLabel");
  if(lab) lab.textContent = `${yy}年${String(mm).padStart(2,"0")}月`;

  syncViewMonthUI();
  safeCall(renderCalendar);
  scheduleFullRefresh();
}

function shiftViewYM(delta){
  const cur = getViewYM();
  let y = cur.y, m = cur.m + Number(delta||0);
  while(m<1){ m+=12; y-=1; }
  while(m>12){ m-=12; y+=1; }
  setViewYM(y,m);
}
function ymToInputValue(y,m){ return `${y}-${pad2(m)}`; }
function syncViewMonthUI(){
  const {y,m} = getViewYM();
  const v = ymToInputValue(y,m);
  const ov = document.getElementById("ovMonth");
  const ind = document.getElementById("indMonth");
  if(ov && ov.value!==v) ov.value = v;
  if(ind && ind.value!==v) ind.value = v;
  const chip1 = document.getElementById("ovMonthChip");
  const chip2 = document.getElementById("indMonthChip");
  const text = `${y}年${pad2(m)}月`;
  if(chip1) chip1.textContent = text;
  if(chip2) chip2.textContent = text;
  const pchip = document.getElementById("printMonthChip");
  if(pchip) pchip.textContent = text;
}

function onViewMonthChange(v){
  if(!v) return;
  const parts = String(v).split("-");
  if(parts.length!==2) return;
  const y = Number(parts[0]), m = Number(parts[1]);
  setViewYM(y,m);
}




function getDateObj(dateKey){
  const [y,m,d]=dateKey.split("-").map(Number);
  return new Date(y, m-1, d);
}
function defaultOff(dateKey){
  const d = getDateObj(dateKey);
  // 土日 + 設定した祝日 を休みに
  if(isWeekend(d)) return true;
  if((settings.holidayDates||[]).includes(dateKey)) return true;
  return false;
}
function isOffday(dateKey){
  if(calendar[dateKey] && typeof calendar[dateKey].off === "boolean") return !!calendar[dateKey].off;
  return defaultOff(dateKey);
}
function setOffday(dateKey, off){
  calendar[dateKey] = { off: !!off };
  save(STORE.calendar, calendar);
}

/* =========================
   Core calculations (Excel準拠)
   ========================= */
function getEntry(dateKey, staffId){
  if(!records[dateKey]) records[dateKey] = {};
  if(!records[dateKey][staffId]) records[dateKey][staffId] = { in:"", out:"", otherOff:"", reason:"", reasonCode:"" };
  const e = records[dateKey][staffId];
  // compat
  if(e.reason==null && e.reasonCode!=null) e.reason = String(e.reasonCode||"");
  if(e.reasonCode==null && e.reason!=null) e.reasonCode = String(e.reason||"");
  return e;
}

function calcFor(dateKey, staffId){
  const e = getEntry(dateKey, staffId);
  const off = isOffday(dateKey);

  // In/Out
  const inMin  = parseTimeToMin(e.in);
  const outMin = parseTimeToMin(e.out);

  // ① 在校時間（raw）
  const stayRaw = minutesDiff(inMin, outMin);

  // 休憩（設定：分）※休みの日は休憩なし（0分）
  const breakWorkMin = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);
  const breakOffMin  = Number(settings.breakOffMin ?? 0);
  const breakMin = off ? breakOffMin : breakWorkMin;

  // 業務外（手入力）
  const otherOffMin = parseDurationToMin(e.otherOff) || 0;

  // ② 除く時間
  const exclude = (stayRaw==null) ? null : (breakMin + otherOffMin);

  // ③ 在校等時間 = ① − ②
  const stayEq = (stayRaw==null) ? null : Math.max(0, stayRaw - exclude);

  // ④ 時間外在校等時間 = ③ − 7:45（休みの日は全て時間外扱い）
  const std = Number(settings.stdMin ?? settings.standardWorkMin ?? (7*60+45));
  const baseStd = off ? 0 : std;
  const over = (stayEq==null) ? null : (off ? stayEq : Math.max(0, stayEq - baseStd));

  return { off, inMin, outMin, stayRaw, breakMin, otherOffMin, exclude, stayEq, over };
}

function monthAggByStaff(staffId, y, m){
  const mi = (y && m) ? {y:Number(y), m:Number(m), daysInMonth: new Date(Number(y), Number(m), 0).getDate()} : getMonthInfo();
  const yy = mi.y, mm = mi.m, daysInMonth = mi.daysInMonth;
  const arr = [];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(yy,mm,d);
    const c = calcFor(key, staffId);
    const ent = getEntry(key, staffId);
    const hasAny = !!(ent.in || ent.out || ent.otherOff);
    arr.push({dateKey:key, day:d, dow:dowLabel(getDateObj(key)), ...c, ent, hasAny});
  }
  return arr;
}

function summaryByStaff(staffId, y, m){
  const vm = (y && m) ? {y:Number(y), m:Number(m)} : getViewYM();
  const days = monthAggByStaff(staffId, vm.y, vm.m);

  // 日数（分母）は「勤務した日数」ではなく、その月の勤務日/週休日の日数で計算する
  const workDays = days.filter(x => !x.off);
  const offDays  = days.filter(x =>  x.off);
  const workHas  = workDays.filter(x => x.hasAny);
  const offHas   = offDays.filter(x => x.hasAny);

  const avg = (vals) => {
    const xs = vals.filter(v => v!=null && !isNaN(v));
    if(xs.length===0) return null;
    return xs.reduce((a,b)=>a+b,0) / xs.length;
  };
  const sum = (vals) => vals.filter(v=>v!=null && !isNaN(v)).reduce((a,b)=>a+b,0);

  // 出勤/退勤（時刻）は「入力がある日」だけで平均（空白日を 00:00 にしないため）
  const avgWorkIn  = avg(workHas.map(x=>x.inMin));
  const avgWorkOut = avg(workHas.map(x=>x.outMin));
  const avgOffIn   = avg(offHas.map(x=>x.inMin));
  const avgOffOut  = avg(offHas.map(x=>x.outMin));

  // 在校等/業務外（時間）は「勤務日数/週休日数」で割る（空白日は 0 とみなす）
  const workDen = workDays.length;
  const offDen  = offDays.length;
  const sumWorkStayEq    = workDays.reduce((a,x)=> a + (x.stayEq==null?0:x.stayEq), 0);
  const sumWorkOtherOff  = workDays.reduce((a,x)=> a + (x.otherOffMin==null?0:x.otherOffMin), 0);
  const sumOffStayEq     = offDays.reduce((a,x)=> a + (x.stayEq==null?0:x.stayEq), 0);
  const sumOffOtherOff   = offDays.reduce((a,x)=> a + (x.otherOffMin==null?0:x.otherOffMin), 0);
  const avgWorkStayEq    = workDen ? (sumWorkStayEq / workDen) : null;
  const avgWorkOtherOff  = workDen ? (sumWorkOtherOff / workDen) : null;
  const avgOffStayEq     = offDen  ? (sumOffStayEq / offDen) : null;
  const avgOffOtherOff   = offDen  ? (sumOffOtherOff / offDen) : null;

  const totalOffStayEq = sum(offDays.map(x=>x.stayEq));  // 週休日等 在校等（合計）
  const totalOver = sum(days.map(x=>x.over));        // 当該月 時間外（合計）
  const totalOtherOff = sum(days.map(x=>x.otherOffMin)); // 当該月 業務外（合計）

  return {
    avgWorkIn, avgWorkOut, avgWorkStayEq,
    avgOffIn, avgOffOut, avgOffStayEq,
    avgWorkOtherOff, avgOffOtherOff,
    totalOffStayEq, totalOver, totalOtherOff,
    anyDaysCount: (workHas.length + offHas.length),
    totalWeekendWork: totalOffStayEq,
    over45: totalOver >= 45*60,
    over80: totalOver >= 80*60,
    offHas: totalOffStayEq>0
  };
}

function dailyTotalOver(){
  const {y,m,daysInMonth} = getMonthInfo();
  const labels = [];
  const totals = [];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    labels.push(String(d));
    let total = 0;
    for(const s of staff){
      const c = calcFor(key, s.id);
      if(c.over!=null) total += c.over;
    }
    totals.push(total);
  }
  return {labels, totals};
}

/* =========================
   UI Init
   ========================= */

function bindMonthNavButtons(){
  const prev = document.getElementById("btnPrevMonth");
  const next = document.getElementById("btnNextMonth");
  const wire = (el, delta)=>{
    if(!el) return;
    const go = (ev)=>{
      ev.preventDefault?.();
      ev.stopPropagation?.();
      shiftMonth(delta);
      return false;
    };
    // iPad Safari: touchendが最優先
    el.addEventListener("touchend", go, {passive:false});
    el.addEventListener("pointerup", go);
    el.addEventListener("click", go);
  };
  wire(prev, -1);
  wire(next, +1);
}

window.addEventListener("load", ()=>{
  bindMonthNavButtons();
  normalizeSettings();
  ensureViewYM();
  normalizeStaff();
  startClock();
  hydrateSettingsUI();

// restore threshold input
try{
  const th = load(KEY_OV_OVER_TH, "");
  ovOverThresholdH = th;
  const el = document.getElementById("ovOverThreshold");
  if(el && th!=null && String(th).trim()!=="") el.value = String(th);
}catch(e){}
  renderAll();

  // default date to today in current month, else 1st
  const today = new Date();
  const {y,m,daysInMonth} = getMonthInfo();
  let d = 1;
  if(today.getFullYear()===y && (today.getMonth()+1)===m){
    d = today.getDate();
  }
  document.getElementById("inpDate").value = dateKeyFromParts(y,m,d);

  startDateRolloverWatcher();

  // selectors
  fillStaffSelects();
  // ブラウザ戻る（popstate）でタブ復元
  window.addEventListener("popstate", (ev)=>{
    const tab = (ev.state && ev.state.tab) ? ev.state.tab : ((location.hash||"").replace("#","") || "input");
    switchTab(tab, {push:false});
  });

syncInputFromEntry();
  renderDaily();
  renderCalendar();
  renderOverview();
  renderIndividual();
  initCharts();
  updateCharts();
  // 初期タブ（hash優先）
  const initTab = ((location.hash||"").replace("#","") || "input");
  switchTab(initTab, {push:false});
  applyModeVisibility();
  try{
    const u = new URL(location.href);
    u.search = location.search;
    history.replaceState({tab: currentTab}, "", u);
  }catch(e){}
});

/* =========================
   Clock
   ========================= */
function startClock(){
  const tick = ()=>{
    const now = new Date();
    const timeStr = now.toLocaleTimeString("ja-JP", {hour:"2-digit", minute:"2-digit", second:"2-digit"});
    const dateStr = now.toLocaleDateString("ja-JP", {year:"numeric", month:"2-digit", day:"2-digit", weekday:"short"});
    document.getElementById("nowTime").textContent = timeStr;
    document.getElementById("nowDate").textContent = dateStr;
  };
  tick();
  setInterval(tick, 1000);
}

function startDateRolloverWatcher(){
  let last = todayKeyLocal();
  setInterval(()=>{
    const nowKey = todayKeyLocal();
    if(nowKey===last) return;

    // date changed
    const prev = last;
    last = nowKey;

    // 入力日が「前の今日」だった場合のみ、自動で「新しい今日」へ
    const inp = document.getElementById("inpDate");
    if(inp && inp.value===prev){
      inp.value = nowKey;
      toast("日付を本日に更新しました");
    }

    // 月跨ぎの場合は、設定月も追従（表示が一致するように）
    const dt = getDateObj(nowKey);
    const ny = dt.getFullYear();
    const nm = dt.getMonth()+1;
    if(settings.year!==ny || settings.month!==nm){
      settings.year = ny;
      settings.month = nm;
      save(STORE.settings, settings);
      const fy = document.getElementById("setYear");
      const fm = document.getElementById("setMonth");
      if(fy) fy.value = String(ny);
      if(fm) fm.value = String(nm).padStart(2,"0");
      hydrateSettingsUI();
      renderCalendar();
      renderHeaderChips();
    }

    syncInputFromEntry();
    renderDaily();
    renderInputCalc();
  }, 20000);
}


/* =========================
   Tab
   ========================= */

// ===== 管理者ログインモード & 戻る耐性 =====
const KEY_ADMIN_PASS = "wh.admin.pass.v1";
const KEY_ADMIN_SESSION = "wh.admin.session.v1";

function getAdminPass(){ return localStorage.getItem(KEY_ADMIN_PASS) || "admin"; }
function setAdminPass(p){ localStorage.setItem(KEY_ADMIN_PASS, String(p||"")); }

function isAdminMode(){ return sessionStorage.getItem(KEY_ADMIN_SESSION) === "1"; }
function setAdminSession(on){
  if(on) sessionStorage.setItem(KEY_ADMIN_SESSION, "1");
  else sessionStorage.removeItem(KEY_ADMIN_SESSION);
}

function openAdminLogin(){
  // モーダル本体（openModalは title/sub/bodyHtml 形式）
  const body = `
    <label class="block text-sm font-bold mb-1">パスワード</label>
    <input id="adminPassInput" type="password" class="input w-full" placeholder="パスワード" autocomplete="current-password" />
  `;
  openModal(
    "管理者ログイン",
    "管理者のみ「設定・出力」「点検」「復元」などが操作できます。",
    body,
    [
      {label:"ログイン", className:"btn btn-primary", onClick: ()=> tryAdminLogin() },
      {label:"キャンセル", className:"btn btn-ghost", onClick: ()=> closeModal() },
    ]
  );
  setTimeout(()=>{ const el=document.getElementById("adminPassInput"); if(el) el.focus(); }, 30);
}

function tryAdminLogin(){
  const el = document.getElementById("adminPassInput");
  const v = (el && el.value!=null) ? String(el.value) : "";
  if(v === getAdminPass()){
    setAdminSession(true);
    closeModal();
    applyModeVisibility();
    toast("管理者モードでログインしました");
    // すぐ設定に移動（任意）
    switchTab("settings", {push:true});
  }else{
    toast("パスワードが違います");
  }
}

function adminLogout(){
  setAdminSession(false);
  applyModeVisibility();
  toast("ログアウトしました");
  switchTab("input", {push:true});
}

function adminToggle(){
  if(isAdminMode()) return adminLogout();
  return openAdminLogin();
}

let currentTab = "input";


function applyModeVisibility(){
  const admin = isAdminMode();

  const badge = document.getElementById("modeBadge");
  setHidden(badge, !admin, "inline-flex");
  const loginBtn = document.getElementById("adminLoginBtn");
  if(loginBtn){
    loginBtn.textContent = admin ? "管理者ログアウト" : "管理者ログイン";
    setHidden(loginBtn, false, "inline-flex");
  }

  // 管理者専用UIを隠す（通常）
  const adminDisplay = (el)=>{
    const tag = (el.tagName||"").toUpperCase();
    if(el.dataset && el.dataset.adminDisplay) return el.dataset.adminDisplay;
    if(tag==="BUTTON") return "inline-flex";
    if(tag==="SECTION") return "block";
    if(tag==="DIV") return "block";
    if(tag==="SPAN") return "inline-flex";
    if(tag==="TR") return "table-row";
    if(tag==="TH" || tag==="TD") return "table-cell";
    return "block";
  };
  document.querySelectorAll("[data-admin-only='1']").forEach(el=>{
    el.style.display = admin ? adminDisplay(el) : "none";
  });

  // 通常でsettingsにいたら戻す
  if(!admin && currentTab==="settings"){
    currentTab = "input";
    // pushはしない（履歴が荒れない）
    switchTab("input", {push:false});
  }
}

function goBackInApp(){
  try{
    if(history.length > 1) history.back();
    else switchTab("input", {push:false});
  }catch(e){
    switchTab("input", {push:false});
  }
}


/* ===== Display helpers (Tailwindが読み込めない環境でも動作するように) ===== */
function rememberDisplay(el){
  if(!el) return;
  if(el.dataset && el.dataset._disp) return;
  try{
    const d = getComputedStyle(el).display;
    el.dataset._disp = (d && d!=="none") ? d : "";
  }catch(e){
    el.dataset._disp = "";
  }
}
function setHidden(el, hidden, fallbackDisplay){
  if(!el) return;
  rememberDisplay(el);
  if(hidden){
    el.style.display = "none";
    el.classList.add("hidden");
  }else{
    const d = (fallbackDisplay!=null && fallbackDisplay!=="") ? fallbackDisplay : (el.dataset._disp || "");
    el.style.display = d || "";
    el.classList.remove("hidden");
  }
}

function switchTab(tab, opts){
  const ADMIN_MODE = isAdminMode();
  opts = opts || {};
  const push = (opts.push !== false);

  if(!ADMIN_MODE && tab==="settings") tab = "input";

  const tabs = ["input","calendar","overview","individual","settings"];
  currentTab = tab;

  for(const t of tabs){
    const sec = document.getElementById(`section-${t}`);
    const btn = document.getElementById(`tab-${t}`);
    if(sec) setHidden(sec, t!==tab);
    if(btn) btn.classList.toggle("active", t===tab);
  }

  if(tab==="calendar") renderCalendar();
  if(tab==="overview"){ renderOverview(); updateCharts(); }
  if(tab==="individual") renderIndividual();
  if(tab==="settings"){ hydrateSettingsUI(); renderStaffTable(); }

  applyModeVisibility();

  if(push){
    try{
      const u = new URL(location.href);
      // file:// では pushState のURL整形で search が落ちる環境があるため、明示的に保持
      u.search = location.search;
      u.hash = tab;
      history.pushState({tab}, "", u);
    }catch(e){
      location.hash = tab;
    }
  }
}

/* =========================
   Populate selects and header chips
   ========================= */
function fillStaffSelects(){
  // 個別一覧
  const selInd = document.getElementById("indStaff");
  const opts = staff.map(s => `<option value="${s.id}">${s.no}. ${escapeHtml(s.name)}</option>`).join("");
  if(selInd){ selInd.innerHTML = opts; }

  // 入力：端末ごとに最後に選んだ職員を保持
  const saved = localStorage.getItem(STORE.selfStaff);
  const initial = (saved && staff.some(s=>s.id===saved)) ? saved : (staff[0]?.id || "");
  setInputStaff(initial);
renderAvgControls();

  // イベント
  const inpDate = document.getElementById("inpDate");
  if(inpDate){
    inpDate.onchange = () => { syncInputFromEntry(); renderDaily(); };
  }
  document.getElementById("inpIn").oninput = renderInputCalc;
  document.getElementById("inpOut").oninput = renderInputCalc;
  document.getElementById("inpOtherOff").oninput = renderInputCalc;

  if(selInd){
    selInd.onchange = ()=> renderIndividual();
  }
}

function renderHeaderChips(){
  const {y,m,daysInMonth} = getMonthInfo();
  document.getElementById("chip-month").textContent = `${y}年${m}月`;
  document.getElementById("chip-month").classList.add("mono");
  // counts
  let work=0, off=0;
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    if(isOffday(key)) off++; else work++;
  }
  document.getElementById("chip-workday-count").textContent = `勤務日: ${work}`;
  document.getElementById("chip-holiday-count").textContent = `週休日: ${off}`;

  document.getElementById("miniBreak").textContent = formatDurJP(Number(settings.breakMin ?? settings.breakWorkMin ?? 45));
}

function safeCall(fn){
  try{ fn(); }catch(e){ console.error(e); }
}

function renderAll(){
  // 月変更などで「どこか1箇所のエラーで全体が止まる」ことを防ぐ
  safeCall(renderHeaderChips);
  safeCall(renderCalendar);
  safeCall(syncInputFromEntry);
  safeCall(renderDaily);
  safeCall(renderOverview);
  safeCall(renderIndividual);
  safeCall(updateCharts);
}

/* =========================
   Input tab behavior
   ========================= */
// --- Input: staff "self" & fast picker ---
let _inpAutoSelect = true; // 自動選択を許可するか（誤操作防止のため、スタンプ後はOFFにする）
function getInpStaffId(){
  const hid = document.getElementById("inpStaffId");
  let v = (hid?.value || "").trim();
  if(v) return v;

  // 自動選択を止めている間は「未選択」を維持
  if(!_inpAutoSelect) return "";

  // 最後に選んだ職員（この端末）
  const stored = (localStorage.getItem(STORE.selfStaff) || "").trim();
  if(stored && staff.some(s=>s.id===stored)){
    if(hid) hid.value = stored;
    const s = staff.find(x=>x.id===stored);
    const nameEl = document.getElementById("inpStaffName");
    if(nameEl) nameEl.textContent = s ? `${s.no}. ${s.name}` : "—";
    return stored;
  }

  return "";
}
function setInputStaff(staffId){
  cancelAutoClearStaff();
  _inpAutoSelect = true; // 選んだら自動選択を再開（ただし「未選択」を維持したい場合は clear でOFFにする）

  const hid = document.getElementById("inpStaffId");
  if(!hid) return;

  const sid = (staffId || "").trim();
  const nameEl = document.getElementById("inpStaffName");

  // 空指定なら「未選択」にする
  if(!sid){
    hid.value = "";
    if(nameEl) nameEl.textContent = "職員名を選択";
    // 入力欄もクリア
    ["inpIn","inpOut","inpOtherOff","inpOverMan"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = "";
    });
    updateInpStaffBtnState();
    safeCall(renderInputCalc);
    return;
  }

  hid.value = sid;

  // remember last used staff on this device
  localStorage.setItem(STORE.selfStaff, sid);

  const s = staff.find(x=>x.id===sid);
  if(nameEl) nameEl.textContent = s ? `${s.no}. ${s.name}` : "—";

  syncInputFromEntry();
}



let _autoClearStaffTimer = null;
let _autoClearStaffDeadline = 0;
let _autoClearStaffIntervalStarted = false;

function cancelAutoClearStaff(){
  if(_autoClearStaffTimer){
    clearTimeout(_autoClearStaffTimer);
    _autoClearStaffTimer = null;
  }
  _autoClearStaffDeadline = 0;
}

function scheduleAutoClearStaff(ms){
  // 10秒後に「未選択」を強制（setTimeoutが途切れても動くようにdeadline監視も併用）
  const wait = Number(ms || 10000);
  cancelAutoClearStaff();
  _autoClearStaffDeadline = Date.now() + wait;

  const kick = ()=>{
    if(!_autoClearStaffDeadline) return;
    const rest = _autoClearStaffDeadline - Date.now();
    if(rest > 5){
      _autoClearStaffTimer = setTimeout(kick, Math.min(rest, 1000));
      return;
    }
    _autoClearStaffDeadline = 0;
    clearInputStaffSelection(true);
  };
  _autoClearStaffTimer = setTimeout(kick, wait);

  if(!_autoClearStaffIntervalStarted){
    _autoClearStaffIntervalStarted = true;
    setInterval(()=>{
      if(_autoClearStaffDeadline && Date.now() >= _autoClearStaffDeadline){
        _autoClearStaffDeadline = 0;
        clearInputStaffSelection(true);
      }
    }, 500);
  }
}

function clearInputStaffSelection(showToast){
  _inpAutoSelect = false; // スタンプ後は自動選択を止め、「未選択」を維持
  const hid = document.getElementById("inpStaffId");
  if(hid) hid.value = "";
  const nameEl = document.getElementById("inpStaffName");
  if(nameEl) nameEl.textContent = "職員名を選択";

  // 入力欄も一旦クリア（次の職員に持ち越さない）
  ["inpIn","inpOut","inpOtherOff","inpOverMan"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.value = "";
  });

  updateInpStaffBtnState();

  // 画面表示も未選択に寄せる
  const rowName = document.getElementById("rowName");
  const rowIn = document.getElementById("rowIn");
  const rowOut = document.getElementById("rowOut");
  const rowStayEq = document.getElementById("rowStayEq");
  const rowOther = document.getElementById("rowOther");
  const rowOver = document.getElementById("rowOver");
  const rowMonthOver = document.getElementById("rowMonthOver");
  if(rowName) rowName.textContent = "—";
  if(rowIn) rowIn.textContent = "--:--";
  if(rowOut) rowOut.textContent = "--:--";
  if(rowStayEq) rowStayEq.textContent = "--:--";
  if(rowOther) rowOther.textContent = "0時間0分";
  if(rowOver) rowOver.textContent = "--:--";
  if(rowMonthOver) rowMonthOver.textContent = "--:--";

  // 残りカード
  ["remToGoal","remTo80"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.textContent="--:--";
  });
  ["remBarGoal","remBar80"].forEach(id=>{
    const el=document.getElementById(id); if(el) el.style.width="0%";
  });
  const cap1H = Math.floor(Number(settings.remCap1H ?? settings.goalOverH ?? 45));
  const cap2H = Math.floor(Number(settings.remCap2H ?? 80));
  const elCap1 = document.getElementById("remCap1HLabel"); if(elCap1) elCap1.textContent = String(cap1H);
  const elCap2 = document.getElementById("remCap2HLabel"); if(elCap2) elCap2.textContent = String(cap2H);
  const elUsedGoal = document.getElementById("usedGoal"); if(elUsedGoal) elUsedGoal.textContent="--:--";
  const elUsed80 = document.getElementById("used80"); if(elUsed80) elUsed80.textContent="--:--";
  const elCapGoal = document.getElementById("capGoal"); if(elCapGoal) elCapGoal.textContent = formatDurJP(Math.max(0,cap1H)*60);
  const elCap80 = document.getElementById("cap80"); if(elCap80) elCap80.textContent = formatDurJP(Math.max(0,cap2H)*60);


  if(typeof renderDaily==='function') renderDaily();

  if(showToast) toast("職員選択を解除しました");
}

function openStaffPicker(){
  const body = `
    <div class="small">検索して選べます（この端末では最後に選んだ職員が自動で保持されます）。</div>
    <input id="staffPickQ" class="input mt-3" placeholder="氏名または番号で検索（例：佐藤 / 12）" oninput="renderStaffPicker()" />
    <div id="staffPickList" class="mt-3 staffPickGrid"></div>
  `;
  openModal("職員を選択", "入力する職員を選びます", body, [
    { label:"閉じる", className:"btn btn-ghost", onClick: closeModal },
  ], { hideHeaderClose:true, maxWidthPx: 1280 });
  setTimeout(()=>renderStaffPicker(), 0);
}

function renderStaffPicker(){
  const q = (document.getElementById("staffPickQ")?.value || "").trim();
  const list = document.getElementById("staffPickList");
  if(!list) return;

  const items = staff.filter(s=>{
    if(!q) return true;
    return (s.name||"").includes(q) || String(s.no||"").includes(q);
  });

  const current = getInpStaffId();
  list.innerHTML = items.map(s=>{
    const active = s.id===current;
    const dateKey = document.getElementById("inpDate")?.value;
    const e = dateKey ? getEntry(dateKey, s.id) : {in:"", out:""};
    const stateClass = (e.out ? "staffState-out" : (e.in ? "staffState-in" : ""));
    const disp = getDisplayNameRole(s);
    return `
      <button type="button" class="btn btn-ghost staffPickBtn ${stateClass} ${active?"active":""} w-full text-left" onclick="pickStaff('${s.id}')">
        <div class="font-black staffPickName">${escapeHtml(disp.name)}</div>
        <div class="small mono">No.${escapeHtml(String(s.no??""))} / ${escapeHtml(disp.role||"")}</div>
      </button>
    `;
  }).join("");
}

function pickStaff(staffId){
  setInputStaff(staffId);
  closeModal();
}

// --- Fast actions ---
function quickStamp(type){
  // 退勤だけ押すミスを防ぐ
  if(type==="out"){
    const inV = (document.getElementById("inpIn")?.value||"").trim();
    if(!inV){
      toast("出勤していないのに退勤を押しています。先に出勤時刻を入力してください。");
      return;
    }
  }
  if(type==="in") fillNow("in");
  if(type==="out") fillNow("out");

  const ok = saveEntry();
  if(ok){
    // 10秒だけ表示して、その後「職員名を選択」に戻す（押し間違い防止）
    scheduleAutoClearStaff(10000);
  }
}

function nudgeTime(field, deltaMin){
  const id = field==="in" ? "inpIn" : (field==="out" ? "inpOut" : null);
  if(!id) return;
  const el = document.getElementById(id);
  const v = el.value;
  if(!v){
    fillNow(field);
    return;
  }
  const [hh,mm] = v.split(":").map(Number);
  let total = hh*60 + mm + deltaMin;
  total = (total%1440+1440)%1440;
  const nh = String(Math.floor(total/60)).padStart(2,"0");
  const nm = String(total%60).padStart(2,"0");
  el.value = `${nh}:${nm}`;
  renderInputCalc();
}

function stepDate(delta){
  const inp = document.getElementById("inpDate");
  if(!inp || !inp.value) return;
  const dt = getDateObj(inp.value);
  dt.setDate(dt.getDate() + Number(delta||0));
  const y = dt.getFullYear();
  const m = dt.getMonth() + 1;
  const d = dt.getDate();

  // 入力日が月をまたいだ場合でも正しく進むよう、表示月（settings/viewYM）を日付に追従
  try{ setViewYM(y, m); }catch(e){
    settings.year = y; settings.month = m; save(STORE.settings, settings);
    viewYM = { y, m }; save(STORE.viewYM, viewYM);
    syncViewMonthUI();
  }

  inp.value = dateKeyFromParts(y, m, d);
  syncInputFromEntry();
  renderDaily();
}

function setInputDateToday(){
  const key = todayKeyLocal();
  const dt = getDateObj(key);
  // 今日に合わせて表示月も追従
  try{ setViewYM(dt.getFullYear(), dt.getMonth()+1); }catch(e){}
  const inp = document.getElementById("inpDate");
  if(inp) inp.value = key;
  syncInputFromEntry();
  renderDaily();
}

function fillNow(which){
  const now = new Date();
  const t = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
  if(which==="in") document.getElementById("inpIn").value = t;
  if(which==="out") document.getElementById("inpOut").value = t;
  renderInputCalc();
}

function clearField(which){
  if(which==="in") document.getElementById("inpIn").value = "";
  if(which==="out") document.getElementById("inpOut").value = "";
  if(which==="other") document.getElementById("inpOtherOff").value = "";
  renderInputCalc();
}

function syncInputFromEntry(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate").value;

  // 日付バッジは「職員未選択」でも表示してよい
  if(dateKey){
    const off = isOffday(dateKey);
    const dobj = getDateObj(dateKey);
    const badge = off
      ? `<span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span>週休日</span> <span class="small">${dobj.toLocaleDateString("ja-JP",{weekday:"short"})}</span>`
      : `<span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>勤務日</span> <span class="small">${dobj.toLocaleDateString("ja-JP",{weekday:"short"})}</span>`;
    const bb = document.getElementById("inpDayBadge");
    if(bb) bb.innerHTML = badge;
  }

  // 職員未選択のときは、入力欄を自動で埋めない（誤操作防止）
  if(!staffId || !dateKey){
    safeCall(renderInputCalc);
    updateInpStaffBtnState();
    return;
  }

  const e = getEntry(dateKey, staffId);

  // keep hidden inputs in sync
  document.getElementById("inpIn").value = e.in || "";
  document.getElementById("inpOut").value = e.out || "";

  const otherEl = document.getElementById("inpOtherOff");
  if(otherEl) otherEl.value = e.otherOff || "";

  renderInputCalc();
  updateInpStaffBtnState();
}

function updateInpStaffBtnState(){
  const btn = document.getElementById("inpStaffBtn");
  if(!btn) return;
  btn.classList.remove("staffState-in","staffState-out");

  // 出勤/退勤の判定は「いま表示中の入力値」を優先（未保存の編集中も反映）
  const inV  = (document.getElementById("inpIn")?.value || "").trim();
  const outV = (document.getElementById("inpOut")?.value || "").trim();

  if(outV) btn.classList.add("staffState-out");
  else if(inV) btn.classList.add("staffState-in");
}

function renderInputCalc(){
  const dateKey = document.getElementById("inpDate").value;
  const staffId = getInpStaffId();
  // 「残り（当月合計）」の基準は、職員未選択でも表示する
  const cap1H = Math.floor(Number(settings.remCap1H ?? settings.goalOverH ?? 45));
  const cap2H = Math.floor(Number(settings.remCap2H ?? 80));
  const cap1Min = Math.max(0, cap1H) * 60;
  const cap2Min = Math.max(0, cap2H) * 60;

  const cap1Label = document.getElementById("remCap1HLabel");
  const cap2Label = document.getElementById("remCap2HLabel");
  if(cap1Label) cap1Label.textContent = String(cap1H);
  if(cap2Label) cap2Label.textContent = String(cap2H);

  const capGoal = document.getElementById("capGoal");
  const cap80 = document.getElementById("cap80");
  if(capGoal) capGoal.textContent = (cap1Min>0 ? formatDurJP(cap1Min) : "--:--");
  if(cap80) cap80.textContent = (cap2Min>0 ? formatDurJP(cap2Min) : "--:--");

  // 休憩表示（説明カード用）
  const br2 = document.getElementById("miniBreak");
  if(br2) br2.textContent = formatDurJP(Number(settings.breakMin ?? settings.breakWorkMin ?? 45));

  if(!dateKey || !staffId){
    const elG0 = document.getElementById("remToGoal");
    const el80_0 = document.getElementById("remTo80");
    const usedGoal0 = document.getElementById("usedGoal");
    const used80_0 = document.getElementById("used80");
    const barG0 = document.getElementById("remBarGoal");
    const bar80_0 = document.getElementById("remBar80");
    if(elG0) elG0.textContent = "--:--";
    if(el80_0) el80_0.textContent = "--:--";
    if(usedGoal0) usedGoal0.textContent = "--:--";
    if(used80_0) used80_0.textContent = "--:--";
    if(barG0) barG0.style.width = "0%";
    if(bar80_0) bar80_0.style.width = "0%";
    updateInpStaffBtnState();
    return;
  }

  const s = staff.find(x=>x.id===staffId);
  const e = getEntry(dateKey, staffId);

  // Use current UI values for preview
  const inV  = document.getElementById("inpIn").value || "";
  const outV = document.getElementById("inpOut").value || "";
  const othV = (document.getElementById("inpOtherOff")?.value || "").trim();

  const backup = {...e};
  e.in = inV;
  e.out = outV;
  e.otherOff = othV;
  const c = calcFor(dateKey, staffId);
  Object.assign(e, backup);

  const off = isOffday(dateKey);

  const rowName = document.getElementById("rowName");
  const rowType = document.getElementById("rowType");
  const rowIn = document.getElementById("rowIn");
  const rowOut = document.getElementById("rowOut");
  const rowStayEq = document.getElementById("rowStayEq");
  const rowOther = document.getElementById("rowOther");
  const rowOver = document.getElementById("rowOver");
  const rowMonthOver = document.getElementById("rowMonthOver");

  if(rowName) rowName.textContent = s ? s.name : "—";
  if(rowType) rowType.textContent = off ? "週休日" : "勤務日";
  if(rowIn) rowIn.textContent = inV ? inV : "--:--";
  if(rowOut) rowOut.textContent = outV ? outV : "--:--";
  if(rowOther){
    const m = parseDurationToMin(othV);
    rowOther.textContent = formatDurJP(m==null?0:m);
  }
  if(rowStayEq) rowStayEq.textContent = (c.stayEq==null) ? "--:--" : formatDurJP(c.stayEq);
  if(rowOver) rowOver.textContent = (c.over==null) ? "--:--" : formatDurJP(c.over);

  // 今月の累計（時間外）
  if(rowMonthOver){
    // 入力中の日付（YYYY-MM-DD）に属する月の合計を表示
    const dObj = getDateObj(dateKey);
    const yy = dObj.getFullYear();
    const mm = dObj.getMonth() + 1;
    const sumObj = summaryByStaff(staffId, yy, mm);
    rowMonthOver.textContent = formatDurJP(sumObj.totalOver || 0);
    // 残り時間（目標・80h）
    try{
      const total = (sumObj.totalOver || 0);
      const remGoal = Math.max(0, cap1Min - total);
      const rem80 = Math.max(0, cap2Min - total);

      const elG = document.getElementById("remToGoal");
      const el80 = document.getElementById("remTo80");
      const barG = document.getElementById("remBarGoal");
      const bar80 = document.getElementById("remBar80");
      const usedGoal = document.getElementById("usedGoal");
      const capGoal = document.getElementById("capGoal");
      const used80 = document.getElementById("used80");
      const cap80 = document.getElementById("cap80");

      if(capGoal) capGoal.textContent = (cap1Min>0 ? formatDurJP(cap1Min) : "--:--");
      if(cap80) cap80.textContent = (cap2Min>0 ? formatDurJP(cap2Min) : "--:--");
      if(usedGoal) usedGoal.textContent = formatDurJP(total);
      if(used80) used80.textContent = formatDurJP(total);

      if(elG){
        if(cap1Min>0 && total > cap1Min) elG.textContent = `+${formatDurJP(total-cap1Min)} 超過`;
        else elG.textContent = (cap1Min>0 ? formatDurJP(remGoal) : "--:--");
      }
      if(el80){
        if(cap2Min>0 && total > cap2Min) el80.textContent = `+${formatDurJP(total-cap2Min)} 超過`;
        else el80.textContent = (cap2Min>0 ? formatDurJP(rem80) : "--:--");
      }

      if(barG){
        const pctG = cap1Min>0 ? Math.min(100, (total/cap1Min*100)) : 0;
        barG.style.width = pctG.toFixed(0) + "%";
        barG.style.background = (cap2Min>0 && total >= cap2Min) ? "rgba(239,68,68,.75)" : (cap1Min>0 && total >= cap1Min) ? "rgba(245,158,11,.75)" : "var(--brand)";
      }
      if(bar80){
        const pct80 = cap2Min>0 ? Math.min(100, (total/cap2Min*100)) : 0;
        bar80.style.width = pct80.toFixed(0) + "%";
        bar80.style.background = (cap2Min>0 && total >= cap2Min) ? "rgba(239,68,68,.85)" : "rgba(239,68,68,.55)";
      }
}catch(e){} 
}

  // mini
  const br = document.getElementById("miniBreak");
  if(br) br.textContent = formatDurJP(Number(settings.breakMin ?? settings.breakWorkMin ?? 45));

  updateInpStaffBtnState();
}



function saveOtherOff(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate").value;
  if(!staffId || !dateKey) return;

  const val = (document.getElementById("inpOtherOff")?.value || "").trim();
  const e = getEntry(dateKey, staffId);

  if(!val){
    e.otherOff = "";
    save(STORE.records, records);
    renderInputCalc();
    renderDaily();
    renderOverview();
    renderIndividual();
    updateCharts();
    return;
  }

  const mm = parseDurationToMin(val);
  if(mm==null){
    toast("業務外の形式が不正です（例: 0:30 / 0.5）");
    document.getElementById("inpOtherOff").focus();
    return;
  }

  const hm = durMinToHM(mm);
  e.otherOff = hm;
  if(document.getElementById("inpOtherOff")) document.getElementById("inpOtherOff").value = hm;
  save(STORE.records, records);
  renderInputCalc();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}
function saveEntry(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId){ toast("職員を選択してください"); return false; }
  if(!dateKey){ toast("日付を選択してください"); return false; }

  const e = getEntry(dateKey, staffId);
  e.in = (document.getElementById("inpIn")?.value || "").trim();
  e.out = (document.getElementById("inpOut")?.value || "").trim();

  // 業務外：全角→半角に整形
  const othEl = document.getElementById("inpOtherOff");
  if(othEl) normalizeHalfInput(othEl);
  e.otherOff = (othEl?.value || e.otherOff || "").trim();

  // 逆転チェック
  const inMin = parseTimeToMin(e.in);
  const outMin = parseTimeToMin(e.out);
  if(inMin!=null && outMin!=null && inMin > outMin){
    toast("出勤と退勤が逆転しています。入力を確認してください。");
    return false;
  }

  save(STORE.records, records);
  autoBackup();
  toast("保存しました");
  syncInputFromEntry();
  safeCall(renderDaily);
  safeCall(renderOverview);
  safeCall(renderIndividual);
  safeCall(updateCharts);
  return true;
}
function jumpToIndividual(){
  // set individual staff select to current staff
  const staffId = getInpStaffId();
  document.getElementById("indStaff").value = staffId;
  switchTab("individual");
}

/* =========================
   Daily table
   ========================= */
function renderDaily(){
  const dateKey = document.getElementById("inpDate").value;
  const tbody = document.getElementById("dailyBody");
  if(!dateKey){ tbody.innerHTML=""; return; }

  const off = isOffday(dateKey);
  const badge = off ? `<span class="chip"><span class="w-2 h-2 rounded-full bg-amber-500 inline-block"></span>週休日</span>`
                    : `<span class="chip"><span class="w-2 h-2 rounded-full bg-emerald-500 inline-block"></span>勤務</span>`;

  tbody.innerHTML = staff.map(s=>{
    const c = calcFor(dateKey, s.id);
    const e = getEntry(dateKey, s.id);
    const stayEq = (c.stayEq==null) ? "—" : `<span class="mono">${formatDurJP(c.stayEq)}</span>`;
    const over = (c.over==null) ? "—" : `<span class="mono ${c.over>=45*60? "text-red-600 font-black": (c.over>0? "text-red-600 font-bold":"text-gray-700")}">${formatDurJP(c.over)}</span>`;

    const warn = (c.over==null) ? "" : ((c.over>=80*60) ? `<span class="chip"><span class="w-2 h-2 bg-red-600 rounded-full"></span>80+</span>` :
                                        (c.over>=45*60) ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>45+</span>` : "");

    return `
      <tr>
        <td class="p-3 text-sm font-bold">${escapeHtml(s.name)}</td>
        <td class="p-3 text-sm">${badge}</td>
        <td class="p-3 text-sm mono">${escapeHtml(e.in||"---")}</td>
        <td class="p-3 text-sm mono">${escapeHtml(e.out||"---")}</td>
        <td class="p-3 text-sm">${stayEq}</td>
        <td class="p-3 text-sm">${over}</td>
        <td class="p-3 text-sm">${warn}</td>
        <td class="p-3 text-sm no-print">
          <button class="btn btn-ghost px-3 py-1" onclick="quickPick('${s.id}')">入力</button>
        </td>
      </tr>
    `;
  }).join("");
}

function quickPick(staffId){
  switchTab("input");
  setInputStaff(staffId);
  window.scrollTo({top:0, behavior:"smooth"});
}

/* =========================
   Calendar
   ========================= */

function hardRepaint(){
  // iPad Safariで「DOMは変わっているのに描画しない」症状の最終対策
  const pk = document.getElementById("paintKick");
  if(pk){
    pk.classList.remove("kick-anim");
    void pk.offsetWidth;
    pk.classList.add("kick-anim");
  }

  // 1pxスクロールは描画を促進することがある（元に戻す）
  const x = window.scrollX, y = window.scrollY;
  window.scrollTo(x, y+1);
  window.scrollTo(x, y);

  // bodyを軽く触ってreflow
  document.body.style.webkitTransform = "translateZ(0)";
  document.body.getBoundingClientRect();
  requestAnimationFrame(()=>{ document.body.style.webkitTransform = ""; });
}

function forceRepaint(el){
  if(!el) return;
  // Safari/iPadで「状態は変わっているのに描画が遅れる」症状対策（強め）
  const prevDisplay = el.style.display;
  const prevTransform = el.style.transform;
  const prevWebkit = el.style.webkitTransform;

  // 1) transform + layout
  el.style.transform = "translateZ(0)";
  el.style.webkitTransform = "translateZ(0)";
  el.getBoundingClientRect();

  // 2) display toggle (micro) to force paint
  el.style.display = "none";
  void el.offsetHeight;
  el.style.display = prevDisplay || "";

  // 3) cleanup next frame
  requestAnimationFrame(()=>{
    el.style.transform = prevTransform || "";
    el.style.webkitTransform = prevWebkit || "";
  });
}

let _fullRefreshTimer = null;
let _monthShiftLock = false;
let _lastTouchToggle = 0;
function scheduleFullRefresh(){
  if(_fullRefreshTimer) clearTimeout(_fullRefreshTimer);
  _fullRefreshTimer = setTimeout(()=>{
    safeCall(renderHeaderChips);
    safeCall(renderDaily);
    safeCall(renderInputCalc);
    safeCall(renderOverview);
    safeCall(renderIndividual);
    safeCall(updateCharts);
  }, 80); // paint first, then refresh heavy parts
}

function shiftMonth(delta){
  if(_monthShiftLock) return;
  _monthShiftLock = true;
  try{
    let y = Number(settings.year);
    let mo = Number(settings.month);
    mo += delta;
    if(mo<=0){ mo=12; y--; }
    if(mo>=13){ mo=1; y++; }

    settings.year = y;
    settings.month = mo;
    save(STORE.settings, settings);

    // keep view month in sync with settings
    viewYM = { y: y, m: mo };
    save(STORE.viewYM, viewYM);
    syncViewMonthUI();

    // settingsフォーム反映
    const fy = document.getElementById("setYear");
    const fm = document.getElementById("setMonth");
    if(fy) fy.value = String(y);
    if(fm) fm.value = String(mo).padStart(2,"0");

    // ラベル更新（最優先）
    const lab = document.getElementById("calMonthLabel");
    if(lab) lab.textContent = `${y}年${String(mo).padStart(2,"0")}月`;

    // calGridノード差し替え（Safariで描画が止まる対策）
    const oldGrid = document.getElementById("calGrid");
    if(oldGrid && oldGrid.parentNode){
      const neoGrid = document.createElement("div");
      neoGrid.id = "calGrid";
      neoGrid.className = oldGrid.className;
      oldGrid.parentNode.replaceChild(neoGrid, oldGrid);
    }

    // 即描画（＋追い描画）
    safeCall(renderCalendar);
    forceRepaint(document.getElementById("calGrid"));

    requestAnimationFrame(()=>{
      safeCall(renderCalendar);
      forceRepaint(document.getElementById("calGrid"));
    });

    setTimeout(()=>{
      safeCall(renderCalendar);
      forceRepaint(document.getElementById("calGrid"));
      scheduleFullRefresh();
    }, 0);

  } finally {
    // lock解除は少し遅らせて二重実行防止
    setTimeout(()=>{ _monthShiftLock = false; }, 120);
  }
}
let calSel = {start:null, end:null}; // range selection
function renderCalendar(){
  const grid = document.getElementById("calGrid");
  const {y,m,daysInMonth,firstDow} = getMonthInfo();
  if(!grid) return;

  const lab = document.getElementById("calMonthLabel");
  if(lab) lab.textContent = `${y}年${String(m).padStart(2,"0")}月`;

  renderHeaderChips();

  const frag = document.createDocumentFragment();
  const shift = firstDow; // 0=Sun
  for(let i=0;i<shift;i++){
    const blank = document.createElement("div");
    blank.className = "h-24 md:h-28 rounded-2xl border border-dashed border-gray-200 bg-white/40";
    frag.appendChild(blank);
  }

  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const dobj = getDateObj(key);
    const off = isOffday(key);
    const dow = dobj.getDay();
    const isSat = dow===6, isSun = dow===0;
    const accent = off ? "bg-amber-50 border-amber-100" : "bg-emerald-50 border-emerald-100";
    const label = ["日","月","火","水","木","金","土"][dow];
    const sub = off ? "休" : "勤";

    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = `h-24 md:h-28 text-left rounded-2xl border ${accent} p-3 hover:brightness-[0.99] transition`;
    btn.title = "タップで勤務日/週休日を切替";

    // touchstart (Safari)
    btn.addEventListener("touchstart", (ev)=>{
      _lastTouchToggle = Date.now();
      ev.preventDefault();
      toggleOffday(key);
    }, {passive:false});

    // click (desktop / windows)
    btn.addEventListener("click", ()=>{
      // touch直後のクリック二重発火防止
      if(Date.now() - _lastTouchToggle < 450) return;
      toggleOffday(key);
    });

    btn.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div>
          <div class="font-black text-lg leading-none">${d}</div>
          <div class="small mt-1">${label}</div>
        </div>
        <div class="flex items-center gap-2">
          <span class="chip ${off? "border-amber-200":"border-emerald-200"}">${sub}</span>
        </div>
      </div>
      <div class="mt-3 small">
        <span class="${isSat? "text-blue-600 font-bold": isSun? "text-red-600 font-bold":"text-gray-500"}">${isSat?"土":isSun?"日":" "}</span>
        <span class="ml-1">${off? "時間外扱い":"勤務日扱い"}</span>
      </div>
    `;
    frag.appendChild(btn);
  }

  grid.replaceChildren(frag);
}

let calDragging = false;
function calMouseDown(key){
  calDragging = true;
  calSel.start = key;
  calSel.end = key;
  renderCalendar();
}
function calMouseEnter(key){
  if(!calDragging) return;
  calSel.end = key;
  renderCalendar();
}
function calMouseUp(){
  calDragging = false;
}
function inRange(key, a, b){
  const x = new Date(key).getTime();
  const t1 = new Date(a).getTime();
  const t2 = new Date(b).getTime();
  const lo = Math.min(t1,t2), hi=Math.max(t1,t2);
  return x>=lo && x<=hi;
}
function bulkSetWorkday(){
  if(!calSel.start || !calSel.end){ toast("範囲選択してください（ドラッグ）"); return; }
  applyRangeOff(false);
}
function bulkSetOffday(){
  if(!calSel.start || !calSel.end){ toast("範囲選択してください（ドラッグ）"); return; }
  applyRangeOff(true);
}
function applyRangeOff(off){
  const {y,m,daysInMonth} = getMonthInfo();
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    if(inRange(key, calSel.start, calSel.end)){
      setOffday(key, off);
    }
  }
  toast(`範囲を「${off?"週休日":"勤務日"}」にしました`);
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}

function toggleOffday(dateKey){
  const nowOff = isOffday(dateKey);
  setOffday(dateKey, !nowOff);
  renderCalendar();
  renderDaily();
  renderOverview();
  renderIndividual();
  updateCharts();
}


/* =========================
   Overview
   ========================= */
function clearOvOverThreshold(){
  const el = document.getElementById("ovOverThreshold");
  if(el){ el.value = ""; }
  ovOverThresholdH = "";
  save(KEY_OV_OVER_TH, ovOverThresholdH);
  renderOverview();
}

function renderOverview(){
  const q = (document.getElementById("ovSearch")?.value || "").trim();
  const tbody = document.getElementById("overviewBody");
  if(!tbody) return;

  const base = staff.filter(s => {
    const disp = getDisplayNameRole(s);
    return !q || (disp.name||'').includes(q);
  });

  const only = window.__ovFilterIds;
  const list = (Array.isArray(only) && only.length)
    ? base.filter(s=>only.includes(s.id))
    : base;

  const vm = getViewYM();

  // threshold input (minutes strict)
  const thEl = document.getElementById("ovOverThreshold");
  let thH = null;
  if(thEl){
    const s = String(thEl.value||"").trim();
    if(s!==""){
      const v = Number(s);
      if(!isNaN(v)){
        thH = Math.max(0, Math.floor(v));
        ovOverThresholdH = thH;
        save(KEY_OV_OVER_TH, ovOverThresholdH);
      }
    }else{
      ovOverThresholdH = "";
      save(KEY_OV_OVER_TH, ovOverThresholdH);
    }
  }
  const thMin = (thH==null) ? null : (thH*60);

  const data = list.map(s=>{
    const sum = summaryByStaff(s.id, vm.y, vm.m);
    return {s, sum};
  });

  // rows
  const rows = data.map(({s, sum})=>{
	    const disp = getDisplayNameRole(s);
    const warn = sum.over80 ? `<span class="chip"><span class="w-2 h-2 bg-red-600 rounded-full"></span>80+</span>`
               : sum.over45 ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>45+</span>`
               : "";
    const hit = (thMin!=null) && ((sum.totalOver||0) >= thMin);
    const trClass = hit ? "ov-hit" : "hover:bg-slate-50";
    return `
      <tr class="${trClass} cursor-pointer" onclick="goToIndividual('${s.id}')" title="個別へ">
        <td class="p-3 text-sm border-b font-bold text-center">${escapeHtml(disp.name)} ${warn}</td>
        <td class="p-3 text-sm border-b text-center">${escapeHtml(disp.role||"")}</td>
        <td class="p-3 text-sm border-b mono text-center">${sum.avgWorkIn==null? "--:--": formatClock(sum.avgWorkIn)}</td>
        <td class="p-3 text-sm border-b mono text-center">${sum.avgWorkOut==null? "--:--": formatClock(sum.avgWorkOut)}</td>
        <td class="p-3 text-sm border-b mono text-center">${sum.avgWorkStayEq==null? "--:--": formatDurJP(sum.avgWorkStayEq)}</td>
        <td class="p-3 text-sm border-b mono font-light text-center">${sum.avgOffIn==null? "--:--": formatClock(sum.avgOffIn)}</td>
        <td class="p-3 text-sm border-b mono font-light text-center">${sum.avgOffOut==null? "--:--": formatClock(sum.avgOffOut)}</td>
        <td class="p-3 text-sm border-b mono text-center">${sum.avgOffStayEq==null? "--:--": formatDurJP(sum.avgOffStayEq)}</td>
        <td class="p-3 text-sm border-b mono text-center">${formatDurJP(sum.totalOtherOff || 0)}</td>
        <td class="p-3 text-sm border-b mono font-black text-center">${formatDurJP(sum.totalOver || 0)}</td>
        <td class="p-3 text-sm border-b text-center">${(()=>{ const rk=getGoalRankInfo(settings.goalOverH, (sum.totalOver||0)); return `<span class=\"chip mono\">${escapeHtml(rk.rank||"-")}</span><span class=\"small ml-2 text-slate-500\">${escapeHtml(rk.word||"")}</span>`; })()}</td>
      </tr>
    `;
  }).join("");

  tbody.innerHTML = rows;

  // update threshold result box
  const resEl = document.getElementById("ovOverResult");
  const namesEl = document.getElementById("ovOverNames");
  if(thMin==null){
    if(resEl) resEl.textContent = "—";
    if(namesEl) namesEl.innerHTML = "";
  }else{
    const hits = data.filter(x => (x.sum.totalOver||0) >= thMin).map(x=>{
        const disp = getDisplayNameRole(x.s);
        return disp.name||'';
      });
    if(resEl) resEl.textContent = `該当：${hits.length}人 / ${data.length}人（${thH}h以上）`;
    if(namesEl){
      namesEl.innerHTML = hits.map(n=>`<span class="chip">${escapeHtml(n)}</span>`).join("");
    }
  }

  renderAvgBox();
}



function goToIndividual(staffId){
  const sel = document.getElementById("indStaff");
  if(sel) sel.value = staffId;
  switchTab("individual");
  safeCall(renderIndividual);
}

// --- Average selection (checks + patterns) ---
function getSelectedAvgStaffIds(){
  const wrap = document.getElementById("avgStaffChecks");
  if(!wrap) return staff.map(s=>s.id);
  const checked = Array.from(wrap.querySelectorAll('input[type="checkbox"][data-staff-id]'))
    .filter(ch=>ch.checked)
    .map(ch=>ch.getAttribute("data-staff-id"));
  return checked.length ? checked : [];
}
function getCheckedStaffIds(){ return getSelectedAvgStaffIds(); }
function toggleAllAvg(flag){
  const wrap = document.getElementById("avgStaffChecks");
  if(!wrap) return;
  wrap.querySelectorAll('input[type="checkbox"][data-staff-id]').forEach(ch=> ch.checked = !!flag);
  persistAvgSelection();
  renderAvgBox();
}
function persistAvgSelection(){
  const ids = getSelectedAvgStaffIds();
  localStorage.setItem(KEY_AVG_SELECTED, JSON.stringify(ids));
}
function loadAvgSelection(){
  try{
    const ids = JSON.parse(localStorage.getItem(KEY_AVG_SELECTED) || "null");
    if(Array.isArray(ids)) return ids;
  }catch(e){}
  return null;
}
function normalizeRoleTag(role){
  const r = (role||"");
  if(r.includes("校長")) return "principal";
  if(r.includes("教頭") || r.includes("副校長")) return "vice";
  if(r.includes("事務")) return "office";
  return "others";
}
function renderAvgControls(){
  const wrap = document.getElementById("avgStaffChecks");
  if(!wrap) return;

  // 初期値：保存がない場合は「全員」をデフォルトにする
  let sel = loadAvgSelection();
  if(!Array.isArray(sel)){
    sel = staff.map(s=>s.id);
    localStorage.setItem(KEY_AVG_SELECTED, JSON.stringify(sel));
  }

  const selectedSet = new Set(sel);
  const chips = staff.map(s=>{
    const on = selectedSet.has(s.id);
    return `
      <label class="chip ${on?"on":""}">
        <input type="checkbox" class="sr-only" data-staff-id="${s.id}" ${on?"checked":""}
          onchange="persistAvgSelection(); renderAvgControls(); renderAvgBox(); renderOverview();" />
        <span class="dot"></span>
        <span class="mono">${escapeHtml(s.name||"")}</span>
        <span class="small ml-2 text-slate-500">${escapeHtml(s.role||"")}</span>
      </label>
    `;
  }).join("");

  const count = sel.length;
  const total = staff.length;
  const allOn = (count===total && total>0);
  const noneOn = (count===0);

  const pill = document.getElementById("avgSelPill");
  if(pill){
    if(noneOn){
      pill.textContent = "対象：なし";
      pill.classList.remove("on");
    }else if(allOn){
      pill.textContent = `対象：全員（${count}）`;
      pill.classList.remove("on");
    }else{
      pill.textContent = `対象：${count}人`;
      pill.classList.add("on");
    }
  }

  wrap.innerHTML = `
    <div class="flex flex-wrap items-center gap-2 mb-2">
      <button class="btn ${allOn?"btn-primary":"btn-ghost"} px-3 py-1" type="button" onclick="toggleAllAvg(true); renderAvgControls(); renderAvgBox(); renderOverview();">全員</button>
      <button class="btn ${noneOn?"btn-primary":"btn-ghost"} px-3 py-1" type="button" onclick="toggleAllAvg(false); renderAvgControls(); renderAvgBox(); renderOverview();">解除</button>
      <span class="small text-slate-500 ml-1">※チェックの変化はすぐ反映されます。</span>
    </div>
    <div class="flex flex-wrap gap-2">${chips}</div>
  `;
}
function renderAvgBox(){
  const ids = getSelectedAvgStaffIds();
  const sums = ids.map(id=>summaryByStaff(id));

  const avg = (vals)=>{
    const xs = vals.filter(v=>v!=null && !isNaN(v));
    if(!xs.length) return null;
    return xs.reduce((a,b)=>a+b,0)/xs.length;
  };
  const sum = (vals)=> vals.filter(v=>v!=null && !isNaN(v)).reduce((a,b)=>a+b,0);

  // 平日（平均）
  const wdIn  = avg(sums.map(s=>s.avgWorkIn));
  const wdOut = avg(sums.map(s=>s.avgWorkOut));
  const wdEq  = avg(sums.map(s=>s.avgWorkStayEq));

  // 週休日（平均）
  const offIn  = avg(sums.map(s=>s.avgOffIn));
  const offOut = avg(sums.map(s=>s.avgOffOut));
  const offEq  = avg(sums.map(s=>s.avgOffStayEq));

  // 参考：週休日等(合計)
  const sumOffEq = sum(sums.map(s=>s.totalOffStayEq||0));

  // 時間外在校等時間（平均：チェック対象の当月合計を人数で平均）
  const avgMonthOver = avg(sums.map(s=> (s.totalOver==null ? 0 : Number(s.totalOver)||0) ));

  const setText = (id, txt)=>{ const el=document.getElementById(id); if(el) el.textContent = txt; };

  setText("avgWdIn",   (wdIn==null? "--:--": formatClock(wdIn)));
  setText("avgWdOut",  (wdOut==null? "--:--": formatClock(wdOut)));
  setText("avgWdEq",   (wdEq==null? "--:--": formatDurJP(wdEq)));

  setText("avgOffIn",  (offIn==null? "--:--": formatClock(offIn)));
  setText("avgOffOut", (offOut==null? "--:--": formatClock(offOut)));
  setText("avgOffEq",  (offEq==null? "--:--": formatDurJP(offEq)));

  setText("sumOffEq",      formatDurJP(sumOffEq));
  setText("avgMonthOver",  (avgMonthOver==null? "—" : formatDurJP(avgMonthOver)));

  updateCharts();
}

/* =========================
   Individual
   ========================= */
function renderIndividual(){
  const staffId = document.getElementById("indStaff")?.value || staff[0]?.id;
  const tbody = document.getElementById("indBody");
  const vm = getViewYM();
  const sum = summaryByStaff(staffId, vm.y, vm.m);
  const sumEl = document.getElementById('indSummary');
  if(!tbody || !staffId) return;

  const days = monthAggByStaff(staffId, vm.y, vm.m);
  if(sumEl){
    sumEl.innerHTML = `
      <div class="flex flex-wrap gap-2">
        <span class="pill">時間外在校等時間（合計）：<b class="mono">${formatDurJP(sum.totalOver||0)}</b></span>
        <span class="pill">当月 業務外(合計)：<b class="mono">${formatDurJP(sum.totalOtherOff||0)}</b></span>
        <span class="pill">週休日等(合計)：<b class="mono">${formatDurJP(sum.totalOffStayEq||0)}</b></span>
      </div>
    `;
  }
  tbody.innerHTML = days.map(x=>{
    const kind = x.off ? `<span class="chip"><span class="w-2 h-2 bg-amber-500 rounded-full"></span>週休日</span>`
                       : `<span class="chip"><span class="w-2 h-2 bg-emerald-500 rounded-full"></span>勤務</span>`;
    const inStr = x.ent.in ? `<span class="mono">${escapeHtml(x.ent.in)}</span>` : "—";
    const outStr= x.ent.out? `<span class="mono">${escapeHtml(x.ent.out)}</span>` : "—";

    const stayEq = x.stayEq==null? "—" : `<span class="mono">${formatDurJP(x.stayEq)}</span>`;
    const over   = x.over==null? "—" : `<span class="mono font-black ${x.over>=45*60? "text-red-600": (x.over>0? "text-red-600":"text-gray-700")}">${formatDurJP(x.over)}</span>`;
    const hasOtherOff = (x.ent.otherOff!=null && String(x.ent.otherOff).trim()!=="");
    const otherOff = hasOtherOff ? `<span class="mono">${formatDurJP(x.otherOffMin||0)}</span>` : "—";

    return `
      <tr>
        <td class="p-3 text-sm">
          <div class="font-bold">${x.day}日（${x.dow}）</div>
          <div class="small mono">${x.dateKey}</div>
        </td>
        <td class="p-3 text-sm">${kind}</td>
        <td class="p-3 text-sm">${inStr}</td>
        <td class="p-3 text-sm">${outStr}</td>
        <td class="p-3 text-sm">${stayEq}</td>
        <td class="p-3 text-sm">${otherOff}</td>
        <td class="p-3 text-sm">${over}</td>
        <td class="p-3 text-sm no-print">
          <button class="btn btn-ghost px-3 py-1" onclick="jumpInput('${staffId}','${x.dateKey}')">入力</button>
          <button class="btn btn-ghost px-3 py-1" onclick="editOtherOff('${staffId}','${x.dateKey}')">業務外</button>
        </td>
      </tr>
    `;
  }).join("");
}

function jumpInput(staffId, dateKey){
  switchTab("input");
  setInputStaff(staffId);
  document.getElementById("inpDate").value = dateKey;
  syncInputFromEntry();
  window.scrollTo({top:0, behavior:"smooth"});
}

function editOtherOff(staffId, dateKey){
  const e = getEntry(dateKey, staffId);
  const c = calcFor(dateKey, staffId);
  openModal("業務外（除く時間）を編集", `${dateKey} / ${staff.find(s=>s.id===staffId)?.name||""}`, `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div>
        <div class="text-sm font-bold mb-1">その他業務外（除く時間）</div>
        <input id="editOtherOff" class="input mono" placeholder="例: 0:30（空欄=0）" value="${escapeAttr(e.otherOff||"")}" />
        <div class="small mt-1">在校等時間 = 在校時間 − 休憩 − その他業務外</div>
      </div>
      <div>
        <div class="text-sm font-bold mb-1">主な理由（番号）</div>
        <input id="editReason" class="input mono" placeholder="例: 1" value="${escapeAttr((e.reason||e.reasonCode)||"")}" />
      </div>
    </div>
    <div class="mt-4 card p-4">
      <div class="small">現状の計算</div>
      <div class="mt-2 flex flex-wrap gap-2">
        <span class="chip">在校時間: <b class="mono">${c.stayRaw==null?"--:--":formatDurJP(c.stayRaw)}</b></span>
        <span class="chip">休憩: <b class="mono">${formatDurJP(c.breakMin)}</b></span>
        <span class="chip">在校等: <b class="mono">${c.stayEq==null?"--:--":formatDurJP(c.stayEq)}</b></span>
        <span class="chip">時間外: <b class="mono">${c.over==null?"--:--":formatDurJP(c.over)}</b></span>
      </div>
    </div>
  `, [
    {label:"保存", className:"btn btn-primary", onClick:()=>{
      const v = document.getElementById("editOtherOff").value.trim();
      if(v){
        const mm = parseDurationToMin(v);
        if(mm==null){ toast("業務外の形式が不正です（例: 0:30）"); return; }
        e.otherOff = formatDurJP(mm);
      }else{
        e.otherOff = "";
      }
      const rc = document.getElementById("editReason").value.trim();
      e.reason = rc ? rc : "";
      e.reasonCode = e.reason;

      save(STORE.records, records);
      closeModal();
      toast("保存しました");
      renderIndividual();
      renderDaily();
      renderOverview();
      updateCharts();
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal},
  ]);
}

function openIndEditHelp(){
  openModal("業務外（除く時間）について", "必要な日だけ入力します（空欄は0扱い）", `
    <div class="space-y-3">
      <div class="card p-4">
        <div class="font-black">計算の考え方</div>
        <div class="small text-slate-600 mt-2">
          <div class="mono">在校等時間 = （退勤−出勤） − 休憩 − 業務外</div>
        </div>
      </div>

      <div class="card p-4">
        <div class="font-black">どんなときに入れる？</div>
        <ul class="small text-slate-600 list-disc pl-5 mt-2 space-y-1">
          <li>所定の勤務外の食事・読書・研修参加など、学校で“除く”として扱う時間がある日</li>
          <li>日によって発生する場合だけ入力（毎日入れる必要はありません）</li>
        </ul>
      </div>

      <div class="card p-4">
        <div class="font-black">入力のしかた</div>
        <ul class="small text-slate-600 list-disc pl-5 mt-2 space-y-1">
          <li>形式：<b>0:30</b> / <b>0.5</b> / <b>30分</b> など</li>
          <li>編集場所：<b>月別 個別一覧</b> の各日「業務外」ボタン</li>
        </ul>
      </div>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick:closeModal}]);
}

/* =========================
   Charts
   ========================= */
function initCharts(){
  const ctx1 = document.getElementById("chartMonthOver")?.getContext("2d");
  const ctx2 = document.getElementById("chartDailyTotal")?.getContext("2d");
  if(ctx1){
    charts.monthOver = new Chart(ctx1, {
      type: "bar",
      data: { labels: [], datasets: [{ label: "時間外在校等時間（合計）", data: [] }] },
      options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{ticks:{callback:(v)=>minutesToHourLabel(v)}}} }
    });
  }
  if(ctx2){
    charts.dailyTotal = new Chart(ctx2, {
      type: "line",
      data: { labels: [], datasets: [{ label: "日別 合計時間外", data: [], tension: 0.25 }] },
      options: { responsive:true, plugins:{legend:{display:true}}, scales:{y:{ticks:{callback:(v)=>minutesToHourLabel(v)}}} }
    });
  }
}
function minutesToHourLabel(min){
  if(min==null) return "";
  return formatDurJP(min);
}
function updateCharts(){
  // Month over by staff (selected)
  if(charts.monthOver){
    const ids = getSelectedAvgStaffIds();
    const labelNames = [];
    const data = [];
    ids.forEach(id=>{
      const s = staff.find(x=>x.id===id);
      if(!s) return;
      const sum = summaryByStaff(id);
      labelNames.push(s.name);
      data.push(sum.totalOver || 0);
    });
    charts.monthOver.data.labels = labelNames;
    charts.monthOver.data.datasets[0].data = data;
    charts.monthOver.update();
  }
  // Daily total over all staff
  if(charts.dailyTotal){
    const {labels, totals} = dailyTotalOver();
    charts.dailyTotal.data.labels = labels;
    charts.dailyTotal.data.datasets[0].data = totals;
    charts.dailyTotal.update();
  }
}

/* =========================
   Settings UI
   ========================= */
function hydrateSettingsUI(){
  const y = document.getElementById("setYear");
  const m = document.getElementById("setMonth");
  const s = document.getElementById("setStdMin");
  const b = document.getElementById("setBreakMin");

  if(y) y.value = settings.year;
  if(m) m.value = String(settings.month).padStart(2,"0");
  if(s) s.value = Number(settings.stdMin ?? settings.standardWorkMin ?? (7*60+45));
  if(b) b.value = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);

  
  const g = document.getElementById("setGoalOverH");
  if(g) g.value = Number(settings.goalOverH ?? 45);
  const r1 = document.getElementById("setRemCap1H");
  if(r1) r1.value = Number(settings.remCap1H ?? settings.goalOverH ?? 45);
  const r2 = document.getElementById("setRemCap2H");
  if(r2) r2.value = Number(settings.remCap2H ?? 80);
renderStaffTable();
  fillStaffSelects();
  fillReasonEditor();
renderHeaderChips();
  hydrateGoalRankUI();
}function hydrateGoalRankUI(){
  const cfg = Array.isArray(settings.goalRankCfg) ? settings.goalRankCfg : (DEFAULT_SETTINGS.goalRankCfg||[]);
  const by = {};
  cfg.forEach(o=>{ by[String(o.rank||"").toUpperCase()] = o; });
  const setVal = (id,v)=>{ const el=document.getElementById(id); if(el!=null) el.value = (v==null? "" : String(v)); };

  setVal("rankS_max", by.S?.max);
  setVal("rankS_word", by.S?.word);

  setVal("rankA_min", by.A?.min); setVal("rankA_max", by.A?.max); setVal("rankA_word", by.A?.word);
  setVal("rankB_min", by.B?.min); setVal("rankB_max", by.B?.max); setVal("rankB_word", by.B?.word);
  setVal("rankC_min", by.C?.min); setVal("rankC_max", by.C?.max); setVal("rankC_word", by.C?.word);
  setVal("rankD_min", by.D?.min); setVal("rankD_max", by.D?.max); setVal("rankD_word", by.D?.word);

  setVal("rankE_min", by.E?.min);
  setVal("rankE_max", by.E?.max);
  setVal("rankE_word", by.E?.word);

  setVal("rankF_min", by.F?.min);
  setVal("rankF_word", by.F?.word);
}

function applyGoalRankSettings(){
  const g = Number(document.getElementById("setGoalOverH")?.value);
  if(!(g>=0 && g<=9999)){ toast("目標（時間）が不正です"); return; }
  settings.goalOverH = Math.floor(g);

  // 入力タブ「残り（当月合計）」の基準（時間）
  const r1s = document.getElementById("setRemCap1H")?.value;
  const r2s = document.getElementById("setRemCap2H")?.value;
  const r1 = (r1s==="" || r1s==null) ? g : Number(r1s);
  const r2 = (r2s==="" || r2s==null) ? 80 : Number(r2s);
  if(!(r1>=0 && r1<=9999) || !(r2>=0 && r2<=9999)){
    toast("残り表示（時間）が不正です");
    return;
  }
  settings.remCap1H = Math.floor(r1);
  settings.remCap2H = Math.floor(r2);

  const n = (id)=>{
    const el = document.getElementById(id);
    if(!el) return null;
    const s = String(el.value||"").trim();
    if(s==="") return null;
    const v = Number(s);
    return (isNaN(v) ? null : v);
  };
  const w = (id)=> String(document.getElementById(id)?.value||"").trim();

  const cfg = [
    { rank:"S", min:null,      max:n("rankS_max"), word:w("rankS_word") },
    { rank:"A", min:n("rankA_min"), max:n("rankA_max"), word:w("rankA_word") },
    { rank:"B", min:n("rankB_min"), max:n("rankB_max"), word:w("rankB_word") },
    { rank:"C", min:n("rankC_min"), max:n("rankC_max"), word:w("rankC_word") },
    { rank:"D", min:n("rankD_min"), max:n("rankD_max"), word:w("rankD_word") },
    { rank:"E", min:n("rankE_min"), max:n("rankE_max"), word:w("rankE_word") },
    { rank:"F", min:n("rankF_min"), max:null,       word:w("rankF_word") },
  ];

  // minimum validation: A〜Dはmin/maxが両方あるときmin<=max
  for(const r of cfg){
    if(r.rank!=="S" && r.rank!=="F" && r.min!=null && r.max!=null && r.min>r.max){
      toast(`${r.rank} の最小/最大が逆です`);
      return;
    }
  }

  // fill empty words with defaults
  const def = (DEFAULT_SETTINGS.goalRankCfg||[]);
  cfg.forEach(r=>{
    if(!r.word){
      r.word = (def.find(x=>x.rank===r.rank)?.word) || "";
    }
  });

  settings.goalRankCfg = cfg;
  save(STORE.settings, settings);
  toast("保存しました");
  renderOverview();
  renderIndividual();
  safeCall(renderInputCalc);
}

function resetGoalRankSettings(){
  settings.goalOverH = Number(DEFAULT_SETTINGS.goalOverH ?? 45);
  settings.remCap1H = Number(DEFAULT_SETTINGS.remCap1H ?? settings.goalOverH ?? 45);
  settings.remCap2H = Number(DEFAULT_SETTINGS.remCap2H ?? 80);
  settings.goalRankCfg = (DEFAULT_SETTINGS.goalRankCfg||[]).map(o=>({rank:o.rank, min:o.min, max:o.max, word:o.word}));
  save(STORE.settings, settings);
  hydrateSettingsUI();
  hydrateGoalRankUI();
  toast("初期値に戻しました");
  renderOverview();
  renderIndividual();
}


function applySettings(){
  const y = Number(document.getElementById("setYear").value);
  const m = Number(document.getElementById("setMonth").value);
  const std = Number(document.getElementById("setStdMin").value);
  const b = Number(document.getElementById("setBreakMin").value);

  if(!(y>=2000 && y<=2100)){ toast("年が不正です"); return; }
  if(!(m>=1 && m<=12)){ toast("月が不正です"); return; }

  settings.year = y;
  settings.month = m;
  settings.stdMin = Math.max(0, std);
  settings.standardWorkMin = settings.stdMin;

  settings.breakMin = Math.max(0, b);
  settings.breakWorkMin = settings.breakMin; // compat
  settings.breakOffMin = 0;

  save(STORE.settings, settings);

  // update date picker to keep in month
  const {daysInMonth} = getMonthInfo();
  const cur = document.getElementById("inpDate")?.value;
  if(cur){
    const dt = getDateObj(cur);
    const newKey = dateKeyFromParts(y,m, Math.min(dt.getDate(), daysInMonth));
    document.getElementById("inpDate").value = newKey;
  }else{
    document.getElementById("inpDate").value = dateKeyFromParts(y,m,1);
  }

  renderAll();
  renderCalendar();
  renderOverview();
  renderIndividual();
  updateCharts();
  toast("設定を保存しました");
}

function addStaff(){
  const name = (document.getElementById("newStaffName").value||"").trim();
  const role = (document.getElementById("newStaffRole").value||"").trim();
  if(!name){ toast("氏名を入力してください"); return; }
  const id = uid();
  const maxNo = staff.reduce((mx,s)=>Math.max(mx, Number(s.no)||0), 0);
  staff.push({ id, no: maxNo+1, name, role });
  document.getElementById("newStaffName").value = "";
  document.getElementById("newStaffRole").value = "";
  save(STORE.staff, staff);
  renderStaffTable();
  fillStaffSelects();
  renderIndividual();
  renderOverview();
  toast("追加しました");
}

function removeStaff(staffId){
  const s = staff.find(x=>x.id===staffId);
  if(!s) return;
  if(!confirm(`${s.name} を削除しますか？（記録は残ります）`)) return;
  staff = staff.filter(x=>x.id!==staffId);
  save(STORE.staff, staff);
  toast("削除しました");
  fillStaffSelects();
  renderStaffTable();
  renderOverview();
  updateCharts();
}

function openStaffEdit(id){
  const s = staff.find(x=>x.id===id);
  if(!s) return;
  openModal("職員の編集", "No・氏名・職名を編集します", `
    <div class="grid gap-3">
      <div>
        <div class="small font-bold text-slate-600 mb-1">No（任意）</div>
        <input id="editStaffNo" class="input" type="number" min="1" step="1" value="${escapeAttr(String(s.no||""))}" />
      </div>
      <div>
        <div class="small font-bold text-slate-600 mb-1">氏名</div>
        <input id="editStaffName" class="input" value="${escapeAttr(s.name||"")}" />
      </div>
      <div>
        <div class="small font-bold text-slate-600 mb-1">職名</div>
        <input id="editStaffRole" class="input" value="${escapeAttr(s.role||"")}" />
      </div>
    </div>
  `,[
    {label:"キャンセル", className:"btn btn-ghost", onClick: closeModal},
    {label:"保存", className:"btn btn-primary", onClick: ()=>saveStaffEdit(id)},
  ]);
}

function saveStaffEdit(id){
  const s = staff.find(x=>x.id===id);
  if(!s) return;
  const noRaw = (document.getElementById("editStaffNo")?.value||"").trim();
  const no = noRaw==="" ? (s.no||null) : Number(noRaw);
  const name = (document.getElementById("editStaffName").value||"").trim();
  const role = (document.getElementById("editStaffRole").value||"").trim();
  if(!name){ toast("氏名を入力してください"); return; }
  if(no!=null && (isNaN(no) || no<1)){ toast("Noは1以上の数値にしてください"); return; }
  if(no!=null) s.no = Math.floor(no);
  s.name = name;
  s.role = role;
  save(STORE.staff, staff);
  closeModal();
  renderStaffTable();
  fillStaffSelects();
  renderIndividual();
  renderOverview();
  toast("保存しました");
}

function sortStaff(){
  staff.sort((a,b)=>{
    const an = Number(a.no)||0;
    const bn = Number(b.no)||0;
    if(an!==bn) return an-bn;
    // 同じNoの場合は氏名で安定化
    return String(a.name||"").localeCompare(String(b.name||""), "ja");
  });
  save(STORE.staff, staff);
  toast("No順に整列しました");
  fillStaffSelects();
  renderStaffTable();
  renderOverview();
}

function renumberStaff(){
  staff.forEach((s,i)=>{ s.no = i+1; });
}

function renderStaffTable(){
  const tbody = document.getElementById("staffBody");
  if(!tbody) return;
  // 常にNoを並び順に合わせる
  renumberStaff();

  tbody.innerHTML = staff.map((s,idx)=>`
    <tr data-idx="${idx}" class="staff-row">
      <td class="p-3 text-sm mono text-center">${s.no}</td>
      <td class="p-3 text-sm font-bold text-center">${escapeHtml(s.name||"")}</td>
      <td class="p-3 text-sm text-center">${escapeHtml(s.role||"")}</td>
      <td class="p-3 text-sm no-print whitespace-nowrap text-center">
        <button class="btn btn-ghost px-3 py-1" onclick="openStaffEdit('${s.id}')" type="button">編集</button>
        <button class="btn btn-ghost px-3 py-1" onclick="removeStaff('${s.id}')" type="button">削除</button>
      </td>
      <td class="p-3 text-sm no-print text-center">
        <span class="dragHandle" title="ドラッグして並び替え" aria-label="ドラッグして並び替え">≡</span>
      </td>
    </tr>
  `).join("");

  setupStaffDrag();
}

let __staffDragFrom = null;

function setupStaffDrag(){
  const tbody = document.getElementById("staffBody");
  if(!tbody) return;
  const rows = Array.from(tbody.querySelectorAll("tr.staff-row"));
  rows.forEach(row=>{
    row.setAttribute("draggable","true");

    row.addEventListener("dragstart", (e)=>{
      __staffDragFrom = Number(row.dataset.idx);
      row.classList.add("is-dragging");
      try{ e.dataTransfer.setData("text/plain", String(__staffDragFrom)); }catch(_){}
      e.dataTransfer.effectAllowed = "move";
    });

    row.addEventListener("dragend", ()=>{
      row.classList.remove("is-dragging");
      __staffDragFrom = null;
      rows.forEach(r=>r.classList.remove("is-drop-target"));
    });

    row.addEventListener("dragover", (e)=>{
      e.preventDefault();
      row.classList.add("is-drop-target");
      e.dataTransfer.dropEffect = "move";
    });

    row.addEventListener("dragleave", ()=>{
      row.classList.remove("is-drop-target");
    });

    row.addEventListener("drop", (e)=>{
      e.preventDefault();
      const from = (__staffDragFrom!=null) ? __staffDragFrom : Number((e.dataTransfer && e.dataTransfer.getData("text/plain"))||-1);
      const to = Number(row.dataset.idx);
      if(!(from>=0) || !(to>=0) || from===to) return;

      const item = staff.splice(from,1)[0];
      staff.splice(to,0,item);

      renumberStaff();
      saveAll();
      renderStaffTable();
      toast("並び順を更新しました");
    });
  });
}

/* =========================
   Export (Excel)
   ========================= */
function exportMonthExcel(){
  const {y,m,daysInMonth} = getViewMonthInfo();

  // Sheet 1: 月別 全体一覧
  const sheet1 = [["氏名","職名","平日 出勤(平均)","平日 退勤(平均)","平日 在校等(平均)","週休日 出勤(平均)","週休日 退勤(平均)","週休日 在校等(平均)","週休日(合計)","業務外(合計)","時間外在校等時間（合計）"]];
  staff.forEach(s=>{
    const sum = summaryByStaff(s.id, y, m);
    const disp = getDisplayNameRole(s);
    sheet1.push([
  disp.name, disp.role||"",
  sum.avgWorkIn==null? "": formatClock(sum.avgWorkIn),
  sum.avgWorkOut==null? "": formatClock(sum.avgWorkOut),
  sum.avgWorkStayEq==null? "": formatDurJP(sum.avgWorkStayEq),
  sum.avgOffIn==null? "": formatClock(sum.avgOffIn),
  sum.avgOffOut==null? "": formatClock(sum.avgOffOut),
  sum.avgOffStayEq==null? "": formatDurJP(sum.avgOffStayEq),
  formatDurJP(sum.totalOffStayEq || 0),
  formatDurJP(sum.totalOtherOff || 0),
  formatDurJP(sum.totalOver || 0),
]);
  });

  // Sheet 2: 月別 個別（全職員・日別）
  const sheet2 = [["日付","曜","勤務日/週休日","氏名","出勤","退勤","在校時間","休憩","業務外(除く)","在校等時間","時間外在校等時間"]];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    const off = isOffday(key);
    const dow = dowLabel(getDateObj(key));
    for(const s of staff){
      const e = getEntry(key, s.id);
      const c = calcFor(key, s.id);
      if(!(e.in||e.out||e.otherOff)) continue;
      sheet2.push([
        key, dow, off?"週休日":"勤務日",
        (getDisplayNameRole(s).name||''),
        e.in||"", e.out||"",
        c.stayRaw==null? "": formatDurJP(c.stayRaw),
        formatDurJP(c.breakMin),
        e.otherOff||"",
        c.stayEq==null? "": formatDurJP(c.stayEq),
        c.over==null? "": formatDurJP(c.over),
      ]);
    }
  }

  // Sheet 3: カレンダー
  const sheet3 = [["日付","曜","週休日(1)/勤務日(0)"]];
  for(let d=1; d<=daysInMonth; d++){
    const key = dateKeyFromParts(y,m,d);
    sheet3.push([key, dowLabel(getDateObj(key)), isOffday(key)?1:0]);
  }

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet1), "月別_全体一覧");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet2), "月別_日別一覧");
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(sheet3), "カレンダー");

  const fname = `在校等時間_${y}-${pad2(m)}.xlsx`;
  XLSX.writeFile(wb, fname);
}

function printOverview(mode){
  try{
    const {y,m} = getViewYM();
    const checked = getCheckedStaffIds();
    const targets = (mode==="selected") ? checked : staff.map(s=>s.id);
    if(mode==="selected" && !targets.length){ toast("チェックした職員がありません"); return; }

    const monthTitle = `${y}年${pad2(m)}月`;
    const modeLabel = (mode==="selected") ? `チェックした職員（${targets.length}名）` : "全体";
    const goalH = Number(settings.goalOverH||0);

    const rows = targets.map((id, i)=>{
      const st = staff.find(s=>s.id===id);
      if(!st) return null;
      const sum = summaryByStaff(id, y, m);
      const rank = getGoalRankInfo(goalH, sum.totalOver);
	      const disp = getDisplayNameRole(st);
	      return { no:i+1, name:disp.name||"", role:disp.role||"", sum, rank };
    }).filter(Boolean);

    if(!rows.length){ toast("印刷対象がありません"); return; }

    const th = (main, sub)=>`<div>${main}</div>${sub?`<div class="thSub">${sub}</div>`:""}`;
    const html = `<!doctype html><html lang="ja"><head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>月別 全体一覧 印刷</title>
${PRINT_STYLE_BLOCK}
<style>
  @page{ size:A4 landscape; margin:10mm; }
  .page{ padding:14px 16px; }
  .panel{ padding:12px 12px 10px; }
  .tbl{ width:100%; }
  .tbl th, .tbl td{ font-size:10px; padding:7px 8px; }
  .tbl thead th{ text-align:center; vertical-align:bottom; }
  .tbl td{ vertical-align:middle; text-align:center; }
  .thSub{ font-size:9px; color:#6b7280; margin-top:2px; }
  .num{ text-align:center; }
  .mono{ font-variant-numeric: tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  .wNo{ width:36px; }
  .wName{ width:100px; }
  .wRole{ width:100px; }
  .wOther{ width:76px; }
  .wOver{ width:98px; }
  .tbl thead th > div:first-child{ white-space:nowrap; }
  .rankCell{ white-space:nowrap; }
  .rankTag{ display:inline-flex; align-items:center; gap:6px; }
</style>
</head><body>
  <div class="printCredit">©2026 Takayuki WAYAMA</div>
  <div class="report">
    <div class="eva-top">
      <div>
        <div class="eva-title">MONTH OVERVIEW</div>
        <div class="eva-sub">月別 全体一覧（${monthTitle}）</div>
      </div>
      <div class="eva-who">
        <div class="chip">${modeLabel}</div>
        <div class="rankMeta">${new Date().toLocaleString('ja-JP')}</div>
      </div>
    </div>
    <div class="page">
      <div class="panel">
        <table class="tbl">
          <thead>
            <tr>
              <th class="wNo">${th("No","")}</th>
              <th class="wName">${th("氏名","")}</th>
              <th class="wRole">${th("職名","")}</th>
              <th>${th("平日 出勤","（平均）")}</th>
              <th>${th("平日 退勤","（平均）")}</th>
              <th>${th("平日 在校等時間","（平均）")}</th>
              <th>${th("週休日 出勤","（平均）")}</th>
              <th>${th("週休日 退勤","（平均）")}</th>
              <th>${th("週休日 在校等時間","（平均）")}</th>
              <th class="wOther">${th("業務外","（合計）")}</th>
              <th class="wOver">${th("時間外在校等時間","（合計）")}</th>
              <th>${th("達成度","")}</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map(r=>{
              const s = r.sum;
              return `<tr>
                <td class="num mono">${r.no}</td>
                <td class="mono">${escapeHtml(r.name)}</td>
                <td class="mono">${escapeHtml(r.role)}</td>
                <td class="num mono">${formatClock(s.avgWorkIn)}</td>
                <td class="num mono">${formatClock(s.avgWorkOut)}</td>
                <td class="num mono">${formatDurJP(s.avgWorkStayEq)}</td>
                <td class="num mono">${formatClock(s.avgOffIn)}</td>
                <td class="num mono">${formatClock(s.avgOffOut)}</td>
                <td class="num mono">${formatDurJP(s.avgOffStayEq)}</td>
                <td class="num mono">${formatDurJP(s.totalOtherOff)}</td>
                <td class="num mono">${formatDurJP(s.totalOver)}</td>
                <td class="rankCell">
                  <span class="rankTag">
                    <span class="chip mono">${escapeHtml(r.rank.rank||"-")}</span>
                    <span class="mono" style="font-size:9px;color:#374151;">${escapeHtml(r.rank.word||"")}</span>
                  </span>
                </td>
              </tr>`;
            }).join("")}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</body></html>`;

    openPrintOverlay(html, true);
  }catch(e){ console.error(e); toast("印刷に失敗しました"); }
}




function fiscalYearFrom(y,m){
  // 4月開始
  return (m>=4) ? y : (y-1);
}

function monthSummaryForStaffYM(staffId, y, m){
  const days = new Date(y, m, 0).getDate();
  let overMin = 0;
  let stayEqMin = 0;
  let stayRawMin = 0;
  let otherOffMin = 0;
  let has = false;
  for(let d=1; d<=days; d++){
    const key = dateKeyFromParts(y,m,d);
    const ent = getEntry(key, staffId);
    if(!(ent.in || ent.out || ent.otherOff)) continue;
    const c = calcFor(key, staffId);
    has = true;
    if(c.over!=null) overMin += c.over;
    if(c.stayEq!=null) stayEqMin += c.stayEq;
    if(c.stayRaw!=null) stayRawMin += c.stayRaw;
    otherOffMin += (c.otherOffMin||0);
  }
  return {has, overMin, stayEqMin, stayRawMin, otherOffMin};
}

function makeBarChartImage(labels, data, title, goalValue, highlightIndex){
  try{
    const c = document.createElement("canvas");
    c.width = 900;
    c.height = 360;
    const ctx = c.getContext("2d");

    // goal line dataset (optional)
    const ds = [{
      label: title || "時間外(時間)",
      data,
    }];

    if(goalValue && goalValue>0){
      ds.push({
        label: "目標",
        data: labels.map(()=>goalValue),
        type: "line",
        borderDash: [6,4],
        pointRadius: 0,
        tension: 0,
      });
    }

    const chart = new Chart(ctx, {
      type: "bar",
      data: { labels, datasets: ds },
      options: {
        responsive: false,
        animation: false,
        plugins: { legend: { display: !!(goalValue && goalValue>0) }, title: { display: !!title, text: title } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // highlight current month bar by drawing overlay (no color change)
    chart.update();
    if(Number.isInteger(highlightIndex) && highlightIndex>=0 && highlightIndex<labels.length){
      const meta = chart.getDatasetMeta(0);
      const el = meta.data[highlightIndex];
      if(el){
        const {x, y, base, width} = el.getProps(['x','y','base','width'], true);
        ctx.save();
        ctx.globalAlpha = 0.12;
        ctx.fillStyle = "#111827";
        ctx.fillRect(x - width/2, y, width, base - y);
        ctx.restore();
      }
    }

    const url = c.toDataURL("image/png");
    chart.destroy();
    return url;
  }catch(e){
    return null;
  }
}

function makeLineChartImage(labels, data, title){
  const c = document.createElement("canvas");
  c.width = 900; c.height = 360;
  const ctx = c.getContext("2d");
  // minimal line chart drawing
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,c.width,c.height);
  ctx.fillStyle = "#111827";
  ctx.font = "bold 20px system-ui,-apple-system,'Noto Sans JP',sans-serif";
  ctx.fillText(title || "", 24, 34);

  const padL = 60, padR = 24, padT = 56, padB = 48;
  const W = c.width - padL - padR;
  const H = c.height - padT - padB;

  const maxV = Math.max(1e-6, ...data.map(v=>Number(v)||0));
  const minV = 0;

  // axes
  ctx.strokeStyle = "#e5e7eb";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT);
  ctx.lineTo(padL, padT+H);
  ctx.lineTo(padL+W, padT+H);
  ctx.stroke();

  const n = Math.max(1, data.length);
  const step = (n<=1) ? 0 : (W/(n-1));

  // line
  ctx.strokeStyle = "#2563eb";
  ctx.lineWidth = 3;
  ctx.beginPath();
  for(let i=0;i<n;i++){
    const v = Number(data[i])||0;
    const x = padL + step*i;
    const y = padT + H - ((v-minV)/(maxV-minV))*H;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // dots
  ctx.fillStyle = "#2563eb";
  for(let i=0;i<n;i++){
    const v = Number(data[i])||0;
    const x = padL + step*i;
    const y = padT + H - ((v-minV)/(maxV-minV))*H;
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  }

  // x labels (sparse)
  ctx.fillStyle = "#64748b";
  ctx.font = "12px system-ui,-apple-system,'Noto Sans JP',sans-serif";
  const every = Math.ceil(n/12);
  for(let i=0;i<n;i+=every){
    const x = padL + step*i;
    const lab = labels[i] ?? "";
    ctx.fillText(String(lab), x-6, padT+H+22);
  }

  // y label max
  ctx.fillText(String(maxV.toFixed(1)), 10, padT+6);
  ctx.fillText("0.0", 20, padT+H+4);

  return c.toDataURL("image/png");
}



function updatePrintOverlayStatus(title, sub){
  const frame = document.getElementById("printFrame");
  if(!frame) return;
  const t = escapeHtml(title || "処理中…");
  const s = escapeHtml(sub || "");
  frame.srcdoc = `<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>${t}</title></head>
    <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
      <div style="font-weight:900;font-size:18px;margin-bottom:8px;">${t}</div>
      <div style="color:#64748b;white-space:pre-wrap;">${s}</div>
    </body></html>`;
}

function setPrintOverlayMsg(html){
  const box = document.getElementById("printOverlayMsg");
  if(!box) return;
  if(html){
    box.style.display = "block";
    box.innerHTML = html;
  }else{
    box.style.display = "none";
    box.innerHTML = "";
  }
}

function openPrintOverlay(htmlDoc, autoPrint=true){
  const ov = document.getElementById("printOverlay");
  const frame = document.getElementById("printFrame");
  if(!ov || !frame){ alert("印刷ビューの準備に失敗しました"); return; }

  ov.classList.remove("hidden");
  ov.classList.add("show");
  ov.style.display = "block";

  // message area reset
  setPrintOverlayMsg("");

  // Safari対策：document.write で確実に描画（srcdocは補助）
  const writeToFrame = () => {
    try{
      const d = frame.contentWindow.document;
      d.open(); d.write(htmlDoc); d.close();
      return true;
    }catch(e){
      return false;
    }
  };

  // 一度クリアしてから書き込み
  try{
    const d = frame.contentWindow.document;
    d.open(); d.write("<!doctype html><html><head><meta charset='utf-8'/></head><body></body></html>"); d.close();
  }catch(e){}

  setTimeout(()=>{
    // まず write
    const ok = writeToFrame();

    // srcdoc も試す（対応ブラウザ向け）
    try{ frame.srcdoc = htmlDoc; }catch(e){}

    if(autoPrint){
      // 次のtickで印刷
      setTimeout(()=>{
        try{ frame.contentWindow.focus(); frame.contentWindow.print(); }catch(e){}
      }, 0);
    }

    if(!ok){
      setPrintOverlayMsg("プレビューの描画に失敗しました。Safariの設定や拡張機能の影響がある可能性があります。");
    }
  }, 0);
}

function closePrintOverlay(){
  const ov = document.getElementById("printOverlay");
  const frame = document.getElementById("printFrame");
  setPrintOverlayMsg("");
  if(frame){
    try{
      const d = frame.contentWindow.document;
      d.open(); d.write("<!doctype html><html><head><meta charset='utf-8'/></head><body></body></html>"); d.close();
    }catch(e){}
    frame.onload=null; frame.srcdoc="";
  }
  if(ov){ ov.classList.remove("show"); ov.classList.add("hidden"); ov.style.display="none"; }
}

function printOverlayPrint(){
  const frame = document.getElementById("printFrame");
  if(!frame){ window.print(); return; }
  try{ frame.contentWindow.focus(); frame.contentWindow.print(); }catch(e){ window.print(); }
}

function printIndividual(){
  try{ toast("個別レポートを準備中…"); }catch(e){}

  // 先にプレビューを表示（Safari対策）
  openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>生成中…</title></head>
    <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
      <div style="font-weight:900;font-size:18px;margin-bottom:8px;">個別レポートを生成しています…</div>
      <div style="color:#64748b;">（Safari対策）この後「確認中…」→「集計中…」へ進みます。</div>
    </body></html>`, false);

  setTimeout(() => {
    try{
      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>確認中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">確認中…</div>
          <div style="color:#64748b;">職員選択とデータを確認しています。</div>
        </body></html>`, false);

      const sel = document.getElementById("indStaff");
      const staffId = (sel && sel.value) ? sel.value : ((Array.isArray(staff) && staff[0] && staff[0].id) ? staff[0].id : "");
      if(!staffId){
        openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>職員未選択</title></head>
          <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#fff;">
            <div style="font-weight:900;font-size:18px;margin-bottom:8px;">職員が未選択です</div>
            <div style="color:#64748b;">上部の「職員」を選んでから、もう一度押してください。</div>
          </body></html>`, false);
        return;
      }
      const s = getStaff(staffId);
      if(!s){
        openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>エラー</title></head>
          <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#fff;">
            <div style="font-weight:900;font-size:18px;margin-bottom:8px;">職員が見つかりません</div>
            <div style="color:#64748b;">職員マスタを確認してください。</div>
          </body></html>`, false);
        return;
      }

      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>集計中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">集計中…</div>
          <div style="color:#64748b;">当月データを集計しています。</div>
        </body></html>`, false);

      const {y,m} = getViewYM();
      const monthTitle = `${y}年${pad2(m)}月`;

      const days = monthAggByStaff(staffId, y, m);
      const sum  = summaryByStaff(staffId, y, m);

      // totals for this month
      const sumMin = (arr, key) => arr.reduce((a,x)=>a + (Number(x[key])||0), 0);
      const monthStayRawMin = sumMin(days, "stayRaw");
      const monthStayEqMin  = sumMin(days, "stayEq");
      const monthOtherOffMin = sumMin(days, "otherOffMin");
      const monthOverMin = sumMin(days, "over");

      const workDays = days.filter(x=>!x.off && x.hasAny && x.over!=null).length;
      const avgOverMin = workDays ? (monthOverMin/workDays) : 0;

      // max over day
      let maxDay = null;
      days.forEach(x=>{
        if(x.over!=null && (maxDay==null || x.over > maxDay.over)) maxDay = {dateKey:x.dateKey, over:x.over};
      });

      // previous month for MoM
      const prev = (()=>{
        let py=y, pm=m-1;
        if(pm<=0){ pm=12; py=y-1; }
        return {y:py,m:pm};
      })();
      const prevDays = monthAggByStaff(staffId, prev.y, prev.m);
      const prevOverMin = prevDays.reduce((a,x)=>a+(Number(x.over)||0),0);
      const thisOverMin = monthOverMin;
      const prevOverMin2 = prevOverMin;
      const momDiffMin = (monthOverMin - prevOverMin);

// goal (rank)
const goalOverH = Number(settings.goalOverH||0);
const goalOverMin = (goalOverH>0) ? goalOverH*60 : 0;
const goalRankInfo = getGoalRankInfo(goalOverH, thisOverMin);

      // reason lookup
      const reasonMap = {};
      (settings.reasons||[]).forEach(r=>{ reasonMap[String(r.code)] = (r.short || r.label || "").slice(0,8); });

      const tableRows = days.map(x=>{
        const ent = x.ent || {};
        const inS  = ent.in || "—";
        const outS = ent.out || "—";
        const otherOffMin = parseDurationToMin(ent.otherOff);
        const otherOffS = (otherOffMin==null) ? "—" : formatDurJP(otherOffMin);
        const stayEqS = (x.stayEq==null)? "—" : formatDurJP(x.stayEq);
        const overS   = (x.over==null)? "—" : `<span style="${(x.over||0)>0?'color:#b91c1c;font-weight:900;':''}">${formatDurJP(x.over)}</span>`;
        const kbn = x.off ? "週休日" : "勤務日";
        const reason = ent.reason ? (reasonMap[String(ent.reason)] || "その他") : "—";
        return `<tr>
          <td>${x.day}日（${x.dow}）<div class="s">${x.dateKey}</div></td>
          <td><span class="pill ${x.off?'off':'work'}">${kbn}</span></td>
          <td class="mono">${escapeHtml(inS)}</td>
          <td class="mono">${escapeHtml(outS)}</td>
          <td class="mono">${stayEqS}</td>
          <td class="mono">${otherOffS==="—" ? "—" : otherOffS}</td>
          <td class="mono">${overS}</td>
          <td class="reason">${escapeHtml(reason)}</td>
        </tr>`;
      }).join("");

      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>年間集計中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">年間集計中…</div>
          <div style="color:#64748b;">4月〜3月の推移を作成しています。</div>
        </body></html>`, false);

      const fyYear = fiscalYearFrom(y,m);
      const annual = [];
      for(let i=0;i<12;i++){
        const mm = ((4 + i - 1) % 12) + 1; // 4..12,1..3
        const yy = (mm>=4) ? fyYear : (fyYear+1);
        const ssum = summaryByStaff(staffId, yy, mm);
        annual.push({y:yy, m:mm, over:(ssum.totalOver||0), anyDays:(ssum.anyDaysCount||0)});
      }
      const chartSvg = buildAnnualOverSvg(annual, y, m, goalOverH);

      const overDaysCount = days.filter(x => (Number(x.over)||0) > 0).length;

// highlights: latest out / earliest in / max stayEq
let latestOut = null;
let earliestIn = null;
let maxStayEqDay = null;
days.forEach(x=>{
  if(x.outMin!=null && !isNaN(x.outMin) && (latestOut==null || x.outMin>latestOut.outMin)){
    latestOut = {dateKey:x.dateKey, outMin:x.outMin};
  }
  if(x.inMin!=null && !isNaN(x.inMin) && (earliestIn==null || x.inMin<earliestIn.inMin)){
    earliestIn = {dateKey:x.dateKey, inMin:x.inMin};
  }
  if(x.stayEq!=null && !isNaN(x.stayEq) && (maxStayEqDay==null || x.stayEq>maxStayEqDay.stayEq)){
    maxStayEqDay = {dateKey:x.dateKey, stayEq:x.stayEq};
  }
});

const kpi = {
  // totals
  monthOverMin,
  monthStayEqMin,
  monthStayRawMin,
  monthOtherOffMin,

  // required summary metrics (from summaryByStaff)
  avgWorkIn: sum.avgWorkIn,
  avgWorkOut: sum.avgWorkOut,
  avgWorkStayEq: sum.avgWorkStayEq,
  avgOffIn: sum.avgOffIn,
  avgOffOut: sum.avgOffOut,
  avgOffStayEq: sum.avgOffStayEq,
  avgWorkOtherOff: sum.avgWorkOtherOff,
  totalOffStayEq: sum.totalOffStayEq,
  totalOtherOff: sum.totalOtherOff,
  totalOver: sum.totalOver,

  // counts
  workDays,
  overDaysCount,

  // averages
  avgOverMin,
  avgStayEqMin: (workDays ? (monthStayEqMin/workDays) : 0),
  avgStayRawMin: (workDays ? (monthStayRawMin/workDays) : 0),

  // highlights
  latestOutKey: latestOut ? latestOut.dateKey : null,
  latestOutMin: latestOut ? latestOut.outMin : null,
  earliestInKey: earliestIn ? earliestIn.dateKey : null,
  earliestInMin: earliestIn ? earliestIn.inMin : null,
  maxStayEqKey: maxStayEqDay ? maxStayEqDay.dateKey : null,
  maxStayEqMin: maxStayEqDay ? maxStayEqDay.stayEq : null,

  // MoM + goal
  maxDayKey: maxDay ? maxDay.dateKey : null,
  maxDayOverMin: maxDay ? maxDay.over : 0,
  prevOverMin2: Number(prevOverMin2),
  thisOverMin: Number(thisOverMin),
  goalRankInfo,
  momDiffMin: Number(momDiffMin),
  achievePct: null,
};

      const p = {
        title: "在校等時間 管理システム",
        staffName: s.name,
        staffRole: s.role || "その他",
        monthTitle,
        breakMin: Number(settings.breakMin||45),
        goalOverH,
        chartSvg,
        chartUrl: null,
        kpi,
        tableRows
      };

      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>レポート作成中…</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#f8fafc;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">レポート作成中…</div>
          <div style="color:#64748b;">レイアウトを生成しています。</div>
        </body></html>`, false);

      const htmlDoc = buildPrintIndividualHTML(p);
      openPrintOverlay(htmlDoc, false);
      toast("個別レポートを表示しました");
    }catch(err){
      console.error(err);
      const msg = (err && (err.stack || err.message)) ? (err.stack || err.message) : String(err);
      setPrintOverlayMsg("個別レポート生成でエラーが発生しました（下に詳細）。");
      openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>エラー</title></head>
        <body style="font-family:system-ui,-apple-system,'Noto Sans JP',sans-serif;padding:24px;color:#111827;background:#fff;">
          <div style="font-weight:900;font-size:18px;margin-bottom:8px;">個別レポート生成でエラーが発生しました</div>
          <div style="color:#64748b;margin-bottom:12px;">下の内容をそのまま送ってください。</div>
          <pre style="white-space:pre-wrap;background:#0f172a;color:#e2e8f0;padding:12px;border-radius:12px;overflow:auto;">${escapeHtml(msg)}</pre>
        </body></html>`, false);
      try{ toast("個別レポートでエラー"); }catch(e){}
    }
  }, 0);
}



function openBatchPrintModal(){
  const vm = getViewYM();
  const y = vm.y, m = vm.m;
  const modeId = `batchMode_${Date.now()}`;

  const listHtml = staff.map(s=>`
    <label class="flex items-center gap-2 py-1">
      <input type="checkbox" class="checkbox" name="bpStaff" value="${escapeAttr(s.id)}" checked>
      <span class="font-semibold">${escapeHtml(s.name||"")}</span>
      <span class="text-xs text-gray-500">${escapeHtml(s.title||"")}</span>
    </label>
  `).join("");

  const body = `
    <div class="space-y-3">
      <div class="text-sm text-gray-600">対象月：<span class="mono font-black">${y}年${m}月</span>　／　複数名の個別レポートをまとめて印刷します。</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div class="card p-3">
          <div class="font-black mb-2">印刷形式</div>
          <label class="flex items-center gap-2 text-sm mb-1"><input type="radio" name="${modeId}" value="one" checked> A4 1枚（要約）</label>
          <label class="flex items-center gap-2 text-sm"><input type="radio" name="${modeId}" value="two"> 2枚（1ページ目：要約／2ページ目：当月一覧）</label>
          <div class="text-xs text-gray-500 mt-2">※一括印刷では、選択した形式で全員分を生成します。</div>
        </div>

        <div class="card p-3">
          <div class="font-black mb-2">職員の選択</div>
          <div class="flex gap-2 mb-2">
            <button class="btn btn-ghost px-3" type="button" onclick="bpSelectAll(true)">全て</button>
            <button class="btn btn-ghost px-3" type="button" onclick="bpSelectAll(false)">解除</button>
          </div>
          <div class="max-h-56 overflow-auto pr-2">${listHtml}</div>
        </div>
      </div>

      <div class="text-xs text-gray-500">※生成後は「印刷プレビュー」画面に切り替わります。</div>
    </div>
  `;

  const getMode = ()=>{
    const el = document.querySelector(`input[name="${modeId}"]:checked`);
    return el ? el.value : "one";
  };

  openModal("一括印刷", "全員 / 複数選択で印刷できます。", body, [
    { label:"選択した職員を印刷", className:"btn btn-primary", onClick: ()=>{
        const ids = Array.from(document.querySelectorAll('input[name="bpStaff"]:checked')).map(x=>x.value);
        if(!ids.length){ showToast("職員を選択してください"); return; }
        const mode = getMode();
        closeModal();
        printIndividualBatch(ids, y, m, mode);
      }
    },
    { label:"全員を印刷", className:"btn btn-ghost", onClick: ()=>{
        const ids = staff.map(s=>s.id);
        const mode = getMode();
        closeModal();
        printIndividualBatch(ids, y, m, mode);
      }
    },
    { label:"閉じる", className:"btn btn-ghost", onClick: closeModal }
  ]);
}

function bpSelectAll(on){
  document.querySelectorAll('input[name="bpStaff"]').forEach(el=>{ el.checked = !!on; });
}

function printIndividualBatch(ids, y, m, mode){
  try{
    // 生成中のページで自動 print() が走ると、未生成の内容で印刷ダイアログが開いてしまう。
    // 一括印刷は「生成 → プレビュー表示 → 右上の印刷ボタン」で統一する。
    openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"><title>印刷プレビュー</title>
      <style>body{font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif; padding:24px; color:#111827}</style></head>
      <body><h2 style="margin:0 0 8px">印刷プレビュー</h2><div style="color:#6b7280">個別レポート（${ids.length}名分）を生成しています…</div></body></html>`, false);
    setTimeout(()=>{
      try{
        const html = buildPrintBatchHTML(ids, y, m, mode);
        openPrintOverlay(html, false);
      }catch(e){
        console.error(e);
        showToast("一括印刷でエラー");
        openPrintOverlay(`<!doctype html><html><head><meta charset="utf-8"><title>印刷プレビュー</title></head>
          <body style="font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,'Noto Sans JP',sans-serif; padding:24px;">
            <h2>印刷プレビュー</h2>
            <p style="color:#b91c1c;font-weight:800;">一括印刷の生成でエラーが発生しました。</p>
            <pre style="white-space:pre-wrap; background:#f3f4f6; padding:12px; border-radius:12px;">${escapeHtml(String(e))}</pre>
          </body></html>`, false);
      }
    }, 60);
  }catch(e){
    console.error(e);
    showToast("一括印刷でエラー");
  }
}

function buildPrintBatchHTML(ids, y, m, mode){
  const curY = Number(y), curM = Number(m);
  const schoolYear = fiscalYearFrom(curY, curM);

  // settings snapshot (current in-memory)
  const breakMin = Number(settings.breakMin ?? settings.breakWorkMin ?? 45);
  const goalOverH = Number(settings.goalOverH ?? 0);

  const reasonMap = {};
  (settings.reasons||[]).forEach(r=>{ reasonMap[String(r.code)] = (r.short || r.label || "").slice(0,8); });

  const sections = ids.map(staffId=>{
    const s = getStaff(staffId) || {id:staffId,name:"",role:""};

    const days = monthAggByStaff(staffId, curY, curM);
    const sum = summaryByStaff(staffId, curY, curM);

    // totals for this month
    const sumMin = (arr, key) => arr.reduce((a,x)=>a + (Number(x[key])||0), 0);
    const monthStayRawMin = sumMin(days, "stayRaw");
    const monthStayEqMin  = sumMin(days, "stayEq");
    const monthOtherOffMin = sumMin(days, "otherOffMin");
    const monthOverMin = sumMin(days, "over");

    const workDays = days.filter(x=>!x.off && x.hasAny && x.over!=null).length;
    const avgOverMin = workDays ? (monthOverMin/workDays) : 0;
    const overDaysCount = days.filter(x => (Number(x.over)||0) > 0).length;

    // max over day
    let maxDay = null;
    days.forEach(x=>{
      if(x.over!=null && (maxDay==null || x.over > maxDay.over)) maxDay = {dateKey:x.dateKey, over:x.over};
    });

    // previous month for MoM
    const prev = (()=>{ let py=curY, pm=curM-1; if(pm<=0){ pm=12; py=curY-1; } return {y:py,m:pm}; })();
    const prevDays = monthAggByStaff(staffId, prev.y, prev.m);
    const prevOverMin2 = prevDays.reduce((a,x)=>a+(Number(x.over)||0),0);
    const thisOverMin = monthOverMin;
    const momDiffMin = (monthOverMin - prevOverMin2);

    // goal (rank)
    const goalRankInfo = getGoalRankInfo(goalOverH, thisOverMin);

    // highlights
    let latestOut = null;
    let earliestIn = null;
    let maxStayEqDay = null;
    days.forEach(x=>{
      if(x.outMin!=null && !isNaN(x.outMin) && (latestOut==null || x.outMin>latestOut.outMin)){
        latestOut = {dateKey:x.dateKey, outMin:x.outMin};
      }
      if(x.inMin!=null && !isNaN(x.inMin) && (earliestIn==null || x.inMin<earliestIn.inMin)){
        earliestIn = {dateKey:x.dateKey, inMin:x.inMin};
      }
      if(x.stayEq!=null && !isNaN(x.stayEq) && (maxStayEqDay==null || x.stayEq>maxStayEqDay.stayEq)){
        maxStayEqDay = {dateKey:x.dateKey, stayEq:x.stayEq};
      }
    });

    const kpi = {
      monthOverMin,
      monthStayEqMin,
      monthStayRawMin,
      monthOtherOffMin,

      avgWorkIn: sum.avgWorkIn,
      avgWorkOut: sum.avgWorkOut,
      avgWorkStayEq: sum.avgWorkStayEq,
      avgOffIn: sum.avgOffIn,
      avgOffOut: sum.avgOffOut,
      avgOffStayEq: sum.avgOffStayEq,
      avgWorkOtherOff: sum.avgWorkOtherOff,
      totalOffStayEq: sum.totalOffStayEq,
      totalOtherOff: sum.totalOtherOff,
      totalOver: sum.totalOver,

      workDays,
      overDaysCount,

      avgOverMin,
      avgStayEqMin: (workDays ? (monthStayEqMin/workDays) : 0),
      avgStayRawMin: (workDays ? (monthStayRawMin/workDays) : 0),

      latestOutKey: latestOut ? latestOut.dateKey : null,
      latestOutMin: latestOut ? latestOut.outMin : null,
      earliestInKey: earliestIn ? earliestIn.dateKey : null,
      earliestInMin: earliestIn ? earliestIn.inMin : null,
      maxStayEqKey: maxStayEqDay ? maxStayEqDay.dateKey : null,
      maxStayEqMin: maxStayEqDay ? maxStayEqDay.stayEq : null,

      maxDayKey: maxDay ? maxDay.dateKey : null,
      maxDayOverMin: maxDay ? maxDay.over : 0,
      prevOverMin2: Number(prevOverMin2),
      thisOverMin: Number(thisOverMin),
      goalRankInfo,
      momDiffMin: Number(momDiffMin),
      achievePct: null,
    };

    // Annual chart (4..3)
    const fyYear = fiscalYearFrom(curY,curM);
    const annual = [];
    for(let i=0;i<12;i++){
      const mm = ((4 + i - 1) % 12) + 1;
      const yy = (mm>=4) ? fyYear : (fyYear+1);
      const ssum = summaryByStaff(staffId, yy, mm);
      annual.push({y:yy, m:mm, over:(ssum.totalOver||0), anyDays:(ssum.anyDaysCount||0)});
    }
    const chartSvg = buildAnnualOverSvg(annual, curY, curM, goalOverH);

    const p = {
      title:`${curY}年${curM}月 / （${schoolYear}年度）`,
      y:curY, m:curM,
      staffName:s.name||"",
      staffRole:(s.role||""),
      breakMin, goalOverH, chartSvg, kpi,
      tableRows: buildPrintTableRows(days, reasonMap),
      mode
    };
    return buildPrintIndividualSection(p, mode);
  }).join('<div class="page-break"></div>');

  return `<!doctype html><html><head><meta charset="utf-8"><title>個別レポート 一括印刷</title>
    ${PRINT_STYLE_BLOCK}
  </head><body data-mode="${escapeHtml(mode||'one')}">
    <div class="printCredit">©2026 Takayuki WAYAMA</div>
    ${sections}
  </body></html>`;
}


function buildPrintTableRows(days, reasonMap){
  return days.map(x=>{
    const ent = x.ent || {};
    const inS  = ent.in || "—";
    const outS = ent.out || "—";
    const otherOffMin = parseDurationToMin(ent.otherOff);
    const otherOffS = (otherOffMin==null) ? "—" : formatDurJP(otherOffMin);
    const stayEqS = (x.stayEq==null)? "—" : formatDurJP(x.stayEq);
    const overS   = (x.over==null)? "—" : `<span style="${(x.over||0)>0?'color:#b91c1c;font-weight:900;':''}">${formatDurJP(x.over)}</span>`;
    const kbn = x.off ? "週休日" : "勤務日";
    const reason = ent.reason ? (reasonMap[String(ent.reason)] || "その他") : "—";
    return `<tr>
      <td>${x.day}日（${x.dow}）<div class="s">${x.dateKey}</div></td>
      <td><span class="pill ${x.off?'off':'work'}">${kbn}</span></td>
      <td class="mono">${escapeHtml(inS)}</td>
      <td class="mono">${escapeHtml(outS)}</td>
      <td class="mono">${stayEqS}</td>
      <td class="mono">${otherOffS==="—" ? "—" : otherOffS}</td>
      <td class="mono">${overS}</td>
      <td class="reason">${escapeHtml(reason)}</td>
    </tr>`;
  }).join("");
}

function buildPrintIndividualSection(p){
  const k = p.kpi||{};
  const role = (p.staffRole || p.staffTitle || "その他");
  const monthTitle = (p.monthTitle || p.title || "");
  const stamp = (p.stamp || new Date().toLocaleString("ja-JP"));

  const clock = (v)=> (v==null || isNaN(v)) ? "—" : `<span class="mono">${formatClock(v)}</span>`;
  const dur = (v)=> (v==null || isNaN(v)) ? "—" : `<span class="mono">${formatDurJP(v)}</span>`;

  const rankInfo = k.goalRankInfo || null;
  const rankHtml = (rankInfo && rankInfo.rank)
    ? `<div class="rankBox">
         <div>
           <div class="rankLetter">${escapeHtml(rankInfo.rank)}</div>
           <div class="eva-sub" style="margin-top:2px;color:rgba(11,18,32,.70);font-size:10px;letter-spacing:.18em;">ACHIEVEMENT</div>
         </div>
         <div style="text-align:right;">
           <div class="rankWord">${escapeHtml(rankInfo.word||"")}</div>
           <div class="rankMeta">目標 ${dur((p.goalOverH||0)*60)} / 今月 ${dur(k.thisOverMin||0)} / 差 ${rankInfo.deltaH>=0?"+":"-"}${Math.abs(rankInfo.deltaH||0)}h</div>
         </div>
       </div>`
    : `<div class="rankBox"><div class="rankLetter">—</div><div style="text-align:right;"><div class="rankWord">NO DATA</div><div class="rankMeta">目標設定 or 入力不足</div></div></div>`;

  // FY TREND は横幅いっぱい（2カラムをまたぐ）で表示できるようにする
  const chart = p.chartSvg ? `<div class="chartWrap span2"><div class="chartTitle">FY TREND (4→3)</div><div class="chart">${p.chartSvg}</div></div>` : "";

const highlightHtml = `
    <div class="panel">
      <div class="h2">HIGHLIGHTS</div>
      <div class="small">
        <div class="row"><span class="k">時間外が発生した日数</span><span class="v">${k.overDaysCount||0}日</span></div>
        <div class="row"><span class="k">最早出勤</span><span class="v">${(k.earliestInMin==null?"—":formatClock(k.earliestInMin))}${k.earliestInKey?` <span class="small">（${escapeHtml(k.earliestInKey)}）</span>`:""}</span></div>
        <div class="row"><span class="k">最遅退勤</span><span class="v">${(k.latestOutMin==null?"—":formatClock(k.latestOutMin))}${k.latestOutKey?` <span class="small">（${escapeHtml(k.latestOutKey)}）</span>`:""}</span></div>
        <div class="row"><span class="k">最長在校等時間</span><span class="v">${(k.maxStayEqMin==null?"—":formatDurJP(k.maxStayEqMin))}${k.maxStayEqKey?` <span class="small">（${escapeHtml(k.maxStayEqKey)}）</span>`:""}</span></div>
        <div class="row"><span class="k">最大時間外在校等時間</span><span class="v"><span class="hlNum">${formatDurJP(k.maxDayOverMin||0)}</span>${k.maxDayKey?` <span class="small">（${escapeHtml(k.maxDayKey)}）</span>`:""}</span></div>
      </div>
    </div>
  `;

  return `
    <div class="report">
      <div class="eva-top">
        <div>
          <div class="eva-title">WORKING HOURS ANALYSIS</div>
          <div class="eva-sub">${escapeHtml(p.title||"在校等時間 管理システム")} ／ ${escapeHtml(monthTitle)}</div>
          <div class="tagline"><span class="dot"></span><span>INTERNAL / EDUCATION OPS</span></div>
        </div>
        <div class="eva-who">
          <div class="eva-name">${escapeHtml(p.staffName||"")}</div>
          <div class="eva-role">${escapeHtml(role)}</div>
          <div class="eva-meta">${escapeHtml(stamp)}</div>
        </div>
      </div>

      <div class="page">
        <div class="grid">
          <div class="panel">
            <div class="h2">SUMMARY</div>

            <div class="metrics">
              <div class="metric">
                <div class="k">勤務日数</div>
                <div class="v">${k.workDays||0}日</div>
                <div class="s">入力がある勤務日のみ</div>
              </div>
              <div class="metric">
                <div class="k">時間外在校等時間（合計）</div>
                <div class="v">${dur(k.totalOver||0)}</div>
                <div class="s">${(k.prevOverMin2!=null? `先月比 ${((k.momDiffMin||0)>=0?"+":"-")}${formatDurJP(Math.abs(k.momDiffMin||0))}`:"")}</div>
              </div>
              <div class="metric">
                <div class="k">業務外(合計)</div>
                <div class="v">${dur(k.totalOtherOff||0)}</div>
                <div class="s">自主研修/食事等</div>
              </div>
            </div>

            <div style="margin-top:10px;">
              ${rankHtml}
            </div>

            <div style="margin-top:10px;" class="split">
              <div class="box">
                <div class="h2" style="margin-bottom:6px;">WEEKDAY PROFILE（平均）</div>
                <div class="row"><span class="k">出勤時刻</span><span class="v">${clock(k.avgWorkIn)}</span></div>
                <div class="row"><span class="k">退勤時刻</span><span class="v">${clock(k.avgWorkOut)}</span></div>
                <div class="row"><span class="k">在校等時間</span><span class="v">${dur(k.avgWorkStayEq||0)}</span></div>
              </div>

              <div class="box">
                <div class="h2" style="margin-bottom:6px;">HOLIDAY PROFILE（平均）</div>
                <div class="row"><span class="k">出勤時刻</span><span class="v">${clock(k.avgOffIn)}</span></div>
                <div class="row"><span class="k">退勤時刻</span><span class="v">${clock(k.avgOffOut)}</span></div>
                <div class="row"><span class="k">在校等時間</span><span class="v">${dur(k.avgOffStayEq||0)}</span></div>
              </div>
            </div>

            <div style="margin-top:8px;" class="split">
              <div class="box">
                <div class="h2" style="margin-bottom:6px;">TOTALS（合計）</div>
                <div class="row"><span class="k">平　日 在校等時間</span><span class="v">${dur(Math.max(0,(k.monthStayEqMin||0)-(k.totalOffStayEq||0)))}</span></div>
                <div class="row"><span class="k">週休日 在校等時間</span><span class="v">${dur(k.totalOffStayEq||0)}</span></div>
                <div class="row"><span class="k">当　月 在校等時間</span><span class="v">${dur(k.monthStayEqMin||0)}</span></div>
                <div class="row"><span class="k">業務外</span><span class="v">${dur(k.totalOtherOff||0)}</span></div>
                <div class="row"><span class="k">時間外在校等時間</span><span class="v">${dur(k.totalOver||0)}</span></div>
              </div>
              <div class="box">
                <div class="h2" style="margin-bottom:6px;">AVERAGE（平均）</div>
                <div class="row"><span class="k">業務外</span><span class="v">${dur(k.avgWorkOtherOff||0)}</span></div>
                <div class="row"><span class="k">時間外在校等時間</span><span class="v">${dur(k.avgOverMin||0)}</span></div>
              </div>
            </div>

          </div>

${highlightHtml}
${chart}
        </div>

      </div>

      <div class="page detail-block">
        <div class="panel" style="background:#fff;">
          <div class="h2">DAILY LOG</div>
          <div class="small" style="margin-bottom:8px;">当月（日別一覧）※2ページ印刷時のみ表示（1ページ印刷では非表示）</div>
          <table class="tbl">
            <thead>
              <tr>
                <th>日付</th>
                <th>区分</th>
                <th>出勤</th>
                <th>退勤</th>
                <th>在校等</th>
                <th>業務外</th>
                <th>時間外在校等時間</th>
                <th>理由</th>
              </tr>
            </thead>
            <tbody>
              ${p.tableRows || ""}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  `;
}

// A shared style block for batch print (keep in sync with buildPrintIndividualHTML)
const PRINT_STYLE_BLOCK = `<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Orbitron:wght@400;700;900&display=swap');

:root{
  --ink:#0b1220;
  --muted:#5b6475;
  --line:#d6dde9;
  --paper:#ffffff;
  --panel:#f7f9fc;
  --accent:#24ff8a;
  --accent2:#8b5cf6;
  --danger:#ef4444;
  --radius:18px;
}

*{ box-sizing:border-box; }
body{
  margin:0;
  background:var(--paper);
  color:var(--ink);
  font-family: Inter, -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP","Hiragino Sans",sans-serif;
}
.mono{ font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono",monospace; }
.tnum, .metric .v, .row .v, .rankMeta, .tbl td, .tbl th{ font-variant-numeric: tabular-nums; font-feature-settings: "tnum" 1; }

.report{
  border:1px solid var(--line);
  border-radius:22px;
  overflow:hidden;
  background:var(--paper);
}

.page{
  padding:14px 16px;
}
.page + .page{ border-top:1px dashed var(--line); }

.eva-top{
  display:flex;
  justify-content:space-between;
  align-items:flex-end;
  gap:12px;
  padding:14px 16px;
  background:
    linear-gradient(90deg, rgba(36,255,138,.15), rgba(139,92,246,.12)),
    repeating-linear-gradient(135deg, rgba(11,18,32,.06) 0 3px, rgba(11,18,32,0) 3px 9px);
  border-bottom:1px solid var(--line);
}
.eva-title{
  font-family: Orbitron, Inter, sans-serif;
  font-weight:900;
  letter-spacing:.10em;
  font-size:18px;
}
.eva-sub{
  margin-top:4px;
  font-size:11px;
  color:var(--muted);
  letter-spacing:.06em;
}
.eva-who{
  text-align:right;
  min-width:160px;
}
.eva-name{
  font-weight:900;
  font-size:16px;
  letter-spacing:.03em;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.eva-role{
  margin-top:2px;
  font-size:11px;
  color:var(--muted);
  letter-spacing:.08em;
}
.eva-meta{
  margin-top:6px;
  font-size:10px;
  color:var(--muted);
}
.tagline{
  display:inline-flex;
  gap:8px;
  align-items:center;
  margin-top:8px;
  font-size:10px;
  letter-spacing:.14em;
  color:var(--ink);
  opacity:.85;
}
.tagline .dot{ width:6px; height:6px; border-radius:999px; background:var(--accent); box-shadow:0 0 0 3px rgba(36,255,138,.18); }

.grid{
  display:grid;
  grid-template-columns: 1.25fr 1fr;
  gap:10px;
}
.span2{ grid-column: 1 / -1; }
@media (max-width: 820px){
  .grid{ grid-template-columns:1fr; }
}

.panel{
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:var(--panel);
  padding:12px 12px;
  position:relative;
}
.panel::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:var(--radius);
  pointer-events:none;
  box-shadow: inset 0 0 0 1px rgba(11,18,32,.04);
}
.h2{
  margin:0 0 10px;
  font-weight:900;
  font-size:12px;
  letter-spacing:.14em;
  font-family: Orbitron, Inter, sans-serif;
}
.small{ font-size:11px; color:var(--muted); line-height:1.55; }

.metrics{
  display:grid;
  grid-template-columns: repeat(3,minmax(0,1fr));
  gap:8px;
}
.metric{
  border:1px solid rgba(11,18,32,.10);
  border-radius:14px;
  background:#fff;
  padding:8px 10px;
}
.metric .k{ font-size:10px; color:var(--muted); font-weight:900; letter-spacing:.08em; }
.metric .v{ font-size:16px; font-weight:900; margin-top:2px; }
.metric .s{ font-size:10px; color:var(--muted); margin-top:1px; }

.split{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:8px;
}
.split .box{
  border:1px solid rgba(11,18,32,.10);
  border-radius:14px;
  background:#fff;
  padding:10px 10px;
}
.row{
  display:flex;
  justify-content:space-between;
  gap:10px;
  margin:4px 0;
}
.row .k{ color:var(--muted); font-size:11px; font-weight:900; letter-spacing:.06em; }
.row .v{ font-weight:900; font-size:12px; color:var(--ink); }
.hlNum{ font-weight:900; }

.rankBox{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid rgba(11,18,32,.14);
  background: linear-gradient(90deg, rgba(36,255,138,.14), rgba(139,92,246,.10));
}
.rankLetter{
  font-family: Orbitron, Inter, sans-serif;
  font-size:30px;
  font-weight:900;
  letter-spacing:.10em;
  line-height:1;
}
.rankWord{
  font-family: Orbitron, Inter, sans-serif;
  font-size:11px;
  letter-spacing:.22em;
  opacity:.88;
  text-transform:uppercase;
  text-align:right;
}
.rankMeta{
  font-size:10px;
  color:rgba(11,18,32,.70);
  margin-top:2px;
  text-align:right;
}

.chartWrap{
  margin-top:10px;
  border:1px solid var(--line);
  border-radius:var(--radius);
  background:#fff;
  padding:8px 10px;
}
.chartTitle{
  font-family: Orbitron, Inter, sans-serif;
  font-weight:900;
  font-size:11px;
  letter-spacing:.14em;
  margin:0 0 6px;
}
.chart{
  height:68mm;
  overflow:hidden;
}
.chart svg{ width:100%; height:100%; }

.detail-block{ margin-top:12px; }
.page-break{ break-after: page; }
.tbl{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
  background:#fff;
  border:1px solid var(--line);
  border-radius:14px;
  overflow:hidden;
}
.tbl th,.tbl td{
  border-bottom:1px solid #eef2f7;
  padding:5px 6px;
  font-size:10px;
  vertical-align:top;
}
.tbl th{
  background:#f1f5f9;
  color:#111827;
  font-weight:900;
  letter-spacing:.06em;
}
.tbl td:nth-child(1){ width:12%; }
.tbl td:nth-child(2){ width:10%; }
.tbl td:nth-child(3), .tbl td:nth-child(4){ width:10%; }
.tbl td:nth-child(5){ width:12%; }
.tbl td:nth-child(6), .tbl td:nth-child(7){ width:12%; }
.tbl td:nth-child(8){ width:22%; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

body[data-mode="two"] .detail-block{ display:block; }
body[data-mode="one"] .detail-block{ display:none; }
.no-print{ display:block; }

/* credit */
.printCredit{
  position:fixed;
  right:9mm;
  bottom:6mm;
  font-size:9px;
  color:rgba(91,100,117,.75);
  letter-spacing:.04em;
  z-index:999;
}

@page{ size:A4; margin:9mm; }
@media print{
  .no-print{ display:none !important; }
  body{ margin:0; }
  .report{ border:none; border-radius:0; }
  .page{ padding:0; }
  .eva-top{ border:none; border-bottom:1px solid var(--line); padding:0 0 8px 0; background:none; }
  .chart{ height:68mm; }
  body[data-mode="two"] .detail-block{ display:block; break-before: page; }
  body[data-mode="one"] .detail-block{ display:none !important; }
  .page-break{ break-after: page; page-break-after: always; }
  .tbl th,.tbl td{ padding:2.8px 3.6px; font-size:8.4px; }
  .tbl td:nth-child(8){ white-space:nowrap; }
}
</style>`;
function buildPrintIndividualHTML(p){
  const now = new Date();
  p.stamp = now.toLocaleString("ja-JP");

  const closeScript = "</scr" + "ipt>";
  return `<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>${escapeHtml(p.title||"在校等時間 管理")} - ${escapeHtml(p.staffName||"")}</title>
${PRINT_STYLE_BLOCK}
<style>
  .previewBar{
    position:sticky;
    top:0;
    z-index:10;
    background:#ffffff;
    border-bottom:1px solid #e5e7eb;
    padding:10px 12px;
    display:flex;
    gap:8px;
    justify-content:flex-end;
    align-items:center;
  }
  .pbtn{
    border:1px solid #d6dde9;
    border-radius:12px;
    padding:8px 12px;
    font-weight:900;
    cursor:pointer;
    background:#fff;
    color:#0b1220;
  }
  .pbtn.active{
    background:#0b1220;
    color:#fff;
    border-color:#0b1220;
  }
</style>
</head>
<body data-mode="one">
  <div class="printCredit">©2026 Takayuki WAYAMA</div>
  <div class="no-print previewBar">
    <button class="pbtn active" id="btnOne" onclick="setMode('one')">1枚（要約）</button>
    <button class="pbtn" id="btnTwo" onclick="setMode('two')">2枚（要約＋当月）</button>
    <button class="pbtn" onclick="window.print()">印刷</button>
  </div>

  ${buildPrintIndividualSection(p)}

  <script>
    function setMode(mode){
      document.body.setAttribute('data-mode', mode);
      document.getElementById('btnOne').classList.toggle('active', mode==='one');
      document.getElementById('btnTwo').classList.toggle('active', mode==='two');
    }
  ${closeScript}
</body>
</html>`;
}


/* =========================
   Backup / Restore
   ========================= */
function backupJSON(){
  const data = {settings, staff, calendar, records, exportedAt: new Date().toISOString()};
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `backup_working_hours_${settings.year}-${pad2(settings.month)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  toast("バックアップを保存しました");
}

function restoreJSON(){
  openModal("復元（JSON）", "バックアップ(JSON)を貼り付けて復元します。", `
    <textarea id="restoreText" class="input min-h-[200px] mono" placeholder="ここにJSONを貼り付け"></textarea>
    <div class="small mt-2 text-red-600">※現在のデータは上書きされます。必要なら先にバックアップしてください。</div>
  `, [
    {label:"復元", className:"btn btn-danger", onClick:()=>{
      try{
        const obj = JSON.parse(document.getElementById("restoreText").value || "{}");
        if(obj.settings) settings = obj.settings;
        if(obj.staff) staff = obj.staff;
        if(obj.calendar) calendar = obj.calendar;
        if(obj.records) records = obj.records;
        saveAll();
        closeModal();
        toast("復元しました");
        hydrateSettingsUI();
        renderCalendar();
        renderDaily();
        renderOverview();
        renderIndividual();
        syncInputFromEntry();
        updateCharts();
      }catch(e){
        toast("JSONが不正です");
      }
    }},
    {label:"キャンセル", className:"btn btn-ghost", onClick:closeModal}
  ]);
}

function resetAll(){
  if(!confirm("全データを初期化します。よろしいですか？")) return;
  localStorage.removeItem(STORE.settings);
  localStorage.removeItem(STORE.staff);
  localStorage.removeItem(STORE.calendar);
  localStorage.removeItem(STORE.records);
  location.reload();
}

/* =========================
   Modal
   ========================= */


function openEditModal(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey){ toast("職員と日付を選択してください"); return; }

  const s = staff.find(x=>x.id===staffId);
  const e = getEntry(dateKey, staffId);

  const body = `
    <div class="space-y-3">
      <div class="small text-slate-600">${s? escapeHtml(s.name):""} / ${dateKey}</div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-black mb-1">出勤</label>
          <input id="modalIn" type="time" class="input mono" value="${escapeAttr(e.in||"")}" />
        </div>
        <div>
          <label class="block text-sm font-black mb-1">退勤</label>
          <input id="modalOut" type="time" class="input mono" value="${escapeAttr(e.out||"")}" />
        </div>
      </div>

      <div>
        <label class="block text-sm font-black mb-1">業務外（時間）</label>
        <input id="modalOther" type="text" class="input mono" placeholder="例: 0:30 / 0.5" value="${escapeAttr(e.otherOff||"")}" />
      </div>

      <div>
        <label class="block text-sm font-black mb-1">業務外の理由</label>
        <select id="modalReason" class="input"></select>
      </div>

      <div class="flex flex-wrap gap-2 pt-2">
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalIn').value='';">出勤クリア</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalOut').value='';">退勤クリア</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalOther').value='';">業務外クリア</button>
        <button type="button" class="btn btn-ghost" onclick="document.getElementById('modalReason').value='';">理由クリア</button>
      </div>

      <div class="small text-slate-600">
        ※保存すると、入力タブの表示・月別集計・グラフにも即反映されます。
      </div>
    </div>
  `;

  openModal("編集", "出勤／退勤／業務外／理由を修正できます。", body, [
    { label:"保存", className:"btn btn-primary", onClick: saveEditModal },
    { label:"閉じる", className:"btn btn-ghost", onClick: closeModal },
  ]);

  // after open
  fillReasonSelect("modalReason");
  const sel = document.getElementById("modalReason");
  if(sel) sel.value = String(e.reason||"");
}

function saveEditModal(){
  const staffId = getInpStaffId();
  const dateKey = document.getElementById("inpDate")?.value;
  if(!staffId || !dateKey) return;

  const inV = document.getElementById("modalIn")?.value || "";
  const outV = document.getElementById("modalOut")?.value || "";
  const othV = (document.getElementById("modalOther")?.value || "").trim();
  const reaV = (document.getElementById("modalReason")?.value || "").trim();

  if(othV){
    const mm = parseDurationToMin(othV);
    if(mm==null){ toast("業務外の形式が不正です（例: 0:30 / 0.5）"); return; }
  }

  const e = getEntry(dateKey, staffId);
  e.in = inV;
  e.out = outV;
  if(!othV){ e.otherOff = ""; }
      else{
        const mm = parseDurationToMin(othV);
        if(mm==null){ toast("業務外の形式が正しくありません（例：0:30 / 0.5 / 30分）"); return; }
        e.otherOff = durMinToHM(mm);
      }
  e.reason = reaV || "";

  save(STORE.records, records);

  // ★保存したらフォーム（モーダル）を消す
  closeModal();

  // reflect into hidden inputs and main field
  if(document.getElementById("inpIn")) document.getElementById("inpIn").value = inV;
  if(document.getElementById("inpOut")) document.getElementById("inpOut").value = outV;
  if(document.getElementById("inpOtherOff")) document.getElementById("inpOtherOff").value = e.otherOff;

  // update views
  safeCall(saveEntry);
  safeCall(renderInputCalc);
  safeCall(renderDaily);
  safeCall(renderOverview);
  safeCall(renderIndividual);
  safeCall(updateCharts);
}
function openModal(title, sub, bodyHtml, actions, opts){
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalSub").textContent = sub;
  document.getElementById("modalBody").innerHTML = bodyHtml;

  const foot = document.getElementById("modalFooter");
  foot.innerHTML = "";
  (actions||[]).forEach(a=>{
    const btn = document.createElement("button");
    btn.className = a.className || "btn btn-ghost";
    btn.textContent = a.label;
    btn.onclick = a.onClick;
    foot.appendChild(btn);
  });

  // ヘッダー右上の「閉じる」ボタン（必要な場合だけ非表示）
  const headClose = document.getElementById("modalHeaderCloseBtn");
  if(headClose){
    headClose.style.display = (opts && opts.hideHeaderClose) ? "none" : "";
  }

  // モーダル幅（必要な場面だけ広げる）
  const card = document.getElementById("modalCard");
  if(card){
    if(opts && opts.maxWidthPx){ card.style.maxWidth = String(opts.maxWidthPx) + "px"; }
    else{ card.style.maxWidth = ""; }
  }

  const wrap = document.getElementById("modalWrap");
  wrap.style.display = "flex";
  wrap.classList.remove("hidden");
  wrap.classList.add("flex");
}
function closeModal(){
  const wrap = document.getElementById("modalWrap");
  if(!wrap) return;
  wrap.classList.add("hidden");
  wrap.classList.remove("flex");
  wrap.style.display = "none";
  const body = document.getElementById("modalBody");
  if(body) body.innerHTML = "";
  const card = document.getElementById("modalCard");
  if(card) card.style.maxWidth = "";
}


function openOverviewPrintMenu(){
  openModal("印刷メニュー", "月別 全体一覧（表示月）", `
    <div class="space-y-3">
      <div class="small text-slate-600">「全体」または「チェックした職員（平均のチェック）」で印刷できます。</div>
      <div class="grid sm:grid-cols-2 gap-2">
        <button class="btn btn-primary w-full" onclick="(function(){ closeModal(); printOverview('all'); })()">全体を印刷</button>
        <button class="btn btn-ghost w-full" onclick="(function(){ closeModal(); printOverview('selected'); })()">チェックした職員を印刷</button>
      </div>
    </div>
  `,[{label:"閉じる", className:"btn btn-ghost", onClick: closeModal}]);
}

function openPrintHelp(){
  const {y,m} = getViewYM();
  const ym = `${y}年${pad2(m)}月`;
  openModal("印刷の使い方", `表示月：${ym}`, `
    <div class="space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="card p-4">
          <div class="font-black">① 表示月を選ぶ</div>
          <div class="small text-slate-600 mt-1">上部の「◀/▶」または月入力で、印刷したい月に切り替えます。</div>
        </div>
        <div class="card p-4">
          <div class="font-black">② 印刷ボタンを押す</div>
          <div class="small text-slate-600 mt-1">全体一覧：<b>全体</b> / <b>チェックした職員</b> のどちらかを選びます。</div>
        </div>
        <div class="card p-4">
          <div class="font-black">③ プレビューで印刷</div>
          <div class="small text-slate-600 mt-1">プレビュー画面が開いたら、ブラウザの印刷で出力します（A4）。</div>
        </div>
      </div>

      <div class="card p-4">
        <div class="font-black">個別レポートの印刷</div>
        <div class="small text-slate-600 mt-1">「個別レポートを開く（印刷/保存）」→ 右上の <b>印刷</b>。A4 1枚/2枚はレポート内で切替できます。</div>
      </div>

      <div class="small text-slate-500">
        ※Safariで別タブが開かない場合は、ポップアップ制限が原因のことがあります。サイトのポップアップ許可をお試しください。
      </div>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick: closeModal}]);
}

function openHelp(){
  openModal("使い方", "迷ったらこの3つだけ覚えればOK", `
    <div class="space-y-3">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div class="card p-4">
          <div class="font-black">① 入力</div>
          <div class="small text-slate-600 mt-1">職員と日付を選び、<b>出勤</b>・<b>退勤</b>（必要な日だけ <b>業務外</b>）を保存。</div>
        </div>
        <div class="card p-4">
          <div class="font-black">② 週休日の日</div>
          <div class="small text-slate-600 mt-1">カレンダーで「週休日/勤務日」を切替（登校日・代休など）。</div>
          <div class="small text-slate-500 mt-2">週休日は <b>在校等＝時間外</b> として集計します。</div>
        </div>
        <div class="card p-4">
          <div class="font-black">③ 確認・出力</div>
          <div class="small text-slate-600 mt-1">月別 全体一覧／個別一覧で集計を確認。必要なら印刷・Excel出力。</div>
          <div class="small text-slate-500 mt-2">印刷の手順は「印刷の使い方」ボタン。</div>
        </div>
      </div>

      <div class="card p-4">
        <div class="font-black">業務外（除く時間）について</div>
        <div class="small text-slate-600 mt-1">
          入力タブは簡単にするため、除く時間の編集は <b>月別 個別一覧 → 業務外</b> で行います。
        </div>
      </div>
    </div>
  `, [{label:"OK", className:"btn btn-primary", onClick:closeModal}]);
}

/* =========================
   Helpers
   ========================= */
function escapeHtml(s){
  return (s??"").toString().replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,"&quot;"); }

// 表示上の「氏名/職名」を安全に扱う（データが逆に入っている場合だけ自動で補正）
function getDisplayNameRole(st){
  const name = (st?.name || "").trim();
  const role = (st?.role || "").trim();
  // 役職っぽい語（入れ替わり判定を強める）
  const roleKw = /(校長|教頭|副校長|教諭|教員|教員等|主任|主幹|事務|養護|講師|栄養|用務|ALT|支援員|非常勤|学年主任|担任|学年|校務|教務|研究|主事|司書|事務長|顧問|相談員|指導|支援|係)/;
  const looksRole = (s)=>!!(s && roleKw.test(s));
  const looksPerson = (s)=>{
    s = (s||"").trim();
    if(!s) return false;
    if(/[0-9]/.test(s)) return false;
    if(looksRole(s)) return false;
    if(!/[一-龯ぁ-んァ-ヶ]/.test(s)) return false;
    if(s.length>12) return false;
    return true;
  };

  const nameLooksRole = looksRole(name);
  const roleLooksRole = looksRole(role);

  // ① name が役職っぽく、role が役職っぽくない → 入れ替え
  if(name && role && nameLooksRole && !roleLooksRole){
    return { name: role, role: name, swapped:true };
  }

  // ② role が人名っぽく、name が人名っぽくない → 入れ替え（担任などの表記を拾う）
  if(name && role){
    const namePerson = looksPerson(name);
    const rolePerson = looksPerson(role);
    if(!namePerson && rolePerson){
      return { name: role, role: name, swapped:true };
    }
  }

  return { name, role, swapped:false };
}


/* =========================
   Hooks (re-render when changing input)
   ========================= */
function renderAvgBoxDebounced(){
  renderAvgBox();
}
</script>
</body>
</html>
